<!DOCTYPE html>
<!-- START: inst/pkgdown/templates/layout.html --><!-- Generated by pkgdown: do not edit by hand --><html lang="en" data-bs-theme="auto"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><title>ESMValTool Tutorial: Writing your own diagnostic script</title><meta name="viewport" content="width=device-width, initial-scale=1"><script src="assets/themetoggle.js"></script><link rel="stylesheet" type="text/css" href="assets/styles.css"><script src="assets/scripts.js" type="text/javascript"></script><!-- mathjax --><script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      config: ["MMLorHTML.js"],
      jax: ["input/TeX","input/MathML","output/HTML-CSS","output/NativeMML", "output/PreviewHTML"],
      extensions: ["tex2jax.js","mml2jax.js","MathMenu.js","MathZoom.js", "fast-preview.js", "AssistiveMML.js", "a11y/accessibility-menu.js"],
      TeX: {
        extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"]
      },
      tex2jax: {
        inlineMath: [['\\(', '\\)']],
        displayMath: [ ['$$','$$'], ['\\[', '\\]'] ],
        processEscapes: true
      }
    });
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><!-- Responsive Favicon for The Carpentries --><link rel="apple-touch-icon" sizes="180x180" href="favicons/incubator/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="favicons/incubator/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="favicons/incubator/favicon-16x16.png"><link rel="manifest" href="favicons/incubator/site.webmanifest"><link rel="mask-icon" href="favicons/incubator/safari-pinned-tab.svg" color="#5bbad5"><meta name="msapplication-TileColor" content="#da532c"><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="black"></head><body>
    <header id="top" class="navbar navbar-expand-md top-nav incubator"><svg xmlns="http://www.w3.org/2000/svg" class="d-none"><symbol id="check2" viewbox="0 0 16 16"><path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"></path></symbol><symbol id="circle-half" viewbox="0 0 16 16"><path d="M8 15A7 7 0 1 0 8 1v14zm0 1A8 8 0 1 1 8 0a8 8 0 0 1 0 16z"></path></symbol><symbol id="moon-stars-fill" viewbox="0 0 16 16"><path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"></path><path d="M10.794 3.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387a1.734 1.734 0 0 0-1.097 1.097l-.387 1.162a.217.217 0 0 1-.412 0l-.387-1.162A1.734 1.734 0 0 0 9.31 6.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387a1.734 1.734 0 0 0 1.097-1.097l.387-1.162zM13.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.156 1.156 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.156 1.156 0 0 0-.732-.732l-.774-.258a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"></path></symbol><symbol id="sun-fill" viewbox="0 0 16 16"><path d="M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"></path></symbol></svg><a class="visually-hidden-focusable skip-link" href="#main-content">Skip to main content</a>
  <div class="container-fluid top-nav-container">
    <div class="col-md-8">
      <div class="large-logo">
        <img id="incubator-logo" alt="Lesson Description" src="assets/images/incubator-logo.svg"><span class="badge text-bg-danger">
          <abbr title="This lesson is in the pre-alpha phase, which means that it is in early development, but has not yet been taught.">
            <a href="https://cdh.carpentries.org/the-lesson-life-cycle.html#early-development-pre-alpha-through-alpha" class="external-link alert-link">
              <i aria-hidden="true" class="icon" data-feather="alert-octagon" style="border-radius: 5px"></i>
              Pre-Alpha
            </a>
            <span class="visually-hidden">This lesson is in the pre-alpha phase, which means that it is in early development, but has not yet been taught.</span>
          </abbr>
        </span>

      </div>
    </div>
    <div class="selector-container">
      <div id="theme-selector">
        <li class="nav-item dropdown" id="theme-button-list">
          <button class="btn btn-link nav-link px-0 px-lg-2 dropdown-toggle d-flex align-items-center" id="bd-theme" type="button" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme (auto)">
            <svg class="bi my-1 theme-icon-active"><use href="#circle-half"></use></svg><i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="bd-theme-text"><li>
              <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
                <svg class="bi me-2 theme-icon"><use href="#sun-fill"></use></svg>
                Light
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
            <li>
              <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                <svg class="bi me-2 theme-icon"><use href="#moon-stars-fill"></use></svg>
                Dark
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
            <li>
              <button type="button" class="btn dropdown-item d-flex align-items-center active" data-bs-theme-value="auto" aria-pressed="true">
                <svg class="bi me-2 theme-icon"><use href="#circle-half"></use></svg>
                Auto
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
          </ul></li>
      </div>

      <div class="dropdown" id="instructor-dropdown">
        <button class="btn btn-secondary dropdown-toggle bordered-button" type="button" id="dropdownMenu1" data-bs-toggle="dropdown" aria-expanded="false">
          <i aria-hidden="true" class="icon" data-feather="eye"></i> Learner View <i data-feather="chevron-down"></i>
        </button>
        <ul class="dropdown-menu" aria-labelledby="dropdownMenu1"><li><button class="dropdown-item" type="button" onclick="window.location.href='instructor/08-diagnostics.html';">Instructor View</button></li>
        </ul></div>
    </div>
  </div>
  <hr></header><nav class="navbar navbar-expand-xl bottom-nav incubator" aria-label="Main Navigation"><div class="container-fluid nav-container">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle Navigation">
      <span class="navbar-toggler-icon"></span>
      <span class="menu-title">Menu</span>
    </button>
    <div class="nav-logo">
      <img class="small-logo" alt="Lesson Description" src="assets/images/incubator-logo-sm.svg"></div>
    <div class="lesson-title-md">
      ESMValTool Tutorial
    </div>
    <div class="search-icon-sm">
      <!-- TODO: do not show until we have search
        <i role="img" aria-label="Search the All In One page" data-feather="search"></i>
      -->
    </div>
    <div class="desktop-nav">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0"><li class="nav-item">
          <span class="lesson-title">
            ESMValTool Tutorial
          </span>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="key-points.html">Key Points</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="reference.html#glossary">Glossary</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="profiles.html">Learner Profiles</a>
        </li>
        <li class="nav-item dropdown">
          <button class="nav-link dropdown-toggle" id="navbarDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            More <i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdown"><li><a class="dropdown-item" href="reference.html">Reference</a></li>
          </ul></li>
      </ul></div>
    <!--
    <form class="d-flex col-md-2 search-form">
      <fieldset disabled>
      <input class="form-control me-2 searchbox" type="search" placeholder="" aria-label="">
        <button class="btn btn-outline-success tablet-search-button"  type="submit">
          <i class="search-icon" data-feather="search" role="img" aria-label="Search the All In One page"></i>
        </button>
      </fieldset>
    </form>
    -->
    <a id="search-button" class="btn btn-primary" href="aio.html" role="button" aria-label="Search the All In One page">Search the All In One page</a>
  </div><!--/div.container-fluid -->
</nav><div class="col-md-12 mobile-title">
  ESMValTool Tutorial
</div>

<aside class="col-md-12 lesson-progress"><div style="width: 54%" class="percentage">
    54%
  </div>
  <div class="progress incubator">
    <div class="progress-bar incubator" role="progressbar" style="width: 54%" aria-valuenow="54" aria-label="Lesson Progress" aria-valuemin="0" aria-valuemax="100">
    </div>
  </div>
</aside><div class="container">
      <div class="row">
        <!-- START: inst/pkgdown/templates/navbar.html -->
<div id="sidebar-col" class="col-lg-4">
  <div id="sidebar" class="sidebar">
      <nav aria-labelledby="flush-headingEleven"><button role="button" aria-label="close menu" alt="close menu" aria-expanded="true" aria-controls="sidebar" class="collapse-toggle" data-collapse="Collapse " data-episodes="Episodes ">
          <i class="search-icon" data-feather="x" role="img"></i>
        </button>
        <div class="sidebar-inner">
          <div class="row mobile-row" id="theme-row-mobile">
            <div class="col" id="theme-selector">
              <li class="nav-item dropdown" id="theme-button-list">
                <button class="btn btn-link nav-link px-0 px-lg-2 dropdown-toggle d-flex align-items-center" id="bd-theme" type="button" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme (auto)">
                  <svg class="bi my-1 theme-icon-active"><use href="#circle-half"></use></svg><span class="d-lg-none ms-1" id="bd-theme-text">Toggle Theme</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-right" aria-labelledby="bd-theme-text"><li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
                      <svg class="bi me-2 theme-icon"><use href="#sun-fill"></use></svg>
                      Light
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                  <li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                      <svg class="bi me-2 theme-icon"><use href="#moon-stars-fill"></use></svg>
                      Dark
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                  <li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center active" data-bs-theme-value="auto" aria-pressed="true">
                      <svg class="bi me-2 theme-icon"><use href="#circle-half"></use></svg>
                      Auto
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                </ul></li>
            </div>
          </div>
          <div class="row mobile-row">
            <div class="col">
              <div class="sidenav-view-selector">
                <div class="accordion accordion-flush" id="accordionFlush9">
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="flush-headingNine">
                      <button class="accordion-button collapsed" id="instructor" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseNine" aria-expanded="false" aria-controls="flush-collapseNine">
                        <i id="eye" aria-hidden="true" class="icon" data-feather="eye"></i> Learner View
                      </button>
                    </h2>
                    <div id="flush-collapseNine" class="accordion-collapse collapse" aria-labelledby="flush-headingNine" data-bs-parent="#accordionFlush2">
                      <div class="accordion-body">
                        <a href="instructor/08-diagnostics.html">Instructor View</a>
                      </div>
                    </div>
                  </div><!--/div.accordion-item-->
                </div><!--/div.accordion-flush-->
              </div><!--div.sidenav-view-selector -->
            </div><!--/div.col -->

            <hr></div><!--/div.mobile-row -->

          <div class="accordion accordion-flush" id="accordionFlush11">
            <div class="accordion-item">

              <button id="chapters" class="accordion-button show" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseEleven" aria-expanded="false" aria-controls="flush-collapseEleven">
                <h2 class="accordion-header chapters" id="flush-headingEleven">
                  EPISODES
                </h2>
              </button>
              <div id="flush-collapseEleven" class="accordion-collapse show collapse" aria-labelledby="flush-headingEleven" data-bs-parent="#accordionFlush11">

                <div class="accordion-body">
                  <div class="accordion accordion-flush" id="accordionFlush1">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading1">
        <a href="index.html">Summary and Setup</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush2">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading2">
        <a href="00-introduction.html">1. Introduction</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush3">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading3">
        <a href="01-quickstart.html">2. Quickstart guide</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush4">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading4">
        <a href="02-installation.html">3. Installation</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush5">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading5">
        <a href="03-configuration.html">4. Configuration</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush6">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading6">
        <a href="04-recipe.html">5. Running your first recipe</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush7">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading7">
        <a href="05-conclusions.html">6. Conclusion of the basic tutorial</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush8">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading8">
        <a href="06-preprocessor.html">7. Writing your own recipe</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush9">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading9">
        <a href="07-development-setup.html">8. Development and contribution</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlushcurrent">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-headingcurrent">
      <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapsecurrent" aria-expanded="true" aria-controls="flush-collapsecurrent">
        <span class="visually-hidden">Current Chapter</span>
        <span class="current-chapter">
        9. Writing your own diagnostic script
        </span>
      </button>
    </div><!--/div.accordion-header-->

    <div id="flush-collapsecurrent" class="accordion-collapse collapse show" aria-labelledby="flush-headingcurrent" data-bs-parent="#accordionFlushcurrent">
      <div class="accordion-body">
        <ul><li><a href="#introduction">Introduction</a></li>
<li><a href="#understanding-an-existing-python-diagnostic">Understanding an existing Python diagnostic</a></li>
<li><a href="#preprocessor-diagnostic-interface">Preprocessor-diagnostic interface</a></li>
<li><a href="#diagnostic-shared-functions">Diagnostic shared functions</a></li>
<li><a href="#diagnostic-computation">Diagnostic computation</a></li>
<li><a href="#diagnostic-output">Diagnostic output</a></li>
<li><a href="#congratulations">Congratulations!</a></li>
        </ul></div><!--/div.accordion-body-->
    </div><!--/div.accordion-collapse-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush11">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading11">
        <a href="09-cmorization.html">10. CMORization: adding new datasets to ESMValTool</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush12">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading12">
        <a href="10-debugging.html">11. Debugging</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

                </div>
              </div>
            </div>

            <hr class="half-width"><div class="accordion accordion-flush lesson-resources" id="accordionFlush12">
              <div class="accordion-item">
                <h2 class="accordion-header" id="flush-headingTwelve">
                  <button class="accordion-button collapsed" id="lesson-resources" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTwelve" aria-expanded="false" aria-controls="flush-collapseTwelve">
                    RESOURCES
                  </button>
                </h2>
                <div id="flush-collapseTwelve" class="accordion-collapse collapse" aria-labelledby="flush-headingTwelve" data-bs-parent="#accordionFlush12">
                  <div class="accordion-body">
                    <ul><li>
                        <a href="key-points.html">Key Points</a>
                      </li>
                      <li>
                        <a href="reference.html#glossary">Glossary</a>
                      </li>
                      <li>
                        <a href="profiles.html">Learner Profiles</a>
                      </li>
                      <li><a href="reference.html">Reference</a></li>
                    </ul></div>
                </div>
              </div>
            </div>
            <hr class="half-width lesson-resources"><a href="aio.html">See all in one page</a>


            <hr class="d-none d-sm-block d-md-none"><div class="d-grid gap-1">

            </div>
          </div><!-- /div.accordion -->
        </div><!-- /div.sidebar-inner -->
      </nav></div><!-- /div.sidebar -->
  </div><!-- /div.sidebar-col -->
<!-- END:   inst/pkgdown/templates/navbar.html-->

        <!-- START: inst/pkgdown/templates/content-instructor.html -->
  <div class="col-xl-8 col-lg-12 primary-content">
    <nav class="lesson-content mx-md-4" aria-label="Previous and Next Chapter"><!-- content for small screens --><div class="d-block d-sm-block d-md-none">
        <a class="chapter-link" href="07-development-setup.html"><i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>Previous</a>
        <a class="chapter-link float-end" href="09-cmorization.html">Next<i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i></a>
      </div>
      <!-- content for large screens -->
      <div class="d-none d-sm-none d-md-block">
        <a class="chapter-link" href="07-development-setup.html" rel="prev">
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>
          Previous: Development and
        </a>
        <a class="chapter-link float-end" href="09-cmorization.html" rel="next">
          Next: CMORization: adding...
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i>
        </a>
      </div>
      <hr></nav><main id="main-content" class="main-content"><div class="container lesson-content">
        <h1>Writing your own diagnostic script</h1>
        <p>Last updated on 2024-11-21 |

        <a href="https://github.com/ehogan/ESMValTool_Tutorial/edit/main/episodes/08-diagnostics.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>



        <div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>

        

<section><h2 class="section-heading" id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a></h2>
<hr class="half-width"><p>The diagnostic script is an important component of ESMValTool and it
is where the scientific analysis or performance metric is implemented.
With ESMValTool, you can adapt an existing diagnostic or write a new
script from scratch. Diagnostics can be written in a number of open
source languages such as Python, R, Julia and NCL but we will focus on
understanding and writing Python diagnostics in this lesson.</p>
<p>In this lesson, we will explain how to find an existing diagnostic
and run it using ESMValTool installed in editable/development mode. For
a development installation, see the instructions in the lesson <a href="%7B%7B%20page.root%20%7D%7D%7B%%20link%20_episodes/07-development-setup.md%20%%7D">Development
and contribution</a>. Also, we will work with the recipe
[recipe_python.yml][recipe] and the diagnostic script
[diagnostic.py][diagnostic] called by this recipe that we have seen in
the lesson <a href="%7B%7B%20page.root%20%7D%7D%7B%%20link%20_episodes/04-recipe.md%20%%7D">Running
your first recipe</a>.</p>
<p>Let’s get started!</p>
</section><section><h2 class="section-heading" id="understanding-an-existing-python-diagnostic">Understanding an existing Python diagnostic<a class="anchor" aria-label="anchor" href="#understanding-an-existing-python-diagnostic"></a></h2>
<hr class="half-width"><p>If you clone the ESMValTool repository, a folder called
<code>ESMValTool</code> is created in your home/working directory, see
the instructions in the lesson <a href="%7B%7B%20page.root%20%7D%7D%7B%%20link%20_episodes/07-development-setup.md%20%%7D">Development
and contribution</a>.</p>
<p>The folder <code>ESMValTool</code> contains the source code of the
tool. We can find the recipe <code>recipe_python.yml</code> and the
python script <code>diagnostic.py</code> in these directories:</p>
<ul><li><em>~/ESMValTool/esmvaltool/recipes/examples/recipe_python.yml</em></li>
<li><em>~/ESMValTool/esmvaltool/diag_scripts/examples/diagnostic.py</em></li>
</ul><p>Let’s have look at the code in <code>diagnostic.py</code>. For
reference, we show the diagnostic code in the dropdown box below. There
are four main sections in the script:</p>
<ul><li>A description i.e. the <code>docstring</code> (line 1).</li>
<li>Import statements (line 2-16).</li>
<li>Functions that implement our analysis (line 21-102).</li>
<li>A typical Python top-level script
i.e. <code>if __name__ == '__main__'</code> (line 105-108).</li>
</ul><blockquote>
<h2 id="diagnostic.py">diagnostic.py</h2>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a> <span class="dv">1</span>:  <span class="st">"""Python example diagnostic."""</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a> <span class="dv">2</span>:  <span class="im">import</span> logging</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a> <span class="dv">3</span>:  <span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a> <span class="dv">4</span>:  <span class="im">from</span> pprint <span class="im">import</span> pformat</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a> <span class="dv">5</span>:</span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a> <span class="dv">6</span>:  <span class="im">import</span> iris</span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a> <span class="dv">7</span>:</span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a> <span class="dv">8</span>:  <span class="im">from</span> esmvaltool.diag_scripts.shared <span class="im">import</span> (</span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a> <span class="dv">9</span>:      group_metadata,</span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a><span class="dv">10</span>:      run_diagnostic,</span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a><span class="dv">11</span>:      save_data,</span>
<span id="cb1-12"><a href="#cb1-12" tabindex="-1"></a><span class="dv">12</span>:      save_figure,</span>
<span id="cb1-13"><a href="#cb1-13" tabindex="-1"></a><span class="dv">13</span>:      select_metadata,</span>
<span id="cb1-14"><a href="#cb1-14" tabindex="-1"></a><span class="dv">14</span>:      sorted_metadata,</span>
<span id="cb1-15"><a href="#cb1-15" tabindex="-1"></a><span class="dv">15</span>:  )</span>
<span id="cb1-16"><a href="#cb1-16" tabindex="-1"></a><span class="dv">16</span>:  <span class="im">from</span> esmvaltool.diag_scripts.shared.plot <span class="im">import</span> quickplot</span>
<span id="cb1-17"><a href="#cb1-17" tabindex="-1"></a><span class="dv">17</span>:</span>
<span id="cb1-18"><a href="#cb1-18" tabindex="-1"></a><span class="dv">18</span>:  logger <span class="op">=</span> logging.getLogger(Path(<span class="va">__file__</span>).stem)</span>
<span id="cb1-19"><a href="#cb1-19" tabindex="-1"></a><span class="dv">19</span>:</span>
<span id="cb1-20"><a href="#cb1-20" tabindex="-1"></a><span class="dv">20</span>:</span>
<span id="cb1-21"><a href="#cb1-21" tabindex="-1"></a><span class="dv">21</span>:  <span class="kw">def</span> get_provenance_record(attributes, ancestor_files):</span>
<span id="cb1-22"><a href="#cb1-22" tabindex="-1"></a><span class="dv">22</span>:      <span class="st">"""Create a provenance record describing the diagnostic data and plot."""</span></span>
<span id="cb1-23"><a href="#cb1-23" tabindex="-1"></a><span class="dv">23</span>:      caption <span class="op">=</span> caption <span class="op">=</span> attributes[<span class="st">'caption'</span>].<span class="bu">format</span>(<span class="op">**</span>attributes)</span>
<span id="cb1-24"><a href="#cb1-24" tabindex="-1"></a><span class="dv">24</span>:</span>
<span id="cb1-25"><a href="#cb1-25" tabindex="-1"></a><span class="dv">25</span>:      record <span class="op">=</span> {</span>
<span id="cb1-26"><a href="#cb1-26" tabindex="-1"></a><span class="dv">26</span>:          <span class="st">'caption'</span>: caption,</span>
<span id="cb1-27"><a href="#cb1-27" tabindex="-1"></a><span class="dv">27</span>:          <span class="st">'statistics'</span>: [<span class="st">'mean'</span>],</span>
<span id="cb1-28"><a href="#cb1-28" tabindex="-1"></a><span class="dv">28</span>:          <span class="st">'domains'</span>: [<span class="st">'global'</span>],</span>
<span id="cb1-29"><a href="#cb1-29" tabindex="-1"></a><span class="dv">29</span>:          <span class="st">'plot_types'</span>: [<span class="st">'zonal'</span>],</span>
<span id="cb1-30"><a href="#cb1-30" tabindex="-1"></a><span class="dv">30</span>:          <span class="st">'authors'</span>: [</span>
<span id="cb1-31"><a href="#cb1-31" tabindex="-1"></a><span class="dv">31</span>:              <span class="st">'andela_bouwe'</span>,</span>
<span id="cb1-32"><a href="#cb1-32" tabindex="-1"></a><span class="dv">32</span>:              <span class="st">'righi_mattia'</span>,</span>
<span id="cb1-33"><a href="#cb1-33" tabindex="-1"></a><span class="dv">33</span>:          ],</span>
<span id="cb1-34"><a href="#cb1-34" tabindex="-1"></a><span class="dv">34</span>:          <span class="st">'references'</span>: [</span>
<span id="cb1-35"><a href="#cb1-35" tabindex="-1"></a><span class="dv">35</span>:              <span class="st">'acknow_project'</span>,</span>
<span id="cb1-36"><a href="#cb1-36" tabindex="-1"></a><span class="dv">36</span>:          ],</span>
<span id="cb1-37"><a href="#cb1-37" tabindex="-1"></a><span class="dv">37</span>:          <span class="st">'ancestors'</span>: ancestor_files,</span>
<span id="cb1-38"><a href="#cb1-38" tabindex="-1"></a><span class="dv">38</span>:      }</span>
<span id="cb1-39"><a href="#cb1-39" tabindex="-1"></a><span class="dv">39</span>:      <span class="cf">return</span> record</span>
<span id="cb1-40"><a href="#cb1-40" tabindex="-1"></a><span class="dv">40</span>:</span>
<span id="cb1-41"><a href="#cb1-41" tabindex="-1"></a><span class="dv">41</span>:</span>
<span id="cb1-42"><a href="#cb1-42" tabindex="-1"></a><span class="dv">42</span>:  <span class="kw">def</span> compute_diagnostic(filename):</span>
<span id="cb1-43"><a href="#cb1-43" tabindex="-1"></a><span class="dv">43</span>:      <span class="st">"""Compute an example diagnostic."""</span></span>
<span id="cb1-44"><a href="#cb1-44" tabindex="-1"></a><span class="dv">44</span>:      logger.debug(<span class="st">"Loading </span><span class="sc">%s</span><span class="st">"</span>, filename)</span>
<span id="cb1-45"><a href="#cb1-45" tabindex="-1"></a><span class="dv">45</span>:      cube <span class="op">=</span> iris.load_cube(filename)</span>
<span id="cb1-46"><a href="#cb1-46" tabindex="-1"></a><span class="dv">46</span>:</span>
<span id="cb1-47"><a href="#cb1-47" tabindex="-1"></a><span class="dv">47</span>:      logger.debug(<span class="st">"Running example computation"</span>)</span>
<span id="cb1-48"><a href="#cb1-48" tabindex="-1"></a><span class="dv">48</span>:      cube <span class="op">=</span> iris.util.squeeze(cube)</span>
<span id="cb1-49"><a href="#cb1-49" tabindex="-1"></a><span class="dv">49</span>:      <span class="cf">return</span> cube</span>
<span id="cb1-50"><a href="#cb1-50" tabindex="-1"></a><span class="dv">50</span>:</span>
<span id="cb1-51"><a href="#cb1-51" tabindex="-1"></a><span class="dv">51</span>:</span>
<span id="cb1-52"><a href="#cb1-52" tabindex="-1"></a><span class="dv">52</span>:  <span class="kw">def</span> plot_diagnostic(cube, basename, provenance_record, cfg):</span>
<span id="cb1-53"><a href="#cb1-53" tabindex="-1"></a><span class="dv">53</span>:      <span class="st">"""Create diagnostic data and plot it."""</span></span>
<span id="cb1-54"><a href="#cb1-54" tabindex="-1"></a><span class="dv">54</span>:</span>
<span id="cb1-55"><a href="#cb1-55" tabindex="-1"></a><span class="dv">55</span>:      <span class="co"># Save the data used for the plot</span></span>
<span id="cb1-56"><a href="#cb1-56" tabindex="-1"></a><span class="dv">56</span>:      save_data(basename, provenance_record, cfg, cube)</span>
<span id="cb1-57"><a href="#cb1-57" tabindex="-1"></a><span class="dv">57</span>:</span>
<span id="cb1-58"><a href="#cb1-58" tabindex="-1"></a><span class="dv">58</span>:      <span class="cf">if</span> cfg.get(<span class="st">'quickplot'</span>):</span>
<span id="cb1-59"><a href="#cb1-59" tabindex="-1"></a><span class="dv">59</span>:          <span class="co"># Create the plot</span></span>
<span id="cb1-60"><a href="#cb1-60" tabindex="-1"></a><span class="dv">60</span>:          quickplot(cube, <span class="op">**</span>cfg[<span class="st">'quickplot'</span>])</span>
<span id="cb1-61"><a href="#cb1-61" tabindex="-1"></a><span class="dv">61</span>:          <span class="co"># And save the plot</span></span>
<span id="cb1-62"><a href="#cb1-62" tabindex="-1"></a><span class="dv">62</span>:          save_figure(basename, provenance_record, cfg)</span>
<span id="cb1-63"><a href="#cb1-63" tabindex="-1"></a><span class="dv">63</span>:</span>
<span id="cb1-64"><a href="#cb1-64" tabindex="-1"></a><span class="dv">64</span>:</span>
<span id="cb1-65"><a href="#cb1-65" tabindex="-1"></a><span class="dv">65</span>:  <span class="kw">def</span> main(cfg):</span>
<span id="cb1-66"><a href="#cb1-66" tabindex="-1"></a><span class="dv">66</span>:      <span class="st">"""Compute the time average for each input dataset."""</span></span>
<span id="cb1-67"><a href="#cb1-67" tabindex="-1"></a><span class="dv">67</span>:      <span class="co"># Get a description of the preprocessed data that we will use as input.</span></span>
<span id="cb1-68"><a href="#cb1-68" tabindex="-1"></a><span class="dv">68</span>:      input_data <span class="op">=</span> cfg[<span class="st">'input_data'</span>].values()</span>
<span id="cb1-69"><a href="#cb1-69" tabindex="-1"></a><span class="dv">69</span>:</span>
<span id="cb1-70"><a href="#cb1-70" tabindex="-1"></a><span class="dv">70</span>:      <span class="co"># Demonstrate use of metadata access convenience functions.</span></span>
<span id="cb1-71"><a href="#cb1-71" tabindex="-1"></a><span class="dv">71</span>:      selection <span class="op">=</span> select_metadata(input_data, short_name<span class="op">=</span><span class="st">'tas'</span>, project<span class="op">=</span><span class="st">'CMIP5'</span>)</span>
<span id="cb1-72"><a href="#cb1-72" tabindex="-1"></a><span class="dv">72</span>:      logger.info(<span class="st">"Example of how to select only CMIP5 temperature data:</span><span class="ch">\n</span><span class="sc">%s</span><span class="st">"</span>,</span>
<span id="cb1-73"><a href="#cb1-73" tabindex="-1"></a><span class="dv">73</span>:                  pformat(selection))</span>
<span id="cb1-74"><a href="#cb1-74" tabindex="-1"></a><span class="dv">74</span>:</span>
<span id="cb1-75"><a href="#cb1-75" tabindex="-1"></a><span class="dv">75</span>:      selection <span class="op">=</span> sorted_metadata(selection, sort<span class="op">=</span><span class="st">'dataset'</span>)</span>
<span id="cb1-76"><a href="#cb1-76" tabindex="-1"></a><span class="dv">76</span>:      logger.info(<span class="st">"Example of how to sort this selection by dataset:</span><span class="ch">\n</span><span class="sc">%s</span><span class="st">"</span>,</span>
<span id="cb1-77"><a href="#cb1-77" tabindex="-1"></a><span class="dv">77</span>:                  pformat(selection))</span>
<span id="cb1-78"><a href="#cb1-78" tabindex="-1"></a><span class="dv">78</span>:</span>
<span id="cb1-79"><a href="#cb1-79" tabindex="-1"></a><span class="dv">79</span>:      grouped_input_data <span class="op">=</span> group_metadata(input_data,</span>
<span id="cb1-80"><a href="#cb1-80" tabindex="-1"></a><span class="dv">80</span>:                                          <span class="st">'variable_group'</span>,</span>
<span id="cb1-81"><a href="#cb1-81" tabindex="-1"></a><span class="dv">81</span>:                                          sort<span class="op">=</span><span class="st">'dataset'</span>)</span>
<span id="cb1-82"><a href="#cb1-82" tabindex="-1"></a><span class="dv">82</span>:      logger.info(</span>
<span id="cb1-83"><a href="#cb1-83" tabindex="-1"></a><span class="dv">83</span>:          <span class="st">"Example of how to group and sort input data by variable groups from "</span></span>
<span id="cb1-84"><a href="#cb1-84" tabindex="-1"></a><span class="dv">84</span>:          <span class="st">"the recipe:</span><span class="ch">\n</span><span class="sc">%s</span><span class="st">"</span>, pformat(grouped_input_data))</span>
<span id="cb1-85"><a href="#cb1-85" tabindex="-1"></a><span class="dv">85</span>:</span>
<span id="cb1-86"><a href="#cb1-86" tabindex="-1"></a><span class="dv">86</span>:      <span class="co"># Example of how to loop over variables/datasets in alphabetical order</span></span>
<span id="cb1-87"><a href="#cb1-87" tabindex="-1"></a><span class="dv">87</span>:      groups <span class="op">=</span> group_metadata(input_data, <span class="st">'variable_group'</span>, sort<span class="op">=</span><span class="st">'dataset'</span>)</span>
<span id="cb1-88"><a href="#cb1-88" tabindex="-1"></a><span class="dv">88</span>:      <span class="cf">for</span> group_name <span class="kw">in</span> groups:</span>
<span id="cb1-89"><a href="#cb1-89" tabindex="-1"></a><span class="dv">89</span>:          logger.info(<span class="st">"Processing variable </span><span class="sc">%s</span><span class="st">"</span>, group_name)</span>
<span id="cb1-90"><a href="#cb1-90" tabindex="-1"></a><span class="dv">90</span>:          <span class="cf">for</span> attributes <span class="kw">in</span> groups[group_name]:</span>
<span id="cb1-91"><a href="#cb1-91" tabindex="-1"></a><span class="dv">91</span>:              logger.info(<span class="st">"Processing dataset </span><span class="sc">%s</span><span class="st">"</span>, attributes[<span class="st">'dataset'</span>])</span>
<span id="cb1-92"><a href="#cb1-92" tabindex="-1"></a><span class="dv">92</span>:              input_file <span class="op">=</span> attributes[<span class="st">'filename'</span>]</span>
<span id="cb1-93"><a href="#cb1-93" tabindex="-1"></a><span class="dv">93</span>:              cube <span class="op">=</span> compute_diagnostic(input_file)</span>
<span id="cb1-94"><a href="#cb1-94" tabindex="-1"></a><span class="dv">94</span>:</span>
<span id="cb1-95"><a href="#cb1-95" tabindex="-1"></a><span class="dv">95</span>:              output_basename <span class="op">=</span> Path(input_file).stem</span>
<span id="cb1-96"><a href="#cb1-96" tabindex="-1"></a><span class="dv">96</span>:              <span class="cf">if</span> group_name <span class="op">!=</span> attributes[<span class="st">'short_name'</span>]:</span>
<span id="cb1-97"><a href="#cb1-97" tabindex="-1"></a><span class="dv">97</span>:                  output_basename <span class="op">=</span> group_name <span class="op">+</span> <span class="st">'_'</span> <span class="op">+</span> output_basename</span>
<span id="cb1-98"><a href="#cb1-98" tabindex="-1"></a><span class="dv">98</span>:              <span class="cf">if</span> <span class="st">"caption"</span> <span class="kw">not</span> <span class="kw">in</span> attributes:</span>
<span id="cb1-99"><a href="#cb1-99" tabindex="-1"></a><span class="dv">99</span>:                  attributes[<span class="st">'caption'</span>] <span class="op">=</span> input_file</span>
<span id="cb1-100"><a href="#cb1-100" tabindex="-1"></a><span class="dv">100</span>:              provenance_record <span class="op">=</span> get_provenance_record(</span>
<span id="cb1-101"><a href="#cb1-101" tabindex="-1"></a><span class="dv">101</span>:                  attributes, ancestor_files<span class="op">=</span>[input_file])</span>
<span id="cb1-102"><a href="#cb1-102" tabindex="-1"></a><span class="dv">102</span>:              plot_diagnostic(cube, output_basename, provenance_record, cfg)</span>
<span id="cb1-103"><a href="#cb1-103" tabindex="-1"></a><span class="dv">103</span>:</span>
<span id="cb1-104"><a href="#cb1-104" tabindex="-1"></a><span class="dv">104</span>:</span>
<span id="cb1-105"><a href="#cb1-105" tabindex="-1"></a><span class="dv">105</span>:  <span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">'__main__'</span>:</span>
<span id="cb1-106"><a href="#cb1-106" tabindex="-1"></a><span class="dv">106</span>:</span>
<span id="cb1-107"><a href="#cb1-107" tabindex="-1"></a><span class="dv">107</span>:      <span class="cf">with</span> run_diagnostic() <span class="im">as</span> config:</span>
<span id="cb1-108"><a href="#cb1-108" tabindex="-1"></a><span class="dv">108</span>:          main(config)</span></code></pre>
</div>
<p>{:.solution}</p>
</blockquote>
<blockquote>
<h2 id="what-is-the-starting-point-of-a-diagnostic">What is the starting
point of a diagnostic?</h2>
<ol style="list-style-type: decimal"><li>Can you spot a function called <code>main</code> in the code
above?</li>
<li>What are its input arguments?</li>
<li>How many times is this function mentioned?</li>
</ol><blockquote>
<h2 id="answer">Answer</h2>
<ol style="list-style-type: decimal"><li>The <code>main</code> function is defined in line 65 as
<code>main(cfg)</code>.</li>
<li>The input argument to this function is the variable
<code>cfg</code>, a Python dictionary that holds all the necessary
information needed to run the diagnostic script such as the location of
input data and various settings. We will next parse this
<code>cfg</code> variable in the <code>main</code> function and extract
information as needed to do our analyses (e.g. in line 68).</li>
<li>The <code>main</code> function is called near the very end on line
108. So, it is mentioned twice in our code - once where it is called by
the top-level Python script and second where it is defined. {:
.solution} {: .challenge}</li>
</ol></blockquote>
</blockquote>
<blockquote>
<h2 id="the-function-run_diagnostic">The function run_diagnostic</h2>
<p>The function <code>run_diagnostic</code> (line 107) is called a
context manager provided with ESMValTool and is the main entry point for
most Python diagnostics.</p>
<p>{: .callout}</p>
</blockquote>
</section><section><h2 class="section-heading" id="preprocessor-diagnostic-interface">Preprocessor-diagnostic interface<a class="anchor" aria-label="anchor" href="#preprocessor-diagnostic-interface"></a></h2>
<hr class="half-width"><p>In the previous exercise, we have seen that the variable
<code>cfg</code> is the input argument of the <code>main</code>
function. The first argument passed to the diagnostic via the
<code>cfg</code> dictionary is a path to a file called
<code>settings.yml</code>. The ESMValTool documentation page provides an
overview of what is in this file, see [Diagnostic script
interfaces][interface].</p>
<blockquote>
<h2 id="what-information-do-i-need-when-writing-a-diagnostic-script">What
information do I need when writing a diagnostic script?</h2>
<p>From the lesson <a href="%7B%7B%20page.root%20%7D%7D%7B%%20link%20_episodes/03-configuration.md%20%%7D">Configuration</a>,
we saw how to change the configuration settings before running a recipe.
First we set the option <code>remove_preproc_dir</code> to
<code>false</code> in the configuration file, then run the recipe
<code>recipe_python.yml</code>:</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="ex">esmvaltool</span> run examples/recipe_python.yml</span></code></pre>
</div>
<ol style="list-style-type: decimal"><li>Find one example of the file <code>settings.yml</code> in the
<code>run</code> directory?</li>
<li>Open the file <code>settings.yml</code> and look at the
<code>input_files</code> list. It contains paths to some files
<code>metadata.yml</code>. What information do you think is saved in
those files?</li>
</ol><blockquote>
<h2 id="answer-1">Answer</h2>
<ol style="list-style-type: decimal"><li>One example of <code>settings.yml</code> can be found in the
directory:
<em>path_to_recipe_output/run/map/script1/settings.yml</em>
</li>
<li>The <code>metadata.yml</code> files hold information about the
preprocessed data. There is one file for each variable having detailed
information on your data including project (e.g., CMIP6, CMIP5), dataset
names (e.g., BCC-ESM1, CanESM2), variable attributes (e.g.,
standard_name, units), preprocessor applied and time range of the data.
You can use all of this information in your own diagnostic.</li>
</ol><p>{: .solution} {: .challenge}</p>
</blockquote>
</blockquote>
</section><section><h2 class="section-heading" id="diagnostic-shared-functions">Diagnostic shared functions<a class="anchor" aria-label="anchor" href="#diagnostic-shared-functions"></a></h2>
<hr class="half-width"><p>Looking at the code in <code>diagnostic.py</code>, we see that
<code>input_data</code> is read from the <code>cfg</code> dictionary
(line 68). Now we can group the <code>input_data</code> according to
some criteria such as the model or experiment. To do so, ESMValTool
provides many functions such as <code>select_metadata</code> (line 71),
<code>sorted_metadata</code> (line 75), and <code>group_metadata</code>
(line 79). As you can see in line 8, these functions are imported from
<code>esmvaltool.diag_scripts.shared</code> that means these are shared
across several diagnostics scripts. A list of available functions and
their description can be found in [The ESMValTool Diagnostic API
reference][shared].</p>
<blockquote>
<h2 id="extracting-information-needed-for-analyses">Extracting
information needed for analyses</h2>
<p>We have seen the functions used for selecting, sorting and grouping
data in the script. What do these functions do?</p>
<blockquote>
<h2 id="answer-2">Answer</h2>
<p>There is a statement after use of <code>select_metadata</code>,
<code>sorted_metadata</code> and <code>group_metadata</code> that starts
with <code>logger.info</code> (lines 72, 76 and 82). These lines print
output to the log files. In the previous exercise, we ran the recipe
<code>recipe_python.yml</code>. If you look at the log file
<code>recipe_python_#_#/run/map/script1/log.txt</code> in
<code>esmvaltool_output</code> directory, you can see the output from
each of these functions, for example:</p>
<pre><code>2023-06-28 12:47:14,038 [2548510] INFO     diagnostic,106	Example of how to
group and sort input data by variable groups from the recipe:
{'tas': [{'alias': 'CMIP5',
         'caption': 'Global map of {long_name} in January 2000 according to '
                    '{dataset}.\n',
         'dataset': 'bcc-csm1-1',
         'diagnostic': 'map',
         'end_year': 2000,
         'ensemble': 'r1i1p1',
         'exp': 'historical',
         'filename': '~/recipe_python_20230628_124639/preproc/map/tas/
CMIP5_bcc-csm1-1_Amon_historical_r1i1p1_tas_2000-P1M.nc',
         'frequency': 'mon',
         'institute': ['BCC'],
         'long_name': 'Near-Surface Air Temperature',
         'mip': 'Amon',
         'modeling_realm': ['atmos'],
         'preprocessor': 'to_degrees_c',
         'product': ['output1', 'output2'],
         'project': 'CMIP5',
         'recipe_dataset_index': 1,
         'short_name': 'tas',
         'standard_name': 'air_temperature',
         'start_year': 2000,
         'timerange': '2000/P1M',
         'units': 'degrees_C',
         'variable_group': 'tas',
         'version': 'v1'},
        {'activity': 'CMIP',
         'alias': 'CMIP6',
         'caption': 'Global map of {long_name} in January 2000 according to '
                    '{dataset}.\n',
         'dataset': 'BCC-ESM1',
         'diagnostic': 'map',
         'end_year': 2000,
         'ensemble': 'r1i1p1f1',
         'exp': 'historical',
         'filename': '~/recipe_python_20230628_124639/preproc/map/tas/
CMIP6_BCC-ESM1_Amon_historical_r1i1p1f1_tas_gn_2000-P1M.nc',
         'frequency': 'mon',
         'grid': 'gn',
         'institute': ['BCC'],
         'long_name': 'Near-Surface Air Temperature',
         'mip': 'Amon',
         'modeling_realm': ['atmos'],
         'preprocessor': 'to_degrees_c',
         'project': 'CMIP6',
         'recipe_dataset_index': 0,
         'short_name': 'tas',
         'standard_name': 'air_temperature',
         'start_year': 2000,
         'timerange': '2000/P1M',
         'units': 'degrees_C',
         'variable_group': 'tas',
         'version': 'v20181214'}]}</code></pre>
<p>This is how we can access preprocessed data within our diagnostic. {:
.solution} {: .challenge}</p>
</blockquote>
</blockquote>
</section><section><h2 class="section-heading" id="diagnostic-computation">Diagnostic computation<a class="anchor" aria-label="anchor" href="#diagnostic-computation"></a></h2>
<hr class="half-width"><p>After grouping and selecting data, we can read individual attributes
(such as filename) of each item. Here, we have grouped the input data by
<code>variables</code>, so we loop over the variables (line 88).
Following this is a call to the function <code>compute_diagnostic</code>
(line 93). Let’s look at the definition of this function in line 42,
where the actual analysis of the data is done.</p>
<p>Note that output from the ESMValCore preprocessor is in the form of
NetCDF files. Here, <code>compute_diagnostic</code> uses <a href="https://scitools-iris.readthedocs.io/en/latest/index.html" class="external-link">Iris</a>
to read data from a netCDF file and performs an operation
<code>squeeze</code> to remove any dimensions of length one. We can
adapt this function to add our own analysis. As an example, here we
calculate the bias using the average of the data using Iris cubes.</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="kw">def</span> compute_diagnostic(filename):</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>    <span class="co">"""Compute an example diagnostic."""</span></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>    logger.debug(<span class="st">"Loading </span><span class="sc">%s</span><span class="st">"</span>, filename)</span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>    cube <span class="op">=</span> iris.load_cube(filename)</span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a>    logger.debug(<span class="st">"Running example computation"</span>)</span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a>    cube <span class="op">=</span> iris.util.squeeze(cube)</span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a>    <span class="co"># Calculate a bias using the average of data</span></span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a>    cube.data <span class="op">=</span> cube.core_data() <span class="op">-</span> cube.core_data.mean()</span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a>    <span class="cf">return</span> cube</span></code></pre>
</div>
<blockquote>
<h2 id="iris-cubes">iris cubes</h2>
<p>Iris reads data from NetCDF files into data structures called <a href="https://scitools-iris.readthedocs.io/en/latest/userguide/iris_cubes.html" class="external-link">cubes</a>.
The data in these cubes can be modified, combined with other cubes’ data
or plotted. {: .callout}</p>
</blockquote>
<blockquote>
<h2 id="reading-data-using-xarray">Reading data using xarray</h2>
<p>Alternately, you can use <a href="http://xarray.pydata.org/en/stable/" class="external-link">xarrays</a> to read the data
instead of Iris.</p>
<blockquote>
<h2 id="answer-3">Answer</h2>
<p>First, import <code>xarray</code> package at the top of the script
as:</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="im">import</span> xarray <span class="im">as</span> xr</span></code></pre>
</div>
<p>Then, change the <code>compute_diagnostic</code> as:</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="kw">def</span> compute_diagnostic(filename):</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>   <span class="co">"""Compute an example diagnostic."""</span></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>   logger.debug(<span class="st">"Loading </span><span class="sc">%s</span><span class="st">"</span>, filename)</span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>   dataset <span class="op">=</span> xr.open_dataset(filename)</span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a>   <span class="co">#do your analyses on the data here</span></span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a>   <span class="cf">return</span> dataset</span></code></pre>
</div>
<p>Caution: If you read data using xarray keep in mind to change
accordingly the other functions in the diagnostic which are dealing at
the moment with Iris cubes.</p>
<p>{: .solution} {: .challenge}</p>
</blockquote>
</blockquote>
<blockquote>
<h2 id="reading-data-using-the-netcdf4-package">Reading data using the
netCDF4 package</h2>
<p>Yet another option to read the NetCDF file data is to use the
[netCDF-4 Python interface][netCDF] to the netCDF C library.</p>
<blockquote>
<h2 id="answer-4">Answer</h2>
<p>First, import the <code>netCDF4</code> package at the top of the
script as:</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="im">import</span> netCDF4</span></code></pre>
</div>
<p>Then, change <code>compute_diagnostic</code> as:</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="kw">def</span> compute_diagnostic(filename):</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>   <span class="co">"""Compute an example diagnostic."""</span></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>   logger.debug(<span class="st">"Loading </span><span class="sc">%s</span><span class="st">"</span>, filename)</span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>   nc_data <span class="op">=</span> netCDF4.Dataset(filename,<span class="st">'r'</span>)</span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a>   <span class="co">#do your analyses on the data here</span></span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a>   <span class="cf">return</span> nc_data</span></code></pre>
</div>
<p>Caution: If you read data using netCDF4 keep in mind to change
accordingly the other functions in the diagnostic which are dealing at
the moment with Iris cubes.</p>
<p>{: .solution} {: .challenge}</p>
</blockquote>
</blockquote>
</section><section><h2 class="section-heading" id="diagnostic-output">Diagnostic output<a class="anchor" aria-label="anchor" href="#diagnostic-output"></a></h2>
<hr class="half-width"><div class="section level3">
<h3 id="plotting-the-output">Plotting the output<a class="anchor" aria-label="anchor" href="#plotting-the-output"></a></h3>
<p>Often, the end product of a diagnostic script is a plot or figure.
The Iris cube returned from the <code>compute_diagnostic</code> function
(line 93) is passed to the <code>plot_diagnostic</code> function (line
102). Let’s have a look at the definition of this function in line 52.
This is where we would plug in our plotting routine in the diagnostic
script.</p>
<p>More specifically, the <code>quickplot</code> function (line 60) can
be replaced with the function of our choice. As can be seen, this
function uses <code>**cfg['quickplot']</code> as an input argument. If
you look at the diagnostic section in the recipe
<code>recipe_python.yml</code>, you see <code>quickplot</code> is a key
there:</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">YAML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yaml" tabindex="0"><code class="sourceCode yaml"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="at">     </span><span class="fu">script1</span><span class="kw">:</span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a><span class="at">       </span><span class="fu">script</span><span class="kw">:</span><span class="at"> examples/diagnostic.py</span></span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a><span class="at">        </span><span class="fu">quickplot</span><span class="kw">:</span></span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a><span class="at">          </span><span class="fu">plot_type</span><span class="kw">:</span><span class="at"> pcolormesh</span></span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a><span class="at">          </span><span class="fu">cmap</span><span class="kw">:</span><span class="at"> Reds</span></span></code></pre>
</div>
<p>This way, we can pass arguments such as the type of plot
<code>pcolormesh</code> and the colormap <code>cmap:Reds</code> from the
recipe to the <code>quickplot</code> function in the diagnostic.</p>
<blockquote>
<h2 id="passing-arguments-from-the-recipe-to-the-diagnostic">Passing
arguments from the recipe to the diagnostic</h2>
<p>Change the type of the plot and its colormap and inspect the output
figure.</p>
<blockquote>
<h2 id="answer-5">Answer</h2>
<p>In the recipe <code>recipe_python.yml</code>, you could change
<code>plot_type</code> and <code>cmap</code>. As an example, we choose
<code>plot_type: pcolor</code> and <code>cmap: BuGn</code>:</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">YAML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yaml" tabindex="0"><code class="sourceCode yaml"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="at">    </span><span class="fu">script1</span><span class="kw">:</span></span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a><span class="at">      </span><span class="fu">script</span><span class="kw">:</span><span class="at"> examples/diagnostic.py</span></span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a><span class="at">       </span><span class="fu">quickplot</span><span class="kw">:</span></span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a><span class="at">         </span><span class="fu">plot_type</span><span class="kw">:</span><span class="at"> pcolor</span></span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a><span class="at">         </span><span class="fu">cmap</span><span class="kw">:</span><span class="at"> BuGn</span></span></code></pre>
</div>
<p>The plot can be found at
<em>path_to_recipe_output/plots/map/script1/png</em>. {: .solution} {:
.challenge}</p>
</blockquote>
</blockquote>
<blockquote>
<h2 id="esmvaltool-gallery">ESMValTool gallery</h2>
<p>ESMValTool makes it possible to produce a wide array of plots and
figures as seen in the <a href="https://docs.esmvaltool.org/en/latest/gallery.html" class="external-link">gallery</a>.
{: .callout}</p>
</blockquote>
</div>
<div class="section level3">
<h3 id="saving-the-output">Saving the output<a class="anchor" aria-label="anchor" href="#saving-the-output"></a></h3>
<p>In our example, the function <code>save_data</code> in line 56 is
used to save the Iris cube. The saved files can be found under the
<code>work</code> directory in a <code>.nc</code> format. There is also
the function <code>save_figure</code> in line 62 to save the plots under
the <code>plot</code> directory in a <code>.png</code> format (or
preferred format specified in your configuration settings). Again, you
may choose your own method of saving the output.</p>
</div>
<div class="section level3">
<h3 id="recording-the-provenance">Recording the provenance<a class="anchor" aria-label="anchor" href="#recording-the-provenance"></a></h3>
<p>When developing a diagnostic script, it is good practice to record
provenance. To do so, we use the function
<code>get_provenance_record</code> (line 100). Let us have a look at the
definition of this function in line 21 where we describe the diagnostic
data and plot. Using the dictionary <code>record</code>, it is possible
to add custom provenance to our diagnostics output. Provenance is stored
in the <em><a href="https://www.w3.org/TR/prov-xml/" class="external-link">W3C PROV
XML</a></em> format and also in an <em>SVG</em> file under the
<code>work</code> and <code>plot</code> directory. For more information,
see [recording provenance][provenance].</p>
</div>
</section><section><h2 class="section-heading" id="congratulations">Congratulations!<a class="anchor" aria-label="anchor" href="#congratulations"></a></h2>
<hr class="half-width"><p>You now know the basic diagnostic script structure and some available
tools for putting together your own diagnostics. Have a look at existing
recipes and diagnostics in the repository for more examples of functions
you can use in your diagnostics! {% include links.md %}</p>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</section></div> <!-- / div.lesson-content -->
    </main><!-- / main#main-content.main-content --><nav class="bottom-pagination mx-md-4" aria-label="Previous and Next Chapter"><div class="d-block d-sm-block d-md-none">
        <a class="chapter-link" href="07-development-setup.html"><i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>Previous</a>
        <a class="chapter-link float-end" href="09-cmorization.html">Next<i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i></a>
      </div>
      <!-- content for large screens -->
      <div class="d-none d-sm-none d-md-block">
        <a class="chapter-link" href="07-development-setup.html" rel="prev">
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>
          Previous: Development and
        </a>
        <a class="chapter-link float-end" href="09-cmorization.html" rel="next">
          Next: CMORization: adding...
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i>
        </a>
      </div>
    </nav></div> <!-- / div.primary-content.col-xs-12 -->
<!-- END:   inst/pkgdown/templates/content-instructor.html-->

      </div><!--/div.row-->
      		<footer class="row footer mx-md-3"><hr><div class="col-md-6">
        <p>This lesson is subject to the <a href="CODE_OF_CONDUCT.html">Code of Conduct</a></p>
        <p>

        <a href="https://github.com/ehogan/ESMValTool_Tutorial/edit/main/episodes/08-diagnostics.md" class="external-link">Edit on GitHub</a>

	
        | <a href="https://github.com/ehogan/ESMValTool_Tutorial/blob/main/CONTRIBUTING.md" class="external-link">Contributing</a>
        | <a href="https://github.com/ehogan/ESMValTool_Tutorial/" class="external-link">Source</a></p>
				<p><a href="https://github.com/ehogan/ESMValTool_Tutorial/blob/main/CITATION.cff" class="external-link">Cite</a> | <a href="mailto:team@carpentries.org">Contact</a> | <a href="https://carpentries.org/about/" class="external-link">About</a></p>
			</div>
			<div class="col-md-6">

        <p>Materials licensed under <a href="LICENSE.html">CC-BY 4.0</a> by the authors</p>

        <p>Template licensed under <a href="https://creativecommons.org/licenses/by-sa/4.0/" class="external-link">CC-BY 4.0</a> by <a href="https://carpentries.org/" class="external-link">The Carpentries</a></p>
        <p>Built with <a href="https://github.com/carpentries/sandpaper/tree/0.16.10" class="external-link">sandpaper (0.16.10)</a>, <a href="https://github.com/carpentries/pegboard/tree/0.7.7" class="external-link">pegboard (0.7.7)</a>, and <a href="https://github.com/carpentries/varnish/tree/1.0.5" class="external-link">varnish (1.0.5)</a></p>
			</div>
		</footer></div> <!-- / div.container -->
	<div id="to-top">
		<a href="#top">
      <i class="search-icon" data-feather="arrow-up" role="img" aria-label="Back To Top"></i><br><!-- <span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top --><span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top
		</a>
	</div>
  <script type="application/ld+json">
    {
  "@context": "https://schema.org",
  "@type": "TrainingMaterial",
  "@id": "https://ehogan.github.io/ESMValTool_Tutorial/08-diagnostics.html",
  "inLanguage": "en",
  "dct:conformsTo": "https://bioschemas.org/profiles/TrainingMaterial/1.0-RELEASE",
  "description": "A Carpentries Lesson teaching foundational data and coding skills to researchers worldwide",
  "keywords": "software, data, lesson, The Carpentries",
  "name": "Writing your own diagnostic script",
  "creativeWorkStatus": "active",
  "url": "https://ehogan.github.io/ESMValTool_Tutorial/08-diagnostics.html",
  "identifier": "https://ehogan.github.io/ESMValTool_Tutorial/08-diagnostics.html",
  "dateCreated": "2024-11-21",
  "dateModified": "2024-11-21",
  "datePublished": "2024-11-26"
}

  </script><script>
		feather.replace();
	</script></body></html><!-- END:   inst/pkgdown/templates/layout.html-->

