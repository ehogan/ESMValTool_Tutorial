<!DOCTYPE html>
<!-- START: inst/pkgdown/templates/layout.html --><!-- Generated by pkgdown: do not edit by hand --><html lang="en" data-bs-theme="auto"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><title>ESMValTool Tutorial: CMORization: adding new datasets to ESMValTool</title><meta name="viewport" content="width=device-width, initial-scale=1"><script src="../assets/themetoggle.js"></script><link rel="stylesheet" type="text/css" href="../assets/styles.css"><script src="../assets/scripts.js" type="text/javascript"></script><!-- mathjax --><script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      config: ["MMLorHTML.js"],
      jax: ["input/TeX","input/MathML","output/HTML-CSS","output/NativeMML", "output/PreviewHTML"],
      extensions: ["tex2jax.js","mml2jax.js","MathMenu.js","MathZoom.js", "fast-preview.js", "AssistiveMML.js", "a11y/accessibility-menu.js"],
      TeX: {
        extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"]
      },
      tex2jax: {
        inlineMath: [['\\(', '\\)']],
        displayMath: [ ['$$','$$'], ['\\[', '\\]'] ],
        processEscapes: true
      }
    });
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><!-- Responsive Favicon for The Carpentries --><link rel="apple-touch-icon" sizes="180x180" href="../favicons/incubator/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="../favicons/incubator/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="../favicons/incubator/favicon-16x16.png"><link rel="manifest" href="../favicons/incubator/site.webmanifest"><link rel="mask-icon" href="../favicons/incubator/safari-pinned-tab.svg" color="#5bbad5"><meta name="msapplication-TileColor" content="#da532c"><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="black"></head><body>
    <header id="top" class="navbar navbar-expand-md top-nav incubator"><svg xmlns="http://www.w3.org/2000/svg" class="d-none"><symbol id="check2" viewbox="0 0 16 16"><path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"></path></symbol><symbol id="circle-half" viewbox="0 0 16 16"><path d="M8 15A7 7 0 1 0 8 1v14zm0 1A8 8 0 1 1 8 0a8 8 0 0 1 0 16z"></path></symbol><symbol id="moon-stars-fill" viewbox="0 0 16 16"><path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"></path><path d="M10.794 3.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387a1.734 1.734 0 0 0-1.097 1.097l-.387 1.162a.217.217 0 0 1-.412 0l-.387-1.162A1.734 1.734 0 0 0 9.31 6.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387a1.734 1.734 0 0 0 1.097-1.097l.387-1.162zM13.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.156 1.156 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.156 1.156 0 0 0-.732-.732l-.774-.258a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"></path></symbol><symbol id="sun-fill" viewbox="0 0 16 16"><path d="M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"></path></symbol></svg><a class="visually-hidden-focusable skip-link" href="#main-content">Skip to main content</a>
  <div class="container-fluid top-nav-container">
    <div class="col-md-8">
      <div class="large-logo">
        <img id="incubator-logo" alt="Lesson Description" src="../assets/images/incubator-logo.svg"><span class="badge text-bg-danger">
          <abbr title="This lesson is in the pre-alpha phase, which means that it is in early development, but has not yet been taught.">
            <a href="https://cdh.carpentries.org/the-lesson-life-cycle.html#early-development-pre-alpha-through-alpha" class="external-link alert-link">
              <i aria-hidden="true" class="icon" data-feather="alert-octagon" style="border-radius: 5px"></i>
              Pre-Alpha
            </a>
            <span class="visually-hidden">This lesson is in the pre-alpha phase, which means that it is in early development, but has not yet been taught.</span>
          </abbr>
        </span>

      </div>
    </div>
    <div class="selector-container">
      <div id="theme-selector">
        <li class="nav-item dropdown" id="theme-button-list">
          <button class="btn btn-link nav-link px-0 px-lg-2 dropdown-toggle d-flex align-items-center" id="bd-theme" type="button" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme (auto)">
            <svg class="bi my-1 theme-icon-active"><use href="#circle-half"></use></svg><i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="bd-theme-text"><li>
              <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
                <svg class="bi me-2 theme-icon"><use href="#sun-fill"></use></svg>
                Light
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
            <li>
              <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                <svg class="bi me-2 theme-icon"><use href="#moon-stars-fill"></use></svg>
                Dark
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
            <li>
              <button type="button" class="btn dropdown-item d-flex align-items-center active" data-bs-theme-value="auto" aria-pressed="true">
                <svg class="bi me-2 theme-icon"><use href="#circle-half"></use></svg>
                Auto
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
          </ul></li>
      </div>

      <div class="dropdown" id="instructor-dropdown">
        <button class="btn btn-secondary dropdown-toggle bordered-button" type="button" id="dropdownMenu1" data-bs-toggle="dropdown" aria-expanded="false">
          <i aria-hidden="true" class="icon" data-feather="eye"></i> Instructor View <i data-feather="chevron-down"></i>
        </button>
        <ul class="dropdown-menu" aria-labelledby="dropdownMenu1"><li><button class="dropdown-item" type="button" onclick="window.location.href='../09-cmorization.html';">Learner View</button></li>
        </ul></div>
    </div>
  </div>
  <hr></header><nav class="navbar navbar-expand-xl bottom-nav incubator" aria-label="Main Navigation"><div class="container-fluid nav-container">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle Navigation">
      <span class="navbar-toggler-icon"></span>
      <span class="menu-title">Menu</span>
    </button>
    <div class="nav-logo">
      <img class="small-logo" alt="Lesson Description" src="../assets/images/incubator-logo-sm.svg"></div>
    <div class="lesson-title-md">
      ESMValTool Tutorial
    </div>
    <div class="search-icon-sm">
      <!-- TODO: do not show until we have search
        <i role="img" aria-label="Search the All In One page" data-feather="search"></i>
      -->
    </div>
    <div class="desktop-nav">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0"><li class="nav-item">
          <span class="lesson-title">
            ESMValTool Tutorial
          </span>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/key-points.html">Key Points</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/instructor-notes.html">Instructor Notes</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/images.html">Extract All Images</a>
        </li>
        <li class="nav-item dropdown">
          <button class="nav-link dropdown-toggle" id="navbarDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            More <i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdown"><hr><li><a class="dropdown-item" href="reference.html">Reference</a></li>
          </ul></li>
      </ul></div>
    <!--
    <form class="d-flex col-md-2 search-form">
      <fieldset disabled>
      <input class="form-control me-2 searchbox" type="search" placeholder="" aria-label="">
        <button class="btn btn-outline-success tablet-search-button"  type="submit">
          <i class="search-icon" data-feather="search" role="img" aria-label="Search the All In One page"></i>
        </button>
      </fieldset>
    </form>
    -->
    <a id="search-button" class="btn btn-primary" href="../instructor/aio.html" role="button" aria-label="Search the All In One page">Search the All In One page</a>
  </div><!--/div.container-fluid -->
</nav><div class="col-md-12 mobile-title">
  ESMValTool Tutorial
</div>

<aside class="col-md-12 lesson-progress"><div style="width: 69%" class="percentage">
    69%
  </div>
  <div class="progress incubator">
    <div class="progress-bar incubator" role="progressbar" style="width: 69%" aria-valuenow="69" aria-label="Lesson Progress" aria-valuemin="0" aria-valuemax="100">
    </div>
  </div>
</aside><div class="container">
      <div class="row">
        <!-- START: inst/pkgdown/templates/navbar.html -->
<div id="sidebar-col" class="col-lg-4">
  <div id="sidebar" class="sidebar">
      <nav aria-labelledby="flush-headingEleven"><button role="button" aria-label="close menu" alt="close menu" aria-expanded="true" aria-controls="sidebar" class="collapse-toggle" data-collapse="Collapse " data-episodes="Episodes ">
          <i class="search-icon" data-feather="x" role="img"></i>
        </button>
        <div class="sidebar-inner">
          <div class="row mobile-row" id="theme-row-mobile">
            <div class="col" id="theme-selector">
              <li class="nav-item dropdown" id="theme-button-list">
                <button class="btn btn-link nav-link px-0 px-lg-2 dropdown-toggle d-flex align-items-center" id="bd-theme" type="button" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme (auto)">
                  <svg class="bi my-1 theme-icon-active"><use href="#circle-half"></use></svg><span class="d-lg-none ms-1" id="bd-theme-text">Toggle Theme</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-right" aria-labelledby="bd-theme-text"><li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
                      <svg class="bi me-2 theme-icon"><use href="#sun-fill"></use></svg>
                      Light
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                  <li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                      <svg class="bi me-2 theme-icon"><use href="#moon-stars-fill"></use></svg>
                      Dark
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                  <li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center active" data-bs-theme-value="auto" aria-pressed="true">
                      <svg class="bi me-2 theme-icon"><use href="#circle-half"></use></svg>
                      Auto
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                </ul></li>
            </div>
          </div>
          <div class="row mobile-row">
            <div class="col">
              <div class="sidenav-view-selector">
                <div class="accordion accordion-flush" id="accordionFlush9">
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="flush-headingNine">
                      <button class="accordion-button collapsed" id="instructor" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseNine" aria-expanded="false" aria-controls="flush-collapseNine">
                        <i id="eye" aria-hidden="true" class="icon" data-feather="eye"></i> Instructor View
                      </button>
                    </h2>
                    <div id="flush-collapseNine" class="accordion-collapse collapse" aria-labelledby="flush-headingNine" data-bs-parent="#accordionFlush2">
                      <div class="accordion-body">
                        <a href="../09-cmorization.html">Learner View</a>
                      </div>
                    </div>
                  </div><!--/div.accordion-item-->
                </div><!--/div.accordion-flush-->
              </div><!--div.sidenav-view-selector -->
            </div><!--/div.col -->

            <hr></div><!--/div.mobile-row -->

          <div class="accordion accordion-flush" id="accordionFlush11">
            <div class="accordion-item">

              <button id="chapters" class="accordion-button show" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseEleven" aria-expanded="false" aria-controls="flush-collapseEleven">
                <h2 class="accordion-header chapters" id="flush-headingEleven">
                  EPISODES
                </h2>
              </button>
              <div id="flush-collapseEleven" class="accordion-collapse show collapse" aria-labelledby="flush-headingEleven" data-bs-parent="#accordionFlush11">

                <div class="accordion-body">
                  <div class="accordion accordion-flush" id="accordionFlush1">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading1">
        <a href="index.html">Summary and Schedule</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush2">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading2">
        <a href="00-introduction.html">1. Introduction</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush3">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading3">
        <a href="01-quickstart.html">2. Quickstart guide</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush4">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading4">
        <a href="02-installation.html">3. Installation</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush5">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading5">
        <a href="03-configuration.html">4. Configuration</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush6">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading6">
        <a href="04-recipe.html">5. Running your first recipe</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush7">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading7">
        <a href="05-conclusions.html">6. Conclusion of the basic tutorial</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush8">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading8">
        <a href="06-preprocessor.html">7. Writing your own recipe</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush9">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading9">
        <a href="07-development-setup.html">8. Development and contribution</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush10">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading10">
        <a href="08-diagnostics.html">9. Writing your own diagnostic script</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlushcurrent">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-headingcurrent">
      <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapsecurrent" aria-expanded="true" aria-controls="flush-collapsecurrent">
        <span class="visually-hidden">Current Chapter</span>
        <span class="current-chapter">
        10. CMORization: adding new datasets to ESMValTool
        </span>
      </button>
    </div><!--/div.accordion-header-->

    <div id="flush-collapsecurrent" class="accordion-collapse collapse show" aria-labelledby="flush-headingcurrent" data-bs-parent="#accordionFlushcurrent">
      <div class="accordion-body">
        <ul><li><a href="#introduction">Introduction</a></li>
<li><a href="#obtaining-the-data">Obtaining the data</a></li>
<li><a href="#run-the-existing-cmorizer-script">Run the existing CMORizer script</a></li>
<li><a href="#make-a-test-recipe">Make a test recipe</a></li>
<li><a href="#starting-from-scratch">Starting from scratch</a></li>
<li><a href="#create-a-new-cmorizer-script-and-a-corresponding-config-file">Create a new CMORizer script and a corresponding config file</a></li>
<li><a href="#some-final-comments">Some final comments</a></li>
        </ul></div><!--/div.accordion-body-->
    </div><!--/div.accordion-collapse-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush12">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading12">
        <a href="10-debugging.html">11. Debugging</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

                </div>
              </div>
            </div>

            <hr class="half-width"><div class="accordion accordion-flush lesson-resources" id="accordionFlush12">
              <div class="accordion-item">
                <h2 class="accordion-header" id="flush-headingTwelve">
                  <button class="accordion-button collapsed" id="lesson-resources" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTwelve" aria-expanded="false" aria-controls="flush-collapseTwelve">
                    RESOURCES
                  </button>
                </h2>
                <div id="flush-collapseTwelve" class="accordion-collapse collapse" aria-labelledby="flush-headingTwelve" data-bs-parent="#accordionFlush12">
                  <div class="accordion-body">
                    <ul><li>
                        <a href="../instructor/key-points.html">Key Points</a>
                      </li>
                      <li>
                        <a href="../instructor/instructor-notes.html">Instructor Notes</a>
                      </li>
                      <li>
                        <a href="../instructor/images.html">Extract All Images</a>
                      </li>
                      <hr><li><a class="dropdown-item" href="reference.html">Reference</a></li>
                    </ul></div>
                </div>
              </div>
            </div>
            <hr class="half-width lesson-resources"><a href="../instructor/aio.html">See all in one page</a>


            <hr class="d-none d-sm-block d-md-none"><div class="d-grid gap-1">

            </div>
          </div><!-- /div.accordion -->
        </div><!-- /div.sidebar-inner -->
      </nav></div><!-- /div.sidebar -->
  </div><!-- /div.sidebar-col -->
<!-- END:   inst/pkgdown/templates/navbar.html-->

        <!-- START: inst/pkgdown/templates/content-instructor.html -->
  <div class="col-xl-8 col-lg-12 primary-content">
    <nav class="lesson-content mx-md-4" aria-label="Previous and Next Chapter"><!-- content for small screens --><div class="d-block d-sm-block d-md-none">
        <a class="chapter-link" href="../instructor/08-diagnostics.html"><i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>Previous</a>
        <a class="chapter-link float-end" href="../instructor/10-debugging.html">Next<i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i></a>
      </div>
      <!-- content for large screens -->
      <div class="d-none d-sm-none d-md-block">
        <a class="chapter-link" href="../instructor/08-diagnostics.html" rel="prev">
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>
          Previous: Writing your own
        </a>
        <a class="chapter-link float-end" href="../instructor/10-debugging.html" rel="next">
          Next: Debugging...
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i>
        </a>
      </div>
      <hr></nav><main id="main-content" class="main-content"><div class="container lesson-content">
        <h1>CMORization: adding new datasets to ESMValTool</h1>
        <p>Last updated on 2024-11-21 |

        <a href="https://github.com/ehogan/ESMValTool_Tutorial/edit/main/episodes/09-cmorization.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>



        <p>Estimated time: <i aria-hidden="true" data-feather="clock"></i> 60 minutes</p>

        <div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>

        

<figure><img src="../fig/data_flow.png" alt="Data flow with ESMValTool" class="figure mx-auto d-block"><div class="figcaption">Data flow with ESMValTool</div>
</figure><section><h2 class="section-heading" id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a></h2>
<hr class="half-width"><p>This episode deals with “CMORization”. ESMValTool is designed to work
with data that follow the CMOR standards. Unfortunately, not all
datasets follow these standards. In order to use such datasets in
ESMValTool we first need to reformat the data. This process is called
“CMORization”.</p>
<blockquote>
<h2 id="what-are-the-cmor-standards">What are the CMOR standards?</h2>
<p>The name “CMOR” originates from a tool: <a href="https://cmor.llnl.gov/" class="external-link">the Climate Model Output Rewriter</a>.
This tool is used to create “CF-Compliant netCDF files for use in the
CMIP projects”. So CMOR extends the <a href="https://cfconventions.org/" class="external-link">CF-standard</a> with additional
requirements for the Coupled Model Intercomparison Projects (see e.g. <a href="https://pcmdi.llnl.gov/CMIP6/Guide/modelers.html#5-model-output-requirements" class="external-link">here</a>).</p>
<p>Concretely, the CMOR standards dictate e.g. the variable names and
units, coordinate information, how the data should be structured (e.g. 1
variable per file), additional metadata requirements, and file naming
conventions a.k.a. the data reference syntax (<a href="https://docs.esmvaltool.org/projects/esmvalcore/en/latest/quickstart/find_data.html" class="external-link">DRS</a>).
All this information is stored in so-called CMOR tables. For example,
the CMOR tables for the CMIP6 project can be found <a href="https://github.com/PCMDI/cmip6-cmor-tables" class="external-link">here</a>. {:
.callout}</p>
</blockquote>
<p>ESMValTool offers two ways to CMORize data: 1. A reformatting script
can be used to create a CMOR-compliant copy. CMORizer scripts for
several popular datasets are included in ESMValTool, and ESMValTool also
provides a convenient way to execute them. 2. ESMValCore can execute
CMOR fixes ‘<a href="https://docs.esmvaltool.org/projects/esmvalcore/en/latest/develop/%20fixing_data.html#fixing-data" class="external-link">on
the fly</a>’. The advantage is that you don’t need to store an
additional, reformatted copy of the data. The disadvantage is that these
fixes should be implemented inside ESMValCore, which is beyond the scope
of this tutorial.</p>
<p>In this lesson, we will re-implement a CMORizer script for the
FLUXCOM dataset that contains observations of the Gross Primary
Production (GPP), a variable that is important for calculating
components of the global carbon cycle. See the next section on how to
obtain data.</p>
<p>As in the previous episode (<a href="%7B%7B%20page.root%20%7D%7D%7B%%20link%20_episodes/07-development-setup.md%20%%7D">Development
and Contribution episode</a>), we will be using the development
installation of ESMValTool.</p>
</section><section><h2 class="section-heading" id="obtaining-the-data">Obtaining the data<a class="anchor" aria-label="anchor" href="#obtaining-the-data"></a></h2>
<hr class="half-width"><p>The data for this episode is available via the <a href="http://www.bgc-jena.mpg.de/geodb/BGI/Home" class="external-link">FluxCom Data
Portal</a>. First you’ll need to register. After registration, in the
dropdown boxes, select FLUXCOM as the data choice and click download.
Three files will be displayed. Click the download button on the “FLUXCOM
(RS+METEO) Global Land Carbon Fluxes using CRUNCEP climate data”. You’ll
receive an email with the FTP address to access the server. Connect to
the server, follow the path in your email, and look for the file
<code>raw/monthly/GPP.ANN.CRUNCEPv6.monthly.2000.nc</code>. Download
that file and save it in a folder called
<code>~/data/RAWOBS/Tier3/FLUXCOM</code>.</p>
<p>Note: you’ll need a user-friendly ftp client. On Linux,
<code>ncftp</code> works okay.</p>
<blockquote>
<h2 id="what-is-the-deal-with-those-tiers">What is the deal with those
“tiers”?</h2>
<p>Many datasets come with access restrictions. In this way the data
providers can keep track of how their data is used. In many cases
“restricted access” just means that one has to register with an email
address and accept the terms of use, which typically ask that you
acknowledge the data providers.</p>
<p>There are also datasets available that do not need a registration.
The “obs4MIPs” or “ana4MIPs” datasets, for example, are specifically
produced to facilitate comparisons with model simulations.</p>
<p>To reflect these different levels of access restriction, the
ESMValTool team has created a tier-system. The definition of the
different tiers are as follows:</p>
<ul><li>
<strong>Tier1</strong>: obs4MIPs and ana4MIPS datasets (can be used
directly with the ESMValTool)</li>
<li>
<strong>Tier2</strong>: other freely available datasets (most of
them will need some kind of cmorization)</li>
<li>
<strong>Tier3</strong>: datasets with access restrictions (most of
these datasets will also need some kind of cmorization)</li>
</ul><p>These access restrictions are also why the ESMValTool developers
cannot distribute copies or automate downloading of all observations and
reanalysis data used in the recipes. As a compromise, we provide the
CMORization scripts so that each user can CMORize their own copy of the
access restricted datasets if needed.</p>
<p>{: .callout}</p>
</blockquote>
</section><section><h2 class="section-heading" id="run-the-existing-cmorizer-script">Run the existing CMORizer script<a class="anchor" aria-label="anchor" href="#run-the-existing-cmorizer-script"></a></h2>
<hr class="half-width"><p>Before we develop our own CMORizer script, let’s first see what
happens when we run the existing one. There is a specific command
available in the ESMValTool to run the CMORizer scripts:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="ex">esmvaltool</span> data format <span class="at">--config_file</span> <span class="op">&lt;</span>path to config-user.yml<span class="op">&gt;</span>  <span class="op">&lt;</span>dataset-name<span class="op">&gt;</span></span></code></pre>
</div>
<p>The <code>config-user.yml</code> is the file in which we define the
different data paths, see the episode on <a href="%7B%7B%20page.root%20%7D%7D%7B%%20link%20_episodes/03-configuration.md%20%%7D">Configuration</a>.
In the <code>rootpath</code> of your <code>config-user.yml</code>, make
sure to add the right directory for “RAWOBS” data in which you
downloaded the FLUXCOM dataset:</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">YAML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yaml" tabindex="0"><code class="sourceCode yaml"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="fu">rootpath</span><span class="kw">:</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="at">  </span><span class="fu">RAWOBS</span><span class="kw">:</span><span class="at"> ~/data/RAWOBS</span></span></code></pre>
</div>
<p>This enables ESMValTool to find the raw observational datasets stored
in the “RAWOBS” folder. The <code>dataset-name</code> needs to be
identical to the folder name that was created to store the raw
observation data files, i.e. <code>RAWOBS/TierX/dataset-name</code>. In
our case this would be “FLUXCOM”.</p>
<p>If everything is okay, the output should look something like
this:</p>
<pre><code>...
... Starting the CMORization Tool at time: 2022-07-26 14:02:16 UTC
... ----------------------------------------------------------------------
... input_dir  = /home/peter/data/RAWOBS
... output_dir = /home/peter/esmvaltool_output/data_formatting_20220726_140216
... ----------------------------------------------------------------------
... Running the CMORization scripts.
... Processing datasets ['FLUXCOM']
... Input data from: /home/peter/data/RAWOBS/Tier3/FLUXCOM
... Output will be written to: /home/peter/esmvaltool_output/
      data_formatting_20220726_140216/Tier3/FLUXCOM
... Reformat script: /home/peter/mambaforge/envs/esmvaltool/lib/python3.9/
      site-packages/esmvaltool/cmorizers/data/formatters/datasets/fluxcom
... CMORizing dataset FLUXCOM using Python script /home/peter/mambaforge/envs/
      esmvaltool/lib/python3.9/site-packages/esmvaltool/cmorizers/data/formatters/
      datasets/fluxcom.py
... Found input file '/home/peter/data/RAWOBS/Tier3/FLUXCOM/GPP.ANN.CRUNCEPv6.monthly.*.nc'
... CMORizing variable 'gpp'
... Lmon
... Var is gpp
... ... UserWarning: Ignoring netCDF variable 'GPP' invalid units 'gC m-2 day-1'

... Fixing time...
... Fixing latitude...
... Fixing longitude...
... Flipping dimensional coordinate latitude...
... Saving file
... Saving: /home/peter/esmvaltool_output/data_formatting_20220726_140216/Tier3/
      FLUXCOM/OBS_FLUXCOM_reanaly_ANN-v1_Lmon_gpp_200001-200012.nc
... Cube has lazy data [lazy is preferred]
... CMORization of dataset FLUXCOM finished!
... Formatting successful for dataset FLUXCOM</code></pre>
<p>{: .output}</p>
<p>So you can see that several fixes are applied, and the CMORized file
is written to the ESMValTool output directory, i.e.
<code>~/esmvaltool_output/data_formatting_YYYYMMDD_HHMMSS/TierX/dataset-name/filename.nc</code>
In order to use it, we’ll have to copy it from the output directory to a
folder called <code>~/data/OBS/Tier3/FLUXCOM</code> and make sure the
path to <code>OBS</code> is set correctly in our config-user file:</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">YAML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yaml" tabindex="0"><code class="sourceCode yaml"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="fu">rootpath</span><span class="kw">:</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a><span class="at">  </span><span class="fu">OBS</span><span class="kw">:</span><span class="at"> ~/data/OBS</span></span></code></pre>
</div>
<p>You can also see the path where ESMValTool stores the reformatting
script:
<code>~/ESMValTool/esmvaltool/data/formatters/datasets/fluxcom.py</code>.
You may have a look at this file if you want. The script also uses a
configuration file:
<code>~/ESMValTool/esmvaltool/cmorizers/data/cmor_config/FLUXCOM.yml</code>.</p>
</section><section><h2 class="section-heading" id="make-a-test-recipe">Make a test recipe<a class="anchor" aria-label="anchor" href="#make-a-test-recipe"></a></h2>
<hr class="half-width"><p>To verify that the data is correctly CMORized, we will make a simple
test recipe. As illustrated in the figure at the top of this episode,
one of the steps that ESMValTool executes is a CMOR-check. If the data
is not correctly CMORized, ESMValTool will give a warning or error.</p>
<blockquote>
<h2 id="create-a-test-recipe">Create a test recipe</h2>
<p>Create a simple recipe called <a href="../files/recipe_check_fluxcom.yml">recipe_check_fluxcom.yml</a> that
loads the FLUXCOM data. It should include a datasets section with a
single entry for the “FLUXCOM” dataset with the correct dataset keys,
and a diagnostics section with two variables: gpp. We don’t need any
preprocessors or scripts (set <code>scripts: null</code>), but we have
to add a documentation section with a description, authors and
maintainer, otherwise the recipe will fail.</p>
<p>Use the following dataset keys:</p>
<ul><li>project: OBS</li>
<li>dataset: FLUXCOM</li>
<li>type: reanaly</li>
<li>version: ANN-v1</li>
<li>mip: Lmon</li>
<li>start_year: 2000</li>
<li>end_year: 2000</li>
<li>tier: 3</li>
</ul><p>Some of these dataset keys are further explained in the callout boxes
in this episode.</p>
<blockquote>
<h2 id="answer">Answer</h2>
<p>Here’s an example recipe</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">YAML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yaml" tabindex="0"><code class="sourceCode yaml"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="fu">documentation</span><span class="kw">:</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a><span class="at">  </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Test recipe for FLUXCOM data</span></span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a><span class="at">  </span><span class="fu">title</span><span class="kw">:</span><span class="at"> This is a test recipe for the FLUXCOM data.</span></span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a><span class="at">  </span><span class="fu">authors</span><span class="kw">:</span></span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> kalverla_peter</span></span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a><span class="at">  </span><span class="fu">maintainer</span><span class="kw">:</span></span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> kalverla_peter</span></span>
<span id="cb5-11"><a href="#cb5-11" tabindex="-1"></a></span>
<span id="cb5-12"><a href="#cb5-12" tabindex="-1"></a><span class="fu">datasets</span><span class="kw">:</span></span>
<span id="cb5-13"><a href="#cb5-13" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="kw">{</span><span class="fu">project</span><span class="kw">:</span><span class="at"> OBS</span><span class="kw">,</span><span class="at"> </span><span class="fu">dataset</span><span class="kw">:</span><span class="at"> FLUXCOM</span><span class="kw">,</span><span class="at"> </span><span class="fu">mip</span><span class="kw">:</span><span class="at"> Lmon</span><span class="kw">,</span><span class="at"> </span><span class="fu">tier</span><span class="kw">:</span><span class="at"> </span><span class="dv">3</span><span class="kw">,</span><span class="at"> </span><span class="fu">start_year</span><span class="kw">:</span><span class="at"> </span><span class="dv">2000</span><span class="kw">,</span><span class="at"> </span></span>
<span id="cb5-14"><a href="#cb5-14" tabindex="-1"></a><span class="at">     </span><span class="fu">end_year</span><span class="kw">:</span><span class="at"> </span><span class="dv">2000</span><span class="kw">,</span><span class="at"> </span><span class="fu">type</span><span class="kw">:</span><span class="at"> reanaly</span><span class="kw">,</span><span class="at"> </span><span class="fu">version</span><span class="kw">:</span><span class="at"> ANN-v1</span><span class="kw">}</span></span>
<span id="cb5-15"><a href="#cb5-15" tabindex="-1"></a></span>
<span id="cb5-16"><a href="#cb5-16" tabindex="-1"></a><span class="fu">diagnostics</span><span class="kw">:</span></span>
<span id="cb5-17"><a href="#cb5-17" tabindex="-1"></a><span class="at">  </span><span class="fu">check_fluxcom</span><span class="kw">:</span></span>
<span id="cb5-18"><a href="#cb5-18" tabindex="-1"></a><span class="at">    </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Check that ESMValTool can load the cmorized fluxnet data without errors.</span></span>
<span id="cb5-19"><a href="#cb5-19" tabindex="-1"></a><span class="at">    </span><span class="fu">variables</span><span class="kw">:</span></span>
<span id="cb5-20"><a href="#cb5-20" tabindex="-1"></a><span class="at">      </span><span class="fu">gpp</span><span class="kw">:</span></span>
<span id="cb5-21"><a href="#cb5-21" tabindex="-1"></a><span class="at">    </span><span class="fu">scripts</span><span class="kw">:</span><span class="at"> </span><span class="ch">null</span></span></code></pre>
</div>
<p>To learn more about writing a recipe, please refer to <a href="%7B%7B%20page.root%20%7D%7D%7B%%20link%20_episodes/06-preprocessor.md%20%%7D">Writing
your own recipe</a>.</p>
<p>{: .solution} {: .challenge}</p>
</blockquote>
</blockquote>
<p>Try to run the example recipe with</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="ex">esmvaltool</span> run recipe_check_fluxcom.yml <span class="at">--config_file</span> <span class="op">&lt;</span>path to config-user.yml<span class="op">&gt;</span> --log_level debug</span></code></pre>
</div>
<p>If everything is okay, the recipe should run without problems.</p>
</section><section><h2 class="section-heading" id="starting-from-scratch">Starting from scratch<a class="anchor" aria-label="anchor" href="#starting-from-scratch"></a></h2>
<hr class="half-width"><p>Now that you’ve seen how to use an existing CMORizer script, let’s
think about adding a new one. We will remove the existing CMORizer
script, and re-implement it from scratch. This exercise allows us to
point out all the details of what’s going on. We’ll also remove the
CMORized data that we’ve just created, so our test recipe will not be
able to use it anymore.</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="fu">rm</span> ~/data/OBS/Tier3/FLUXCOM/OBS_FLUXCOM_reanaly_ANN-v1_Lmon_gpp_200001-200012.nc</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a><span class="fu">rm</span> ~/ESMValTool/esmvaltool/cmorizers/data/formatters/datasets/fluxcom.py</span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a><span class="fu">rm</span> ~/ESMValTool/esmvaltool/cmorizers/data/cmor_config/FLUXCOM.yml</span></code></pre>
</div>
<p>If you now run the test recipe again it should fail, and somewhere in
the output you should find something like:</p>
<pre><code>No input files found for ...
Looked for files matching: /home/peter/data/OBS/Tier3/
      FLUXCOM/OBS_FLUXCOM_reanaly_ANN-v1_Lmon_gpp[_.]*nc</code></pre>
<p>{: .error}</p>
<p>From this we can see that the first thing our CMORizer should do is
to rename the file so that it follows the CMOR filename conventions.</p>
</section><section><h2 class="section-heading" id="create-a-new-cmorizer-script-and-a-corresponding-config-file">Create a new CMORizer script and a corresponding config file<a class="anchor" aria-label="anchor" href="#create-a-new-cmorizer-script-and-a-corresponding-config-file"></a></h2>
<hr class="half-width"><p>The first step now is to create a new file in the right folder that
will contain our new CMORizer instructions. Create a file called
<code>fluxcom.py</code></p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="fu">nano</span> ~/ESMValTool/esmvaltool/cmorizers/data/formatters/datasets/fluxcom.py</span></code></pre>
</div>
<p>and fill it with the following boilerplate code:</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="co">"""ESMValTool CMORizer for FLUXCOM GPP data.</span></span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a><span class="co">&lt;We will add some useful info here later&gt;</span></span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a><span class="im">import</span> logging</span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a><span class="im">from</span> esmvaltool.cmorizers.data <span class="im">import</span> utilities <span class="im">as</span> utils</span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a></span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a>logger <span class="op">=</span> logging.getLogger(<span class="va">__name__</span>)</span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a></span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a><span class="kw">def</span> cmorization(in_dir, out_dir, cfg, cfg_user, start_date, end_date):</span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a>    <span class="co">"""Cmorize the dataset."""</span></span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a></span>
<span id="cb10-13"><a href="#cb10-13" tabindex="-1"></a>    <span class="co"># This is where you'll add the cmorization code</span></span>
<span id="cb10-14"><a href="#cb10-14" tabindex="-1"></a>    <span class="co"># 1. find the input data</span></span>
<span id="cb10-15"><a href="#cb10-15" tabindex="-1"></a>    <span class="co"># 2. apply the necessary fixes</span></span>
<span id="cb10-16"><a href="#cb10-16" tabindex="-1"></a>    <span class="co"># 3. store the data with the correct filename</span></span></code></pre>
</div>
<p>Here, <code>in_dir</code> corresponds to the input directory of the
raw files, <code>out_dir</code> to the output directory of final
reformatted data set and <code>cfg</code> to a configuration dictionary
given by a configuration file that we will get to shortly. The last
three arguments will not be considered in this script but can be used in
other cases. <code>cfg_user</code> corresponds to the user configuration
file, <code>start_date</code> to the start of the period to format, and
<code>end_date</code> to the end of the period to format. When you type
the command <code>esmvaltool data format</code> in the terminal,
ESMValTool will call this function with the settings found in your
configuration files.</p>
<p>The ESMValTool CMORizer also needs a dataset configuration file.
Create a file called
<code>~/ESMValTool/esmvaltool/cmorizers/data/cmor_config/FLUXCOM.yml</code>
and fill it with the following boilerplate:</p>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">YAML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yaml" tabindex="0"><code class="sourceCode yaml"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="pp">---</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a><span class="co"># filename: ???</span></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a><span class="fu">attributes</span><span class="kw">:</span></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a><span class="at">  </span><span class="fu">project_id</span><span class="kw">:</span><span class="at"> OBS6</span></span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a><span class="co">#   dataset_id: ???</span></span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a><span class="co">#   version: ???</span></span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a><span class="co">#   tier: ???</span></span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a><span class="co">#   modeling_realm: ???</span></span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a><span class="co">#   source: ???</span></span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a><span class="co">#   reference: ???</span></span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a><span class="co">#   comment: ???</span></span>
<span id="cb11-13"><a href="#cb11-13" tabindex="-1"></a></span>
<span id="cb11-14"><a href="#cb11-14" tabindex="-1"></a><span class="co"># variables:</span></span>
<span id="cb11-15"><a href="#cb11-15" tabindex="-1"></a><span class="co">#   ???:</span></span>
<span id="cb11-16"><a href="#cb11-16" tabindex="-1"></a><span class="co">#     mip: ???</span></span></code></pre>
</div>
<p><strong>Note</strong>: the name of this file <em>must</em> be
identical to <code>dataset-name</code>.</p>
<p>As you can see, the configuration file contains information about the
original filename of the dataset, and some additional metadata that you
might recognize from the CMOR filename structure. It also contains a
list of variables that’s available for this dataset. We’ll add this
information step by step in the following sections.</p>
<blockquote>
<h2 id="rawobs-obs-obs6">RAWOBS, OBS, OBS6!?</h2>
<p>In the configuration above we’ve already filled in the
<code>project_id</code>. ESMValTool uses these project IDs to find the
data on your hard drive, and also to find more information about the
data. The <code>RAWOBS</code> and <code>OBS</code> projects refer to
<em>external</em> data before and after CMORization, respectively.
Historically, most external data were observations, hence the
naming.</p>
<p>In going from CMIP5 to CMIP6, the CMOR standards changed a bit. For
example, some variables were renamed, which posed a dilemma: should
CMORization reformat to the CMIP5 or CMIP6 definition? To solve this,
the <code>OBS6</code> project was created. So <code>OBS6</code> data
follow the CMIP6 standards, and that’s what we’ll use for the new
CMORizer.</p>
<p>{: .callout}</p>
</blockquote>
<p>You can try running the CMORizer at this point, and it should work
without errors. However, it doesn’t produce any output yet:</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="ex">esmvaltool</span> data format <span class="at">--config_file</span> <span class="op">&lt;</span>path to config-user.yml<span class="op">&gt;</span> FLUXCOM</span></code></pre>
</div>
<div class="section level3">
<h3 id="find-the-input-data">1. Find the input data<a class="anchor" aria-label="anchor" href="#find-the-input-data"></a></h3>
<p>First we’ll get the CMORizer script to locate our FLUXCOM data. We
can use the information from the <code>in_dir</code> and
<code>cfg</code> variables. Add the following snippet to your CMORizer
script:</p>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="co"># 1. find the input data</span></span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>logger.info(<span class="st">"in_dir: '</span><span class="sc">%s</span><span class="st">'"</span>, in_dir)</span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a>logger.info(<span class="st">"cfg: '</span><span class="sc">%s</span><span class="st">'"</span>, cfg)</span></code></pre>
</div>
<p>If you run the CMORizer again, it will print out the content of these
variables and the output should contain something like this:</p>
<pre><code>... in_dir: '/home/peter/data/RAWOBS/Tier3/FLUXCOM'
... cfg: '{'attributes': {'project_id': 'OBS6', 'comment': ''},
    'cmor_table': &lt;esmvalcore.cmor.table.CMIP6Info object at 0x7fbd0a0f6bf0&gt;}'</code></pre>
<p>{: .output}</p>
<blockquote>
<h2 id="load-the-data">Load the data</h2>
<p>Try to locate the input data inside the CMORizer script and load it
(we’ll use <code>iris</code> because ESMValTool includes helper
utilities for iris cubes). Confirm that you’ve loaded the data by
logging the correct path and (part of the) file content.</p>
<blockquote>
<h2 id="solution">Solution</h2>
<p>There are many ways to do it. In any case, you should have added the
original filename to the configuration file (and un-commented this
line): <code>filename: 'GPP.ANN.CRUNCEPv6.monthly.*.nc'</code>. Note the
<code>*</code>: this is a useful shorthand to find multiple files for
different years. In a similar way we can also look for multiple
variables, etc.</p>
<p>Here’s an example solution (inserted directly under the original
comment):</p>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="co"># 1. find the input data</span></span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a>filename_pattern <span class="op">=</span> cfg[<span class="st">'filename'</span>]</span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a>matches <span class="op">=</span> Path(in_dir).glob(filename_pattern)</span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a></span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a><span class="cf">for</span> match <span class="kw">in</span> matches:</span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a>    input_file <span class="op">=</span> <span class="bu">str</span>(match)</span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a>    logger.info(<span class="st">"found: </span><span class="sc">%s</span><span class="st">"</span>, input_file)</span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a>    cube <span class="op">=</span> iris.load_cube(input_file)</span>
<span id="cb15-9"><a href="#cb15-9" tabindex="-1"></a>    logger.info(<span class="st">"content: </span><span class="sc">%s</span><span class="st">"</span>, cube)</span></code></pre>
</div>
<p>To make this work we’ve added <code>import iris</code> and
<code>from pathlib import Path</code> at the top of the file. Note that
we’ve started a loop, since we may find multiple files if there’s more
than one year of data available.</p>
<p>{: .solution} {: .challenge}</p>
</blockquote>
</blockquote>
</div>
<div class="section level3">
<h3 id="save-the-data-with-the-correct-filename">2. Save the data with the correct filename<a class="anchor" aria-label="anchor" href="#save-the-data-with-the-correct-filename"></a></h3>
<p>Before we start adding fixes, we’ll first make sure that our CMORizer
can also write output files with the correct name. This will enable us
to use the test recipe for the CMOR compatibility check.</p>
<p>We can use the <code>save</code> function from the <code>utils</code>
that we imported at the top. The call signature looks like this:
<code>utils.save_variables(cube, var, outdir, attrs, **kwargs)</code>.</p>
<p>We already have the <code>cube</code> and the <code>outdir</code>.
The variable short name (<code>var</code>) and attributes
(<code>attrs</code>) are set through the configuration file. So we need
to find out what the correct short name and attributes are.</p>
<p>The standard attributes for CMIP variables are defined in the <a href="https://github.com/ESMValGroup/ESMValCore/tree/main/esmvalcore/cmor/tables/cmip6/Tables" class="external-link">CMIP
tables</a>. These tables are differentiated according to the “MIP” they
belong to. The tables are a copy of the <a href="https://github.com/PCMDI" class="external-link">PCMDI</a> guidelines.</p>
<blockquote>
<h2 id="find-the-variable-gpp-in-a-cmor-table">Find the variable “gpp”
in a CMOR table</h2>
<p>Check the available CMOR tables to find the variable “gpp” with the
following characteristics: - standard_name:
<code>gross_primary_productivity_of_biomass_expressed_as_carbon</code> -
frequency: <code>mon</code> - modeling_realm: <code>land</code></p>
<blockquote>
<h2 id="answers">Answers</h2>
<p>The variable “gpp” belongs to the land variables. The temporal
resolution that we are looking for is “monthly”. This information points
to the “Lmon” CMIP table. And indeed, the variable “gpp” can be found in
the file <a href="https://github.com/ESMValGroup/ESMValCore/blob/main/esmvalcore/%20cmor/tables/cmip6/Tables/CMIP6_Lmon.json" class="external-link">here</a>.</p>
<p>{: .solution} {: .challenge}</p>
</blockquote>
</blockquote>
<p>If the variable you are interested in is not available in the
standard CMOR tables, you could write a custom CMOR table entry for the
variable. This, however, is beyond the scope of this tutorial.</p>
<blockquote>
<h2 id="fill-the-configuration-file">Fill the configuration file</h2>
<p>Uncomment the following entries in your configuration file and fill
them with appropriate values:</p>
<ul><li>dataset_id</li>
<li>version</li>
<li>tier</li>
<li>modeling_realm</li>
<li>short_name (the ??? immediately under <code>variables</code>)</li>
<li>mip</li>
</ul><blockquote>
<h2 id="answers-1">Answers</h2>
<p>The configuration file now look something like this:</p>
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">YAML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yaml" tabindex="0"><code class="sourceCode yaml"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="pp">---</span></span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a><span class="fu">filename</span><span class="kw">:</span><span class="at"> </span><span class="st">'GPP.ANN.CRUNCEPv6.monthly.*.nc'</span></span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a><span class="fu">attributes</span><span class="kw">:</span></span>
<span id="cb16-5"><a href="#cb16-5" tabindex="-1"></a><span class="at">  </span><span class="fu">project_id</span><span class="kw">:</span><span class="at"> OBS6</span></span>
<span id="cb16-6"><a href="#cb16-6" tabindex="-1"></a><span class="at">  </span><span class="fu">dataset_id</span><span class="kw">:</span><span class="at"> FLUXCOM</span></span>
<span id="cb16-7"><a href="#cb16-7" tabindex="-1"></a><span class="at">  </span><span class="fu">version</span><span class="kw">:</span><span class="at"> </span><span class="st">'ANN-v1'</span></span>
<span id="cb16-8"><a href="#cb16-8" tabindex="-1"></a><span class="at">  </span><span class="fu">tier</span><span class="kw">:</span><span class="at"> </span><span class="dv">3</span></span>
<span id="cb16-9"><a href="#cb16-9" tabindex="-1"></a><span class="at">  </span><span class="fu">modeling_realm</span><span class="kw">:</span><span class="at"> reanaly</span></span>
<span id="cb16-10"><a href="#cb16-10" tabindex="-1"></a><span class="at">  </span><span class="fu">source</span><span class="kw">:</span><span class="at"> </span><span class="st">''</span></span>
<span id="cb16-11"><a href="#cb16-11" tabindex="-1"></a><span class="at">  </span><span class="fu">reference</span><span class="kw">:</span><span class="at"> </span><span class="st">''</span></span>
<span id="cb16-12"><a href="#cb16-12" tabindex="-1"></a><span class="at">  </span><span class="fu">comment</span><span class="kw">:</span><span class="at"> </span><span class="st">''</span></span>
<span id="cb16-13"><a href="#cb16-13" tabindex="-1"></a></span>
<span id="cb16-14"><a href="#cb16-14" tabindex="-1"></a><span class="fu">variables</span><span class="kw">:</span></span>
<span id="cb16-15"><a href="#cb16-15" tabindex="-1"></a><span class="at">  </span><span class="fu">gpp</span><span class="kw">:</span></span>
<span id="cb16-16"><a href="#cb16-16" tabindex="-1"></a><span class="at">    </span><span class="fu">mip</span><span class="kw">:</span><span class="at"> Lmon</span></span></code></pre>
</div>
<p>{: .solution} {: .challenge}</p>
</blockquote>
</blockquote>
<p>Now that we have set this information correctly in the config file,
we can call the save function. Add the following python code to your
CMORizer script:</p>
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="co"># 3. store the data with the correct filename</span></span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a>attributes <span class="op">=</span> cfg[<span class="st">'attributes'</span>]</span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a>variables <span class="op">=</span> cfg[<span class="st">'variables'</span>]</span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a><span class="cf">for</span> short_name, variable_info <span class="kw">in</span> variables.items():</span>
<span id="cb17-6"><a href="#cb17-6" tabindex="-1"></a>    all_attributes <span class="op">=</span> {<span class="op">**</span>attributes, <span class="op">**</span>variable_info}  <span class="co"># add the mip to the other attributes</span></span>
<span id="cb17-7"><a href="#cb17-7" tabindex="-1"></a>    utils.save_variable(cube<span class="op">=</span>cube, var<span class="op">=</span>short_name, outdir<span class="op">=</span>out_dir, attrs<span class="op">=</span>all_attributes)</span></code></pre>
</div>
<p>Since we only have one variable (gpp), the loop is not strictly
necessary. However, this makes it possible to add more variables later
on.</p>
<blockquote>
<h2 id="was-the-cmorization-successful-so-far">Was the CMORization
successful so far?</h2>
<p>If you run the CMORizer again, you should see that it creates an
output file named
<code>OBS6_FLUXCOM_reanaly_ANN-v1_Lmon_gpp_xxxx01-xxxx12.nc</code>
stored in your ESMValTool output directory
<code>~/esmvaltool_output/data_formatting_YYYYMMDD_HHMMSS/Tier3/FLUXCOM/</code>.
The “xxxx” and “yyyy” represent the start and end year of the data.</p>
<p>{: .callout}</p>
</blockquote>
<p>Great! So we have produced a NetCDF file with the CMORizer that
follows the naming convention for ESMValTool datasets. Let’s have a look
at the NetCDF file as it was written with the very basic CMORizer from
above.</p>
<div class="codewrapper sourceCode" id="cb18">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a><span class="ex">ncdump</span> <span class="at">-h</span> OBS6_FLUXCOM_reanaly_ANN-v1_Lmon_gpp_200001-200012.nc</span></code></pre>
</div>
<pre><code>netcdf OBS6_FLUXCOM_reanaly_ANN-v1_Lmon_gpp_200001-200012 {
dimensions:
        time = 12 ;
        lat = 360 ;
        lon = 720 ;
variables:
        float GPP(time, lat, lon) ;
                GPP:_FillValue = 1.e+20f ;
                GPP:long_name = "GPP" ;
        double time(time) ;
                time:axis = "T" ;
                time:units = "days since 1582-10-15 00:00:00" ;
                time:standard_name = "time" ;
                time:calendar = "gregorian" ;
        double lat(lat) ;
        double lon(lon) ;

// global attributes:
                :_NCProperties = "version=2,netcdf=4.7.4,hdf5=1.10.6" ;
                :created_by = "Fabian Gans [fgans@bgc-jena.mpg.de], Ulrich Weber
		  [uweber@bgc-jena.mpg.de]" ;
                :flux = "GPP" ;
                :forcing = "CRUNCEPv6" ;
                :institution = "MPI-BGC-BGI" ;
                :invalid_units = "gC m-2 day-1" ;
                :method = "Artificial Neural Networks" ;
                :provided_by = "Martin Jung [mjung@bgc-jena.mpg.de] on behalf of FLUXCOM team" ;
                :reference = "Jung et al. 2016, Nature; Tramontana et al. 2016, Biogeosciences" ;
                :temporal_resolution = "monthly" ;
                :title = "GPP based on FLUXCOM RS+METEO with CRUNCEPv6 climate " ;
                :version = "v1" ;
                :Conventions = "CF-1.7" ;
}</code></pre>
<p>{: .output}</p>
<p>The file contains a variable named “GPP” that contains three
dimensions: “time”, “lat”, “lon”. Notice the strange time units, and the
<code>invalid_units</code> in the global attributes section. Also it
seems that there is not information available about the lat and lon
coordinates. These are just some of the things we’ll address in the next
section.</p>
</div>
<div class="section level3">
<h3 id="implementing-additional-fixes">3. Implementing additional fixes<a class="anchor" aria-label="anchor" href="#implementing-additional-fixes"></a></h3>
<p>Copy the output of the CMORizer to your folder
<code>~/data/OBS6/Tier3/FLUXCOM/</code> and change the test recipe to
look for OBS6 data instead of OBS (note: we’re upgrading the CMORizer to
newer standards here!). Make sure the path to <code>OBS6</code> is set
correctly in our config-user file:</p>
<div class="codewrapper sourceCode" id="cb20">
<h3 class="code-label">YAML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yaml" tabindex="0"><code class="sourceCode yaml"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a><span class="fu">rootpath</span><span class="kw">:</span></span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a><span class="at">  </span><span class="fu">OBS6</span><span class="kw">:</span><span class="at"> ~/data/OBS6</span></span></code></pre>
</div>
<p>If we now run the test recipe on our newly ‘CMORized’ data,</p>
<div class="codewrapper sourceCode" id="cb21">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a><span class="ex">esmvaltool</span> run recipe_check_fluxcom.yml <span class="at">--config_file</span> <span class="op">&lt;</span>path to config-user.yml<span class="op">&gt;</span> --log_level debug</span></code></pre>
</div>
<p>it should be able to find the correct file, but it does not succeed
yet. The first thing that the ESMValTool CMOR checker brings up is:</p>
<pre><code>iris.exceptions.UnitConversionError: Cannot convert from unknown units. The
"units" attribute may be set directly.</code></pre>
<p>{: .error}</p>
<p>If you look closely at the error messages, you can see that this
error concerns the units of the coordinates. ESMValTool tries to fix
them automatically, but since no units are defined on the coordinates,
this fails.</p>
<p>The cmorizer utilities also include a function called
<code>fix_coords</code>, but before we can use it, we’ll also need to
make sure the coordinates have the correct standard name. Add the
following code to your cmorizer:</p>
<div class="codewrapper sourceCode" id="cb23">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a><span class="co"># 2. Apply the necessary fixes</span></span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a><span class="co"># 2a. Fix/add coordinate information and metadata</span></span>
<span id="cb23-3"><a href="#cb23-3" tabindex="-1"></a>cube.coord(<span class="st">'lat'</span>).standard_name <span class="op">=</span> <span class="st">'latitude'</span></span>
<span id="cb23-4"><a href="#cb23-4" tabindex="-1"></a>cube.coord(<span class="st">'lon'</span>).standard_name <span class="op">=</span> <span class="st">'longitude'</span></span>
<span id="cb23-5"><a href="#cb23-5" tabindex="-1"></a>utils.fix_coords(cube)</span></code></pre>
</div>
<p>With some additional refactoring, our cmorization function might then
look something like this:</p>
<div class="codewrapper sourceCode" id="cb24">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a><span class="kw">def</span> cmorization(in_dir, out_dir, cfg, cfg_user, start_date, end_date):</span>
<span id="cb24-2"><a href="#cb24-2" tabindex="-1"></a>    <span class="co">"""Cmorize the dataset."""</span></span>
<span id="cb24-3"><a href="#cb24-3" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" tabindex="-1"></a>    <span class="co"># Get general information from the config file</span></span>
<span id="cb24-5"><a href="#cb24-5" tabindex="-1"></a>    attributes <span class="op">=</span> cfg[<span class="st">'attributes'</span>]</span>
<span id="cb24-6"><a href="#cb24-6" tabindex="-1"></a>    variables <span class="op">=</span> cfg[<span class="st">'variables'</span>]</span>
<span id="cb24-7"><a href="#cb24-7" tabindex="-1"></a></span>
<span id="cb24-8"><a href="#cb24-8" tabindex="-1"></a>    <span class="cf">for</span> short_name, variable_info <span class="kw">in</span> variables.items():</span>
<span id="cb24-9"><a href="#cb24-9" tabindex="-1"></a>        logger.info(<span class="st">"CMORizing variable: </span><span class="sc">%s</span><span class="st">"</span>, short_name)</span>
<span id="cb24-10"><a href="#cb24-10" tabindex="-1"></a></span>
<span id="cb24-11"><a href="#cb24-11" tabindex="-1"></a>        <span class="co"># 1a. Find the input data (one file for each year)</span></span>
<span id="cb24-12"><a href="#cb24-12" tabindex="-1"></a>        filename_pattern <span class="op">=</span> cfg[<span class="st">'filename'</span>]</span>
<span id="cb24-13"><a href="#cb24-13" tabindex="-1"></a>        matches <span class="op">=</span> Path(in_dir).glob(filename_pattern)</span>
<span id="cb24-14"><a href="#cb24-14" tabindex="-1"></a></span>
<span id="cb24-15"><a href="#cb24-15" tabindex="-1"></a>        <span class="cf">for</span> match <span class="kw">in</span> matches:</span>
<span id="cb24-16"><a href="#cb24-16" tabindex="-1"></a>            <span class="co"># 1b. Load the input data</span></span>
<span id="cb24-17"><a href="#cb24-17" tabindex="-1"></a>            input_file <span class="op">=</span> <span class="bu">str</span>(match)</span>
<span id="cb24-18"><a href="#cb24-18" tabindex="-1"></a>            logger.info(<span class="st">"found: </span><span class="sc">%s</span><span class="st">"</span>, input_file)</span>
<span id="cb24-19"><a href="#cb24-19" tabindex="-1"></a>            cube <span class="op">=</span> iris.load_cube(input_file)</span>
<span id="cb24-20"><a href="#cb24-20" tabindex="-1"></a></span>
<span id="cb24-21"><a href="#cb24-21" tabindex="-1"></a>            <span class="co"># 2. Apply the necessary fixes</span></span>
<span id="cb24-22"><a href="#cb24-22" tabindex="-1"></a>            <span class="co"># 2a. Fix/add coordinate information and metadata</span></span>
<span id="cb24-23"><a href="#cb24-23" tabindex="-1"></a>            cube.coord(<span class="st">'lat'</span>).standard_name <span class="op">=</span> <span class="st">'latitude'</span></span>
<span id="cb24-24"><a href="#cb24-24" tabindex="-1"></a>            cube.coord(<span class="st">'lon'</span>).standard_name <span class="op">=</span> <span class="st">'longitude'</span></span>
<span id="cb24-25"><a href="#cb24-25" tabindex="-1"></a>            utils.fix_coords(cube)</span>
<span id="cb24-26"><a href="#cb24-26" tabindex="-1"></a></span>
<span id="cb24-27"><a href="#cb24-27" tabindex="-1"></a>            <span class="co"># 3. Save the CMORized data</span></span>
<span id="cb24-28"><a href="#cb24-28" tabindex="-1"></a>            all_attributes <span class="op">=</span> {<span class="op">**</span>attributes, <span class="op">**</span>variable_info}</span>
<span id="cb24-29"><a href="#cb24-29" tabindex="-1"></a>            utils.save_variable(cube<span class="op">=</span>cube, var<span class="op">=</span>short_name, outdir<span class="op">=</span>out_dir, attrs<span class="op">=</span>all_attributes)</span></code></pre>
</div>
<p>Run the CMORizer script once more. Have a look at the netCDF file,
and confirm that the coordinates now have much more metadata added to
them. Then, run the test recipe again with the latest CMORizer output.
The next error is:</p>
<pre><code>esmvalcore.cmor.check.CMORCheckError: There were errors in variable GPP:
Variable GPP units unknown can not be converted to kg m-2 s-1 in cube:</code></pre>
<p>{: .error}</p>
<p>Okay, so let’s fix the units of the “GPP” variable in the CMORizer.
Remember that you can find the correct units in the CMOR table. Add the
following three lines to our CMORizer:</p>
<div class="codewrapper sourceCode" id="cb26">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a><span class="co"># 2b. Fix gpp units</span></span>
<span id="cb26-2"><a href="#cb26-2" tabindex="-1"></a>logger.info(<span class="st">"Changing units for gpp from gc/m2/day to kg/m2/s"</span>)</span>
<span id="cb26-3"><a href="#cb26-3" tabindex="-1"></a>cube.data <span class="op">=</span> cube.core_data() <span class="op">/</span> (<span class="dv">1000</span> <span class="op">*</span> <span class="dv">86400</span>)</span>
<span id="cb26-4"><a href="#cb26-4" tabindex="-1"></a>cube.units <span class="op">=</span> <span class="st">'kg m-2 s-1'</span></span></code></pre>
</div>
<p>If everything is okay, the test recipe should now pass. We’re getting
there. Looking through the output though, there’s still a warning.</p>
<pre><code>WARNING There were warnings in variable GPP:
Standard name for GPP changed from None to gross_primary_productivity_of_biomass_expressed_as_carbon
Long name for GPP changed from GPP to Carbon Mass Flux out of Atmosphere Due to
      Gross Primary Production on Land [kgC m-2 s-1]</code></pre>
<p>{: .output}</p>
<p>ESMValTool is able to apply automatic fixes here, but if we are
running a CMORizer script anyway, we might as well fix it
immediately.</p>
<p>Add the following snippet:</p>
<div class="codewrapper sourceCode" id="cb28">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" tabindex="-1"></a><span class="co"># 2c. Fix metadata</span></span>
<span id="cb28-2"><a href="#cb28-2" tabindex="-1"></a>cmor_table <span class="op">=</span> cfg[<span class="st">'cmor_table'</span>]</span>
<span id="cb28-3"><a href="#cb28-3" tabindex="-1"></a>cmor_info <span class="op">=</span> cmor_table.get_variable(variable_info[<span class="st">'mip'</span>], short_name)</span>
<span id="cb28-4"><a href="#cb28-4" tabindex="-1"></a>utils.fix_var_metadata(cube, cmor_info)</span></code></pre>
</div>
<p>You can see that we’re using the CMOR table here. This was passed on
by ESMValTool as part of the <code>CFG</code> input variable. So here
we’re making sure that we’re updating the cubes metadata to conform to
the CMOR table.</p>
<p>Finally, the test recipe should run without errors or warnings.</p>
</div>
<div class="section level3">
<h3 id="finalizing-the-cmorizer">4. Finalizing the CMORizer<a class="anchor" aria-label="anchor" href="#finalizing-the-cmorizer"></a></h3>
<p>Once everything works as expected, there’s a couple of things that we
can still do.</p>
<ul><li>
<strong>Add download instructions</strong>. The header of the
CMORizer contains information about where to obtain the data, when it
was accessed the last time, which ESMValTool “tier” it is associated
with, and more detailed information about the necessary downloading and
processing steps.</li>
</ul><blockquote>
<h2 id="fill-out-the-header-for-the-fluxcom-dataset">Fill out the header
for the “FLUXCOM” dataset</h2>
<p>Fill out the header of the new CMORizer. The different parts that
need to be present in the header are the following:</p>
<ul><li>Caption: the first line of the docstring should summarize what the
script does.</li>
<li>Tier</li>
<li>Source</li>
<li>Last access</li>
<li>Download and processing instructions</li>
</ul><blockquote>
<h2 id="answers-2">Answers</h2>
<p>The header for the “FLUXCOM” dataset could look something like
this:</p>
<div class="codewrapper sourceCode" id="cb29">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" tabindex="-1"></a><span class="co">"""ESMValTool CMORizer for FLUXCOM GPP data.</span></span>
<span id="cb29-2"><a href="#cb29-2" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" tabindex="-1"></a><span class="co">Tier</span></span>
<span id="cb29-4"><a href="#cb29-4" tabindex="-1"></a><span class="co">    Tier 3: restricted dataset.</span></span>
<span id="cb29-5"><a href="#cb29-5" tabindex="-1"></a></span>
<span id="cb29-6"><a href="#cb29-6" tabindex="-1"></a><span class="co">Source</span></span>
<span id="cb29-7"><a href="#cb29-7" tabindex="-1"></a><span class="co">    http://www.bgc-jena.mpg.de/geodb/BGI/Home</span></span>
<span id="cb29-8"><a href="#cb29-8" tabindex="-1"></a></span>
<span id="cb29-9"><a href="#cb29-9" tabindex="-1"></a><span class="co">Last access</span></span>
<span id="cb29-10"><a href="#cb29-10" tabindex="-1"></a><span class="co">    20190727</span></span>
<span id="cb29-11"><a href="#cb29-11" tabindex="-1"></a></span>
<span id="cb29-12"><a href="#cb29-12" tabindex="-1"></a><span class="co">Download and processing instructions</span></span>
<span id="cb29-13"><a href="#cb29-13" tabindex="-1"></a><span class="co">    From the website, select FLUXCOM as the data choice and click download.</span></span>
<span id="cb29-14"><a href="#cb29-14" tabindex="-1"></a><span class="co">    Two files will be displayed. One for Land Carbon Fluxes and one for</span></span>
<span id="cb29-15"><a href="#cb29-15" tabindex="-1"></a><span class="co">    Land Energy fluxes. The Land Carbon Flux file (RS + METEO) using</span></span>
<span id="cb29-16"><a href="#cb29-16" tabindex="-1"></a><span class="co">    CRUNCEP data file has several data files for different variables.</span></span>
<span id="cb29-17"><a href="#cb29-17" tabindex="-1"></a><span class="co">    The data for GPP generated using the</span></span>
<span id="cb29-18"><a href="#cb29-18" tabindex="-1"></a><span class="co">    Artificial Neural Network Method will be in files with name:</span></span>
<span id="cb29-19"><a href="#cb29-19" tabindex="-1"></a><span class="co">    GPP.ANN.CRUNCEPv6.monthly.\*.nc</span></span>
<span id="cb29-20"><a href="#cb29-20" tabindex="-1"></a><span class="co">    A registration is required for downloading the data.</span></span>
<span id="cb29-21"><a href="#cb29-21" tabindex="-1"></a><span class="co">    Users in the UK with a CEDA-JASMIN account may request access to the jules</span></span>
<span id="cb29-22"><a href="#cb29-22" tabindex="-1"></a><span class="co">    workspace and access the data.</span></span>
<span id="cb29-23"><a href="#cb29-23" tabindex="-1"></a><span class="co">    Note : This data may require rechunking of the netcdf files.</span></span>
<span id="cb29-24"><a href="#cb29-24" tabindex="-1"></a><span class="co">    This constraint will not exist once iris is updated to</span></span>
<span id="cb29-25"><a href="#cb29-25" tabindex="-1"></a><span class="co">    version 2.3.0 Aug 2019</span></span>
<span id="cb29-26"><a href="#cb29-26" tabindex="-1"></a><span class="co">"""</span></span></code></pre>
</div>
<p>{: .solution} {: .challenge}</p>
</blockquote>
</blockquote>
<ul><li>
<strong>Fill the dataset information list</strong>. The file <a href="https://github.com/ESMValGroup/ESMValTool/blob/main/esmvaltool/%20cmorizers/data/datasets.yml" class="external-link">datasets.yml</a>
contains the ESMValTool “tier”, the data source, the last access time
and download instructions for all supported datasets in ESMValTool. You
can simply reuse the information written in the header of the
CMORizer.</li>
</ul><blockquote>
<h2 id="fill-out-the-fluxcom-entry-in-datasets.yml">Fill out the FLUXCOM
entry in <code>datasets.yml</code>
</h2>
<p>Fill out the FLUXCOM entry in <code>datasets.yml</code>. The
different parts that need to be present in the entry are the
following:</p>
<ul><li>Dataset-name</li>
<li>Tier</li>
<li>Source</li>
<li>Last access</li>
<li>Download and processing instructions</li>
</ul><blockquote>
<h2 id="answers-3">Answers</h2>
<p>The entry for the “FLUXCOM” dataset should look like:</p>
<div class="codewrapper sourceCode" id="cb30">
<h3 class="code-label">YAML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yaml" tabindex="0"><code class="sourceCode yaml"><span id="cb30-1"><a href="#cb30-1" tabindex="-1"></a><span class="fu">FLUXCOM</span><span class="kw">:</span></span>
<span id="cb30-2"><a href="#cb30-2" tabindex="-1"></a><span class="at">  </span><span class="fu">tier</span><span class="kw">:</span><span class="at"> </span><span class="dv">3</span></span>
<span id="cb30-3"><a href="#cb30-3" tabindex="-1"></a><span class="at">  </span><span class="fu">source</span><span class="kw">:</span><span class="at"> http://www.bgc-jena.mpg.de/geodb/BGI/Home</span></span>
<span id="cb30-4"><a href="#cb30-4" tabindex="-1"></a><span class="at">  </span><span class="fu">last_access</span><span class="kw">:</span><span class="at"> 2019-07-27</span></span>
<span id="cb30-5"><a href="#cb30-5" tabindex="-1"></a><span class="fu">  info</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb30-6"><a href="#cb30-6" tabindex="-1"></a>    From the website, select FLUXCOM as the data choice and click download.</span>
<span id="cb30-7"><a href="#cb30-7" tabindex="-1"></a>    Two files will be displayed. One for Land Carbon Fluxes and one for</span>
<span id="cb30-8"><a href="#cb30-8" tabindex="-1"></a>    Land Energy fluxes. The Land Carbon Flux file (RS + METEO) using</span>
<span id="cb30-9"><a href="#cb30-9" tabindex="-1"></a>    CRUNCEP data file has several data files for different variables.</span>
<span id="cb30-10"><a href="#cb30-10" tabindex="-1"></a>    The data for GPP generated using the</span>
<span id="cb30-11"><a href="#cb30-11" tabindex="-1"></a>    Artificial Neural Network Method will be in files with name:</span>
<span id="cb30-12"><a href="#cb30-12" tabindex="-1"></a>    GPP.ANN.CRUNCEPv6.monthly.*.nc</span>
<span id="cb30-13"><a href="#cb30-13" tabindex="-1"></a>    A registration is required for downloading the data.</span>
<span id="cb30-14"><a href="#cb30-14" tabindex="-1"></a>    Users in the UK with a CEDA-JASMIN account may request access to the jules</span>
<span id="cb30-15"><a href="#cb30-15" tabindex="-1"></a>    workspace and access the data.</span>
<span id="cb30-16"><a href="#cb30-16" tabindex="-1"></a>    Note : This data may require rechunking of the netcdf files.</span>
<span id="cb30-17"><a href="#cb30-17" tabindex="-1"></a>    This constraint will not exist once iris is updated to</span>
<span id="cb30-18"><a href="#cb30-18" tabindex="-1"></a>    version 2.3.0 Aug 2019</span></code></pre>
</div>
<p>{: .solution} {: .challenge}</p>
</blockquote>
</blockquote>
<p>Once the <code>datasets.yml</code> file is filled, you can check that
ESMValTool can display information about the added dataset with:</p>
<div class="codewrapper sourceCode" id="cb31">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb31-1"><a href="#cb31-1" tabindex="-1"></a><span class="ex">esmvaltool</span> data info FLUXCOM</span></code></pre>
</div>
<p>If everything is okay, the output should look something like
this:</p>
<pre><code> $ esmvaltool data info FLUXCOM
FLUXCOM

Tier: 3
Source: http://www.bgc-jena.mpg.de/geodb/BGI/Home
Automatic download: No

From the website, select FLUXCOM as the data choice and click download.
Two files will be displayed. One for Land Carbon Fluxes and one for
Land Energy fluxes. The Land Carbon Flux file (RS + METEO) using
CRUNCEP data file has several data files for different variables.
The data for GPP generated using the
Artificial Neural Network Method will be in files with name:
GPP.ANN.CRUNCEPv6.monthly.*.nc
A registration is required for downloading the data.
Users in the UK with a CEDA-JASMIN account may request access to the jules
workspace and access the data.
Note : This data may require rechunking of the netcdf files.
This constraint will not exist once iris is updated to
version 2.3.0 Aug 2019</code></pre>
<p>{: .output}</p>
<p>Note that <code>Automatic download: No</code> means that no automatic
downloading script is available in ESMValTool for this dataset. The
implementation of such a script is beyond the scope of this tutorial. To
find out which datasets come with an automatic download script, you can
run: <code>esmvaltool data list</code> to list all datasets supported in
ESMValTool. More information about the usage of automatic downloading
scripts can be found in the <a href="https://docs.esmvaltool.org/en/latest/develop/dataset.html#downloader-script-optional" class="external-link">User
Guide</a>.</p>
<ul><li>
<strong>Complete the metadata in the config file</strong>. We have
left a few fields empty in the configuration file, such as ‘source’. By
filling out these fields we can make sure the relevant metadata is
passed on as attributes in the CMORized data. To make this work, add the
following line to the CMORizer script:</li>
</ul><div class="codewrapper sourceCode" id="cb33">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" tabindex="-1"></a><span class="co"># 2d. Update the cubes metadata with all info from the config file</span></span>
<span id="cb33-2"><a href="#cb33-2" tabindex="-1"></a>utils.set_global_atts(cube, attributes)</span></code></pre>
</div>
<ul><li><p><strong>Add a reference</strong>. Make sure that there is a
reference file available for the dataset, see the instruction <a href="https://docs.esmvaltool.org/en%20/latest/community/diagnostic.html#adding-references" class="external-link">here</a>.</p></li>
<li><p><strong>Make a pull request</strong>. Since you have gone through
all the trouble to reformat the dataset so that the ESMValTool can work
with it, it would be great if you could provide the CMORizer, and
ultimately with that the dataset, to the rest of the community. For more
information, see the episode on <a href="%7B%7B%20page.root%20%7D%7D%7B%%20link%20_episodes/07-development-setup.md%20%%7D">Development
and contribution</a>.</p></li>
<li><p><strong>Add documentation</strong>. Make sure that you have added
the info of your dataset to the User Guide so that people know it is
available for the ESMValTool <a href="https://github.com/ESMValGroup/ESMValTool/blob/main/doc/sphinx/source/input.rst" class="external-link">Obtaining
input data</a>.</p></li>
</ul></div>
</section><section><h2 class="section-heading" id="some-final-comments">Some final comments<a class="anchor" aria-label="anchor" href="#some-final-comments"></a></h2>
<hr class="half-width"><p>Congratulations! You have just added support for a new dataset to
ESMValTool! Adding a new CMORizer is definitely already an advanced task
when working with the ESMValTool. You need to have a basic understanding
of how the ESMValTool works and how it’s internal structure looks like.
In addition, you need to have a basic understanding of NetCDF files and
a programming language. In our example we used python for the CMORizing
script since we advocate for focusing the code development on only a few
different programming languages. This helps to maintain the code and to
ensure the compatibility of the code with possible fundamental changes
to the structure of the ESMValTool and ESMValCore.</p>
<p>More information about adding observations to the ESMValTool can be
found in the <a href="https://docs.esmvaltool.org/en/latest/input.html#observations" class="external-link">documentation</a>.</p>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</section></div> <!-- / div.lesson-content -->
    </main><!-- / main#main-content.main-content --><nav class="bottom-pagination mx-md-4" aria-label="Previous and Next Chapter"><div class="d-block d-sm-block d-md-none">
        <a class="chapter-link" href="../instructor/08-diagnostics.html"><i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>Previous</a>
        <a class="chapter-link float-end" href="../instructor/10-debugging.html">Next<i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i></a>
      </div>
      <!-- content for large screens -->
      <div class="d-none d-sm-none d-md-block">
        <a class="chapter-link" href="../instructor/08-diagnostics.html" rel="prev">
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>
          Previous: Writing your own
        </a>
        <a class="chapter-link float-end" href="../instructor/10-debugging.html" rel="next">
          Next: Debugging...
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i>
        </a>
      </div>
    </nav></div> <!-- / div.primary-content.col-xs-12 -->
<!-- END:   inst/pkgdown/templates/content-instructor.html-->

      </div><!--/div.row-->
      		<footer class="row footer mx-md-3"><hr><div class="col-md-6">
        <p>This lesson is subject to the <a href="CODE_OF_CONDUCT.html">Code of Conduct</a></p>
        <p>

        <a href="https://github.com/ehogan/ESMValTool_Tutorial/edit/main/episodes/09-cmorization.md" class="external-link">Edit on GitHub</a>

	
        | <a href="https://github.com/ehogan/ESMValTool_Tutorial/blob/main/CONTRIBUTING.md" class="external-link">Contributing</a>
        | <a href="https://github.com/ehogan/ESMValTool_Tutorial/" class="external-link">Source</a></p>
				<p><a href="https://github.com/ehogan/ESMValTool_Tutorial/blob/main/CITATION.cff" class="external-link">Cite</a> | <a href="mailto:team@carpentries.org">Contact</a> | <a href="https://carpentries.org/about/" class="external-link">About</a></p>
			</div>
			<div class="col-md-6">

        <p>Materials licensed under <a href="LICENSE.html">CC-BY 4.0</a> by the authors</p>

        <p>Template licensed under <a href="https://creativecommons.org/licenses/by-sa/4.0/" class="external-link">CC-BY 4.0</a> by <a href="https://carpentries.org/" class="external-link">The Carpentries</a></p>
        <p>Built with <a href="https://github.com/carpentries/sandpaper/tree/0.16.10" class="external-link">sandpaper (0.16.10)</a>, <a href="https://github.com/carpentries/pegboard/tree/0.7.7" class="external-link">pegboard (0.7.7)</a>, and <a href="https://github.com/carpentries/varnish/tree/1.0.5" class="external-link">varnish (1.0.5)</a></p>
			</div>
		</footer></div> <!-- / div.container -->
	<div id="to-top">
		<a href="#top">
      <i class="search-icon" data-feather="arrow-up" role="img" aria-label="Back To Top"></i><br><!-- <span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top --><span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top
		</a>
	</div>
  <script type="application/ld+json">
    {
  "@context": "https://schema.org",
  "@type": "TrainingMaterial",
  "@id": "https://ehogan.github.io/ESMValTool_Tutorial/instructor/09-cmorization.html",
  "inLanguage": "en",
  "dct:conformsTo": "https://bioschemas.org/profiles/TrainingMaterial/1.0-RELEASE",
  "description": "A Carpentries Lesson teaching foundational data and coding skills to researchers worldwide",
  "keywords": "software, data, lesson, The Carpentries",
  "name": "CMORization: adding new datasets to ESMValTool",
  "creativeWorkStatus": "active",
  "url": "https://ehogan.github.io/ESMValTool_Tutorial/instructor/09-cmorization.html",
  "identifier": "https://ehogan.github.io/ESMValTool_Tutorial/instructor/09-cmorization.html",
  "dateCreated": "2024-11-21",
  "dateModified": "2024-11-21",
  "datePublished": "2024-12-10"
}

  </script><script>
		feather.replace();
	</script></body></html><!-- END:   inst/pkgdown/templates/layout.html-->

