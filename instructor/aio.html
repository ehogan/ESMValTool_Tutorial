<!DOCTYPE html>
<!-- START: inst/pkgdown/templates/layout.html --><!-- Generated by pkgdown: do not edit by hand --><html lang="en" data-bs-theme="auto">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<title>ESMValTool Tutorial: All in One View</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="../assets/themetoggle.js"></script><link rel="stylesheet" type="text/css" href="../assets/styles.css">
<script src="../assets/scripts.js" type="text/javascript"></script><!-- mathjax --><script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      config: ["MMLorHTML.js"],
      jax: ["input/TeX","input/MathML","output/HTML-CSS","output/NativeMML", "output/PreviewHTML"],
      extensions: ["tex2jax.js","mml2jax.js","MathMenu.js","MathZoom.js", "fast-preview.js", "AssistiveMML.js", "a11y/accessibility-menu.js"],
      TeX: {
        extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"]
      },
      tex2jax: {
        inlineMath: [['\\(', '\\)']],
        displayMath: [ ['$$','$$'], ['\\[', '\\]'] ],
        processEscapes: true
      }
    });
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><!-- Responsive Favicon for The Carpentries --><link rel="apple-touch-icon" sizes="180x180" href="../favicons/incubator/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicons/incubator/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="../favicons/incubator/favicon-16x16.png">
<link rel="manifest" href="../favicons/incubator/site.webmanifest">
<link rel="mask-icon" href="../favicons/incubator/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="white">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="black">
</head>
<body>
    <header id="top" class="navbar navbar-expand-md top-nav incubator"><svg xmlns="http://www.w3.org/2000/svg" class="d-none"><symbol id="check2" viewbox="0 0 16 16"><path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"></path></symbol><symbol id="circle-half" viewbox="0 0 16 16"><path d="M8 15A7 7 0 1 0 8 1v14zm0 1A8 8 0 1 1 8 0a8 8 0 0 1 0 16z"></path></symbol><symbol id="moon-stars-fill" viewbox="0 0 16 16"><path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"></path><path d="M10.794 3.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387a1.734 1.734 0 0 0-1.097 1.097l-.387 1.162a.217.217 0 0 1-.412 0l-.387-1.162A1.734 1.734 0 0 0 9.31 6.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387a1.734 1.734 0 0 0 1.097-1.097l.387-1.162zM13.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.156 1.156 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.156 1.156 0 0 0-.732-.732l-.774-.258a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"></path></symbol><symbol id="sun-fill" viewbox="0 0 16 16"><path d="M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"></path></symbol></svg><a class="visually-hidden-focusable skip-link" href="#main-content">Skip to main content</a>
  <div class="container-fluid top-nav-container">
    <div class="col-md-8">
      <div class="large-logo">
        <img id="incubator-logo" alt="Lesson Description" src="../assets/images/incubator-logo.svg"><span class="badge text-bg-danger">
          <abbr title="This lesson is in the pre-alpha phase, which means that it is in early development, but has not yet been taught.">
            <a href="https://cdh.carpentries.org/the-lesson-life-cycle.html#early-development-pre-alpha-through-alpha" class="external-link alert-link">
              <i aria-hidden="true" class="icon" data-feather="alert-octagon" style="border-radius: 5px"></i>
              Pre-Alpha
            </a>
            <span class="visually-hidden">This lesson is in the pre-alpha phase, which means that it is in early development, but has not yet been taught.</span>
          </abbr>
        </span>

      </div>
    </div>
    <div class="selector-container">
      <div id="theme-selector">
        <li class="nav-item dropdown" id="theme-button-list">
          <button class="btn btn-link nav-link px-0 px-lg-2 dropdown-toggle d-flex align-items-center" id="bd-theme" type="button" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme (auto)">
            <svg class="bi my-1 theme-icon-active"><use href="#circle-half"></use></svg><i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="bd-theme-text">
<li>
              <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
                <svg class="bi me-2 theme-icon"><use href="#sun-fill"></use></svg>
                Light
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
            <li>
              <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                <svg class="bi me-2 theme-icon"><use href="#moon-stars-fill"></use></svg>
                Dark
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
            <li>
              <button type="button" class="btn dropdown-item d-flex align-items-center active" data-bs-theme-value="auto" aria-pressed="true">
                <svg class="bi me-2 theme-icon"><use href="#circle-half"></use></svg>
                Auto
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
          </ul>
</li>
      </div>

      <div class="dropdown" id="instructor-dropdown">
        <button class="btn btn-secondary dropdown-toggle bordered-button" type="button" id="dropdownMenu1" data-bs-toggle="dropdown" aria-expanded="false">
          <i aria-hidden="true" class="icon" data-feather="eye"></i> Instructor View <i data-feather="chevron-down"></i>
        </button>
        <ul class="dropdown-menu" aria-labelledby="dropdownMenu1">
<li><button class="dropdown-item" type="button" onclick="window.location.href='../aio.html';">Learner View</button></li>
        </ul>
</div>
    </div>
  </div>
  <hr></header><nav class="navbar navbar-expand-xl bottom-nav incubator" aria-label="Main Navigation"><div class="container-fluid nav-container">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle Navigation">
      <span class="navbar-toggler-icon"></span>
      <span class="menu-title">Menu</span>
    </button>
    <div class="nav-logo">
      <img class="small-logo" alt="Lesson Description" src="../assets/images/incubator-logo-sm.svg">
</div>
    <div class="lesson-title-md">
      ESMValTool Tutorial
    </div>
    <div class="search-icon-sm">
      <!-- TODO: do not show until we have search
        <i role="img" aria-label="Search the All In One page" data-feather="search"></i>
      -->
    </div>
    <div class="desktop-nav">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
<li class="nav-item">
          <span class="lesson-title">
            ESMValTool Tutorial
          </span>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/key-points.html">Key Points</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/instructor-notes.html">Instructor Notes</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/images.html">Extract All Images</a>
        </li>
        <li class="nav-item dropdown">
          <button class="nav-link dropdown-toggle" id="navbarDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            More <i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
<hr>
<li><a class="dropdown-item" href="reference.html">Reference</a></li>
          </ul>
</li>
      </ul>
</div>
    <!--
    <form class="d-flex col-md-2 search-form">
      <fieldset disabled>
      <input class="form-control me-2 searchbox" type="search" placeholder="" aria-label="">
        <button class="btn btn-outline-success tablet-search-button"  type="submit">
          <i class="search-icon" data-feather="search" role="img" aria-label="Search the All In One page"></i>
        </button>
      </fieldset>
    </form>
    -->
    <a id="search-button" class="btn btn-primary" href="../instructor/aio.html" role="button" aria-label="Search the All In One page">Search the All In One page</a>
  </div>
<!--/div.container-fluid -->
</nav><div class="col-md-12 mobile-title">
  ESMValTool Tutorial
</div>

<aside class="col-md-12 lesson-progress"><div style="width: %" class="percentage">
    %
  </div>
  <div class="progress incubator">
    <div class="progress-bar incubator" role="progressbar" style="width: %" aria-valuenow="" aria-label="Lesson Progress" aria-valuemin="0" aria-valuemax="100">
    </div>
  </div>
</aside><div class="container">
      <div class="row">
        <!-- START: inst/pkgdown/templates/navbar.html -->
<div id="sidebar-col" class="col-lg-4">
  <div id="sidebar" class="sidebar">
      <nav aria-labelledby="flush-headingEleven"><button role="button" aria-label="close menu" alt="close menu" aria-expanded="true" aria-controls="sidebar" class="collapse-toggle" data-collapse="Collapse " data-episodes="Episodes ">
          <i class="search-icon" data-feather="x" role="img"></i>
        </button>
        <div class="sidebar-inner">
          <div class="row mobile-row" id="theme-row-mobile">
            <div class="col" id="theme-selector">
              <li class="nav-item dropdown" id="theme-button-list">
                <button class="btn btn-link nav-link px-0 px-lg-2 dropdown-toggle d-flex align-items-center" id="bd-theme" type="button" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme (auto)">
                  <svg class="bi my-1 theme-icon-active"><use href="#circle-half"></use></svg><span class="d-lg-none ms-1" id="bd-theme-text">Toggle Theme</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-right" aria-labelledby="bd-theme-text">
<li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
                      <svg class="bi me-2 theme-icon"><use href="#sun-fill"></use></svg>
                      Light
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                  <li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                      <svg class="bi me-2 theme-icon"><use href="#moon-stars-fill"></use></svg>
                      Dark
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                  <li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center active" data-bs-theme-value="auto" aria-pressed="true">
                      <svg class="bi me-2 theme-icon"><use href="#circle-half"></use></svg>
                      Auto
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                </ul>
</li>
            </div>
          </div>
          <div class="row mobile-row">
            <div class="col">
              <div class="sidenav-view-selector">
                <div class="accordion accordion-flush" id="accordionFlush9">
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="flush-headingNine">
                      <button class="accordion-button collapsed" id="instructor" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseNine" aria-expanded="false" aria-controls="flush-collapseNine">
                        <i id="eye" aria-hidden="true" class="icon" data-feather="eye"></i> Instructor View
                      </button>
                    </h2>
                    <div id="flush-collapseNine" class="accordion-collapse collapse" aria-labelledby="flush-headingNine" data-bs-parent="#accordionFlush2">
                      <div class="accordion-body">
                        <a href="../aio.html">Learner View</a>
                      </div>
                    </div>
                  </div>
<!--/div.accordion-item-->
                </div>
<!--/div.accordion-flush-->
              </div>
<!--div.sidenav-view-selector -->
            </div>
<!--/div.col -->

            <hr>
</div>
<!--/div.mobile-row -->

          <div class="accordion accordion-flush" id="accordionFlush11">
            <div class="accordion-item">

              <button id="chapters" class="accordion-button show" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseEleven" aria-expanded="false" aria-controls="flush-collapseEleven">
                <h2 class="accordion-header chapters" id="flush-headingEleven">
                  EPISODES
                </h2>
              </button>
              <div id="flush-collapseEleven" class="accordion-collapse show collapse" aria-labelledby="flush-headingEleven" data-bs-parent="#accordionFlush11">

                <div class="accordion-body">
                  <div class="accordion accordion-flush" id="accordionFlush1">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading1">
        <a href="index.html">Summary and Schedule</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush2">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading2">
        <a href="00-introduction.html">1. Introduction</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush3">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading3">
        <a href="01-quickstart.html">2. Quickstart guide</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush4">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading4">
        <a href="02-installation.html">3. Installation</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush5">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading5">
        <a href="03-configuration.html">4. Configuration</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush6">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading6">
        <a href="04-recipe.html">5. Running your first recipe</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush7">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading7">
        <a href="05-conclusions.html">6. Conclusion of the basic tutorial</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush8">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading8">
        <a href="06-preprocessor.html">7. Writing your own recipe</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush9">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading9">
        <a href="07-development-setup.html">8. Development and contribution</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush10">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading10">
        <a href="08-diagnostics.html">9. Writing your own diagnostic script</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush11">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading11">
        <a href="09-cmorization.html">10. CMORization: adding new datasets to ESMValTool</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush12">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading12">
        <a href="10-debugging.html">11. Debugging</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

                </div>
              </div>
            </div>

            <hr class="half-width">
<div class="accordion accordion-flush lesson-resources" id="accordionFlush12">
              <div class="accordion-item">
                <h2 class="accordion-header" id="flush-headingTwelve">
                  <button class="accordion-button collapsed" id="lesson-resources" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTwelve" aria-expanded="false" aria-controls="flush-collapseTwelve">
                    RESOURCES
                  </button>
                </h2>
                <div id="flush-collapseTwelve" class="accordion-collapse collapse" aria-labelledby="flush-headingTwelve" data-bs-parent="#accordionFlush12">
                  <div class="accordion-body">
                    <ul>
<li>
                        <a href="../instructor/key-points.html">Key Points</a>
                      </li>
                      <li>
                        <a href="../instructor/instructor-notes.html">Instructor Notes</a>
                      </li>
                      <li>
                        <a href="../instructor/images.html">Extract All Images</a>
                      </li>
                      <hr>
<li><a class="dropdown-item" href="reference.html">Reference</a></li>
                    </ul>
</div>
                </div>
              </div>
            </div>
            <hr class="half-width lesson-resources">
<a href="../instructor/aio.html">See all in one page</a>


            <hr class="d-none d-sm-block d-md-none">
<div class="d-grid gap-1">

            </div>
          </div>
<!-- /div.accordion -->
        </div>
<!-- /div.sidebar-inner -->
      </nav>
</div>
<!-- /div.sidebar -->
  </div>
<!-- /div.sidebar-col -->
<!-- END:   inst/pkgdown/templates/navbar.html-->

        <!-- START: inst/pkgdown/templates/content-extra.html -->
  <div class="col-xl-8 col-lg-12 primary-content">
    <main id="main-content" class="main-content"><div class="container lesson-content">
        
        
<section id="aio-00-introduction"><p>Content from <a href="00-introduction.html">Introduction</a></p>
<hr>
<p>Last updated on 2024-11-21 |

        <a href="https://github.com/ehogan/ESMValTool_Tutorial/edit/main/episodes/00-introduction.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Estimated time: <i aria-hidden="true" data-feather="clock"></i> 15 minutes</p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<section><h2 class="section-heading" id="what-is-esmvaltool">What is ESMValTool?<a class="anchor" aria-label="anchor" href="#what-is-esmvaltool"></a>
</h2>
<hr class="half-width">
<p>This tutorial is a first introduction to ESMValTool. Before diving
into the technical steps, let’s talk about what ESMValTool is all
about.</p>
<blockquote>
<h2 id="what-is-esmvaltool-1">What is ESMValTool?</h2>
<p>What do you already know about or expect from ESMValTool?</p>
<blockquote>
<h2 id="esmvaltool-is">ESMValTool is…</h2>
<p>EMSValTool is many things, but in this tutorial we will focus on the
following traits:</p>
<p>✓ <strong>A tool to analyse climate data</strong></p>
<p>✓ <strong>A collection of diagnostics for reproducible climate
science</strong></p>
<p>✓ <strong>A community effort</strong></p>
<p>{: .solution} {: .challenge}</p>
</blockquote>
</blockquote>
</section><section><h2 class="section-heading" id="a-tool-to-analyse-climate-data">A tool to analyse climate data<a class="anchor" aria-label="anchor" href="#a-tool-to-analyse-climate-data"></a>
</h2>
<hr class="half-width">
<p>ESMValTool takes care of finding, opening, checking, fixing,
concatenating, and preprocessing CMIP data and several other supported
datasets.</p>
<p>The central component of ESMValTool that we will see in this tutorial
is the <strong>recipe</strong>. Any ESMValTool recipe is basically a set
of instructions to reproduce a certain result. The basic structure of a
recipe is as follows:</p>
<ul>
<li>
<strong>Documentation</strong> with relevant (citation)
information</li>
<li>
<strong>Datasets</strong> that should be analysed</li>
<li>
<strong>Preprocessor</strong> steps that must be applied</li>
<li>
<strong>Diagnostic</strong> scripts performing more specific
evaluation steps</li>
</ul>
<p>An example recipe could look like this:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">YAML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yaml" tabindex="0"><code class="sourceCode yaml"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">documentation</span><span class="kw">:</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="at">  </span><span class="fu">title</span><span class="kw">:</span><span class="at"> This is an example recipe.</span></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="at">  </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Example recipe</span></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="at">  </span><span class="fu">authors</span><span class="kw">:</span></span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> lastname_firstname</span></span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a><span class="fu">datasets</span><span class="kw">:</span></span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="kw">{</span><span class="fu">dataset</span><span class="kw">:</span><span class="at"> HadGEM2-ES</span><span class="kw">,</span><span class="at"> </span><span class="fu">project</span><span class="kw">:</span><span class="at"> CMIP5</span><span class="kw">,</span><span class="at"> </span><span class="fu">exp</span><span class="kw">:</span><span class="at"> historical</span><span class="kw">,</span><span class="at"> </span><span class="fu">mip</span><span class="kw">:</span><span class="at"> Amon</span><span class="kw">,</span><span class="at"> </span></span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a><span class="at">     </span><span class="fu">ensemble</span><span class="kw">:</span><span class="at"> r1i1p1</span><span class="kw">,</span><span class="at"> </span><span class="fu">start_year</span><span class="kw">:</span><span class="at"> </span><span class="dv">1960</span><span class="kw">,</span><span class="at"> </span><span class="fu">end_year</span><span class="kw">:</span><span class="at"> </span><span class="dv">2005</span><span class="kw">}</span></span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a><span class="fu">preprocessors</span><span class="kw">:</span></span>
<span id="cb1-12"><a href="#cb1-12" tabindex="-1"></a><span class="at">  </span><span class="fu">global_mean</span><span class="kw">:</span></span>
<span id="cb1-13"><a href="#cb1-13" tabindex="-1"></a><span class="at">    </span><span class="fu">area_statistics</span><span class="kw">:</span></span>
<span id="cb1-14"><a href="#cb1-14" tabindex="-1"></a><span class="at">      </span><span class="fu">operator</span><span class="kw">:</span><span class="at"> mean</span></span>
<span id="cb1-15"><a href="#cb1-15" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" tabindex="-1"></a><span class="fu">diagnostics</span><span class="kw">:</span></span>
<span id="cb1-17"><a href="#cb1-17" tabindex="-1"></a><span class="at">  </span><span class="fu">hockeystick_plot</span><span class="kw">:</span></span>
<span id="cb1-18"><a href="#cb1-18" tabindex="-1"></a><span class="at">    </span><span class="fu">description</span><span class="kw">:</span><span class="at"> plot of global mean temperature change</span></span>
<span id="cb1-19"><a href="#cb1-19" tabindex="-1"></a><span class="at">    </span><span class="fu">variables</span><span class="kw">:</span></span>
<span id="cb1-20"><a href="#cb1-20" tabindex="-1"></a><span class="at">      </span><span class="fu">temperature</span><span class="kw">:</span></span>
<span id="cb1-21"><a href="#cb1-21" tabindex="-1"></a><span class="at">        </span><span class="fu">short_name</span><span class="kw">:</span><span class="at"> tas</span></span>
<span id="cb1-22"><a href="#cb1-22" tabindex="-1"></a><span class="at">        </span><span class="fu">preprocessor</span><span class="kw">:</span><span class="at"> global_mean</span></span>
<span id="cb1-23"><a href="#cb1-23" tabindex="-1"></a><span class="at">    </span><span class="fu">scripts</span><span class="kw">:</span><span class="at"> hockeystick.py</span></span></code></pre>
</div>
<blockquote>
<h2 id="understanding-the-different-section-of-the-recipe">Understanding
the different section of the recipe</h2>
<p>Try to figure out the meaning of the different dataset keys. Hint:
they can be found in the documentation of ESMValTool.</p>
<blockquote>
<h2 id="solution">Solution</h2>
<p>The keys are explained in the ESMValTool documentation, in the
<code>Recipe   section</code>, under <a href="https://docs.esmvaltool.org/projects/esmvalcore/en/latest/recipe/%20overview.html#recipe-section-datasets" class="external-link">datasets</a>
{: .solution} {: .challenge}</p>
</blockquote>
</blockquote>
</section><section><h2 class="section-heading" id="a-collection-of-diagnostics-for-reproducible-climate-science">A collection of diagnostics for reproducible climate science<a class="anchor" aria-label="anchor" href="#a-collection-of-diagnostics-for-reproducible-climate-science"></a>
</h2>
<hr class="half-width">
<p>More than a tool, ESMValTool is a collection of publicly available
recipes and diagnostic scripts. This makes it possible to easily
reproduce important results.</p>
<blockquote>
<h2 id="explore-the-available-recipes">Explore the available
recipes</h2>
<p>Go to the <a href="https://docs.esmvaltool.org/" class="external-link">ESMValTool
Documentation webpage</a> and explore the <code>Available recipes</code>
section. Which recipe(s) would you like to try? {: .challenge}</p>
</blockquote>
</section><section><h2 class="section-heading" id="a-community-effort">A community effort<a class="anchor" aria-label="anchor" href="#a-community-effort"></a>
</h2>
<hr class="half-width">
<p>ESMValTool is built and maintained by an active community of
scientists and software engineers. It is an open source project to which
anyone can contribute. Many of the interactions take place on GitHub.
Here, we briefly introduce you to some of the most important pages.</p>
<blockquote>
<h2 id="meet-the-esmvalgroup">Meet the ESMValGroup</h2>
<p>Go to <a href="https://github.com/ESMValGroup" class="external-link">github.com/ESMValGroup</a>. This
is the GitHub page of our ‘organization’. Have a look around. How many
collaborators are there? Do you know any of them?</p>
<p>Near the top of the page there are 2 pinned repositories: ESMValTool
and ESMValCore. Visit each of the repositories. How many people have
contributed to each of them? Can you also find out how many people have
contributed to this tutorial? {: .challenge}</p>
</blockquote>
<blockquote>
<h2 id="issues-and-pull-requests">Issues and pull requests</h2>
<p>Go back to the repository pages of <a href="https://github.com/ESMValGroup/ESMValTool" class="external-link">ESMValTool</a> or <a href="https://github.com/ESMValGroup/ESMValCore" class="external-link">ESMValCore</a>. There
are tabs for ‘issues’ and ‘pull requests’. You can use the labels to
navigate them a bit more. How many open issues are about enhancements of
ESMValTool? And how many bugs have been fixed in ESMValCore? There is
also an ‘insights’ tab, where you can see a summary of recent activity.
How many issues have been opened and closed in the past month? {:
.challenge}</p>
</blockquote>
</section><section><h2 class="section-heading" id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<hr class="half-width">
<p>This concludes the introduction of the tutorial. You now have a basic
knowledge of ESMValTool and its community. The following episodes will
walk you through the installation, configuration and running your first
recipes.</p>
<p>{% include links.md %}</p>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</section></section><section id="aio-01-quickstart"><p>Content from <a href="01-quickstart.html">Quickstart guide</a></p>
<hr>
<p>Last updated on 2024-11-21 |

        <a href="https://github.com/ehogan/ESMValTool_Tutorial/edit/main/episodes/01-quickstart.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Estimated time: <i aria-hidden="true" data-feather="clock"></i> 10 minutes</p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<blockquote>
<h2 id="what-is-the-purpose-of-the-quickstart-guide">What is the purpose
of the quickstart guide?</h2>
<ul>
<li>The purpose of the quickstart guide is to enable a user of
ESMValTool to run ESMValTool as quickly as possible by making the bare
minimum number of changes. {: .discussion}</li>
</ul>
</blockquote>
<blockquote>
<h2 id="how-do-i-load-and-check-the-esmvaltool-environment">How do I
load and check the ESMValTool environment?</h2>
<ul>
<li><p>For this quickstart guide, an assumption is made that ESMValTool
has already been installed at the site where ESMValTool will be run. If
this is not the case, see the [Installation][lesson-installation]
episode in this tutorial.</p></li>
<li><p>Load the ESMValTool environment by following the instructions at
[ESMValTool: Pre-installed versions on HPC clusters / other
servers][activate-environment].</p></li>
<li>
<p>Check the ESMValTool environment by accessing the help for
ESMValTool:</p>
<pre><code><span><span class="va">esmvaltool</span> <span class="op">-</span><span class="op">-</span><span class="va">help</span></span></code></pre>
<p>{: .language-bash} {: .challenge}</p>
</li>
</ul>
</blockquote>
<blockquote>
<h2 id="how-do-i-configure-esmvaltool">How do I configure
ESMValTool?</h2>
<ul>
<li>
<p>Create the ESMValTool user configuration file (the file is
written by default to <code>~/.esmvaltool/config-user.yml</code>):</p>
<pre><code>esmvaltool config get_config_user</code></pre>
<p>{: .language-bash}</p>
</li>
<li><p>Edit the ESMValTool user configuration file using your favourite
text editor to uncomment the lines relating to the site where ESMValTool
will be run.</p></li>
<li><p>For more details about the ESMValTool user configuration file see
the [Configuration][lesson-configuration] episode in this tutorial. {:
.challenge}</p></li>
</ul>
</blockquote>
<blockquote>
<h2 id="how-do-i-run-a-recipe">How do I run a recipe?</h2>
<ul>
<li>
<p>Run the example Python recipe:</p>
<pre><code>esmvaltool run examples/recipe_python.yml </code></pre>
<p>{: .language-bash}</p>
</li>
<li>
<p>Wait for the recipe to complete. If the recipe completes
successfully, the last line printed to screen at the end of the log will
look something like:</p>
<pre><code>YYYY-MM-DD HH:mm:SS, NNN UTC [NNNNN] INFO    Run was successful</code></pre>
<p>{: .language-bash}</p>
</li>
<li>
<p>View the output of the recipe by opening the HTML file produced
by ESMValTool (the location of this file is printed to screen near the
end of the log):</p>
<pre><code>YYYY-MM-DD HH:mm:SS, NNN UTC [NNNNN] INFO    Wrote recipe output to:
file:///$HOME/esmvaltool_output/recipe_python_&lt;date&gt;_&lt;time&gt;/index.html</code></pre>
<p>{: .language-bash}</p>
</li>
<li><p>For more details about running recipes see the [Running your
first recipe][lesson-recipe] episode in this tutorial. {:
.challenge}</p></li>
</ul>
</blockquote>
<p>{% include links.md %} <!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 --></p></section><section id="aio-02-installation"><p>Content from <a href="02-installation.html">Installation</a></p>
<hr>
<p>Last updated on 2024-11-21 |

        <a href="https://github.com/ehogan/ESMValTool_Tutorial/edit/main/episodes/02-installation.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Estimated time: <i aria-hidden="true" data-feather="clock"></i> 20 minutes</p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<section><h2 class="section-heading" id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<hr class="half-width">
<p>The instructions help with the installation of ESMValTool on
operating systems like Linux/MacOSX/Windows. We use the <a href="https://mamba.readthedocs.io/en/latest/index.html" class="external-link">Mamba</a>
package manager to install the ESMValTool. Other installation methods
are also available; they can be found in the <a href="https://docs.esmvaltool.org/en/latest/quickstart/installation.html" class="external-link">documentation</a>.
We will first install Mamba, and then ESMValTool. We end this chapter by
testing that the installation was successful.</p>
<p>Before we begin, here are all the possible ways in which you can use
ESMValTool depending on your level of expertise or involvement with
ESMValTool and associated software such as GitHub and Mamba.</p>
<ol style="list-style-type: decimal">
<li>If you have access to a server where ESMValTool is already installed
as a module, for e.g., the <a href="https://help.jasmin.ac.uk/article%20/4955-community-software-esmvaltool" class="external-link">CEDA
JASMIN</a> server, you can simply load the module with the following
command:</li>
</ol>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="ex">module</span> load esmvaltool</span></code></pre>
</div>
<p>After loading <code>esmvaltool</code>, we can start using ESMValTool
right away. Please see the <a href="%7B%7B%20page.root%20%7D%7D%7B%%20link%20_episodes/03-configuration.md%20%%7D">next
lesson</a>. 2. If you would like to install ESMValTool as a mamba
package, then this lesson will tell you how! 3. If you would like to
start experimenting with existing diagnostics or contributing to
ESMvalTool, please see the instructions for source installation in the
lesson <a href="%7B%7B%20page.root%20%7D%7D%7B%%20link%20_episodes/07-development-setup.md%20%%7D">Development
and contribution</a> and in the <a href="https://docs.esmvaltool.org/en/latest/quickstart/installation.html" class="external-link">documentation</a>.</p>
<blockquote>
<h2 id="install-esmvaltool-on-windows">Install ESMValTool on
Windows</h2>
<p>ESMValTool does not directly support Windows, but successful usage
has been reported through the <a href="https://docs.microsoft.com/en-us/windows/wsl/" class="external-link">Windows Subsystem
for Linux(WSL)</a>, available in Windows 10. To install the WSL please
follow the instructions <a href="https://docs.microsoft.com/en-us/windows/wsl/install-win10" class="external-link">on the
Windows Documentation page</a>. After installing the WSL, installation
can be done using the same instructions for <a href="#install-esmvaltool-on-linuxmacosx">Linux/MacOSX</a>. {:
.callout}</p>
</blockquote>
</section><section><h2 class="section-heading" id="install-esmvaltool-on-linuxmacosx">Install ESMValTool on Linux/MacOSX<a class="anchor" aria-label="anchor" href="#install-esmvaltool-on-linuxmacosx"></a>
</h2>
<hr class="half-width">
<div class="section level3">
<h3 id="install-mamba">Install Mamba<a class="anchor" aria-label="anchor" href="#install-mamba"></a>
</h3>
<p>ESMValTool is distributed using <a href="https://mamba.readthedocs.io/en/latest/index.html" class="external-link">Mamba</a>. To
install mamba on <code>Linux</code> or <code>MacOSX</code>, follow the
instructions below:</p>
<ol style="list-style-type: decimal">
<li><p>Please download the installation file for the latest Mamba
version <a href="https://github.com/conda-forge/miniforge#mambaforge" class="external-link">here</a>.</p></li>
<li>
<p>Next, run the installer from the place where you downloaded
it:</p>
<p>On <code>Linux</code>:</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="fu">bash</span> Mambaforge-Linux-x86_64.sh</span></code></pre>
</div>
<p>On <code>MacOSX</code>:</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="fu">bash</span> Mambaforge-MacOSX-x86_64.sh</span></code></pre>
</div>
</li>
<li><p>Follow the instructions in the installer. The defaults should
normally suffice.</p></li>
<li><p>You will need to restart your terminal for the changes to have
effect.</p></li>
<li>
<p>We recommend updating mamba before the esmvaltool installation.
To do so, run:</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="ex">mamba</span> update <span class="at">--name</span> base mamba</span></code></pre>
</div>
</li>
<li>
<p>Verify you have a working mamba installation by:</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="fu">which</span> mamba</span></code></pre>
</div>
<p>This should show the path to your mamba executable,
e.g. <code>~/mambaforge/bin/mamba</code>.</p>
</li>
</ol>
<p>For more information about installing mamba, see <a href="https://docs.esmvaltool.org/en%20/latest/quickstart/installation.html#mamba-installation" class="external-link">the
mamba installation documentation</a>.</p>
</div>
<div class="section level3">
<h3 id="install-the-esmvaltool-package">Install the ESMValTool package<a class="anchor" aria-label="anchor" href="#install-the-esmvaltool-package"></a>
</h3>
<p>The ESMValTool package contains diagnostics scripts in four
languages: R, Python, Julia and NCL. This introduces a lot of
dependencies, and therefore the installation can take quite long. It is,
however, possible to install ‘subpackages’ for each of the languages.
The following (sub)packages are available:</p>
<ul>
<li><code>esmvaltool-python</code></li>
<li><code>esmvaltool-ncl</code></li>
<li><code>esmvaltool-r</code></li>
<li>
<code>esmvaltool</code> –&gt; the complete package, i.e. the
combination of the above.</li>
</ul>
<p>For the tutorial, we will install the complete package. Thus, to
install the ESMValTool package, run</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="ex">mamba</span> create <span class="at">--name</span> esmvaltool esmvaltool </span></code></pre>
</div>
<p>On MacOSX ESMValTool functionalities in Julia, NCL, and R are not
supported. To install a Mamba environment on MacOSX, please refer to
specific <a href="https://%20docs.esmvaltool.org/en/latest/quickstart/installation.html#installation-on-%20macosx" class="external-link">information</a>.</p>
<p>This will create a new <a href="https://docs.conda.io/projects/conda/en/latest/user-guide/tasks%20/manage-environments.html" class="external-link">Mamba
environment</a> called <code>esmvaltool</code>, with the ESMValTool
package and all of its dependencies installed in it.</p>
<blockquote>
<h2 id="common-issues">Common issues</h2>
<p>You find a list of common installation problems and their solutions
in the <a href="https://docs.esmvaltool.org/en/latest/quickstart/installation%20.html#common-installation-problems-and-their-solutions" class="external-link">documentation</a>.</p>
<p>{: .callout}</p>
</blockquote>
</div>
<div class="section level3">
<h3 id="install-julia">Install Julia<a class="anchor" aria-label="anchor" href="#install-julia"></a>
</h3>
<p>Some ESMValTool diagnostics are written in the Julia programming
language. If you want a full installation of ESMValTool including Julia
diagnostics, you need to make sure Julia is installed before installing
ESMValTool.</p>
<p>In this tutorial, we will not use Julia, but for reference, we have
listed the steps to install Julia below. Complete instructions for
installing Julia can be found on the <a href="https://julialang.org/downloads/platform/#linux_and_freebsd" class="external-link">Julia
installation page</a>.</p>
<blockquote>
<h2 id="julia-installation-instructions">Julia installation
instructions</h2>
<p>First, open a bash terminal and activate the newly created
<code>esmvaltool</code> environment.</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="ex">conda</span> activate esmvaltool</span></code></pre>
</div>
<p>Next, to install Julia via <code>mamba</code>, you can use the
following command:</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="ex">mamba</span> install julia</span></code></pre>
</div>
<p>To check that the Julia executable can be found, run</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="fu">which</span> julia</span></code></pre>
</div>
<p>to display the path to the Julia executable, it should be</p>
<pre><code>~/mambaforge/envs/esmvaltool/bin/julia</code></pre>
<p>{: .output}</p>
<p>To test that Julia is installed correctly, run</p>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="ex">julia</span></span></code></pre>
</div>
<p>to start the interactive Julia interpreter. Press <code>Ctrl+D</code>
to exit. {: .solution}</p>
</blockquote>
</div>
<div class="section level3">
<h3 id="test-that-the-installation-was-successful">Test that the installation was successful<a class="anchor" aria-label="anchor" href="#test-that-the-installation-was-successful"></a>
</h3>
<p>To test that the installation was successful, run</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="ex">conda</span> activate esmvaltool</span></code></pre>
</div>
<p>to activate the conda environment called <code>esmvaltool</code>. In
the shell prompt the active conda environment should have been changed
from <code>(base)</code> to <code>(esmvaltool)</code>.</p>
<p>Next, run</p>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="ex">esmvaltool</span> <span class="at">--help</span></span></code></pre>
</div>
<p>to display the command line help.</p>
<blockquote>
<h2 id="version-of-esmvaltool">Version of ESMValTool</h2>
<p>Can you figure out which version of ESMValTool has been
installed?</p>
<blockquote>
<h2 id="solution">Solution</h2>
<p>The <code>esmvaltool --help</code> command lists <code>version</code>
as a command to get the version</p>
<p>When you run ~~~ esmvaltool version ~~~ {: .bash} The version of
ESMValTool installed should be displayed on the screen as: ~~~
ESMValCore: 2.10.0 ESMValTool: 2.10.0 ~~~ {: .output} Note that on HPC
servers such as JASMIN, sometimes a more recent development version may
be displayed for ESMValTool, for e.g. 
<code>ESMValTool: 2.9.0.dev4+g6948d5512</code> {: .solution} {:
.challenge}</p>
</blockquote>
</blockquote>
<p>{% include links.md %}</p>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</div>
</section></section><section id="aio-03-configuration"><p>Content from <a href="03-configuration.html">Configuration</a></p>
<hr>
<p>Last updated on 2024-11-21 |

        <a href="https://github.com/ehogan/ESMValTool_Tutorial/edit/main/episodes/03-configuration.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Estimated time: <i aria-hidden="true" data-feather="clock"></i> 20 minutes</p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<section><h2 class="section-heading" id="the-configuration-file">The configuration file<a class="anchor" aria-label="anchor" href="#the-configuration-file"></a>
</h2>
<hr class="half-width">
<p>For the purposes of this tutorial, we will create a directory in our
home directory called <code>esmvaltool_tutorial</code> and use that as
our working directory. The following steps should do that:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a> <span class="fu">mkdir</span> esmvaltool_tutorial</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a> <span class="bu">cd</span> esmvaltool_tutorial</span></code></pre>
</div>
<p>The <code>config-user.yml</code> configuration file contains all the
global level information needed by ESMValTool to run. This is a <a href="https://yaml.org/spec/1.2/spec.html" class="external-link">YAML file</a>.</p>
<p>You can get the default configuration file by running:</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a>  <span class="ex">esmvaltool</span> config get_config_user <span class="at">--path</span><span class="op">=&lt;</span>target_dir<span class="op">&gt;</span></span></code></pre>
</div>
<p>The default configuration file will be downloaded to the directory
specified with the <code>--path</code> variable. For instance, you can
provide the path to your working directory as the
<code>target_dir</code>. If this option is not used, the file will be
saved to the default location:
<code>~/.esmvaltool/config-user.yml</code>, where <code>~</code> is the
path to your home directory. Note that files and directories starting
with a period are “hidden”, to see the <code>.esmvaltool</code>
directory in the terminal use <code>ls -la ~</code>. Note that if a
configuration file by that name already exists in the default location,
the <code>get_config_user</code> command will not update the file as
ESMValTool will not overwrite the file. You will have to move the file
first if you want an updated copy of the user configuration file.</p>
<p>We run a text editor called <code>nano</code> to have a look inside
the configuration file and then modify it if needed:</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a>  <span class="fu">nano</span> ~/.esmvaltool/config-user.yml</span></code></pre>
</div>
<p>Any other editor can be used, e.g.vim.</p>
<p>This file contains the information for:</p>
<ul>
<li>Output settings</li>
<li>Destination directory</li>
<li>Auxiliary data directory</li>
<li>Number of tasks that can be run in parallel</li>
<li>Rootpath to input data</li>
<li>Directory structure for the data from different projects</li>
</ul>
<blockquote>
<h2 id="text-editor-side-note">Text editor side note</h2>
<p>No matter what editor you use, you will need to know where it
searches for and saves files. If you start it from the shell, it will
(probably) use your current working directory as its default location.
We use <code>nano</code> in examples here because it is one of the least
complex text editors. Press <kbd>ctrl</kbd> + <kbd>O</kbd> to save the
file, and then <kbd>ctrl</kbd> + <kbd>X</kbd> to exit <code>nano</code>.
{: .callout}</p>
</blockquote>
</section><section><h2 class="section-heading" id="output-settings">Output settings<a class="anchor" aria-label="anchor" href="#output-settings"></a>
</h2>
<hr class="half-width">
<p>The configuration file starts with output settings that inform
ESMValTool about your preference for output. You can turn on or off the
setting by <code>true</code> or <code>false</code> values. Most of these
settings are fairly self-explanatory.</p>
<blockquote>
<h2 id="saving-preprocessed-data">Saving preprocessed data</h2>
<p>Later in this tutorial, we will want to look at the contents of the
<code>preproc</code> folder. This folder contains preprocessed data and
is removed by default when ESMValTool is run. In the configuration file,
which settings can be modified to prevent this from happening?</p>
<blockquote>
<h2 id="solution">Solution</h2>
<p>If the option <code>remove_preproc_dir</code> is set to
<code>false</code>, then the <code>preproc/</code> directory contains
all the pre-processed data and the metadata interface files. If the
option <code>save_intermediary_cubes</code> is set to <code>true</code>
then data will also be saved after each preprocessor step in the folder
<code>preproc</code>. Note that saving all intermediate results to file
will result in a considerable slowdown, and can quickly fill your disk.
{: .solution} {: .challenge}</p>
</blockquote>
</blockquote>
</section><section><h2 class="section-heading" id="destination-directory">Destination directory<a class="anchor" aria-label="anchor" href="#destination-directory"></a>
</h2>
<hr class="half-width">
<p>The destination directory is the rootpath where ESMValTool will store
its output folders containing e.g. figures, data, logs, etc. With every
run, ESMValTool automatically generates a new output folder determined
by recipe name, and date and time using the format: YYYYMMDD_HHMMSS.</p>
<blockquote>
<h2 id="set-the-destination-directory">Set the destination
directory</h2>
<p>Let’s name our destination directory <code>esmvaltool_output</code>
in the working directory. ESMValTool should write the output to this
path, so make sure you have the disk space to write output to this
directory. How do we set this in the <code>config-user.yml</code>?</p>
<blockquote>
<h2 id="solution-1">Solution</h2>
<p>We use <code>output_dir</code> entry in the
<code>config-user.yml</code> file as:</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">YAML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yaml" tabindex="0"><code class="sourceCode yaml"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="fu">output_dir</span><span class="kw">:</span><span class="at"> ./esmvaltool_output</span></span></code></pre>
</div>
<p>If the <code>esmvaltool_output</code> does not exist, ESMValTool will
generate it for you. {: .solution} {: .challenge}</p>
</blockquote>
</blockquote>
</section><section><h2 class="section-heading" id="rootpath-to-input-data">Rootpath to input data<a class="anchor" aria-label="anchor" href="#rootpath-to-input-data"></a>
</h2>
<hr class="half-width">
<p>ESMValTool uses several categories (in ESMValTool, this is referred
to as projects) for input data based on their source. The current
categories in the configuration file are mentioned below. For example,
CMIP is used for a dataset from the Climate Model Intercomparison
Project whereas OBS may be used for an observational dataset. More
information about the projects used in ESMValTool is available in the <a href="https://docs.esmvaltool.org/projects/esmvalcore/en/latest/%20quickstart/find_data.html" class="external-link">documentation</a>.
When using ESMValTool on your own machine, you can create a directory to
download climate model data or observation data sets and let the tool
use data from there. It is also possible to ask ESMValTool to download
climate model data as needed. This can be done by specifying a download
directory and by setting the option to download data as shown below.</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">YAML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yaml" tabindex="0"><code class="sourceCode yaml"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="co"># Directory for storing downloaded climate data</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a><span class="fu">download_dir</span><span class="kw">:</span><span class="at"> ~/climate_data</span></span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a><span class="fu">search_esgf</span><span class="kw">:</span><span class="at"> always</span></span></code></pre>
</div>
<p>If you are working offline or do not want to download the data then
set the option above to <code>never</code>. If you want to download data
only when the necessary files are missing at the usual location, you can
set the option to <code>when_missing</code>.</p>
<p>The <code>rootpath</code> specifies the directories where ESMValTool
will look for input data. For each category, you can define either one
path or several paths as a list. For example:</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">YAML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yaml" tabindex="0"><code class="sourceCode yaml"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="fu">rootpath</span><span class="kw">:</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a><span class="at">  </span><span class="fu">CMIP5</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at">~/cmip5_inputpath1</span><span class="kw">,</span><span class="at"> ~/cmip5_inputpath2</span><span class="kw">]</span></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a><span class="at">  </span><span class="fu">OBS</span><span class="kw">:</span><span class="at"> ~/obs_inputpath</span></span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a><span class="at">  </span><span class="fu">RAWOBS</span><span class="kw">:</span><span class="at"> ~/rawobs_inputpath</span></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a><span class="at">  </span><span class="fu">default</span><span class="kw">:</span><span class="at"> ~/climate_data</span></span></code></pre>
</div>
<p>These are typically available in the default configuration file you
downloaded, so simply removing the machine specific lines should be
sufficient to access input data.</p>
<blockquote>
<h2 id="set-the-correct-rootpath">Set the correct rootpath</h2>
<p>In this tutorial, we will work with data from <a href="https://esgf-node.llnl.gov/projects/cmip5/" class="external-link">CMIP5</a> and <a href="https://esgf-node.llnl.gov/projects/cmip6" class="external-link">CMIP6</a>. How can we
modify the <code>rootpath</code> to make sure the data path is set
correctly for both CMIP5 and CMIP6? Note: to get the data, check the
instructions in <a href="%7B%7B%20page.root%20%7D%7D%7B%%20link%20setup.md%20%%7D">Setup</a>.</p>
<blockquote>
<h2 id="solution-2">Solution</h2>
<ul>
<li>Are you working on your own local machine? You need to add the root
path of the folder where the data is available to the
<code>config-user.yml</code> file as:</li>
</ul>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">YAML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yaml" tabindex="0"><code class="sourceCode yaml"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="at">  </span><span class="fu">rootpath</span><span class="kw">:</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a><span class="at">  ...</span></span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a><span class="at">    </span><span class="fu">CMIP5</span><span class="kw">:</span><span class="at"> ~/esmvaltool_tutorial/data</span></span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a><span class="at">    </span><span class="fu">CMIP6</span><span class="kw">:</span><span class="at"> ~/esmvaltool_tutorial/data</span></span></code></pre>
</div>
<ul>
<li>Are you working on your local machine and have downloaded data using
ESMValTool? You need to add the root path of the folder where the data
has been downloaded to as specified in the
<code>download_dir</code>.</li>
</ul>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">YAML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yaml" tabindex="0"><code class="sourceCode yaml"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="fu">rootpath</span><span class="kw">:</span></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a><span class="co">...</span></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a><span class="co">  CMIP5: ~/climate_data</span></span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a><span class="co">  CMIP6: ~/climate_data</span></span></code></pre>
</div>
<ul>
<li>Are you working on a computer cluster like Jasmin or DKRZ?
Site-specific path to the data for JASMIN/DKRZ/ETH/IPSL are already
listed at the end of the <code>config-user.yml</code> file. You need to
uncomment the related lines. For example, on JASMIN:</li>
</ul>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">YAML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yaml" tabindex="0"><code class="sourceCode yaml"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="fu">auxiliary_data_dir</span><span class="kw">:</span><span class="at"> /gws/nopw/j04/esmeval/aux_data/AUX</span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a><span class="fu">rootpath</span><span class="kw">:</span><span class="at"> </span></span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a><span class="at"> </span><span class="fu">CMIP6</span><span class="kw">:</span><span class="at"> /badc/cmip6/data/CMIP6</span></span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a><span class="at"> </span><span class="fu">CMIP5</span><span class="kw">:</span><span class="at"> /badc/cmip5/data/cmip5/output1</span></span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a><span class="at"> </span><span class="fu">OBS</span><span class="kw">:</span><span class="at"> /gws/nopw/j04/esmeval/obsdata-v2</span></span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a><span class="at"> </span><span class="fu">OBS6</span><span class="kw">:</span><span class="at"> /gws/nopw/j04/esmeval/obsdata-v2</span></span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a><span class="at"> </span><span class="fu">obs4MIPs</span><span class="kw">:</span><span class="at"> /gws/nopw/j04/esmeval/obsdata-v2</span></span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a><span class="at"> </span><span class="fu">ana4mips</span><span class="kw">:</span><span class="at"> /gws/nopw/j04/esmeval/obsdata-v2</span></span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a><span class="at"> </span><span class="fu">default</span><span class="kw">:</span><span class="at"> /gws/nopw/j04/esmeval/obsdata-v2</span></span></code></pre>
</div>
<ul>
<li>For more information about setting the rootpath, see also the
ESMValTool <a href="https://docs.esmvaltool.org/projects/esmvalcore/en/latest/%20quickstart/find_data.html" class="external-link">documentation</a>.
{: .solution} {: .challenge}</li>
</ul>
</blockquote>
</blockquote>
</section><section><h2 class="section-heading" id="directory-structure-for-the-data-from-different-projects">Directory structure for the data from different projects<a class="anchor" aria-label="anchor" href="#directory-structure-for-the-data-from-different-projects"></a>
</h2>
<hr class="half-width">
<p>Input data can be from various models, observations and reanalysis
data that adhere to the <a href="https://cmor.llnl.gov/" class="external-link">CF/CMOR
standard</a>. The <code>drs</code> setting describes the file
structure.</p>
<p>The <code>drs</code> setting describes the file structure for several
projects (e.g. CMIP6, CMIP5, obs4mips, OBS6, OBS) on several key
machines (e.g. BADC, CP4CDS, DKRZ, ETHZ, SMHI, BSC). For more
information about <code>drs</code>, you can visit the ESMValTool
documentation on <a href="https://docs.esmvaltool.org/projects/esmvalcore/%20en/latest/quickstart/find_data.html#cmor-drs" class="external-link">Data
Reference Syntax (DRS)</a>.</p>
<blockquote>
<h2 id="set-the-correct-drs">Set the correct drs</h2>
<p>In this lesson, we will work with data from <a href="https://esgf-node.llnl.gov/projects/cmip5/" class="external-link">CMIP5</a> and <a href="https://esgf-node.llnl.gov/projects/cmip6/" class="external-link">CMIP6</a>. How can we
set the correct <code>drs</code>?</p>
<blockquote>
<h2 id="solution-3">Solution</h2>
<ul>
<li>Are you working on your own local machine? You need to set the
<code>drs</code> of the data in the <code>config-user.yml</code> file
as:</li>
</ul>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">YAML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yaml" tabindex="0"><code class="sourceCode yaml"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="at">  </span><span class="fu">drs</span><span class="kw">:</span></span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a><span class="at">    </span><span class="fu">CMIP5</span><span class="kw">:</span><span class="at"> default</span></span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a><span class="at">    </span><span class="fu">CMIP6</span><span class="kw">:</span><span class="at"> default</span></span></code></pre>
</div>
<ul>
<li>Are you asking ESMValTool to download the data for use with your
diagnostics? You need to set the <code>drs</code> of the data in the
<code>config-user.yml</code> file as:</li>
</ul>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">YAML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yaml" tabindex="0"><code class="sourceCode yaml"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="at">   </span><span class="fu">drs</span><span class="kw">:</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a><span class="at">     </span><span class="fu">CMIP5</span><span class="kw">:</span><span class="at"> ESGF</span></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a><span class="at">     </span><span class="fu">CMIP6</span><span class="kw">:</span><span class="at"> ESGF</span></span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a><span class="at">     </span><span class="fu">CORDEX</span><span class="kw">:</span><span class="at"> ESGF</span></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a><span class="at">     </span><span class="fu">obs4MIPs</span><span class="kw">:</span><span class="at"> ESGF</span></span></code></pre>
</div>
<ul>
<li>Are you working on a computer cluster like Jasmin or DKRZ?
Site-specific <code>drs</code> of the data are already listed at the end
of the <code>config-user.yml</code> file. You need to uncomment the
related lines. For example, on Jasmin:</li>
</ul>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">YAML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yaml" tabindex="0"><code class="sourceCode yaml"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="co">  # Site-specific entries: Jasmin</span></span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a><span class="co">  # Uncomment the lines below to locate data on JASMIN</span></span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a><span class="at">  </span><span class="fu">drs</span><span class="kw">:</span></span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a><span class="at">    </span><span class="fu">CMIP6</span><span class="kw">:</span><span class="at"> BADC</span></span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a><span class="at">    </span><span class="fu">CMIP5</span><span class="kw">:</span><span class="at"> BADC</span></span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a><span class="at">    </span><span class="fu">OBS</span><span class="kw">:</span><span class="at"> default</span></span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a><span class="at">    </span><span class="fu">OBS6</span><span class="kw">:</span><span class="at"> default</span></span>
<span id="cb12-8"><a href="#cb12-8" tabindex="-1"></a><span class="at">    </span><span class="fu">obs4mips</span><span class="kw">:</span><span class="at"> default</span></span>
<span id="cb12-9"><a href="#cb12-9" tabindex="-1"></a><span class="at">    </span><span class="fu">ana4mips</span><span class="kw">:</span><span class="at"> default</span></span></code></pre>
</div>
<p>{: .solution} {: .challenge}</p>
</blockquote>
</blockquote>
<blockquote>
<h2 id="explain-the-default-drs-if-working-on-local-machine">Explain the
default drs (if working on local machine)</h2>
<ol style="list-style-type: decimal">
<li>In the previous exercise, we set the <code>drs</code> of CMIP5 data
to <code>default</code>. Can you explain why?</li>
<li>Have a look at the directory structure of the <code>OBS</code> data.
There is a folder called <code>Tier1</code>. What does it mean?</li>
</ol>
<blockquote>
<h2 id="solution-4">Solution</h2>
<ol style="list-style-type: decimal">
<li><p><code>drs: default</code> is one way to retrieve data from a ROOT
directory that has no DRS-like structure. <code>default</code> indicates
that all the files are in a folder without any structure.</p></li>
<li><p>Observational data are organized in Tiers depending on their
level of public availability. Therefore the default directory must be
structured accordingly with sub-directories <code>TierX</code>
e.g. Tier1, Tier2 or Tier3, even when <code>drs: default</code>. More
details can be found in the <a href="https://docs.esmvaltool.org/projects/esmvalcore/en/latest/%20quickstart/find_data.html#observational-data" class="external-link">documentation</a>.</p></li>
</ol>
<p>{: .solution} {: .challenge}</p>
</blockquote>
</blockquote>
</section><section><h2 class="section-heading" id="other-settings">Other settings<a class="anchor" aria-label="anchor" href="#other-settings"></a>
</h2>
<hr class="half-width">
<blockquote>
<h2 id="auxiliary-data-directory">Auxiliary data directory</h2>
<p>The <code>auxiliary_data_dir</code> setting is the path where any
required additional auxiliary data files are stored. This location
allows us to tell the diagnostic script where to find the files if they
can not be downloaded at runtime. This option should not be used for
model or observational datasets, but for data files (e.g. shape files)
used in plotting such as coastline descriptions and if you want to feed
some additional data (e.g. shape files) to your recipe.</p>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">YAML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yaml" tabindex="0"><code class="sourceCode yaml"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="fu">auxiliary_data_dir</span><span class="kw">:</span><span class="at"> ~/auxiliary_data</span></span></code></pre>
</div>
<p>See more information in ESMValTool <a href="https://docs.esmvaltool.org/projects/ESMValCore/en/latest/quickstart%20/configure.html?highlight=auxiliary_data#user-configuration-file" class="external-link">document</a>.
{: .callout}</p>
</blockquote>
<blockquote>
<h2 id="number-of-parallel-tasks">Number of parallel tasks</h2>
<p>This option enables you to perform parallel processing. You can
choose the number of tasks in parallel as 1/2/3/4/… or you can set it to
<code>null</code>. That tells ESMValTool to use the maximum number of
available CPUs. For the purpose of the tutorial, please set ESMValTool
use only 1 cpu:</p>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">YAML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yaml" tabindex="0"><code class="sourceCode yaml"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="fu">max_parallel_tasks</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span></code></pre>
</div>
<p>In general, if you run out of memory, try setting
<code>max_parallel_tasks</code> to 1. Then, check the amount of memory
you need for that by inspecting the file
<code>run/resource_usage.txt</code> in the output directory. Using the
number there you can increase the number of parallel tasks again to a
reasonable number for the amount of memory available in your system. {:
.callout}</p>
</blockquote>
<blockquote>
<h2 id="make-your-own-configuration-file">Make your own configuration
file</h2>
<p>It is possible to have several configuration files with different
purposes, for example: config-user_formalised_runs.yml,
config-user_debugging.yml. In this case, you have to pass the path of
your own configuration file as a command-line option when running the
ESMValTool. We will learn how to do this in the <a href="%7B%7B%20page.root%20%7D%7D%7B%%20link%20_episodes/04-recipe.md%20%%7D">next
lesson</a>. {: .callout}</p>
</blockquote>
<p>{% include links.md %}</p>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</section></section><section id="aio-04-recipe"><p>Content from <a href="04-recipe.html">Running your first recipe</a></p>
<hr>
<p>Last updated on 2024-11-21 |

        <a href="https://github.com/ehogan/ESMValTool_Tutorial/edit/main/episodes/04-recipe.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Estimated time: <i aria-hidden="true" data-feather="clock"></i> 30 minutes</p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<p>This episode describes how ESMValTool recipes work, how to run a
recipe and how to explore the recipe output. By the end of this episode,
you should be able to run your first recipe, look at the recipe output,
and make small modifications.</p>
<section><h2 class="section-heading" id="running-an-existing-recipe">Running an existing recipe<a class="anchor" aria-label="anchor" href="#running-an-existing-recipe"></a>
</h2>
<hr class="half-width">
<p>The recipe format has briefly been introduced in the
[Introduction][lesson-introduction] episode. To see all the recipes that
are shipped with ESMValTool, type</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="ex">esmvaltool</span> recipes list</span></code></pre>
</div>
<p>We will start by running <a href="https://docs.esmvaltool.%20org/en/latest/recipes/recipe_examples.html" class="external-link">examples/recipe_python.yml</a></p>
<pre><code>esmvaltool run examples/recipe_python.yml</code></pre>
<p>or if you have the user configuration file in your current directory
then</p>
<pre><code>esmvaltool run --config_file ./config-user.yml examples/recipe_python.yml</code></pre>
<p>If everything is okay, you should see that ESMValTool is printing a
lot of output to the command line. The final message should be “Run was
successful”. The exact output varies depending on your machine, but it
should look something like the example log output on terminal below.</p>
<p>{% include example_output.txt %}</p>
<blockquote>
<h2 id="pro-tip-esmvaltool-search-paths">Pro tip: ESMValTool search
paths</h2>
<p>You might wonder how ESMValTool was able find the recipe file, even
though it’s not in your working directory. All the recipe paths printed
from <code>esmvaltool recipes list</code> are relative to ESMValTool’s
installation location. This is where ESMValTool will look if it cannot
find the file by following the path from your working directory. {:
.callout}</p>
</blockquote>
</section><section><h2 class="section-heading" id="investigating-the-log-messages">Investigating the log messages<a class="anchor" aria-label="anchor" href="#investigating-the-log-messages"></a>
</h2>
<hr class="half-width">
<p>Let’s dissect what’s happening here.</p>
<blockquote>
<h2 id="output-files-and-directories">Output files and directories</h2>
<p>After the banner and general information, the output starts with some
important locations.</p>
<ol style="list-style-type: decimal">
<li>Did ESMValTool use the right config file?</li>
<li>What is the path to the example recipe?</li>
<li>What is the main output folder generated by ESMValTool?</li>
<li>Can you guess what the different output directories are for?</li>
<li>ESMValTool creates two log files. What is the difference?</li>
</ol>
<blockquote>
<h2 id="answers">Answers</h2>
<ol style="list-style-type: decimal">
<li>The config file should be the one we edited in the previous episode,
something like
<code>/home/&lt;username&gt;/.esmvaltool/config-user.yml</code> or
<code>~/esmvaltool_tutorial/config-user.yml</code>.</li>
<li>ESMValTool found the recipe in its installation directory, something
like
<code>/home/users/username/mambaforge/envs/esmvaltool/bin/esmvaltool/recipes/examples/</code>
or if you are using a pre-installed module on a server, something like
<code>/apps/jasmin/community/esmvaltool/ESMValTool_&lt;version&gt; /esmvaltool/recipes/examples/recipe_python.yml</code>,
where <code>&lt;version&gt;</code> is the latest release.</li>
<li>ESMValTool creates a time-stamped output directory for every run. In
this case, it should be something like
<code>recipe_python_YYYYMMDD_HHMMSS</code>. This folder is made inside
the output directory specified in the previous episode:
<code>~/esmvaltool_tutorial/esmvaltool_output</code>.</li>
<li>There should be four output folders:
<ul>
<li>
<code>plots/</code>: this is where output figures are stored.</li>
<li>
<code>preproc/</code>: this is where pre-processed data are
stored.</li>
<li>
<code>run/</code>: this is where esmvaltool stores general
information about the run, such as log messages and a copy of the recipe
file.</li>
<li>
<code>work/</code>: this is where output files (not figures) are
stored.</li>
</ul>
</li>
<li>The log files are:
<ul>
<li>
<code>main_log.txt</code> is a copy of the command-line output</li>
<li>
<code>main_log_debug.txt</code> contains more detailed information
that may be useful for debugging.</li>
</ul>
</li>
</ol>
<p>{: .solution} {: .challenge}</p>
</blockquote>
</blockquote>
<blockquote>
<h2 id="debugging-no-preproc-directory">Debugging: No ‘preproc’
directory?</h2>
<p>If you’re missing the preproc directory, then your
<code>config-user.yml</code> file has the value
<code>remove_preproc_dir</code> set to <code>true</code> (this is used
to save disk space). Please set this value to <code>false</code> and run
the recipe again.</p>
<p>{: .callout}</p>
</blockquote>
<p>After the output locations, there are two main sections that can be
distinguished in the log messages:</p>
<ul>
<li>Creating tasks</li>
<li>Executing tasks</li>
</ul>
<blockquote>
<h2 id="analyse-the-tasks">Analyse the tasks</h2>
<p>List all the tasks that ESMValTool is executing for this recipe. Can
you guess what this recipe does?</p>
<blockquote>
<h2 id="answer">Answer</h2>
<p>Just after all the ‘creating tasks’ and before ‘executing tasks’, we
find the following line in the output:</p>
<pre><code>[134535] INFO    These tasks will be executed: map/tas, timeseries/tas_global,
timeseries/script1, map/script1, timeseries/tas_amsterdam</code></pre>
<p>So there are three tasks related to timeseries: global temperature,
Amsterdam temperature, and a script (<em>tas</em>: near-surface air
temperature). And then there are two tasks related to a map: something
with temperature, and again a script. {: .solution} {: .challenge}</p>
</blockquote>
</blockquote>
</section><section><h2 class="section-heading" id="examining-the-recipe-file">Examining the recipe file<a class="anchor" aria-label="anchor" href="#examining-the-recipe-file"></a>
</h2>
<hr class="half-width">
<p>To get more insight into what is happening, we will have a look at
the recipe file itself. Use the following command to copy the recipe to
your working directory</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="ex">esmvaltool</span> recipes get examples/recipe_python.yml</span></code></pre>
</div>
<p>Now you should see the recipe file in your working directory (type
<code>ls</code> to verify). Use the <code>nano</code> editor to open
this file:</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="fu">nano</span> recipe_python.yml</span></code></pre>
</div>
<p>For reference, you can also view the recipe by unfolding the box
below.</p>
<blockquote>
<h2 id="recipe_python.yml">recipe_python.yml</h2>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">YAML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yaml" tabindex="0"><code class="sourceCode yaml"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="co"># ESMValTool</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a><span class="co"># recipe_python.yml</span></span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a><span class="co"># See https://docs.esmvaltool.org/en/latest/recipes/recipe_examples.html</span></span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a><span class="co"># for a description of this recipe.</span></span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a><span class="co"># See https://docs.esmvaltool.org/projects/esmvalcore/en/latest/recipe/overview.html</span></span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a><span class="co"># for a description of the recipe format.</span></span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a><span class="pp">---</span></span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a><span class="fu">documentation</span><span class="kw">:</span></span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a><span class="fu"> description</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb7-12"><a href="#cb7-12" tabindex="-1"></a>   Example recipe that plots a map and timeseries of temperature.</span>
<span id="cb7-13"><a href="#cb7-13" tabindex="-1"></a></span>
<span id="cb7-14"><a href="#cb7-14" tabindex="-1"></a><span class="at"> </span><span class="fu">title</span><span class="kw">:</span><span class="at"> Recipe that runs an example diagnostic written in Python.</span></span>
<span id="cb7-15"><a href="#cb7-15" tabindex="-1"></a></span>
<span id="cb7-16"><a href="#cb7-16" tabindex="-1"></a><span class="at"> </span><span class="fu">authors</span><span class="kw">:</span></span>
<span id="cb7-17"><a href="#cb7-17" tabindex="-1"></a><span class="at">   </span><span class="kw">-</span><span class="at"> andela_bouwe</span></span>
<span id="cb7-18"><a href="#cb7-18" tabindex="-1"></a><span class="at">   </span><span class="kw">-</span><span class="at"> righi_mattia</span></span>
<span id="cb7-19"><a href="#cb7-19" tabindex="-1"></a></span>
<span id="cb7-20"><a href="#cb7-20" tabindex="-1"></a><span class="at"> </span><span class="fu">maintainer</span><span class="kw">:</span></span>
<span id="cb7-21"><a href="#cb7-21" tabindex="-1"></a><span class="at">   </span><span class="kw">-</span><span class="at"> schlund_manuel</span></span>
<span id="cb7-22"><a href="#cb7-22" tabindex="-1"></a></span>
<span id="cb7-23"><a href="#cb7-23" tabindex="-1"></a><span class="at"> </span><span class="fu">references</span><span class="kw">:</span></span>
<span id="cb7-24"><a href="#cb7-24" tabindex="-1"></a><span class="at">   </span><span class="kw">-</span><span class="at"> acknow_project</span></span>
<span id="cb7-25"><a href="#cb7-25" tabindex="-1"></a></span>
<span id="cb7-26"><a href="#cb7-26" tabindex="-1"></a><span class="at"> </span><span class="fu">projects</span><span class="kw">:</span></span>
<span id="cb7-27"><a href="#cb7-27" tabindex="-1"></a><span class="at">   </span><span class="kw">-</span><span class="at"> esmval</span></span>
<span id="cb7-28"><a href="#cb7-28" tabindex="-1"></a><span class="at">   </span><span class="kw">-</span><span class="at"> c3s-magic</span></span>
<span id="cb7-29"><a href="#cb7-29" tabindex="-1"></a></span>
<span id="cb7-30"><a href="#cb7-30" tabindex="-1"></a><span class="fu">datasets</span><span class="kw">:</span></span>
<span id="cb7-31"><a href="#cb7-31" tabindex="-1"></a><span class="at"> </span><span class="kw">-</span><span class="at"> </span><span class="kw">{</span><span class="fu">dataset</span><span class="kw">:</span><span class="at"> BCC-ESM1</span><span class="kw">,</span><span class="at"> </span><span class="fu">project</span><span class="kw">:</span><span class="at"> CMIP6</span><span class="kw">,</span><span class="at"> </span><span class="fu">exp</span><span class="kw">:</span><span class="at"> historical</span><span class="kw">,</span><span class="at"> </span><span class="fu">ensemble</span><span class="kw">:</span><span class="at"> r1i1p1f1</span><span class="kw">,</span><span class="at"> </span><span class="fu">grid</span><span class="kw">:</span><span class="at"> gn</span><span class="kw">}</span></span>
<span id="cb7-32"><a href="#cb7-32" tabindex="-1"></a><span class="at"> </span><span class="kw">-</span><span class="at"> </span><span class="kw">{</span><span class="fu">dataset</span><span class="kw">:</span><span class="at"> bcc-csm1-1</span><span class="kw">,</span><span class="at"> </span><span class="fu">project</span><span class="kw">:</span><span class="at"> CMIP5</span><span class="kw">,</span><span class="at"> </span><span class="fu">exp</span><span class="kw">:</span><span class="at"> historical</span><span class="kw">,</span><span class="at"> </span><span class="fu">ensemble</span><span class="kw">:</span><span class="at"> r1i1p1</span><span class="kw">}</span></span>
<span id="cb7-33"><a href="#cb7-33" tabindex="-1"></a></span>
<span id="cb7-34"><a href="#cb7-34" tabindex="-1"></a><span class="fu">preprocessors</span><span class="kw">:</span></span>
<span id="cb7-35"><a href="#cb7-35" tabindex="-1"></a><span class="co"> # See https://docs.esmvaltool.org/projects/esmvalcore/en/latest/recipe/preprocessor.html</span></span>
<span id="cb7-36"><a href="#cb7-36" tabindex="-1"></a><span class="co"> # for a description of the preprocessor functions.</span></span>
<span id="cb7-37"><a href="#cb7-37" tabindex="-1"></a></span>
<span id="cb7-38"><a href="#cb7-38" tabindex="-1"></a><span class="at"> </span><span class="fu">to_degrees_c</span><span class="kw">:</span></span>
<span id="cb7-39"><a href="#cb7-39" tabindex="-1"></a><span class="at">   </span><span class="fu">convert_units</span><span class="kw">:</span></span>
<span id="cb7-40"><a href="#cb7-40" tabindex="-1"></a><span class="at">     </span><span class="fu">units</span><span class="kw">:</span><span class="at"> degrees_C</span></span>
<span id="cb7-41"><a href="#cb7-41" tabindex="-1"></a></span>
<span id="cb7-42"><a href="#cb7-42" tabindex="-1"></a><span class="at"> </span><span class="fu">annual_mean_amsterdam</span><span class="kw">:</span></span>
<span id="cb7-43"><a href="#cb7-43" tabindex="-1"></a><span class="at">   </span><span class="fu">extract_location</span><span class="kw">:</span></span>
<span id="cb7-44"><a href="#cb7-44" tabindex="-1"></a><span class="at">     </span><span class="fu">location</span><span class="kw">:</span><span class="at"> Amsterdam</span></span>
<span id="cb7-45"><a href="#cb7-45" tabindex="-1"></a><span class="at">     </span><span class="fu">scheme</span><span class="kw">:</span><span class="at"> linear</span></span>
<span id="cb7-46"><a href="#cb7-46" tabindex="-1"></a><span class="at">   </span><span class="fu">annual_statistics</span><span class="kw">:</span></span>
<span id="cb7-47"><a href="#cb7-47" tabindex="-1"></a><span class="at">     </span><span class="fu">operator</span><span class="kw">:</span><span class="at"> mean</span></span>
<span id="cb7-48"><a href="#cb7-48" tabindex="-1"></a><span class="at">   </span><span class="fu">multi_model_statistics</span><span class="kw">:</span></span>
<span id="cb7-49"><a href="#cb7-49" tabindex="-1"></a><span class="at">     </span><span class="fu">statistics</span><span class="kw">:</span></span>
<span id="cb7-50"><a href="#cb7-50" tabindex="-1"></a><span class="at">       </span><span class="kw">-</span><span class="at"> mean</span></span>
<span id="cb7-51"><a href="#cb7-51" tabindex="-1"></a><span class="at">     </span><span class="fu">span</span><span class="kw">:</span><span class="at"> overlap</span></span>
<span id="cb7-52"><a href="#cb7-52" tabindex="-1"></a><span class="at">   </span><span class="fu">convert_units</span><span class="kw">:</span></span>
<span id="cb7-53"><a href="#cb7-53" tabindex="-1"></a><span class="at">     </span><span class="fu">units</span><span class="kw">:</span><span class="at"> degrees_C</span></span>
<span id="cb7-54"><a href="#cb7-54" tabindex="-1"></a></span>
<span id="cb7-55"><a href="#cb7-55" tabindex="-1"></a><span class="at"> </span><span class="fu">annual_mean_global</span><span class="kw">:</span></span>
<span id="cb7-56"><a href="#cb7-56" tabindex="-1"></a><span class="at">   </span><span class="fu">area_statistics</span><span class="kw">:</span></span>
<span id="cb7-57"><a href="#cb7-57" tabindex="-1"></a><span class="at">     </span><span class="fu">operator</span><span class="kw">:</span><span class="at"> mean</span></span>
<span id="cb7-58"><a href="#cb7-58" tabindex="-1"></a><span class="at">   </span><span class="fu">annual_statistics</span><span class="kw">:</span></span>
<span id="cb7-59"><a href="#cb7-59" tabindex="-1"></a><span class="at">     </span><span class="fu">operator</span><span class="kw">:</span><span class="at"> mean</span></span>
<span id="cb7-60"><a href="#cb7-60" tabindex="-1"></a><span class="at">   </span><span class="fu">convert_units</span><span class="kw">:</span></span>
<span id="cb7-61"><a href="#cb7-61" tabindex="-1"></a><span class="at">     </span><span class="fu">units</span><span class="kw">:</span><span class="at"> degrees_C</span></span>
<span id="cb7-62"><a href="#cb7-62" tabindex="-1"></a></span>
<span id="cb7-63"><a href="#cb7-63" tabindex="-1"></a><span class="fu">diagnostics</span><span class="kw">:</span></span>
<span id="cb7-64"><a href="#cb7-64" tabindex="-1"></a></span>
<span id="cb7-65"><a href="#cb7-65" tabindex="-1"></a><span class="at"> </span><span class="fu">map</span><span class="kw">:</span></span>
<span id="cb7-66"><a href="#cb7-66" tabindex="-1"></a><span class="at">   </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Global map of temperature in January 2000.</span></span>
<span id="cb7-67"><a href="#cb7-67" tabindex="-1"></a><span class="at">   </span><span class="fu">themes</span><span class="kw">:</span></span>
<span id="cb7-68"><a href="#cb7-68" tabindex="-1"></a><span class="at">     </span><span class="kw">-</span><span class="at"> phys</span></span>
<span id="cb7-69"><a href="#cb7-69" tabindex="-1"></a><span class="at">   </span><span class="fu">realms</span><span class="kw">:</span></span>
<span id="cb7-70"><a href="#cb7-70" tabindex="-1"></a><span class="at">     </span><span class="kw">-</span><span class="at"> atmos</span></span>
<span id="cb7-71"><a href="#cb7-71" tabindex="-1"></a><span class="at">   </span><span class="fu">variables</span><span class="kw">:</span></span>
<span id="cb7-72"><a href="#cb7-72" tabindex="-1"></a><span class="at">     </span><span class="fu">tas</span><span class="kw">:</span></span>
<span id="cb7-73"><a href="#cb7-73" tabindex="-1"></a><span class="at">       </span><span class="fu">mip</span><span class="kw">:</span><span class="at"> Amon</span></span>
<span id="cb7-74"><a href="#cb7-74" tabindex="-1"></a><span class="at">       </span><span class="fu">preprocessor</span><span class="kw">:</span><span class="at"> to_degrees_c</span></span>
<span id="cb7-75"><a href="#cb7-75" tabindex="-1"></a><span class="at">       </span><span class="fu">timerange</span><span class="kw">:</span><span class="at"> 2000/P1M</span></span>
<span id="cb7-76"><a href="#cb7-76" tabindex="-1"></a><span class="fu">       caption</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb7-77"><a href="#cb7-77" tabindex="-1"></a>         Global map of {long_name} in January 2000 according to {dataset}.</span>
<span id="cb7-78"><a href="#cb7-78" tabindex="-1"></a><span class="at">   </span><span class="fu">scripts</span><span class="kw">:</span></span>
<span id="cb7-79"><a href="#cb7-79" tabindex="-1"></a><span class="at">     </span><span class="fu">script1</span><span class="kw">:</span></span>
<span id="cb7-80"><a href="#cb7-80" tabindex="-1"></a><span class="at">       </span><span class="fu">script</span><span class="kw">:</span><span class="at"> examples/diagnostic.py</span></span>
<span id="cb7-81"><a href="#cb7-81" tabindex="-1"></a><span class="at">       </span><span class="fu">quickplot</span><span class="kw">:</span></span>
<span id="cb7-82"><a href="#cb7-82" tabindex="-1"></a><span class="at">         </span><span class="fu">plot_type</span><span class="kw">:</span><span class="at"> pcolormesh</span></span>
<span id="cb7-83"><a href="#cb7-83" tabindex="-1"></a><span class="at">         </span><span class="fu">cmap</span><span class="kw">:</span><span class="at"> Reds</span></span>
<span id="cb7-84"><a href="#cb7-84" tabindex="-1"></a></span>
<span id="cb7-85"><a href="#cb7-85" tabindex="-1"></a><span class="at"> </span><span class="fu">timeseries</span><span class="kw">:</span></span>
<span id="cb7-86"><a href="#cb7-86" tabindex="-1"></a><span class="at">   </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Annual mean temperature in Amsterdam and global mean since 1850.</span></span>
<span id="cb7-87"><a href="#cb7-87" tabindex="-1"></a><span class="at">   </span><span class="fu">themes</span><span class="kw">:</span></span>
<span id="cb7-88"><a href="#cb7-88" tabindex="-1"></a><span class="at">     </span><span class="kw">-</span><span class="at"> phys</span></span>
<span id="cb7-89"><a href="#cb7-89" tabindex="-1"></a><span class="at">   </span><span class="fu">realms</span><span class="kw">:</span></span>
<span id="cb7-90"><a href="#cb7-90" tabindex="-1"></a><span class="at">     </span><span class="kw">-</span><span class="at"> atmos</span></span>
<span id="cb7-91"><a href="#cb7-91" tabindex="-1"></a><span class="at">   </span><span class="fu">variables</span><span class="kw">:</span></span>
<span id="cb7-92"><a href="#cb7-92" tabindex="-1"></a><span class="at">     </span><span class="fu">tas_amsterdam</span><span class="kw">:</span></span>
<span id="cb7-93"><a href="#cb7-93" tabindex="-1"></a><span class="at">       </span><span class="fu">short_name</span><span class="kw">:</span><span class="at"> tas</span></span>
<span id="cb7-94"><a href="#cb7-94" tabindex="-1"></a><span class="at">       </span><span class="fu">mip</span><span class="kw">:</span><span class="at"> Amon</span></span>
<span id="cb7-95"><a href="#cb7-95" tabindex="-1"></a><span class="at">       </span><span class="fu">preprocessor</span><span class="kw">:</span><span class="at"> annual_mean_amsterdam</span></span>
<span id="cb7-96"><a href="#cb7-96" tabindex="-1"></a><span class="at">       </span><span class="fu">timerange</span><span class="kw">:</span><span class="at"> 1850/2000</span></span>
<span id="cb7-97"><a href="#cb7-97" tabindex="-1"></a><span class="at">       </span><span class="fu">caption</span><span class="kw">:</span><span class="at"> Annual mean {long_name} in Amsterdam according to {dataset}.</span></span>
<span id="cb7-98"><a href="#cb7-98" tabindex="-1"></a><span class="at">     </span><span class="fu">tas_global</span><span class="kw">:</span></span>
<span id="cb7-99"><a href="#cb7-99" tabindex="-1"></a><span class="at">       </span><span class="fu">short_name</span><span class="kw">:</span><span class="at"> tas</span></span>
<span id="cb7-100"><a href="#cb7-100" tabindex="-1"></a><span class="at">       </span><span class="fu">mip</span><span class="kw">:</span><span class="at"> Amon</span></span>
<span id="cb7-101"><a href="#cb7-101" tabindex="-1"></a><span class="at">       </span><span class="fu">preprocessor</span><span class="kw">:</span><span class="at"> annual_mean_global</span></span>
<span id="cb7-102"><a href="#cb7-102" tabindex="-1"></a><span class="at">       </span><span class="fu">timerange</span><span class="kw">:</span><span class="at"> 1850/2000</span></span>
<span id="cb7-103"><a href="#cb7-103" tabindex="-1"></a><span class="at">       </span><span class="fu">caption</span><span class="kw">:</span><span class="at"> Annual global mean {long_name} according to {dataset}.</span></span>
<span id="cb7-104"><a href="#cb7-104" tabindex="-1"></a><span class="at">   </span><span class="fu">scripts</span><span class="kw">:</span></span>
<span id="cb7-105"><a href="#cb7-105" tabindex="-1"></a><span class="at">     </span><span class="fu">script1</span><span class="kw">:</span></span>
<span id="cb7-106"><a href="#cb7-106" tabindex="-1"></a><span class="at">       </span><span class="fu">script</span><span class="kw">:</span><span class="at"> examples/diagnostic.py</span></span>
<span id="cb7-107"><a href="#cb7-107" tabindex="-1"></a><span class="at">       </span><span class="fu">quickplot</span><span class="kw">:</span></span>
<span id="cb7-108"><a href="#cb7-108" tabindex="-1"></a><span class="at">         </span><span class="fu">plot_type</span><span class="kw">:</span><span class="at"> plot</span></span></code></pre>
</div>
<p>{: .solution}</p>
</blockquote>
<p>Do you recognize the basic recipe structure that was introduced in
episode 1?</p>
<ul>
<li>
<strong>Documentation</strong> with relevant (citation)
information</li>
<li>
<strong>Datasets</strong> that should be analysed</li>
<li>
<strong>Preprocessors</strong> groups of common preprocessing
steps</li>
<li>
<strong>Diagnostics</strong> scripts performing more specific
evaluation steps</li>
</ul>
<blockquote>
<h2 id="analyse-the-recipe">Analyse the recipe</h2>
<p>Try to answer the following questions:</p>
<ol style="list-style-type: decimal">
<li>Who wrote this recipe?</li>
<li>Who should be approached if there is a problem with this
recipe?</li>
<li>How many datasets are analyzed?</li>
<li>What does the preprocessor called <code>annual_mean_global</code>
do?</li>
<li>Which script is applied for the diagnostic called
<code>map</code>?</li>
<li>Can you link specific lines in the recipe to the tasks that we saw
before?</li>
<li>How is the location of the city specified?</li>
<li>How is the temporal range of the data specified?</li>
</ol>
<blockquote>
<h2 id="answers-1">Answers</h2>
<ol style="list-style-type: decimal">
<li>The example recipe is written by Bouwe Andela and Mattia Righi.</li>
<li>Manuel Schlund is listed as the maintainer of this recipe.</li>
<li>Two datasets are analysed:
<ul>
<li>CMIP6 data from the model BCC-ESM1</li>
<li>CMIP5 data from the model bcc-csm1-1</li>
</ul>
</li>
<li>The preprocessor <code>annual_mean_global</code> computes an area
mean as well as annual means</li>
<li>The diagnostic called <code>map</code> executes a script referred to
as <code>script1</code>. This is a python script named
<code>examples/diagnostic.py</code>
</li>
<li>There are two diagnostics: <code>map</code> and
<code>timeseries</code>. Under the diagnostic <code>map</code> we find
two tasks:
<ul>
<li>a preprocessor task called <code>tas</code>, applying the
preprocessor called <code>to_degrees_c</code> to the variable
<code>tas</code>.</li>
<li>a diagnostic task called <code>script1</code>, applying the script
<code>examples/diagnostic.py</code> to the preprocessed data
(<code>map/tas</code>).</li>
</ul>
Under the diagnostic <code>timeseries</code> we find three tasks:
<ul>
<li>a preprocessor task called <code>tas_amsterdam</code>, applying the
preprocessor called <code>annual_mean_amsterdam</code> to the variable
<code>tas</code>.</li>
<li>a preprocessor task called <code>tas_global</code>, applying the
preprocessor called <code>annual_mean_global</code> to the variable
<code>tas</code>.</li>
<li>a diagnostic task called <code>script1</code>, applying the script
<code>examples/diagnostic.py</code> to the preprocessed data
(<code>timeseries/tas_global</code> and
<code>timeseries/tas_amsterdam</code>).</li>
</ul>
</li>
<li>The <code>extract_location</code> preprocessor is used to get data
for a specific location here. ESMValTool interpolates to the location
based on the chosen scheme. Can you tell the scheme used here? For more
ways to extract areas, see the [Area
operations][preproc-area-manipulation] page.</li>
<li>The <code>timerange</code> tag is used to extract data from a
specific time period here. The start time is <code>01/01/2000</code> and
the span of time to calculate means is <code>1 Month</code> given by
<code>P1M</code>. For more options on how to specify time ranges, see
the [timerange documentation][timeranges]. {: .solution} {:
.challenge}</li>
</ol>
</blockquote>
</blockquote>
<blockquote>
<h2 id="pro-tip-short-names-and-variable-groups">Pro tip: short names
and variable groups</h2>
<p>The preprocessor tasks in ESMValTool are called ‘variable groups’.
For the diagnostic <code>timeseries</code>, we have two variable groups:
<code>tas_amsterdam</code> and <code>tas_global</code>. Both of them
operate on the variable <code>tas</code> (as indicated by the
<code>short_name</code>), but they apply different preprocessors. For
the diagnostic <code>map</code> the variable group itself is named
<code>tas</code>, and you’ll notice that we do not explicitly provide
the <code>short_name</code>. This is a shorthand built into ESMValTool.
{: .callout}</p>
</blockquote>
<blockquote>
<h2 id="output-files">Output files</h2>
<p>Have another look at the output directory created by the ESMValTool
run.</p>
<p>Which files/folders are created by each task?</p>
<blockquote>
<h2 id="answer-1">Answer</h2>
<ul>
<li>
<strong>map/tas</strong>: creates <code>/preproc/map/tas</code>,
which contains preprocessed data for each of the input datasets, a file
called <code>metadata.yml</code> describing the contents of these
datasets and provenance information in the form of <code>.xml</code>
files.</li>
<li>
<strong>timeseries/tas_global</strong>: creates
<code>/preproc/timeseries/tas_global</code>, which contains preprocessed
data for each of the input datasets, a <code>metadata.yml</code> file
and provenance information in the form of <code>.xml</code> files.</li>
<li>
<strong>timeseries/tas_amsterdam</strong>: creates
<code>/preproc/timeseries/tas_amsterdam</code>, which contains
preprocessed data for each of the input datasets, plus a combined
<code>MultiModelMean</code>, a <code>metadata.yml</code> file and
provenance files.</li>
<li>
<strong>map/script1</strong>: creates <code>/run/map/script1</code>
with general information and a log of the diagnostic script run. It also
creates <code>/plots/map/script1/</code> and
<code>/work/map/script1</code>, which contain output figures and output
datasets, respectively. For each output file, there is also
corresponding provenance information in the form of <code>.xml</code>,
<code>.bibtex</code> and <code>.txt</code> files.</li>
<li>
<strong>timeseries/script1</strong>: creates
<code>/run/timeseries/script1</code> with general information and a log
of the diagnostic script run. It also creates
<code>/plots/timeseries/script1</code> and
<code>/work/timeseries/script1</code>, which contain output figures and
output datasets, respectively. For each output file, there is also
corresponding provenance information in the form of <code>.xml</code>,
<code>.bibtex</code> and <code>.txt</code> files.</li>
</ul>
<p>{: .solution} {: .challenge}</p>
</blockquote>
</blockquote>
<blockquote>
<h2 id="pro-tip-diagnostic-logs">Pro tip: diagnostic logs</h2>
<p>When you run ESMValTool, any log messages from the diagnostic script
are not printed on the terminal. But they are written to the
<code>log.txt</code> files in the folder
<code>/run/&lt;diag_name&gt;/log.txt</code>.</p>
<p>ESMValTool <em>does</em> print a command that can be used to re-run a
diagnostic script. When you use this the output <em>will</em> be printed
to the command line. {: .callout}</p>
</blockquote>
</section><section><h2 class="section-heading" id="modifying-the-example-recipe">Modifying the example recipe<a class="anchor" aria-label="anchor" href="#modifying-the-example-recipe"></a>
</h2>
<hr class="half-width">
<p>Let’s make a small modification to the example recipe. Notice that
now that you have copied and edited the recipe, you can use</p>
<pre><code>esmvaltool run recipe_python.yml</code></pre>
<p>to refer to your local file rather than the default version shipped
with ESMValTool.</p>
<blockquote>
<h2 id="change-your-location">Change your location</h2>
<p>Modify and run the recipe to analyse the temperature for your own
location.</p>
<blockquote>
<h2 id="solution">Solution</h2>
<p>In principle, you only have to modify the location in the
preprocessor called <code>annual_mean_amsterdam</code>. However, it is
good practice to also replace all instances of <code>amsterdam</code>
with the correct name of your location. Otherwise the log messages and
output will be confusing. You are free to modify the names of
preprocessors or diagnostics.</p>
<p>In the <code>diff</code> file below you will see the changes we have
made to the file. The top 2 lines are the filenames and the lines like
<code>@@ -39,9 +39,9 @@</code> represent the line numbers in the
original and modified file, respectively. For more info on this format,
see <a href="https://en.wikipedia.org/wiki/Diff#Unified_format" class="external-link">here</a>.</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">DIFF<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode diff" tabindex="0"><code class="sourceCode diff"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="kw">--- recipe_python.yml	</span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a><span class="dt">+++ recipe_python_london.yml	</span></span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a><span class="dt">@@ -39,9 +39,9 @@</span></span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a>    convert_units:</span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a>      units: degrees_C</span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a><span class="st">-  annual_mean_amsterdam:</span></span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a><span class="va">+  annual_mean_london:</span></span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a>    extract_location:</span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a><span class="st">-      location: Amsterdam</span></span>
<span id="cb9-11"><a href="#cb9-11" tabindex="-1"></a><span class="va">+      location: London</span></span>
<span id="cb9-12"><a href="#cb9-12" tabindex="-1"></a>      scheme: linear</span>
<span id="cb9-13"><a href="#cb9-13" tabindex="-1"></a>    annual_statistics:</span>
<span id="cb9-14"><a href="#cb9-14" tabindex="-1"></a>      operator: mean</span>
<span id="cb9-15"><a href="#cb9-15" tabindex="-1"></a><span class="dt">@@ -83,7 +83,7 @@</span></span>
<span id="cb9-16"><a href="#cb9-16" tabindex="-1"></a>          cmap: Reds</span>
<span id="cb9-17"><a href="#cb9-17" tabindex="-1"></a></span>
<span id="cb9-18"><a href="#cb9-18" tabindex="-1"></a>  timeseries:</span>
<span id="cb9-19"><a href="#cb9-19" tabindex="-1"></a><span class="st">-    description: Annual mean temperature in Amsterdam and global mean since 1850.</span></span>
<span id="cb9-20"><a href="#cb9-20" tabindex="-1"></a><span class="va">+    description: Annual mean temperature in London and global mean since 1850.</span></span>
<span id="cb9-21"><a href="#cb9-21" tabindex="-1"></a>    themes:</span>
<span id="cb9-22"><a href="#cb9-22" tabindex="-1"></a>      - phys</span>
<span id="cb9-23"><a href="#cb9-23" tabindex="-1"></a>    realms:</span>
<span id="cb9-24"><a href="#cb9-24" tabindex="-1"></a><span class="dt">@@ -92,9 +92,9 @@</span></span>
<span id="cb9-25"><a href="#cb9-25" tabindex="-1"></a>      tas_amsterdam:</span>
<span id="cb9-26"><a href="#cb9-26" tabindex="-1"></a>        short_name: tas</span>
<span id="cb9-27"><a href="#cb9-27" tabindex="-1"></a>        mip: Amon</span>
<span id="cb9-28"><a href="#cb9-28" tabindex="-1"></a><span class="st">-        preprocessor: annual_mean_amsterdam</span></span>
<span id="cb9-29"><a href="#cb9-29" tabindex="-1"></a><span class="va">+        preprocessor: annual_mean_london</span></span>
<span id="cb9-30"><a href="#cb9-30" tabindex="-1"></a>        timerange: 1850/2000</span>
<span id="cb9-31"><a href="#cb9-31" tabindex="-1"></a><span class="st">-        caption: Annual mean {long_name} in Amsterdam according to {dataset}.</span></span>
<span id="cb9-32"><a href="#cb9-32" tabindex="-1"></a><span class="va">+        caption: Annual mean {long_name} in London according to {dataset}.</span></span>
<span id="cb9-33"><a href="#cb9-33" tabindex="-1"></a>      tas_global:</span>
<span id="cb9-34"><a href="#cb9-34" tabindex="-1"></a>        short_name: tas</span>
<span id="cb9-35"><a href="#cb9-35" tabindex="-1"></a>        mip: Amon</span></code></pre>
</div>
<p>{: .solution} {: .challenge}</p>
</blockquote>
</blockquote>
<p>{% include links.md %}</p>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</section></section><section id="aio-05-conclusions"><p>Content from <a href="05-conclusions.html">Conclusion of the basic tutorial</a></p>
<hr>
<p>Last updated on 2024-11-21 |

        <a href="https://github.com/ehogan/ESMValTool_Tutorial/edit/main/episodes/05-conclusions.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Estimated time: <i aria-hidden="true" data-feather="clock"></i> 10 minutes</p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<section><h2 class="section-heading" id="congratulations">Congratulations!<a class="anchor" aria-label="anchor" href="#congratulations"></a>
</h2>
<hr class="half-width">
<p>Congratulations on completing the ESMValTool tutorial! You should be
now ready to go and start using ESMValTool independently.</p>
<p>The rest of this tutorial contains individual mini-tutorials to help
work through a specific issue (not developed yet).</p>
<div class="section level3">
<h3 id="what-next">What next?<a class="anchor" aria-label="anchor" href="#what-next"></a>
</h3>
<p>From here, there are lots of ways that you can continue to use
ESMValTool.</p>
<ul>
<li>You can start from the list of <a href="https://docs.esmvaltool.org/en/latest/recipes/index.html" class="external-link">existing
recipes</a> and run one of those.</li>
<li>You can learn how to <a href="https://docs.esmvaltool.org/en/latest/develop/index.html" class="external-link">write
your own diagnostics and recipes</a>.</li>
<li>You can <a href="https://docs.esmvaltool.org/en/latest/community/index.html" class="external-link">contribute
your recipe and diagnostics</a> back into ESMValTool.</li>
<li>You can learn how to prepare <a href="https://docs.esmvaltool.org/en/latest/input.html#observations" class="external-link">observational
datasets</a> to be suitable for use by ESMValTool.</li>
</ul>
<blockquote>
<h2 id="exercise-what-do-you-want-to-do-next"><code>Exercise: What do you want to do next?</code></h2>
<ul>
<li>Think about what you want to do with ESMValTool.
<ul>
<li>Decide what datasets and variables you want to use.</li>
<li>Is any observational data available?</li>
<li>How will you preprocess the data?</li>
<li>What will your diagnostic script need to do?</li>
<li>What will your final figure show? {: .challenge}</li>
</ul>
</li>
</ul>
</blockquote>
</div>
<div class="section level3">
<h3 id="where-can-i-get-more-information-on-esmvaltool">Where can I get more information on ESMValTool?<a class="anchor" aria-label="anchor" href="#where-can-i-get-more-information-on-esmvaltool"></a>
</h3>
<blockquote>
<h2 id="additional-resources">Additional resources:</h2>
<ul>
<li><a href="https://docs.esmvaltool.org" class="external-link">Documenation</a></li>
<li><a href="https://www.esmvaltool.org/" class="external-link">ESMValTool home page</a></li>
<li><a href="https://esmvaltool.org/references/" class="external-link">Papers</a></li>
<li><a href="https://github.com/ESMValGroup/ESMValTool" class="external-link">Source code
(ESMValTool)</a></li>
<li>
<a href="https://github.com/ESMValGroup/ESMValCore" class="external-link">Source code
(ESMValCore )</a> {: .callout}</li>
</ul>
</blockquote>
</div>
<div class="section level3">
<h3 id="where-can-i-get-more-help">Where can I get more help?<a class="anchor" aria-label="anchor" href="#where-can-i-get-more-help"></a>
</h3>
<p>There are lots of resources available to assist you in using
ESMValTool.</p>
<p>The ESMValTool <a href="https://github.com/ESMValGroup/ESMValTool/discussions" class="external-link">Discussions
page</a> is a good place to find information on general issues, or check
if your question has already been addressed. If you have a GitHub
account, you can also post your questions there.</p>
<p>If you encounter difficulties, a great starting point is to visit
issues page <a href="https://github.com/ESMValGroup/ESMValTool/issues" class="external-link">issue page</a>
to check whether your issues have already been reported or not. If they
have been reported before, suggestions provided by developers can help
you to solve the issues you encountered. Note that you will need a
GitHub account for this.</p>
<p>Additionally, there is an ESMValTool email list. Please see <a href="https://docs.esmvaltool.org/en/latest/introduction.html#user-mailing-list" class="external-link">information</a>
on how to subscribe to the user mailing list.</p>
</div>
<div class="section level3">
<h3 id="what-if-i-find-a-bug">What if I find a bug?<a class="anchor" aria-label="anchor" href="#what-if-i-find-a-bug"></a>
</h3>
<p>If you find a bug, please report it to the ESMValTool team. This will
help us fix issues, ensuring not only your uninterrupted workflow but
also contributing to the overall stability of ESMValTool for all
users.</p>
<p>To report a bug, please create a new issue using the <a href="https://github.com/ESMValGroup/ESMValTool/issues" class="external-link">issue
page</a>.</p>
<p>In your bug report, please describe the problem as clearly and as
completely as possible. You may need to include a recipe or the output
log as well.</p>
</div>
<div class="section level3">
<h3 id="how-do-i-cite-the-tutorial">How do I cite the Tutorial?<a class="anchor" aria-label="anchor" href="#how-do-i-cite-the-tutorial"></a>
</h3>
<p>Please use citation information available at <a href="https://doi.org/10.5281/zenodo.3974591" class="external-link">https://doi.org/10.5281/zenodo.3974591</a>.</p>
<p>{% include links.md %}</p>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</div>
</section></section><section id="aio-06-preprocessor"><p>Content from <a href="06-preprocessor.html">Writing your own recipe</a></p>
<hr>
<p>Last updated on 2024-11-21 |

        <a href="https://github.com/ehogan/ESMValTool_Tutorial/edit/main/episodes/06-preprocessor.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Estimated time: <i aria-hidden="true" data-feather="clock"></i> 45 minutes</p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<section><h2 class="section-heading" id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<hr class="half-width">
<p>One of the key strengths of ESMValTool is in making complex analyses
reusable and reproducible. But that doesn’t mean everything in
ESMValTool needs to be complex. Sometimes, the biggest challenge is in
keeping things simple. You probably know the ‘warming stripes’
visualization by Professor Ed Hawkins. On the site <a href="https://showyourstripes.info" class="external-link uri">https://showyourstripes.info</a>{:target=“_blank”} you can
find the same visualization for many regions in the world.</p>
<p><img src="../fig/warming_stripes.png" alt="Warming stripes" class="figure"><em>Shared by Ed Hawkins under a Creative Commons 4.0 Attribution
International licence. Source: <a href="https://showyourstripes.info" class="external-link uri">https://showyourstripes.info</a></em></p>
<p>In this episode, we will reproduce and extend this functionality with
ESMValTool. We have prepared a small Python script that takes a NetCDF
file with timeseries data, and visualizes it in the form of our desired
warming stripes figure.</p>
<p>The diagnostic script that we will use is called
<code>warming_stripes.py</code> and can be downloaded <a href="../files/warming_stripes.py">here</a>.</p>
<p>Download the file and store it in your working directory. If you
want, you may also have a look at the contents, but it is not necessary
to do so for this lesson.</p>
<p>We will write an ESMValTool recipe that takes some data, performs the
necessary preprocessing, and then runs this Python script.</p>
<blockquote>
<h2 id="drawing-up-a-plan">Drawing up a plan</h2>
<p>Previously, we saw that running ESMValTool executes a number of
tasks. What tasks do you think we will need to execute and what should
each of these tasks do to generate the warming stripes?</p>
<blockquote>
<h2 id="answer">Answer</h2>
<p>In this episode, we will need to do the following two tasks:</p>
<ul>
<li>A preprocessing task that converts the gridded temperature data to a
timeseries of global temperature anomalies</li>
<li>A diagnostic tasks that calls our Python script, taking our
preprocessed timeseries data as input.</li>
</ul>
<p>{: .solution} {: .challenge}</p>
</blockquote>
</blockquote>
</section><section><h2 class="section-heading" id="building-a-recipe-from-scratch">Building a recipe from scratch<a class="anchor" aria-label="anchor" href="#building-a-recipe-from-scratch"></a>
</h2>
<hr class="half-width">
<p>The easiest way to make a new recipe is to start from an existing
one, and modify it until it does exactly what you need. However, in this
episode we will start from scratch. This forces us to think about all
the steps involved in processing the data. We will also deal with
commonly occurring errors through the development of the recipe.</p>
<p>Remember the basic structure of a recipe, and notice that each
component is extensively described in the documentation under the
section, [“Overview”][recipe-overview]{:target=“_blank”}:</p>
<ul>
<li>[documentation][recipe-section-documentation]{:target=“_blank”}</li>
<li>[datasets][recipe-section-datasets]{:target=“_blank”}</li>
<li>[preprocessors][recipe-section-preprocessors]{:target=“_blank”}</li>
<li>[diagnostics][recipe-section-diagnostics]{:target=“_blank”}</li>
</ul>
<p>This is the first place to look for help if you get stuck.</p>
<p>Open a new file called <code>recipe_warming_stripes.yml</code>:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">nano</span> recipe_warming_stripes.yml</span></code></pre>
</div>
<p>Let’s add the standard header comments (these do not do anything),
and a first description.</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">YAML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yaml" tabindex="0"><code class="sourceCode yaml"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="co"># ESMValTool</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="co"># recipe_warming_stripes.yml</span></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a><span class="pp">---</span></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a><span class="fu">documentation</span><span class="kw">:</span></span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a><span class="at">  </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Reproducing Ed Hawkins' warming stripes visualization</span></span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a><span class="at">  </span><span class="fu">title</span><span class="kw">:</span><span class="at"> Reproducing Ed Hawkins' warming stripes visualization.</span></span></code></pre>
</div>
<p>Notice that <code>yaml</code> always requires <code>two spaces</code>
indentation between the different levels. Pressing <code>ctrl+o</code>
will save the file. Verify the filename at the bottom and press enter.
Then use <code>ctrl+x</code> to exit the editor.</p>
<p>We will try to run the recipe after every modification we make, to
see if it (still) works!</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="ex">esmvaltool</span> run recipe_warming_stripes.yml</span></code></pre>
</div>
<p>In this case, it gives an error. Below you see the last few lines of
the error message.</p>
<pre><code>...
yamale.yamale_error.YamaleError:
Error validating data '/home/users/username/esmvaltool_tutorial/recipe_warming_stripes.yml'
with schema
'/apps/jasmin/community/esmvaltool/miniconda3_py311_23.11.0-2/envs/esmvaltool/lib/python3.11/
site-packages/esmvalcore/_recipe/recipe_schema.yml'
	documentation.authors: Required field missing
2024-05-27 13:21:23,805 UTC [41924] INFO
If you have a question or need help, please start a new discussion on
https://github.com/ESMValGroup/ESMValTool/discussions
If you suspect this is a bug, please open an issue on
https://github.com/ESMValGroup/ESMValTool/issues
To make it easier to find out what the problem is, please consider attaching the
files run/recipe_*.yml and run/main_log_debug.txt from the output directory.
</code></pre>
<p>{: .error}</p>
<p>We can use the the log message above, to understand why ESMValTool
failed. Here, this is because we missed a required field with author
names. The text
<code>documentation.authors: Required field missing</code> tells us
that. We see that ESMValTool always tries to validate the recipe at an
early stage. Note also the suggestion to open a GitHub issue if you need
help debugging the error message. This is something most users do when
they cannot understand the error or are not able to fix it on their
own.</p>
<p>Let’s add some additional information to the recipe. Open the recipe
file again, and add an authors section below the description. ESMValTool
expects the authors as a list, like so:</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">YAML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yaml" tabindex="0"><code class="sourceCode yaml"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="fu">authors</span><span class="kw">:</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> lastname_firstname</span></span></code></pre>
</div>
<p>To bypass a number of similar error messages, add a minimal
diagnostics section below the documentation. The file should now look
like:</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">YAML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yaml" tabindex="0"><code class="sourceCode yaml"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="co"># ESMValTool</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a><span class="co"># recipe_warming_stripes.yml</span></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a><span class="pp">---</span></span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a><span class="fu">documentation</span><span class="kw">:</span></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a><span class="at">  </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Reproducing Ed Hawkins' warming stripes visualization</span></span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a><span class="at">  </span><span class="fu">title</span><span class="kw">:</span><span class="at"> Reproducing Ed Hawkins' warming stripes visualization.</span></span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a><span class="at">  </span><span class="fu">authors</span><span class="kw">:</span></span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> doe_john</span></span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a><span class="fu">diagnostics</span><span class="kw">:</span></span>
<span id="cb6-11"><a href="#cb6-11" tabindex="-1"></a><span class="at">  </span><span class="fu">dummy_diagnostic_1</span><span class="kw">:</span></span>
<span id="cb6-12"><a href="#cb6-12" tabindex="-1"></a><span class="at">    </span><span class="fu">scripts</span><span class="kw">:</span><span class="at"> </span><span class="ch">null</span></span></code></pre>
</div>
<p>This is the minimal recipe layout that is required by ESMValTool. If
we now run the recipe again, you will probably see the following
error:</p>
<pre><code>ValueError: Tag 'doe_john' does not exist in section
'authors' of /apps/jasmin/community/esmvaltool/ESMValTool_2.10.0/esmvaltool/config-references.yml
</code></pre>
<p>{: .error}</p>
<blockquote>
<h2 id="pro-tip-config-references.yml">Pro tip:
config-references.yml</h2>
<p>The error message above points to a file named
[config-references.yml][config-references] This is where ESMValTool
stores all its citation information. To add yourself as an author, add
your name in the form <code>lastname_firstname</code> in alphabetical
order following the existing entries, under the
<code># Development team</code> section. See the [List of
authors][list-of-authors]{:target=“_blank”} section in the ESMValTool
documentation for more information. {: .callout}</p>
</blockquote>
<p>For now, let’s just use one of the existing references. Change the
author field to <code>righi_mattia</code>, who cannot receive enough
credit for all the effort he put into ESMValTool. If you now run the
recipe again, you should see the final message</p>
<pre><code>ERROR   No tasks to run!</code></pre>
<p>{: .output}</p>
<p>Although there is no actual error in the recipe, ESMValTool assumes
you mistakenly left out a variable name to process and alerts you with
this error message. ## Adding a dataset entry</p>
<p>Let’s add a datasets section.</p>
<blockquote>
<h2 id="filling-in-the-dataset-keys">Filling in the dataset keys</h2>
<p>Use the paths specified in the configuration file to explore the data
directory, and look at the explanation of the dataset entry in the
[ESMValTool documentation][recipe-section-datasets]{:target=“_blank”}.
For both the datasets, write down the following properties:</p>
<ul>
<li>project</li>
<li>variable (short name)</li>
<li>CMIP table</li>
<li>dataset (model name or obs/reanalysis dataset)</li>
<li>experiment</li>
<li>ensemble member</li>
<li>grid</li>
<li>start year</li>
<li>end year</li>
</ul>
<blockquote>
<h2 id="answers">Answers</h2>
<div class="line-block">
<strong>key</strong> | <strong>file 1</strong> |
<strong>file 2</strong> |<br>
project | CMIP6 | CMIP5 |<br>
short name | tas | tas |<br>
CMIP table | Amon | Amon |<br>
dataset | BCC-ESM1 | bcc-csm1-1|<br>
experiment | historical | historical |<br>
ensemble | r1i1p1f1 | r1i1p1 |<br>
grid | gn (native grid) | N/A |<br>
start year | 1850 | 1850 |<br>
end year | 2014 | 2005 |</div>
<p>Note that the grid key is only required for CMIP6 data, and that the
extent of the historical period has changed between CMIP5 and CMIP6.</p>
<p>{: .solution} {: .challenge}</p>
</blockquote>
</blockquote>
<p>Let us start with the BCC-ESM1 dataset and add a datasets section to
the recipe, listing this single dataset, as shown below. Note that key
fields such as <code>mip</code> or <code>start_year</code> are included
in the <code>datasets</code> section here but are part of the
<code>diagnostic</code> section in the recipe example seen in <a href="%7B%7B%20page.root%20%7D%7D%7B%%20link%20_episodes/04-recipe.md%20%%7D">Running
your first recipe</a>.</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">YAML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yaml" tabindex="0"><code class="sourceCode yaml"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="co"># ESMValTool</span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a><span class="co"># recipe_warming_stripes.yml</span></span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a><span class="pp">---</span></span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a><span class="fu">documentation</span><span class="kw">:</span></span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a><span class="at">  </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Reproducing Ed Hawkins' warming stripes visualization</span></span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a><span class="at">  </span><span class="fu">title</span><span class="kw">:</span><span class="at"> Reproducing Ed Hawkins' warming stripes visualization.</span></span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a><span class="at">  </span><span class="fu">authors</span><span class="kw">:</span></span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> doe_john</span></span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a><span class="fu">datasets</span><span class="kw">:</span></span>
<span id="cb9-11"><a href="#cb9-11" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="kw">{</span><span class="fu">dataset</span><span class="kw">:</span><span class="at"> BCC-ESM1</span><span class="kw">,</span><span class="at"> </span><span class="fu">project</span><span class="kw">:</span><span class="at"> CMIP6</span><span class="kw">,</span><span class="at"> </span><span class="fu">mip</span><span class="kw">:</span><span class="at"> Amon</span><span class="kw">,</span><span class="at"> </span><span class="fu">exp</span><span class="kw">:</span><span class="at"> historical</span><span class="kw">,</span><span class="at"> </span></span>
<span id="cb9-12"><a href="#cb9-12" tabindex="-1"></a><span class="at">     </span><span class="fu">ensemble</span><span class="kw">:</span><span class="at"> r1i1p1f1</span><span class="kw">,</span><span class="at"> </span><span class="fu">grid</span><span class="kw">:</span><span class="at"> gn</span><span class="kw">,</span><span class="at"> </span><span class="fu">start_year</span><span class="kw">:</span><span class="at"> </span><span class="dv">1850</span><span class="kw">,</span><span class="at"> </span><span class="fu">end_year</span><span class="kw">:</span><span class="at"> </span><span class="dv">2014</span><span class="kw">}</span></span>
<span id="cb9-13"><a href="#cb9-13" tabindex="-1"></a></span>
<span id="cb9-14"><a href="#cb9-14" tabindex="-1"></a><span class="fu">diagnostics</span><span class="kw">:</span></span>
<span id="cb9-15"><a href="#cb9-15" tabindex="-1"></a><span class="at">  </span><span class="fu">dummy_diagnostic_1</span><span class="kw">:</span></span>
<span id="cb9-16"><a href="#cb9-16" tabindex="-1"></a><span class="at">    </span><span class="fu">scripts</span><span class="kw">:</span><span class="at"> </span><span class="ch">null</span></span></code></pre>
</div>
<p>The recipe should run but produce the same message as in the previous
case since we still have not included a variable to actually process. We
have not included the short name of the variable in this dataset section
because this allows us to reuse this dataset entry with different
variable names later on. This is not really necessary for our simple use
case, but it is common practice in ESMValTool.</p>
<blockquote>
<h2 id="pro-tip-automatically-populating-a-recipe-with-all-available-datasets">Pro-tip:
Automatically populating a recipe with all available datasets</h2>
<p>You can select all available models for processing using
<code>glob</code> patterns or wildcards. An example
<code>datasets</code> section that uses all available CMIP6 models and
ensemble members for the <code>historical</code> experiment is available
[here] [include-all-datasets]{:target=“_blank”}. Note that you will have
to set the <code>search_esgf</code> option in the
<code>config_file</code> to <code>always</code> so that you can download
data from ESGF nodes as needed. {: .callout}</p>
</blockquote>
</section><section><h2 class="section-heading" id="adding-the-preprocessor-section">Adding the preprocessor section<a class="anchor" aria-label="anchor" href="#adding-the-preprocessor-section"></a>
</h2>
<hr class="half-width">
<p>Above, we already described the preprocessing task that needs to
convert the standard, gridded temperature data to a timeseries of
temperature anomalies.</p>
<blockquote>
<h2 id="defining-the-preprocessor">Defining the preprocessor</h2>
<p>Have a look at the available preprocessors in the
[documentation][preprocessor]{:target=“_blank”}. Write down</p>
<ul>
<li>Which preprocessor functions do you think we should use?</li>
<li>What are the parameters that we can pass to these functions?</li>
<li>What do you think should be the order of the preprocessors?</li>
<li>A suitable name for the overall preprocessor</li>
</ul>
<blockquote>
<h2 id="solution">Solution</h2>
<p>We need to calculate anomalies and global means. There is an
<code>anomalies</code> preprocessor which takes in as arguments, a time
period, a reference period, and whether or not to standardize the data.
The global means can be calculated with the <code>area_statistics</code>
preprocessor, which takes an operator as argument (in our case we want
to compute the <code>mean</code>).</p>
<p>The default order in which these preprocessors are applied can be
seen [here][preprocessor-functions]{:target=“_blank”}:
<code>area_statistics</code> comes before <code>anomalies</code>. If you
want to change this, you can use the <code>custom_order</code>
preprocessor as described
[here][recipe-section-preprocessors]{:target=“_blank”}. For this
example, we will keep the default order..</p>
<p>Let’s name our preprocessor <code>global_anomalies</code>. {:
.solution} {: .challenge}</p>
</blockquote>
</blockquote>
<p>Add the following block to your recipe file between the
<code>datasets</code> and <code>diagnostics</code> block:</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">YAML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yaml" tabindex="0"><code class="sourceCode yaml"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="fu">preprocessors</span><span class="kw">:</span></span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a><span class="at">  </span><span class="fu">global_anomalies</span><span class="kw">:</span></span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a><span class="at">    </span><span class="fu">area_statistics</span><span class="kw">:</span></span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a><span class="at">      </span><span class="fu">operator</span><span class="kw">:</span><span class="at"> mean</span></span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a><span class="at">    </span><span class="fu">anomalies</span><span class="kw">:</span></span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a><span class="at">        </span><span class="fu">period</span><span class="kw">:</span><span class="at"> month</span></span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a><span class="at">        </span><span class="fu">reference</span><span class="kw">:</span></span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a><span class="at">          </span><span class="fu">start_year</span><span class="kw">:</span><span class="at"> </span><span class="dv">1981</span></span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a><span class="at">          </span><span class="fu">start_month</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a><span class="at">          </span><span class="fu">start_day</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a><span class="at">          </span><span class="fu">end_year</span><span class="kw">:</span><span class="at"> </span><span class="dv">2010</span></span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a><span class="at">          </span><span class="fu">end_month</span><span class="kw">:</span><span class="at"> </span><span class="dv">12</span></span>
<span id="cb10-13"><a href="#cb10-13" tabindex="-1"></a><span class="at">          </span><span class="fu">end_day</span><span class="kw">:</span><span class="at"> </span><span class="dv">31</span></span>
<span id="cb10-14"><a href="#cb10-14" tabindex="-1"></a><span class="at">        </span><span class="fu">standardize</span><span class="kw">:</span><span class="at"> </span><span class="ch">false</span></span></code></pre>
</div>
</section><section><h2 class="section-heading" id="completing-the-diagnostics-section">Completing the diagnostics section<a class="anchor" aria-label="anchor" href="#completing-the-diagnostics-section"></a>
</h2>
<hr class="half-width">
<p>We are now ready to finish our diagnostics section. Remember that we
want to create two tasks: a preprocessor task, and a diagnostic task. To
illustrate that we can also pass settings to the diagnostic script, we
add the option to specify a custom colormap.</p>
<blockquote>
<h2 id="fill-in-the-blanks">Fill in the blanks</h2>
<p>Extend the diagnostics section in your recipe by filling in the
blanks in the following template:</p>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">YAML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yaml" tabindex="0"><code class="sourceCode yaml"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="fu">diagnostics</span><span class="kw">:</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a><span class="at">  </span><span class="fu">&lt;... (suitable name for our diagnostic)&gt;</span><span class="kw">:</span></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a><span class="fu">    description</span><span class="kw">: </span><span class="at">&lt;...</span><span class="ch">&gt;</span></span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a><span class="at">    </span><span class="fu">variables</span><span class="kw">:</span></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a><span class="at">      </span><span class="fu">&lt;... (suitable name for the preprocessed variable)&gt;</span><span class="kw">:</span></span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a><span class="fu">        short_name</span><span class="kw">: </span><span class="at">&lt;...</span><span class="ch">&gt;</span></span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a><span class="fu">        preprocessor</span><span class="kw">: </span><span class="at">&lt;...</span><span class="ch">&gt;</span></span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a><span class="at">    </span><span class="fu">scripts</span><span class="kw">:</span></span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a><span class="at">      </span><span class="fu">&lt;... (suitable name for our python script)&gt;</span><span class="kw">:</span></span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a><span class="at">        </span><span class="fu">script</span><span class="kw">:</span><span class="at"> &lt;full path to python script&gt;</span></span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a><span class="at">        </span><span class="fu">colormap</span><span class="kw">:</span><span class="at"> &lt;... choose from matplotlib colormaps&gt;</span></span></code></pre>
</div>
<blockquote>
<h2 id="solution-1">Solution</h2>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">YAML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yaml" tabindex="0"><code class="sourceCode yaml"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="fu">diagnostics</span><span class="kw">:</span></span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a><span class="at">  </span><span class="fu">diagnostic_warming_stripes</span><span class="kw">:</span></span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a><span class="at">    </span><span class="fu">description</span><span class="kw">:</span><span class="at"> visualize global temperature anomalies as warming stripes</span></span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a><span class="at">    </span><span class="fu">variables</span><span class="kw">:</span></span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a><span class="at">      </span><span class="fu">global_temperature_anomalies_global</span><span class="kw">:</span></span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a><span class="at">        </span><span class="fu">short_name</span><span class="kw">:</span><span class="at"> tas</span></span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a><span class="at">        </span><span class="fu">preprocessor</span><span class="kw">:</span><span class="at"> global_anomalies</span></span>
<span id="cb12-8"><a href="#cb12-8" tabindex="-1"></a><span class="at">    </span><span class="fu">scripts</span><span class="kw">:</span></span>
<span id="cb12-9"><a href="#cb12-9" tabindex="-1"></a><span class="at">      </span><span class="fu">warming_stripes_script</span><span class="kw">:</span></span>
<span id="cb12-10"><a href="#cb12-10" tabindex="-1"></a><span class="at">        </span><span class="fu">script</span><span class="kw">:</span><span class="at"> ~/esmvaltool_tutorial/warming_stripes.py</span></span>
<span id="cb12-11"><a href="#cb12-11" tabindex="-1"></a><span class="at">        </span><span class="fu">colormap</span><span class="kw">:</span><span class="at"> </span><span class="st">'bwr'</span></span></code></pre>
</div>
<p>{: .solution} {: .challenge}</p>
</blockquote>
</blockquote>
<p>You should now be able to run the recipe to get your own warming
stripes.</p>
<p>Note: for the purpose of simplicity in this episode, we have not
added logging or provenance tracking in the diagnostic script. Once you
start to develop your own diagnostic scripts and want to add them to the
ESMValTool repositories, this will be required. Writing your own
diagnostic script is discussed in a <a href="%7B%7B%20page.root%20%7D%7D%7B%%20link%20_episodes/08-diagnostics.md%20%%7D">later
episode</a>.</p>
</section><section><h2 class="section-heading" id="bonus-exercises">Bonus exercises<a class="anchor" aria-label="anchor" href="#bonus-exercises"></a>
</h2>
<hr class="half-width">
<p>Below are a few exercises to practice modifying an ESMValTool recipe.
For your reference, here’s a copy of the <a href="../files/recipe_warming_stripes.yml">recipe at this point</a>. This
will be the point of departure for each of the modifications we’ll make
below.</p>
<blockquote>
<h2 id="specific-location-selection">Specific location selection</h2>
<p>On showyourstripes.org, you can download stripes for specific
locations. Here we show how this can be done with ESMValTool. Instead of
the global mean, we can pick a location to plot the stripes for. Can you
find a suitable preprocessor to do this?</p>
<blockquote>
<h2 id="solution-2">Solution</h2>
<p>You can use <code>extract_point</code> or <code>extract_region</code>
to select a location. We used <code>extract_point</code>. Here’s a copy
of the <a href="../files/recipe_warming_stripes_local.yml">recipe at this
point</a> and this is the difference from the previous recipe:</p>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">DIFF<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode diff" tabindex="0"><code class="sourceCode diff"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="kw">--- recipe_warming_stripes.yml</span></span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a><span class="dt">+++ recipe_warming_stripes_local.yml</span></span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a><span class="dt">@@ -10,9 +10,11 @@</span></span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a>   - {dataset: BCC-ESM1, project: CMIP6, mip: Amon, exp: historical, </span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a>      ensemble: r1i1p1f1, grid: gn, start_year: 1850, end_year: 2014}</span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a> preprocessors:</span>
<span id="cb13-8"><a href="#cb13-8" tabindex="-1"></a><span class="st">-  global_anomalies:</span></span>
<span id="cb13-9"><a href="#cb13-9" tabindex="-1"></a><span class="st">-    area_statistics:</span></span>
<span id="cb13-10"><a href="#cb13-10" tabindex="-1"></a><span class="st">-      operator: mean</span></span>
<span id="cb13-11"><a href="#cb13-11" tabindex="-1"></a><span class="va">+  anomalies_amsterdam:</span></span>
<span id="cb13-12"><a href="#cb13-12" tabindex="-1"></a><span class="va">+    extract_point:</span></span>
<span id="cb13-13"><a href="#cb13-13" tabindex="-1"></a><span class="va">+      latitude: 52.379189</span></span>
<span id="cb13-14"><a href="#cb13-14" tabindex="-1"></a><span class="va">+      longitude: 4.899431</span></span>
<span id="cb13-15"><a href="#cb13-15" tabindex="-1"></a><span class="va">+      scheme: linear</span></span>
<span id="cb13-16"><a href="#cb13-16" tabindex="-1"></a>     anomalies:</span>
<span id="cb13-17"><a href="#cb13-17" tabindex="-1"></a>       period: month</span>
<span id="cb13-18"><a href="#cb13-18" tabindex="-1"></a>       reference:</span>
<span id="cb13-19"><a href="#cb13-19" tabindex="-1"></a><span class="dt">@@ -27,9 +29,9 @@</span></span>
<span id="cb13-20"><a href="#cb13-20" tabindex="-1"></a> diagnostics:</span>
<span id="cb13-21"><a href="#cb13-21" tabindex="-1"></a>   diagnostic_warming_stripes:</span>
<span id="cb13-22"><a href="#cb13-22" tabindex="-1"></a>     variables:</span>
<span id="cb13-23"><a href="#cb13-23" tabindex="-1"></a><span class="st">-      global_temperature_anomalies:</span></span>
<span id="cb13-24"><a href="#cb13-24" tabindex="-1"></a><span class="va">+      temperature_anomalies_amsterdam:</span></span>
<span id="cb13-25"><a href="#cb13-25" tabindex="-1"></a>         short_name: tas</span>
<span id="cb13-26"><a href="#cb13-26" tabindex="-1"></a><span class="st">-        preprocessor: global_anomalies</span></span>
<span id="cb13-27"><a href="#cb13-27" tabindex="-1"></a><span class="va">+        preprocessor: anomalies_amsterdam</span></span>
<span id="cb13-28"><a href="#cb13-28" tabindex="-1"></a>     scripts:</span>
<span id="cb13-29"><a href="#cb13-29" tabindex="-1"></a>       warming_stripes_script:</span>
<span id="cb13-30"><a href="#cb13-30" tabindex="-1"></a>         script: ~/esmvaltool_tutorial/warming_stripes.py</span></code></pre>
</div>
<p>{: .solution} {:.challenge}</p>
</blockquote>
</blockquote>
<blockquote>
<h2 id="different-time-periods">Different time periods</h2>
<p>Split the diagnostic in two with two different time periods for the
same variable. You can choose the time periods yourself. In the example
below, we have chosen the recent past and the 20th century and have used
variable grouping.</p>
<blockquote>
<h2 id="solution-3">Solution</h2>
<p>Here’s a copy of the <a href="../files/recipe_warming_stripes_periods.yml">recipe at this point</a>
and this is the difference with the previous recipe:</p>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">DIFF<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode diff" tabindex="0"><code class="sourceCode diff"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="kw">--- recipe_warming_stripes_local.yml</span></span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a><span class="dt">+++ recipe_warming_stripes_periods.yml</span></span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a><span class="dt">@@ -7,7 +7,7 @@</span></span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a> datasets:</span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a><span class="st">-  - {dataset: BCC-ESM1, project: CMIP6, mip: Amon, exp: historical, </span></span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a><span class="st">-  	  ensemble: r1i1p1f1, grid: gn, start_year: 1850, end_year: 2014}</span></span>
<span id="cb14-8"><a href="#cb14-8" tabindex="-1"></a><span class="va">+  - {dataset: BCC-ESM1, project: CMIP6, mip: Amon, exp: historical, </span></span>
<span id="cb14-9"><a href="#cb14-9" tabindex="-1"></a><span class="va">+     ensemble: r1i1p1f1, grid: gn}</span></span>
<span id="cb14-10"><a href="#cb14-10" tabindex="-1"></a></span>
<span id="cb14-11"><a href="#cb14-11" tabindex="-1"></a> preprocessors:</span>
<span id="cb14-12"><a href="#cb14-12" tabindex="-1"></a>   anomalies_amsterdam:</span>
<span id="cb14-13"><a href="#cb14-13" tabindex="-1"></a><span class="dt">@@ -29,9 +29,16 @@</span></span>
<span id="cb14-14"><a href="#cb14-14" tabindex="-1"></a> diagnostics:</span>
<span id="cb14-15"><a href="#cb14-15" tabindex="-1"></a>   diagnostic_warming_stripes:</span>
<span id="cb14-16"><a href="#cb14-16" tabindex="-1"></a>     variables:</span>
<span id="cb14-17"><a href="#cb14-17" tabindex="-1"></a><span class="st">-      temperature_anomalies_amsterdam:</span></span>
<span id="cb14-18"><a href="#cb14-18" tabindex="-1"></a><span class="va">+      temperature_anomalies_recent:</span></span>
<span id="cb14-19"><a href="#cb14-19" tabindex="-1"></a>         short_name: tas</span>
<span id="cb14-20"><a href="#cb14-20" tabindex="-1"></a>         preprocessor: anomalies_amsterdam</span>
<span id="cb14-21"><a href="#cb14-21" tabindex="-1"></a><span class="va">+        start_year: 1950</span></span>
<span id="cb14-22"><a href="#cb14-22" tabindex="-1"></a><span class="va">+        end_year: 2014</span></span>
<span id="cb14-23"><a href="#cb14-23" tabindex="-1"></a><span class="va">+      temperature_anomalies_20th_century:</span></span>
<span id="cb14-24"><a href="#cb14-24" tabindex="-1"></a><span class="va">+        short_name: tas</span></span>
<span id="cb14-25"><a href="#cb14-25" tabindex="-1"></a><span class="va">+        preprocessor: anomalies_amsterdam</span></span>
<span id="cb14-26"><a href="#cb14-26" tabindex="-1"></a><span class="va">+        start_year: 1900</span></span>
<span id="cb14-27"><a href="#cb14-27" tabindex="-1"></a><span class="va">+        end_year: 1999</span></span>
<span id="cb14-28"><a href="#cb14-28" tabindex="-1"></a>     scripts:</span>
<span id="cb14-29"><a href="#cb14-29" tabindex="-1"></a>       warming_stripes_script:</span>
<span id="cb14-30"><a href="#cb14-30" tabindex="-1"></a>         script: ~/esmvaltool_tutorial/warming_stripes.py</span></code></pre>
</div>
<p>{: .solution} {:.challenge}</p>
</blockquote>
</blockquote>
<blockquote>
<h2 id="different-preprocessors">Different preprocessors</h2>
<p>Now that you have different variable groups, we can also use
different preprocessors. Add a second preprocessor to add another
location of your choosing.</p>
<blockquote>
<h2 id="solution-4">Solution</h2>
<p>Here’s a copy of the <a href="../files/recipe_warming_stripes_multiple_locations.yml">recipe at
this point</a> and this is the difference with the previous recipe:</p>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">DIFF<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode diff" tabindex="0"><code class="sourceCode diff"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="kw">--- recipe_warming_stripes_periods.yml</span></span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a><span class="dt">+++ recipe_warming_stripes_multiple_locations.yml</span></span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a><span class="dt">@@ -15,7 +15,7 @@</span></span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a>       latitude: 52.379189</span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a>       longitude: 4.899431</span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a>       scheme: linear</span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a><span class="st">-    anomalies:</span></span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a><span class="va">+    anomalies: &amp;anomalies</span></span>
<span id="cb15-9"><a href="#cb15-9" tabindex="-1"></a>       period: month</span>
<span id="cb15-10"><a href="#cb15-10" tabindex="-1"></a>       reference:</span>
<span id="cb15-11"><a href="#cb15-11" tabindex="-1"></a>         start_year: 1981</span>
<span id="cb15-12"><a href="#cb15-12" tabindex="-1"></a><span class="dt">@@ -25,18 +25,24 @@</span></span>
<span id="cb15-13"><a href="#cb15-13" tabindex="-1"></a>         end_month: 12</span>
<span id="cb15-14"><a href="#cb15-14" tabindex="-1"></a>         end_day: 31</span>
<span id="cb15-15"><a href="#cb15-15" tabindex="-1"></a>       standardize: false</span>
<span id="cb15-16"><a href="#cb15-16" tabindex="-1"></a><span class="va">+  anomalies_london:</span></span>
<span id="cb15-17"><a href="#cb15-17" tabindex="-1"></a><span class="va">+    extract_point:</span></span>
<span id="cb15-18"><a href="#cb15-18" tabindex="-1"></a><span class="va">+      latitude: 51.5074</span></span>
<span id="cb15-19"><a href="#cb15-19" tabindex="-1"></a><span class="va">+      longitude: 0.1278</span></span>
<span id="cb15-20"><a href="#cb15-20" tabindex="-1"></a><span class="va">+      scheme: linear</span></span>
<span id="cb15-21"><a href="#cb15-21" tabindex="-1"></a><span class="va">+    anomalies: *anomalies</span></span>
<span id="cb15-22"><a href="#cb15-22" tabindex="-1"></a></span>
<span id="cb15-23"><a href="#cb15-23" tabindex="-1"></a> diagnostics:</span>
<span id="cb15-24"><a href="#cb15-24" tabindex="-1"></a>   diagnostic_warming_stripes:</span>
<span id="cb15-25"><a href="#cb15-25" tabindex="-1"></a>     variables:</span>
<span id="cb15-26"><a href="#cb15-26" tabindex="-1"></a><span class="st">-      temperature_anomalies_recent:</span></span>
<span id="cb15-27"><a href="#cb15-27" tabindex="-1"></a><span class="va">+      temperature_anomalies_recent_amsterdam:</span></span>
<span id="cb15-28"><a href="#cb15-28" tabindex="-1"></a>         short_name: tas</span>
<span id="cb15-29"><a href="#cb15-29" tabindex="-1"></a>         preprocessor: anomalies_amsterdam</span>
<span id="cb15-30"><a href="#cb15-30" tabindex="-1"></a>         start_year: 1950</span>
<span id="cb15-31"><a href="#cb15-31" tabindex="-1"></a>         end_year: 2014</span>
<span id="cb15-32"><a href="#cb15-32" tabindex="-1"></a><span class="st">-      temperature_anomalies_20th_century:</span></span>
<span id="cb15-33"><a href="#cb15-33" tabindex="-1"></a><span class="va">+      temperature_anomalies_20th_century_london:</span></span>
<span id="cb15-34"><a href="#cb15-34" tabindex="-1"></a>         short_name: tas</span>
<span id="cb15-35"><a href="#cb15-35" tabindex="-1"></a><span class="st">-        preprocessor: anomalies_amsterdam</span></span>
<span id="cb15-36"><a href="#cb15-36" tabindex="-1"></a><span class="va">+        preprocessor: anomalies_london</span></span>
<span id="cb15-37"><a href="#cb15-37" tabindex="-1"></a>         start_year: 1900</span>
<span id="cb15-38"><a href="#cb15-38" tabindex="-1"></a>         end_year: 1999</span>
<span id="cb15-39"><a href="#cb15-39" tabindex="-1"></a>     scripts:</span></code></pre>
</div>
<p>{: .solution}</p>
</blockquote>
<p>{:.challenge}</p>
</blockquote>
<blockquote>
<h2 id="pro-tip-yaml-anchors">Pro-tip: YAML anchors</h2>
<p>If you want to avoid retyping the arguments used in your
preprocessor, you can use YAML anchors as seen in the
<code>anomalies</code> preprocessor specifications in the recipe above.
{:.callout}</p>
</blockquote>
<blockquote>
<h2 id="additional-datasets">Additional datasets</h2>
<p>So far we have defined the datasets in the datasets section of the
recipe. However, it’s also possible to add specific datasets only for
specific variables or variable groups. Take a look at the documentation
to learn about the <code>additional_datasets</code> keyword
[here][additional-datasets]{:target=“_blank”}, and add a second dataset
only for one of the variable groups.</p>
<blockquote>
<h2 id="solution-5">Solution</h2>
<p>Here’s a copy of the <a href="../files/recipe_warming_stripes_additional_datasets.yml">recipe at
this point</a> and this is the difference with the previous recipe:</p>
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">DIFF<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode diff" tabindex="0"><code class="sourceCode diff"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="kw">--- recipe_warming_stripes_multiple_locations.yml</span></span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a><span class="dt">+++ recipe_warming_stripes_additional_datasets.yml</span></span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a><span class="dt">@@ -45,6 +45,8 @@</span></span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a>         preprocessor: anomalies_london</span>
<span id="cb16-5"><a href="#cb16-5" tabindex="-1"></a>         start_year: 1900</span>
<span id="cb16-6"><a href="#cb16-6" tabindex="-1"></a>         end_year: 1999</span>
<span id="cb16-7"><a href="#cb16-7" tabindex="-1"></a><span class="va">+        additional_datasets:</span></span>
<span id="cb16-8"><a href="#cb16-8" tabindex="-1"></a><span class="va">+          - {dataset: CanESM2, project: CMIP5, mip: Amon, exp: historical, ensemble: r1i1p1}</span></span>
<span id="cb16-9"><a href="#cb16-9" tabindex="-1"></a>     scripts:</span>
<span id="cb16-10"><a href="#cb16-10" tabindex="-1"></a>       warming_stripes_script:</span>
<span id="cb16-11"><a href="#cb16-11" tabindex="-1"></a>         script: ~/esmvaltool_tutorial/warming_stripes.py</span></code></pre>
</div>
<p>{: .solution} {:.challenge}</p>
</blockquote>
</blockquote>
<blockquote>
<h2 id="multiple-ensemble-members">Multiple ensemble members</h2>
<p>You can choose data from multiple ensemble members for a model in a
single line.</p>
<blockquote>
<h2 id="solution-6">Solution</h2>
<p>The <code>dataset</code> section allows you to choose more than one
ensemble member Here’s a copy of the changed <a href="../files/recipe_warming_stripes_multiple_ensemble_members.yml">recipe</a>
to do that. Changes made are shown in the diff output below:</p>
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">DIFF<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode diff" tabindex="0"><code class="sourceCode diff"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="kw">--- recipe_warming_stripes.yml	2024-05-27 15:37:52.340358967 +0100</span></span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a><span class="dt">+++ recipe_warming_stripes_multiens.yml	2024-05-27 22:18:42.035558837 +0100</span></span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a><span class="dt">@@ -10,7 +10,7 @@</span></span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a><span class="st">-     ensemble: r1i1p1f1, grid: gn, start_year: 1850, end_year: 2014}</span></span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a><span class="va">+     ensemble: "r(1:2)i1p1f1", grid: gn, start_year: 1850, end_year: 2014}</span></span></code></pre>
</div>
<p>{: .solution} {:.challenge}</p>
</blockquote>
</blockquote>
<blockquote>
<h2 id="pro-tip-concatenating-datasets">Pro-tip: Concatenating
datasets</h2>
<p>Check out the section on a different way to use multiple ensemble
members or even multiple experiments at [Concatenating data
corresponding to multiple facets]
[concatenating-datasets]{:target=“_blank”}.</p>
<p>{: .callout}</p>
</blockquote>
<p>{% include links.md %}</p>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</section></section><section id="aio-07-development-setup"><p>Content from <a href="07-development-setup.html">Development and contribution</a></p>
<hr>
<p>Last updated on 2024-11-21 |

        <a href="https://github.com/ehogan/ESMValTool_Tutorial/edit/main/episodes/07-development-setup.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Estimated time: <i aria-hidden="true" data-feather="clock"></i> 30 minutes</p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<p>We now know how ESMValTool works, but how do we develop it?
ESMValTool is an open-source project in ESMValGroup. We can contribute
to its development by:</p>
<ul>
<li>a new or updated recipe script, see lesson on <a href="%7B%7B%20page.root%20%7D%7D%7B%%20link%20_episodes/06-preprocessor.md%20%%7D">Writing
your own recipe</a>
</li>
<li>a new or updated diagnostics script, see lesson on <a href="%7B%7B%20page.root%20%7D%7D%7B%%20link%20_episodes/08-diagnostics.md%20%%7D">Writing
your own diagnostic script</a>
</li>
<li>a new or updated cmorizer script, see lesson on <a href="%7B%7B%20page.root%20%7D%7D%7B%%20link%20_episodes/09-cmorization.md%20%%7D">CMORization:
Using observational datasets</a>
</li>
<li>helping with reviewing process of pull requests, see ESMValTool
documentation on <a href="https://docs.esmvaltool.org/en/latest/community/review.html" class="external-link">Review
of pull requests</a>
</li>
</ul>
<p>In this lesson, we first show how to set up a development
installation of ESMValTool so you can make changes or additions. We then
explain how you can contribute these changes to the community.</p>
<blockquote>
<h2 id="git-knowledge">Git knowledge</h2>
<p>For this episode, you need some knowledge of <a href="https://git-scm.com/" class="external-link">Git</a>. You can refresh your knowledge in
the corresponding <a href="http://swcarpentry.github.io/git-novice/" class="external-link">Git
carpentries course</a>. {: .callout}</p>
</blockquote>
<section><h2 class="section-heading" id="development-installation">Development installation<a class="anchor" aria-label="anchor" href="#development-installation"></a>
</h2>
<hr class="half-width">
<p>We’ll explore how ESMValTool can be installed it in a
<code>develop</code> mode. Even if you aren’t collaborating with the
community, this installation is needed to run your new codes with
ESMValTool. Let’s get started.</p>
<div class="section level3">
<h3 id="source-code">1 Source code<a class="anchor" aria-label="anchor" href="#source-code"></a>
</h3>
<p>The ESMValTool source code is available on a public GitHub
repository: <a href="https://github.com/ESMValGroup/ESMValTool" class="external-link">https://github.com/ESMValGroup/ESMValTool</a>.
To obtain the code, there are two options:</p>
<ol style="list-style-type: decimal">
<li>Download the code from the repository. A ZIP file called
<code>ESMValTool-main.zip</code> is downloaded. To continue the
installation, unzip the file, move to the <code>ESMValTool-main</code>
directory and then follow the sequence of steps starting from the
section on <strong>ESMValTool dependencies</strong> below.</li>
<li>Clone the repository if you want to contribute to the ESMValTool
development:</li>
</ol>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/ESMValGroup/ESMValTool.git</span></code></pre>
</div>
<p>This command will ask your GitHub username and a personal
<strong>token</strong> as password. Please follow instructions on
[GitHub token authentication
requirements][token-authentication-requirements] to create a personal
access token. Alternatively, you could [generate a new SSH
key][generate-ssh-key] and [add it to your GitHub account][add-ssh-key].
After the authentication, the output might look like:</p>
<pre><code>Cloning into 'ESMValTool'...
remote: Enumerating objects: 163, done.
remote: Counting objects: 100% (163/163), done.
remote: Compressing objects: 100% (125/125), done.
remote: Total 95049 (delta 84), reused 76 (delta 30), pack-reused 94886
Receiving objects: 100% (95049/95049), 175.16 MiB | 5.48 MiB/s, done.
Resolving deltas: 100% (68808/68808), done.</code></pre>
<p>{: .output}</p>
<p>Now, a folder called <code>ESMValTool</code> has been created in your
working directory. This folder contains the source code of the tool. To
continue the installation, we move into the <code>ESMValTool</code>
directory:</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="bu">cd</span> ESMValTool</span></code></pre>
</div>
<p>Note that the <code>main</code> branch is checked out by default. We
can see this if we run:</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="fu">git</span> status</span></code></pre>
</div>
<pre><code>On branch main
Your branch is up to date with 'origin/main'.

nothing to commit, working tree clean</code></pre>
<p>{: .output}</p>
</div>
<div class="section level3">
<h3 id="esmvaltool-dependencies">2 ESMValTool dependencies<a class="anchor" aria-label="anchor" href="#esmvaltool-dependencies"></a>
</h3>
<p>Please don’t forget if an esmvaltool environment is already created
following the lesson <a href="%7B%7B%20page.root%20%7D%7D%7B%%20link%20_episodes/02-installation.md%20%%7D">Installation</a>,
we should choose another name for the new environment in this
lesson.</p>
<p>ESMValTool now uses <code>mamba</code> instead of <code>conda</code>
for the recommended installation. For a minimal mamba installation, see
section <strong>Install Mamba</strong> in lesson <a href="%7B%7B%20page.root%20%7D%7D%7B%%20link%20_episodes/02-installation.md%20%%7D">Installation</a>.</p>
<p>It is good practice to update the version of mamba and conda on your
machine before setting up ESMValTool. This can be done as follows:</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="ex">mamba</span> update <span class="at">--name</span> base mamba conda</span></code></pre>
</div>
<p>To simplify the installation process, an environment file
<code>environment.yml</code> is provided in the ESMValTool directory. We
create an environment by running:</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="ex">mamba</span> env create <span class="at">--name</span> esmvaltool <span class="at">--file</span> environment.yml</span></code></pre>
</div>
<p>The environment is called <code>esmvaltool</code> by default. If an
<code>esmvaltool</code> environment is already created following the
lesson <a href="%7B%7B%20page.root%20%7D%7D%7B%%20link%20_episodes/02-installation.md%20%%7D">Installation</a>,
we should choose another name for the new environment in this lesson
by:</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="ex">mamba</span> env create <span class="at">--name</span> a_new_name <span class="at">--file</span> environment.yml</span></code></pre>
</div>
<p>This will create a new conda environment and install ESMValTool (with
all dependencies that are needed for development purposes) into it with
a single command.</p>
<p>For more information see [conda managing
environments][manage-environments].</p>
<p>Now, we should activate the environment:</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="ex">conda</span> activate esmvaltool</span></code></pre>
</div>
<p>where <code>esmvaltool</code> is the name of the environment (replace
by <code>a_new_name</code> in case another environment name was
used).</p>
</div>
<div class="section level3">
<h3 id="esmvaltool-installation">3 ESMValTool installation<a class="anchor" aria-label="anchor" href="#esmvaltool-installation"></a>
</h3>
<p>ESMValTool can be installed in a <code>develop</code> mode by
running:</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="ex">pip</span> install <span class="at">--editable</span> <span class="st">'.[develop]'</span></span></code></pre>
</div>
<p>This will add the <code>esmvaltool</code> directory to the Python
path in editable mode and install the development dependencies. We
should check if the installation works properly. To do this, run the
tool with:</p>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="ex">esmvaltool</span> <span class="at">--help</span></span></code></pre>
</div>
<p>If the installation is successful, ESMValTool prints a help message
to the console.</p>
<blockquote>
<h2 id="checking-the-development-installation">Checking the development
installation</h2>
<p>We can use the command <code>mamba list</code> to list installed
packages in the <code>esmvaltool</code> environment. Use this command to
check that ESMValTool is installed in a <code>develop</code> mode.</p>
<p><strong>Tip</strong>: see the <a href="https://docs.conda.io/projects/conda/en/latest/commands/list.html" class="external-link">documentation
on conda list</a>.</p>
<blockquote>
<h2 id="solution">Solution</h2>
<p>Run:</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="ex">mamba</span> list esmvaltool</span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="co"># Name                    Version                   Build  Channel</span></span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a><span class="ex">esmvaltool</span>                2.10.0.dev3+g2dbc2cfcc    pypi_0   pypi</span></code></pre>
</div>
<p>{: .solution} {: .challenge}</p>
</blockquote>
</blockquote>
</div>
<div class="section level3">
<h3 id="updating-esmvaltool">4 Updating ESMValTool<a class="anchor" aria-label="anchor" href="#updating-esmvaltool"></a>
</h3>
<p>The <code>main</code> branch has the latest features of ESMValTool.
Please make sure that the source code on your machine is up-to-date. If
you obtain the source code using git clone as explained in step
<strong>1 Source code</strong>, you can run <code>git pull</code> to
update the source code. Then ESMValTool installation will be updated
with changes from the <code>main</code> branch.</p>
</div>
</section><section><h2 class="section-heading" id="contribution">Contribution<a class="anchor" aria-label="anchor" href="#contribution"></a>
</h2>
<hr class="half-width">
<p>We have seen how to install ESMValTool in a <code>develop</code>
mode. Now, we try to contribute to its development. Let’s see how this
can be achieved. We first discuss our ideas in an <strong><a href="https://github.com/ESMValGroup/ESMValTool/issues" class="external-link">issue</a></strong>
in ESMValTool repository. This can avoid disappointment at a later
stage, for example, if more people are doing the same thing. It also
gives other people an early opportunity to provide input and
suggestions, which results in more valuable contributions.</p>
<p>Then, we create a new <code>branch</code> locally and start
developing new codes. To create a new branch: ~<del>bash git checkout -b
your_branch_name</del>~ If needed, a link to a git tutorial can be found
in <a href="%7B%7B%20page.root%20%7D%7D%7B%%20link%20setup.md%20%%7D">Setup</a>.</p>
<p>Once our development is finished, we can initiate a
<code>pull request</code>. To this end, we encourage you to join the
ESMValTool development team.</p>
<p>For more extensive documentation on contributing code, including a
section on the <a href="https://docs.esmvaltool.org/en/latest/community/repository.html#github-workflow" class="external-link">GitHubWorkflow</a>,
please see the [Contributing code and documentation][code-documentation]
section in the ESMValtool documentation.</p>
<div class="section level3">
<h3 id="review-process">Review process<a class="anchor" aria-label="anchor" href="#review-process"></a>
</h3>
<p>The pull request will be tested, discussed and merged as part of the
“<strong>review process</strong>”. The process will take some effort and
time to learn. However, a few (command line) tools can get you a long
way, and we’ll cover those essentials in the next sections.</p>
<p><strong>Tip</strong>: we encourage you to keep the pull requests
small. Reviewing small incremental changes is more efficient.</p>
</div>
<div class="section level3">
<h3 id="working-example">Working example<a class="anchor" aria-label="anchor" href="#working-example"></a>
</h3>
<p>We saw the ‘warming stripes’ diagnostic in lesson <a href="%7B%7B%20page.root%20%7D%7D%7B%%20link%20_episodes/06-preprocessor.md%20%%7D">Writing
your own recipe</a>. Imagine the following task: you want to contribute
warming stripes recipe and diagnostics to ESMValTool. You have to add
the diagnostics <a href="../files/warming_stripes.py">warming_stripes.py</a> and the recipe <a href="../files/recipe_warming_stripes.yml">recipe_warming_stripes.yml</a>
to their locations in ESMValTool directory. After these changes, you
should also check if everything works fine. This is where we take
advantage of the tools that are introduced later.</p>
<p>Let’s get started. Note that since this is an exercise to get
familiar with the development and contribution process, we will not
create a GitHub issue at this time but proceed as though it has been
done.</p>
</div>
<div class="section level3">
<h3 id="check-code-quality">Check code quality<a class="anchor" aria-label="anchor" href="#check-code-quality"></a>
</h3>
<p>We aim to adhere to best practices and coding standards. There are
several tools that check our code against those standards like:</p>
<ul>
<li>
<a href="https://flake8.pycqa.org/en/latest/#" class="external-link">flake8</a> for
checking against the PEP8 style guide</li>
<li>
<a href="https://pypi.org/project/yapf/" class="external-link">yapf</a> to ensure
consistent formatting for the whole project</li>
<li>
<a href="https://pypi.org/project/isort/" class="external-link">isort</a> to consistently
sort the import statements</li>
<li>
<a href="https://yamllint.readthedocs.io/en/stable/#" class="external-link">yamllint</a>
to ensure there are no syntax errors in our recipes and config
files</li>
<li>
<a href="https://github.com/jimhester/lintr" class="external-link">lintr</a> for
diagnostic scripts written in R</li>
<li>
<a href="https://pypi.org/project/codespell/" class="external-link">codespell</a> to check
grammar</li>
</ul>
<p>The good news is that <code>pre-commit</code> has been already
installed when we chose development installation.
<code>pre-commit</code> is a command line and runs all of those tools.
It also fixes some of those errors. To explore other tools, have a look
at ESMValTool documentation on <a href="https://docs.esmvaltool.org/en/latest/community/introduction.html#code-style" class="external-link">Code
style</a>.</p>
<blockquote>
<h2 id="using-pre-commit">Using pre-commit</h2>
<p>Let’s checkout our local branch and add the script <a href="../files/warming_stripes.py">warming_stripes.py</a> to the
<code>esmvaltool/diag_scripts</code> directory.</p>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="bu">cd</span> ESMValTool</span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a><span class="fu">git</span> checkout your_branch_name</span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a><span class="fu">cp</span> path_of_warming_stripes.py esmvaltool/diag_scripts/</span></code></pre>
</div>
<p>By default, <code>pre-commit</code> only runs on the files that have
been staged in git:</p>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="fu">git</span> status</span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a><span class="fu">git</span> add esmvaltool/diag_scripts/warming_stripes.py</span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a><span class="ex">pre-commit</span> run <span class="at">--files</span> esmvaltool/diag_scripts/warming_stripes.py</span></code></pre>
</div>
<p>Inspect the output of <code>pre-commit</code> and fix the remaining
errors.</p>
<blockquote>
<h2 id="solution-1">Solution</h2>
<p>The tail of the output of <code>pre-commit</code>:</p>
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="ex">Check</span> for added large files..............................................Passed</span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a><span class="ex">Check</span> python ast.........................................................Passed</span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a><span class="ex">Check</span> for case conflicts.................................................Passed</span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a><span class="ex">Check</span> for merge conflicts................................................Passed</span>
<span id="cb16-5"><a href="#cb16-5" tabindex="-1"></a><span class="ex">Debug</span> Statements <span class="er">(</span><span class="ex">Python</span><span class="kw">)</span><span class="ex">................................................Passed</span></span>
<span id="cb16-6"><a href="#cb16-6" tabindex="-1"></a><span class="ex">Fix</span> End of Files.........................................................Passed</span>
<span id="cb16-7"><a href="#cb16-7" tabindex="-1"></a><span class="ex">Trim</span> Trailing Whitespace.................................................Passed</span>
<span id="cb16-8"><a href="#cb16-8" tabindex="-1"></a><span class="ex">yamllint.............................................</span><span class="er">(</span><span class="ex">no</span> files to check<span class="kw">)</span><span class="ex">Skipped</span></span>
<span id="cb16-9"><a href="#cb16-9" tabindex="-1"></a><span class="ex">nclcodestyle.........................................</span><span class="er">(</span><span class="ex">no</span> files to check<span class="kw">)</span><span class="ex">Skipped</span></span>
<span id="cb16-10"><a href="#cb16-10" tabindex="-1"></a><span class="ex">style-files..........................................</span><span class="er">(</span><span class="ex">no</span> files to check<span class="kw">)</span><span class="ex">Skipped</span></span>
<span id="cb16-11"><a href="#cb16-11" tabindex="-1"></a><span class="ex">lintr................................................</span><span class="er">(</span><span class="ex">no</span> files to check<span class="kw">)</span><span class="ex">Skipped</span></span>
<span id="cb16-12"><a href="#cb16-12" tabindex="-1"></a><span class="ex">codespell................................................................Passed</span></span>
<span id="cb16-13"><a href="#cb16-13" tabindex="-1"></a><span class="ex">isort....................................................................Passed</span></span>
<span id="cb16-14"><a href="#cb16-14" tabindex="-1"></a><span class="ex">yapf.....................................................................Passed</span></span>
<span id="cb16-15"><a href="#cb16-15" tabindex="-1"></a><span class="ex">docformatter.............................................................Failed</span></span>
<span id="cb16-16"><a href="#cb16-16" tabindex="-1"></a><span class="ex">-</span> hook id: docformatter</span>
<span id="cb16-17"><a href="#cb16-17" tabindex="-1"></a><span class="ex">-</span> files were modified by this hook</span>
<span id="cb16-18"><a href="#cb16-18" tabindex="-1"></a><span class="ex">flake8...................................................................Failed</span></span>
<span id="cb16-19"><a href="#cb16-19" tabindex="-1"></a><span class="ex">-</span> hook id: flake8</span>
<span id="cb16-20"><a href="#cb16-20" tabindex="-1"></a><span class="ex">-</span> exit code: 1</span>
<span id="cb16-21"><a href="#cb16-21" tabindex="-1"></a></span>
<span id="cb16-22"><a href="#cb16-22" tabindex="-1"></a><span class="ex">esmvaltool/diag_scripts/warming_stripes.py:20:5:</span></span>
<span id="cb16-23"><a href="#cb16-23" tabindex="-1"></a><span class="ex">F841</span> local variable <span class="st">'nx'</span> is assigned to but never used</span></code></pre>
</div>
<p>As can be seen above, there are two <code>Failed</code> check:</p>
<ol style="list-style-type: decimal">
<li>
<code>docformatter</code>: it is mentioned that “files were modified
by this hook”. We run <code>git diff</code> to see the modifications.
The output includes the following:</li>
</ol>
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="ex">+in</span> the form of the popular warming stripes figure by Ed Hawkins.<span class="st">"""</span></span></code></pre>
</div>
<p>The syntax <code>"""</code> at the end of docstring is moved by one
line. Shifting it to the next line should fix this error.</p>
<ol start="2" style="list-style-type: decimal">
<li>
<code>flake8</code>: the error message is about an unused local
variable <code>nx</code>. We should check our codes regarding the usage
of <code>nx</code>. For now, let’s assume that it is added by mistake
and remove it. Note that you have to run <code>git add</code> again to
re-stage the file. Then rerun pre-commit and check that it passes. {:
.solution} {: .challenge}</li>
</ol>
</blockquote>
</blockquote>
</div>
<div class="section level3">
<h3 id="run-unit-tests">Run unit tests<a class="anchor" aria-label="anchor" href="#run-unit-tests"></a>
</h3>
<p>Previous section introduced some tools to check code style and
quality. There is lack of mechanism to determine whether or not our code
is getting the right answer. To achieve that, we need to write and run
tests for widely-used functions. ESMValTool comes with a lot of tests
that are in the folder <code>tests</code>.</p>
<p>To run tests, first we make sure that the working directory is
<code>ESMValTool</code> and our local branch is checked out. Then, we
can run tests using <code>pytest</code> locally:</p>
<div class="codewrapper sourceCode" id="cb18">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a><span class="ex">pytest</span></span></code></pre>
</div>
<p>Tests will also be run automatically by <a href="https://circleci.com/" class="external-link">CircleCI</a>, when you submit a pull
request.</p>
<blockquote>
<h2 id="running-tests">Running tests</h2>
<p>Make sure our local branch is checked out and add the recipe <a href="../files/recipe_warming_stripes.yml">recipe_warming_stripes.yml</a>
to the <code>esmvaltool/recipes</code> directory:</p>
<div class="codewrapper sourceCode" id="cb19">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a><span class="fu">cp</span> path_of_recipe_warming_stripes.yml esmvaltool/recipes/</span></code></pre>
</div>
<p>Run <code>pytest</code> and inspect the results, this might take a
few minutes. If a test is failed, try to fix it.</p>
<blockquote>
<h2 id="solution-2">Solution</h2>
<p>Run:</p>
<div class="codewrapper sourceCode" id="cb20">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a><span class="ex">pytest</span></span></code></pre>
</div>
<p>When <code>pytest</code> run is complete, you can inspect the test
reports that are printed in the console. Have a look at the second
section of the report <code>FAILURES</code>:</p>
<div class="codewrapper sourceCode" id="cb21">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a><span class="ex">================================</span> FAILURES ==========================================</span>
<span id="cb21-2"><a href="#cb21-2" tabindex="-1"></a><span class="ex">______________</span> test_recipe_valid<span class="pp">[</span><span class="ss">recipe_warming_stripes.yml</span><span class="pp">]</span> ______________</span></code></pre>
</div>
<p>The test message shows that the recipe
<code>recipe_warming_stripes.yml</code> is not a valid recipe. Look for
a line that starts with an <code>E</code> in the rest of the
message:</p>
<div class="codewrapper sourceCode" id="cb22">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a></span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a><span class="ex">E</span>           esmvalcore._task.DiagnosticError: Cannot execute script</span>
<span id="cb22-3"><a href="#cb22-3" tabindex="-1"></a><span class="st">'~/esmvaltool_tutorial/warming_stripes.py'</span> <span class="er">(</span><span class="ex">~/esmvaltool_tutorial/warming_stripes.py</span><span class="kw">)</span><span class="bu">:</span></span>
<span id="cb22-4"><a href="#cb22-4" tabindex="-1"></a><span class="fu">file</span> does not exist.</span></code></pre>
</div>
<p>To fix the recipe, we need to edit the path of the diagnostic script
as <code>warming_stripes.py</code>:</p>
<div class="codewrapper sourceCode" id="cb23">
<h3 class="code-label">YAML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yaml" tabindex="0"><code class="sourceCode yaml"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a><span class="at">   </span><span class="fu">scripts</span><span class="kw">:</span></span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a><span class="at">     </span><span class="fu">warming_stripes_script</span><span class="kw">:</span></span>
<span id="cb23-3"><a href="#cb23-3" tabindex="-1"></a><span class="at">       </span><span class="fu">script</span><span class="kw">:</span><span class="at"> warming_stripes.py</span></span></code></pre>
</div>
<p>For details, see lesson <a href="%7B%7B%20page.root%20%7D%7D%7B%%20link%20_episodes/08-diagnostics.md%20%%7D">Writing
your own diagnostic script</a>.</p>
<p>{: .solution} {: .challenge}</p>
</blockquote>
</blockquote>
</div>
<div class="section level3">
<h3 id="build-documentation">Build documentation<a class="anchor" aria-label="anchor" href="#build-documentation"></a>
</h3>
<p>When we add or update a code, we also update its corresponding
documentation. The ESMValTool documentation is available on <a href="https://docs.esmvaltool.org/en/latest/index.html" class="external-link">docs.esmvaltool.org</a>.
The source files are located in
<code>ESMValTool/doc/sphinx/source/</code>.</p>
<p>To build documentation locally, first we make sure that the working
directory is <code>ESMValTool</code> and our local branch is checked
out. Then, we run:</p>
<div class="codewrapper sourceCode" id="cb24">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a><span class="ex">sphinx-build</span> <span class="at">-Ea</span> doc/sphinx/source/ doc/sphinx/build/</span></code></pre>
</div>
<p>Similar to code, documentation should be well written and adhere to
standards. If the documentation is built properly, the previous command
prints a message to the console:</p>
<pre><code>build succeeded.

The HTML pages are in doc/sphinx/build.</code></pre>
<p>{: .output}</p>
<p>The main page of the documentation has been built into
<code>index.html</code> in <code>doc/sphinx/build/</code> directory. To
preview this page locally, we open the file in a web browser:</p>
<div class="codewrapper sourceCode" id="cb26">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a><span class="fu">xdg-open</span> doc/sphinx/build/index.html</span></code></pre>
</div>
<blockquote>
<h2 id="creating-a-documentation">Creating a documentation</h2>
<p>In previous exercises, we added the recipe <a href="../files/recipe_warming_stripes.yml">recipe_warming_stripes.yml</a>
to ESMValTool. Now, we create a documentation file
<code>recipe_warming_stripes.rst</code> for this recipe:</p>
<div class="codewrapper sourceCode" id="cb27">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb27-1"><a href="#cb27-1" tabindex="-1"></a><span class="fu">nano</span> doc/sphinx/source/recipes/recipe_warming_stripes.rst</span></code></pre>
</div>
<p>Add a reference i.e. <code>.. _recipe_warming_stripes:</code>, a
section title and some text about the recipe like:</p>
<pre><code>.. _recipe_warming_stripes:

Reproducing Ed Hawkins' warming stripes visualization
======================================================

This recipe produces warming stripes plots.</code></pre>
<p>Save and close the file. We can think of this file as one page of a
book. Examples of documentation pages can be found in the folder
<code>ESMValTool/doc/sphinx/source/recipes</code>. Then, we need to
decide where this page should be located inside the book. The table of
content is defined by <code>index.rst</code>. Let’s have a look at the
content:</p>
<div class="codewrapper sourceCode" id="cb29">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb29-1"><a href="#cb29-1" tabindex="-1"></a><span class="fu">nano</span> doc/sphinx/source/recipes/index.rst</span></code></pre>
</div>
<p>Add the recipe name i.e. <code>recipe_warming_stripes</code> to the
section <code>Other</code> in this file and preview the recipe
documentation page locally.</p>
<blockquote>
<h2 id="solution-3">Solution</h2>
<p>First, we add the recipe name <code>recipe_warming_stripes</code> to
the section <code>Other</code>:</p>
<pre><code>Other
^^^^^
.. toctree::
  :maxdepth: 1
  ...
  ...
  recipe_warming_stripes</code></pre>
<p>Then, we build and preview the documentation page:</p>
<div class="codewrapper sourceCode" id="cb31">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb31-1"><a href="#cb31-1" tabindex="-1"></a><span class="ex">sphinx-build</span> <span class="at">-Ea</span> doc/sphinx/source/ doc/sphinx/build/</span>
<span id="cb31-2"><a href="#cb31-2" tabindex="-1"></a><span class="fu">xdg-open</span> doc/sphinx/build/recipes/recipe_warming_stripes.html</span></code></pre>
</div>
<p>{: .solution} {: .challenge}</p>
</blockquote>
</blockquote>
<p>Congratulations! You are now ready to make a pull request.</p>
<p>{% include links.md %}</p>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</div>
</section></section><section id="aio-08-diagnostics"><p>Content from <a href="08-diagnostics.html">Writing your own diagnostic script</a></p>
<hr>
<p>Last updated on 2024-11-21 |

        <a href="https://github.com/ehogan/ESMValTool_Tutorial/edit/main/episodes/08-diagnostics.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Estimated time: <i aria-hidden="true" data-feather="clock"></i> 50 minutes</p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<section><h2 class="section-heading" id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<hr class="half-width">
<p>The diagnostic script is an important component of ESMValTool and it
is where the scientific analysis or performance metric is implemented.
With ESMValTool, you can adapt an existing diagnostic or write a new
script from scratch. Diagnostics can be written in a number of open
source languages such as Python, R, Julia and NCL but we will focus on
understanding and writing Python diagnostics in this lesson.</p>
<p>In this lesson, we will explain how to find an existing diagnostic
and run it using ESMValTool installed in editable/development mode. For
a development installation, see the instructions in the lesson <a href="%7B%7B%20page.root%20%7D%7D%7B%%20link%20_episodes/07-development-setup.md%20%%7D">Development
and contribution</a>. Also, we will work with the recipe
[recipe_python.yml][recipe] and the diagnostic script
[diagnostic.py][diagnostic] called by this recipe that we have seen in
the lesson <a href="%7B%7B%20page.root%20%7D%7D%7B%%20link%20_episodes/04-recipe.md%20%%7D">Running
your first recipe</a>.</p>
<p>Let’s get started!</p>
</section><section><h2 class="section-heading" id="understanding-an-existing-python-diagnostic">Understanding an existing Python diagnostic<a class="anchor" aria-label="anchor" href="#understanding-an-existing-python-diagnostic"></a>
</h2>
<hr class="half-width">
<p>If you clone the ESMValTool repository, a folder called
<code>ESMValTool</code> is created in your home/working directory, see
the instructions in the lesson <a href="%7B%7B%20page.root%20%7D%7D%7B%%20link%20_episodes/07-development-setup.md%20%%7D">Development
and contribution</a>.</p>
<p>The folder <code>ESMValTool</code> contains the source code of the
tool. We can find the recipe <code>recipe_python.yml</code> and the
python script <code>diagnostic.py</code> in these directories:</p>
<ul>
<li><em>~/ESMValTool/esmvaltool/recipes/examples/recipe_python.yml</em></li>
<li><em>~/ESMValTool/esmvaltool/diag_scripts/examples/diagnostic.py</em></li>
</ul>
<p>Let’s have look at the code in <code>diagnostic.py</code>. For
reference, we show the diagnostic code in the dropdown box below. There
are four main sections in the script:</p>
<ul>
<li>A description i.e. the <code>docstring</code> (line 1).</li>
<li>Import statements (line 2-16).</li>
<li>Functions that implement our analysis (line 21-102).</li>
<li>A typical Python top-level script
i.e. <code>if __name__ == '__main__'</code> (line 105-108).</li>
</ul>
<blockquote>
<h2 id="diagnostic.py">diagnostic.py</h2>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a> <span class="dv">1</span>:  <span class="st">"""Python example diagnostic."""</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a> <span class="dv">2</span>:  <span class="im">import</span> logging</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a> <span class="dv">3</span>:  <span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a> <span class="dv">4</span>:  <span class="im">from</span> pprint <span class="im">import</span> pformat</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a> <span class="dv">5</span>:</span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a> <span class="dv">6</span>:  <span class="im">import</span> iris</span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a> <span class="dv">7</span>:</span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a> <span class="dv">8</span>:  <span class="im">from</span> esmvaltool.diag_scripts.shared <span class="im">import</span> (</span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a> <span class="dv">9</span>:      group_metadata,</span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a><span class="dv">10</span>:      run_diagnostic,</span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a><span class="dv">11</span>:      save_data,</span>
<span id="cb1-12"><a href="#cb1-12" tabindex="-1"></a><span class="dv">12</span>:      save_figure,</span>
<span id="cb1-13"><a href="#cb1-13" tabindex="-1"></a><span class="dv">13</span>:      select_metadata,</span>
<span id="cb1-14"><a href="#cb1-14" tabindex="-1"></a><span class="dv">14</span>:      sorted_metadata,</span>
<span id="cb1-15"><a href="#cb1-15" tabindex="-1"></a><span class="dv">15</span>:  )</span>
<span id="cb1-16"><a href="#cb1-16" tabindex="-1"></a><span class="dv">16</span>:  <span class="im">from</span> esmvaltool.diag_scripts.shared.plot <span class="im">import</span> quickplot</span>
<span id="cb1-17"><a href="#cb1-17" tabindex="-1"></a><span class="dv">17</span>:</span>
<span id="cb1-18"><a href="#cb1-18" tabindex="-1"></a><span class="dv">18</span>:  logger <span class="op">=</span> logging.getLogger(Path(<span class="va">__file__</span>).stem)</span>
<span id="cb1-19"><a href="#cb1-19" tabindex="-1"></a><span class="dv">19</span>:</span>
<span id="cb1-20"><a href="#cb1-20" tabindex="-1"></a><span class="dv">20</span>:</span>
<span id="cb1-21"><a href="#cb1-21" tabindex="-1"></a><span class="dv">21</span>:  <span class="kw">def</span> get_provenance_record(attributes, ancestor_files):</span>
<span id="cb1-22"><a href="#cb1-22" tabindex="-1"></a><span class="dv">22</span>:      <span class="st">"""Create a provenance record describing the diagnostic data and plot."""</span></span>
<span id="cb1-23"><a href="#cb1-23" tabindex="-1"></a><span class="dv">23</span>:      caption <span class="op">=</span> caption <span class="op">=</span> attributes[<span class="st">'caption'</span>].<span class="bu">format</span>(<span class="op">**</span>attributes)</span>
<span id="cb1-24"><a href="#cb1-24" tabindex="-1"></a><span class="dv">24</span>:</span>
<span id="cb1-25"><a href="#cb1-25" tabindex="-1"></a><span class="dv">25</span>:      record <span class="op">=</span> {</span>
<span id="cb1-26"><a href="#cb1-26" tabindex="-1"></a><span class="dv">26</span>:          <span class="st">'caption'</span>: caption,</span>
<span id="cb1-27"><a href="#cb1-27" tabindex="-1"></a><span class="dv">27</span>:          <span class="st">'statistics'</span>: [<span class="st">'mean'</span>],</span>
<span id="cb1-28"><a href="#cb1-28" tabindex="-1"></a><span class="dv">28</span>:          <span class="st">'domains'</span>: [<span class="st">'global'</span>],</span>
<span id="cb1-29"><a href="#cb1-29" tabindex="-1"></a><span class="dv">29</span>:          <span class="st">'plot_types'</span>: [<span class="st">'zonal'</span>],</span>
<span id="cb1-30"><a href="#cb1-30" tabindex="-1"></a><span class="dv">30</span>:          <span class="st">'authors'</span>: [</span>
<span id="cb1-31"><a href="#cb1-31" tabindex="-1"></a><span class="dv">31</span>:              <span class="st">'andela_bouwe'</span>,</span>
<span id="cb1-32"><a href="#cb1-32" tabindex="-1"></a><span class="dv">32</span>:              <span class="st">'righi_mattia'</span>,</span>
<span id="cb1-33"><a href="#cb1-33" tabindex="-1"></a><span class="dv">33</span>:          ],</span>
<span id="cb1-34"><a href="#cb1-34" tabindex="-1"></a><span class="dv">34</span>:          <span class="st">'references'</span>: [</span>
<span id="cb1-35"><a href="#cb1-35" tabindex="-1"></a><span class="dv">35</span>:              <span class="st">'acknow_project'</span>,</span>
<span id="cb1-36"><a href="#cb1-36" tabindex="-1"></a><span class="dv">36</span>:          ],</span>
<span id="cb1-37"><a href="#cb1-37" tabindex="-1"></a><span class="dv">37</span>:          <span class="st">'ancestors'</span>: ancestor_files,</span>
<span id="cb1-38"><a href="#cb1-38" tabindex="-1"></a><span class="dv">38</span>:      }</span>
<span id="cb1-39"><a href="#cb1-39" tabindex="-1"></a><span class="dv">39</span>:      <span class="cf">return</span> record</span>
<span id="cb1-40"><a href="#cb1-40" tabindex="-1"></a><span class="dv">40</span>:</span>
<span id="cb1-41"><a href="#cb1-41" tabindex="-1"></a><span class="dv">41</span>:</span>
<span id="cb1-42"><a href="#cb1-42" tabindex="-1"></a><span class="dv">42</span>:  <span class="kw">def</span> compute_diagnostic(filename):</span>
<span id="cb1-43"><a href="#cb1-43" tabindex="-1"></a><span class="dv">43</span>:      <span class="st">"""Compute an example diagnostic."""</span></span>
<span id="cb1-44"><a href="#cb1-44" tabindex="-1"></a><span class="dv">44</span>:      logger.debug(<span class="st">"Loading </span><span class="sc">%s</span><span class="st">"</span>, filename)</span>
<span id="cb1-45"><a href="#cb1-45" tabindex="-1"></a><span class="dv">45</span>:      cube <span class="op">=</span> iris.load_cube(filename)</span>
<span id="cb1-46"><a href="#cb1-46" tabindex="-1"></a><span class="dv">46</span>:</span>
<span id="cb1-47"><a href="#cb1-47" tabindex="-1"></a><span class="dv">47</span>:      logger.debug(<span class="st">"Running example computation"</span>)</span>
<span id="cb1-48"><a href="#cb1-48" tabindex="-1"></a><span class="dv">48</span>:      cube <span class="op">=</span> iris.util.squeeze(cube)</span>
<span id="cb1-49"><a href="#cb1-49" tabindex="-1"></a><span class="dv">49</span>:      <span class="cf">return</span> cube</span>
<span id="cb1-50"><a href="#cb1-50" tabindex="-1"></a><span class="dv">50</span>:</span>
<span id="cb1-51"><a href="#cb1-51" tabindex="-1"></a><span class="dv">51</span>:</span>
<span id="cb1-52"><a href="#cb1-52" tabindex="-1"></a><span class="dv">52</span>:  <span class="kw">def</span> plot_diagnostic(cube, basename, provenance_record, cfg):</span>
<span id="cb1-53"><a href="#cb1-53" tabindex="-1"></a><span class="dv">53</span>:      <span class="st">"""Create diagnostic data and plot it."""</span></span>
<span id="cb1-54"><a href="#cb1-54" tabindex="-1"></a><span class="dv">54</span>:</span>
<span id="cb1-55"><a href="#cb1-55" tabindex="-1"></a><span class="dv">55</span>:      <span class="co"># Save the data used for the plot</span></span>
<span id="cb1-56"><a href="#cb1-56" tabindex="-1"></a><span class="dv">56</span>:      save_data(basename, provenance_record, cfg, cube)</span>
<span id="cb1-57"><a href="#cb1-57" tabindex="-1"></a><span class="dv">57</span>:</span>
<span id="cb1-58"><a href="#cb1-58" tabindex="-1"></a><span class="dv">58</span>:      <span class="cf">if</span> cfg.get(<span class="st">'quickplot'</span>):</span>
<span id="cb1-59"><a href="#cb1-59" tabindex="-1"></a><span class="dv">59</span>:          <span class="co"># Create the plot</span></span>
<span id="cb1-60"><a href="#cb1-60" tabindex="-1"></a><span class="dv">60</span>:          quickplot(cube, <span class="op">**</span>cfg[<span class="st">'quickplot'</span>])</span>
<span id="cb1-61"><a href="#cb1-61" tabindex="-1"></a><span class="dv">61</span>:          <span class="co"># And save the plot</span></span>
<span id="cb1-62"><a href="#cb1-62" tabindex="-1"></a><span class="dv">62</span>:          save_figure(basename, provenance_record, cfg)</span>
<span id="cb1-63"><a href="#cb1-63" tabindex="-1"></a><span class="dv">63</span>:</span>
<span id="cb1-64"><a href="#cb1-64" tabindex="-1"></a><span class="dv">64</span>:</span>
<span id="cb1-65"><a href="#cb1-65" tabindex="-1"></a><span class="dv">65</span>:  <span class="kw">def</span> main(cfg):</span>
<span id="cb1-66"><a href="#cb1-66" tabindex="-1"></a><span class="dv">66</span>:      <span class="st">"""Compute the time average for each input dataset."""</span></span>
<span id="cb1-67"><a href="#cb1-67" tabindex="-1"></a><span class="dv">67</span>:      <span class="co"># Get a description of the preprocessed data that we will use as input.</span></span>
<span id="cb1-68"><a href="#cb1-68" tabindex="-1"></a><span class="dv">68</span>:      input_data <span class="op">=</span> cfg[<span class="st">'input_data'</span>].values()</span>
<span id="cb1-69"><a href="#cb1-69" tabindex="-1"></a><span class="dv">69</span>:</span>
<span id="cb1-70"><a href="#cb1-70" tabindex="-1"></a><span class="dv">70</span>:      <span class="co"># Demonstrate use of metadata access convenience functions.</span></span>
<span id="cb1-71"><a href="#cb1-71" tabindex="-1"></a><span class="dv">71</span>:      selection <span class="op">=</span> select_metadata(input_data, short_name<span class="op">=</span><span class="st">'tas'</span>, project<span class="op">=</span><span class="st">'CMIP5'</span>)</span>
<span id="cb1-72"><a href="#cb1-72" tabindex="-1"></a><span class="dv">72</span>:      logger.info(<span class="st">"Example of how to select only CMIP5 temperature data:</span><span class="ch">\n</span><span class="sc">%s</span><span class="st">"</span>,</span>
<span id="cb1-73"><a href="#cb1-73" tabindex="-1"></a><span class="dv">73</span>:                  pformat(selection))</span>
<span id="cb1-74"><a href="#cb1-74" tabindex="-1"></a><span class="dv">74</span>:</span>
<span id="cb1-75"><a href="#cb1-75" tabindex="-1"></a><span class="dv">75</span>:      selection <span class="op">=</span> sorted_metadata(selection, sort<span class="op">=</span><span class="st">'dataset'</span>)</span>
<span id="cb1-76"><a href="#cb1-76" tabindex="-1"></a><span class="dv">76</span>:      logger.info(<span class="st">"Example of how to sort this selection by dataset:</span><span class="ch">\n</span><span class="sc">%s</span><span class="st">"</span>,</span>
<span id="cb1-77"><a href="#cb1-77" tabindex="-1"></a><span class="dv">77</span>:                  pformat(selection))</span>
<span id="cb1-78"><a href="#cb1-78" tabindex="-1"></a><span class="dv">78</span>:</span>
<span id="cb1-79"><a href="#cb1-79" tabindex="-1"></a><span class="dv">79</span>:      grouped_input_data <span class="op">=</span> group_metadata(input_data,</span>
<span id="cb1-80"><a href="#cb1-80" tabindex="-1"></a><span class="dv">80</span>:                                          <span class="st">'variable_group'</span>,</span>
<span id="cb1-81"><a href="#cb1-81" tabindex="-1"></a><span class="dv">81</span>:                                          sort<span class="op">=</span><span class="st">'dataset'</span>)</span>
<span id="cb1-82"><a href="#cb1-82" tabindex="-1"></a><span class="dv">82</span>:      logger.info(</span>
<span id="cb1-83"><a href="#cb1-83" tabindex="-1"></a><span class="dv">83</span>:          <span class="st">"Example of how to group and sort input data by variable groups from "</span></span>
<span id="cb1-84"><a href="#cb1-84" tabindex="-1"></a><span class="dv">84</span>:          <span class="st">"the recipe:</span><span class="ch">\n</span><span class="sc">%s</span><span class="st">"</span>, pformat(grouped_input_data))</span>
<span id="cb1-85"><a href="#cb1-85" tabindex="-1"></a><span class="dv">85</span>:</span>
<span id="cb1-86"><a href="#cb1-86" tabindex="-1"></a><span class="dv">86</span>:      <span class="co"># Example of how to loop over variables/datasets in alphabetical order</span></span>
<span id="cb1-87"><a href="#cb1-87" tabindex="-1"></a><span class="dv">87</span>:      groups <span class="op">=</span> group_metadata(input_data, <span class="st">'variable_group'</span>, sort<span class="op">=</span><span class="st">'dataset'</span>)</span>
<span id="cb1-88"><a href="#cb1-88" tabindex="-1"></a><span class="dv">88</span>:      <span class="cf">for</span> group_name <span class="kw">in</span> groups:</span>
<span id="cb1-89"><a href="#cb1-89" tabindex="-1"></a><span class="dv">89</span>:          logger.info(<span class="st">"Processing variable </span><span class="sc">%s</span><span class="st">"</span>, group_name)</span>
<span id="cb1-90"><a href="#cb1-90" tabindex="-1"></a><span class="dv">90</span>:          <span class="cf">for</span> attributes <span class="kw">in</span> groups[group_name]:</span>
<span id="cb1-91"><a href="#cb1-91" tabindex="-1"></a><span class="dv">91</span>:              logger.info(<span class="st">"Processing dataset </span><span class="sc">%s</span><span class="st">"</span>, attributes[<span class="st">'dataset'</span>])</span>
<span id="cb1-92"><a href="#cb1-92" tabindex="-1"></a><span class="dv">92</span>:              input_file <span class="op">=</span> attributes[<span class="st">'filename'</span>]</span>
<span id="cb1-93"><a href="#cb1-93" tabindex="-1"></a><span class="dv">93</span>:              cube <span class="op">=</span> compute_diagnostic(input_file)</span>
<span id="cb1-94"><a href="#cb1-94" tabindex="-1"></a><span class="dv">94</span>:</span>
<span id="cb1-95"><a href="#cb1-95" tabindex="-1"></a><span class="dv">95</span>:              output_basename <span class="op">=</span> Path(input_file).stem</span>
<span id="cb1-96"><a href="#cb1-96" tabindex="-1"></a><span class="dv">96</span>:              <span class="cf">if</span> group_name <span class="op">!=</span> attributes[<span class="st">'short_name'</span>]:</span>
<span id="cb1-97"><a href="#cb1-97" tabindex="-1"></a><span class="dv">97</span>:                  output_basename <span class="op">=</span> group_name <span class="op">+</span> <span class="st">'_'</span> <span class="op">+</span> output_basename</span>
<span id="cb1-98"><a href="#cb1-98" tabindex="-1"></a><span class="dv">98</span>:              <span class="cf">if</span> <span class="st">"caption"</span> <span class="kw">not</span> <span class="kw">in</span> attributes:</span>
<span id="cb1-99"><a href="#cb1-99" tabindex="-1"></a><span class="dv">99</span>:                  attributes[<span class="st">'caption'</span>] <span class="op">=</span> input_file</span>
<span id="cb1-100"><a href="#cb1-100" tabindex="-1"></a><span class="dv">100</span>:              provenance_record <span class="op">=</span> get_provenance_record(</span>
<span id="cb1-101"><a href="#cb1-101" tabindex="-1"></a><span class="dv">101</span>:                  attributes, ancestor_files<span class="op">=</span>[input_file])</span>
<span id="cb1-102"><a href="#cb1-102" tabindex="-1"></a><span class="dv">102</span>:              plot_diagnostic(cube, output_basename, provenance_record, cfg)</span>
<span id="cb1-103"><a href="#cb1-103" tabindex="-1"></a><span class="dv">103</span>:</span>
<span id="cb1-104"><a href="#cb1-104" tabindex="-1"></a><span class="dv">104</span>:</span>
<span id="cb1-105"><a href="#cb1-105" tabindex="-1"></a><span class="dv">105</span>:  <span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">'__main__'</span>:</span>
<span id="cb1-106"><a href="#cb1-106" tabindex="-1"></a><span class="dv">106</span>:</span>
<span id="cb1-107"><a href="#cb1-107" tabindex="-1"></a><span class="dv">107</span>:      <span class="cf">with</span> run_diagnostic() <span class="im">as</span> config:</span>
<span id="cb1-108"><a href="#cb1-108" tabindex="-1"></a><span class="dv">108</span>:          main(config)</span></code></pre>
</div>
<p>{:.solution}</p>
</blockquote>
<blockquote>
<h2 id="what-is-the-starting-point-of-a-diagnostic">What is the starting
point of a diagnostic?</h2>
<ol style="list-style-type: decimal">
<li>Can you spot a function called <code>main</code> in the code
above?</li>
<li>What are its input arguments?</li>
<li>How many times is this function mentioned?</li>
</ol>
<blockquote>
<h2 id="answer">Answer</h2>
<ol style="list-style-type: decimal">
<li>The <code>main</code> function is defined in line 65 as
<code>main(cfg)</code>.</li>
<li>The input argument to this function is the variable
<code>cfg</code>, a Python dictionary that holds all the necessary
information needed to run the diagnostic script such as the location of
input data and various settings. We will next parse this
<code>cfg</code> variable in the <code>main</code> function and extract
information as needed to do our analyses (e.g. in line 68).</li>
<li>The <code>main</code> function is called near the very end on line
108. So, it is mentioned twice in our code - once where it is called by
the top-level Python script and second where it is defined. {:
.solution} {: .challenge}</li>
</ol>
</blockquote>
</blockquote>
<blockquote>
<h2 id="the-function-run_diagnostic">The function run_diagnostic</h2>
<p>The function <code>run_diagnostic</code> (line 107) is called a
context manager provided with ESMValTool and is the main entry point for
most Python diagnostics.</p>
<p>{: .callout}</p>
</blockquote>
</section><section><h2 class="section-heading" id="preprocessor-diagnostic-interface">Preprocessor-diagnostic interface<a class="anchor" aria-label="anchor" href="#preprocessor-diagnostic-interface"></a>
</h2>
<hr class="half-width">
<p>In the previous exercise, we have seen that the variable
<code>cfg</code> is the input argument of the <code>main</code>
function. The first argument passed to the diagnostic via the
<code>cfg</code> dictionary is a path to a file called
<code>settings.yml</code>. The ESMValTool documentation page provides an
overview of what is in this file, see [Diagnostic script
interfaces][interface].</p>
<blockquote>
<h2 id="what-information-do-i-need-when-writing-a-diagnostic-script">What
information do I need when writing a diagnostic script?</h2>
<p>From the lesson <a href="%7B%7B%20page.root%20%7D%7D%7B%%20link%20_episodes/03-configuration.md%20%%7D">Configuration</a>,
we saw how to change the configuration settings before running a recipe.
First we set the option <code>remove_preproc_dir</code> to
<code>false</code> in the configuration file, then run the recipe
<code>recipe_python.yml</code>:</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="ex">esmvaltool</span> run examples/recipe_python.yml</span></code></pre>
</div>
<ol style="list-style-type: decimal">
<li>Find one example of the file <code>settings.yml</code> in the
<code>run</code> directory?</li>
<li>Open the file <code>settings.yml</code> and look at the
<code>input_files</code> list. It contains paths to some files
<code>metadata.yml</code>. What information do you think is saved in
those files?</li>
</ol>
<blockquote>
<h2 id="answer-1">Answer</h2>
<ol style="list-style-type: decimal">
<li>One example of <code>settings.yml</code> can be found in the
directory:
<em>path_to_recipe_output/run/map/script1/settings.yml</em>
</li>
<li>The <code>metadata.yml</code> files hold information about the
preprocessed data. There is one file for each variable having detailed
information on your data including project (e.g., CMIP6, CMIP5), dataset
names (e.g., BCC-ESM1, CanESM2), variable attributes (e.g.,
standard_name, units), preprocessor applied and time range of the data.
You can use all of this information in your own diagnostic.</li>
</ol>
<p>{: .solution} {: .challenge}</p>
</blockquote>
</blockquote>
</section><section><h2 class="section-heading" id="diagnostic-shared-functions">Diagnostic shared functions<a class="anchor" aria-label="anchor" href="#diagnostic-shared-functions"></a>
</h2>
<hr class="half-width">
<p>Looking at the code in <code>diagnostic.py</code>, we see that
<code>input_data</code> is read from the <code>cfg</code> dictionary
(line 68). Now we can group the <code>input_data</code> according to
some criteria such as the model or experiment. To do so, ESMValTool
provides many functions such as <code>select_metadata</code> (line 71),
<code>sorted_metadata</code> (line 75), and <code>group_metadata</code>
(line 79). As you can see in line 8, these functions are imported from
<code>esmvaltool.diag_scripts.shared</code> that means these are shared
across several diagnostics scripts. A list of available functions and
their description can be found in [The ESMValTool Diagnostic API
reference][shared].</p>
<blockquote>
<h2 id="extracting-information-needed-for-analyses">Extracting
information needed for analyses</h2>
<p>We have seen the functions used for selecting, sorting and grouping
data in the script. What do these functions do?</p>
<blockquote>
<h2 id="answer-2">Answer</h2>
<p>There is a statement after use of <code>select_metadata</code>,
<code>sorted_metadata</code> and <code>group_metadata</code> that starts
with <code>logger.info</code> (lines 72, 76 and 82). These lines print
output to the log files. In the previous exercise, we ran the recipe
<code>recipe_python.yml</code>. If you look at the log file
<code>recipe_python_#_#/run/map/script1/log.txt</code> in
<code>esmvaltool_output</code> directory, you can see the output from
each of these functions, for example:</p>
<pre><code>2023-06-28 12:47:14,038 [2548510] INFO     diagnostic,106	Example of how to
group and sort input data by variable groups from the recipe:
{'tas': [{'alias': 'CMIP5',
         'caption': 'Global map of {long_name} in January 2000 according to '
                    '{dataset}.\n',
         'dataset': 'bcc-csm1-1',
         'diagnostic': 'map',
         'end_year': 2000,
         'ensemble': 'r1i1p1',
         'exp': 'historical',
         'filename': '~/recipe_python_20230628_124639/preproc/map/tas/
CMIP5_bcc-csm1-1_Amon_historical_r1i1p1_tas_2000-P1M.nc',
         'frequency': 'mon',
         'institute': ['BCC'],
         'long_name': 'Near-Surface Air Temperature',
         'mip': 'Amon',
         'modeling_realm': ['atmos'],
         'preprocessor': 'to_degrees_c',
         'product': ['output1', 'output2'],
         'project': 'CMIP5',
         'recipe_dataset_index': 1,
         'short_name': 'tas',
         'standard_name': 'air_temperature',
         'start_year': 2000,
         'timerange': '2000/P1M',
         'units': 'degrees_C',
         'variable_group': 'tas',
         'version': 'v1'},
        {'activity': 'CMIP',
         'alias': 'CMIP6',
         'caption': 'Global map of {long_name} in January 2000 according to '
                    '{dataset}.\n',
         'dataset': 'BCC-ESM1',
         'diagnostic': 'map',
         'end_year': 2000,
         'ensemble': 'r1i1p1f1',
         'exp': 'historical',
         'filename': '~/recipe_python_20230628_124639/preproc/map/tas/
CMIP6_BCC-ESM1_Amon_historical_r1i1p1f1_tas_gn_2000-P1M.nc',
         'frequency': 'mon',
         'grid': 'gn',
         'institute': ['BCC'],
         'long_name': 'Near-Surface Air Temperature',
         'mip': 'Amon',
         'modeling_realm': ['atmos'],
         'preprocessor': 'to_degrees_c',
         'project': 'CMIP6',
         'recipe_dataset_index': 0,
         'short_name': 'tas',
         'standard_name': 'air_temperature',
         'start_year': 2000,
         'timerange': '2000/P1M',
         'units': 'degrees_C',
         'variable_group': 'tas',
         'version': 'v20181214'}]}</code></pre>
<p>This is how we can access preprocessed data within our diagnostic. {:
.solution} {: .challenge}</p>
</blockquote>
</blockquote>
</section><section><h2 class="section-heading" id="diagnostic-computation">Diagnostic computation<a class="anchor" aria-label="anchor" href="#diagnostic-computation"></a>
</h2>
<hr class="half-width">
<p>After grouping and selecting data, we can read individual attributes
(such as filename) of each item. Here, we have grouped the input data by
<code>variables</code>, so we loop over the variables (line 88).
Following this is a call to the function <code>compute_diagnostic</code>
(line 93). Let’s look at the definition of this function in line 42,
where the actual analysis of the data is done.</p>
<p>Note that output from the ESMValCore preprocessor is in the form of
NetCDF files. Here, <code>compute_diagnostic</code> uses <a href="https://scitools-iris.readthedocs.io/en/latest/index.html" class="external-link">Iris</a>
to read data from a netCDF file and performs an operation
<code>squeeze</code> to remove any dimensions of length one. We can
adapt this function to add our own analysis. As an example, here we
calculate the bias using the average of the data using Iris cubes.</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="kw">def</span> compute_diagnostic(filename):</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>    <span class="co">"""Compute an example diagnostic."""</span></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>    logger.debug(<span class="st">"Loading </span><span class="sc">%s</span><span class="st">"</span>, filename)</span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>    cube <span class="op">=</span> iris.load_cube(filename)</span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a>    logger.debug(<span class="st">"Running example computation"</span>)</span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a>    cube <span class="op">=</span> iris.util.squeeze(cube)</span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a>    <span class="co"># Calculate a bias using the average of data</span></span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a>    cube.data <span class="op">=</span> cube.core_data() <span class="op">-</span> cube.core_data.mean()</span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a>    <span class="cf">return</span> cube</span></code></pre>
</div>
<blockquote>
<h2 id="iris-cubes">iris cubes</h2>
<p>Iris reads data from NetCDF files into data structures called <a href="https://scitools-iris.readthedocs.io/en/latest/userguide/iris_cubes.html" class="external-link">cubes</a>.
The data in these cubes can be modified, combined with other cubes’ data
or plotted. {: .callout}</p>
</blockquote>
<blockquote>
<h2 id="reading-data-using-xarray">Reading data using xarray</h2>
<p>Alternately, you can use <a href="http://xarray.pydata.org/en/stable/" class="external-link">xarrays</a> to read the data
instead of Iris.</p>
<blockquote>
<h2 id="answer-3">Answer</h2>
<p>First, import <code>xarray</code> package at the top of the script
as:</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="im">import</span> xarray <span class="im">as</span> xr</span></code></pre>
</div>
<p>Then, change the <code>compute_diagnostic</code> as:</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="kw">def</span> compute_diagnostic(filename):</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>   <span class="co">"""Compute an example diagnostic."""</span></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>   logger.debug(<span class="st">"Loading </span><span class="sc">%s</span><span class="st">"</span>, filename)</span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>   dataset <span class="op">=</span> xr.open_dataset(filename)</span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a>   <span class="co">#do your analyses on the data here</span></span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a>   <span class="cf">return</span> dataset</span></code></pre>
</div>
<p>Caution: If you read data using xarray keep in mind to change
accordingly the other functions in the diagnostic which are dealing at
the moment with Iris cubes.</p>
<p>{: .solution} {: .challenge}</p>
</blockquote>
</blockquote>
<blockquote>
<h2 id="reading-data-using-the-netcdf4-package">Reading data using the
netCDF4 package</h2>
<p>Yet another option to read the NetCDF file data is to use the
[netCDF-4 Python interface][netCDF] to the netCDF C library.</p>
<blockquote>
<h2 id="answer-4">Answer</h2>
<p>First, import the <code>netCDF4</code> package at the top of the
script as:</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="im">import</span> netCDF4</span></code></pre>
</div>
<p>Then, change <code>compute_diagnostic</code> as:</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="kw">def</span> compute_diagnostic(filename):</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>   <span class="co">"""Compute an example diagnostic."""</span></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>   logger.debug(<span class="st">"Loading </span><span class="sc">%s</span><span class="st">"</span>, filename)</span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>   nc_data <span class="op">=</span> netCDF4.Dataset(filename,<span class="st">'r'</span>)</span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a>   <span class="co">#do your analyses on the data here</span></span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a>   <span class="cf">return</span> nc_data</span></code></pre>
</div>
<p>Caution: If you read data using netCDF4 keep in mind to change
accordingly the other functions in the diagnostic which are dealing at
the moment with Iris cubes.</p>
<p>{: .solution} {: .challenge}</p>
</blockquote>
</blockquote>
</section><section><h2 class="section-heading" id="diagnostic-output">Diagnostic output<a class="anchor" aria-label="anchor" href="#diagnostic-output"></a>
</h2>
<hr class="half-width">
<div class="section level3">
<h3 id="plotting-the-output">Plotting the output<a class="anchor" aria-label="anchor" href="#plotting-the-output"></a>
</h3>
<p>Often, the end product of a diagnostic script is a plot or figure.
The Iris cube returned from the <code>compute_diagnostic</code> function
(line 93) is passed to the <code>plot_diagnostic</code> function (line
102). Let’s have a look at the definition of this function in line 52.
This is where we would plug in our plotting routine in the diagnostic
script.</p>
<p>More specifically, the <code>quickplot</code> function (line 60) can
be replaced with the function of our choice. As can be seen, this
function uses <code>**cfg['quickplot']</code> as an input argument. If
you look at the diagnostic section in the recipe
<code>recipe_python.yml</code>, you see <code>quickplot</code> is a key
there:</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">YAML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yaml" tabindex="0"><code class="sourceCode yaml"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="at">     </span><span class="fu">script1</span><span class="kw">:</span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a><span class="at">       </span><span class="fu">script</span><span class="kw">:</span><span class="at"> examples/diagnostic.py</span></span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a><span class="at">        </span><span class="fu">quickplot</span><span class="kw">:</span></span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a><span class="at">          </span><span class="fu">plot_type</span><span class="kw">:</span><span class="at"> pcolormesh</span></span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a><span class="at">          </span><span class="fu">cmap</span><span class="kw">:</span><span class="at"> Reds</span></span></code></pre>
</div>
<p>This way, we can pass arguments such as the type of plot
<code>pcolormesh</code> and the colormap <code>cmap:Reds</code> from the
recipe to the <code>quickplot</code> function in the diagnostic.</p>
<blockquote>
<h2 id="passing-arguments-from-the-recipe-to-the-diagnostic">Passing
arguments from the recipe to the diagnostic</h2>
<p>Change the type of the plot and its colormap and inspect the output
figure.</p>
<blockquote>
<h2 id="answer-5">Answer</h2>
<p>In the recipe <code>recipe_python.yml</code>, you could change
<code>plot_type</code> and <code>cmap</code>. As an example, we choose
<code>plot_type: pcolor</code> and <code>cmap: BuGn</code>:</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">YAML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yaml" tabindex="0"><code class="sourceCode yaml"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="at">    </span><span class="fu">script1</span><span class="kw">:</span></span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a><span class="at">      </span><span class="fu">script</span><span class="kw">:</span><span class="at"> examples/diagnostic.py</span></span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a><span class="at">       </span><span class="fu">quickplot</span><span class="kw">:</span></span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a><span class="at">         </span><span class="fu">plot_type</span><span class="kw">:</span><span class="at"> pcolor</span></span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a><span class="at">         </span><span class="fu">cmap</span><span class="kw">:</span><span class="at"> BuGn</span></span></code></pre>
</div>
<p>The plot can be found at
<em>path_to_recipe_output/plots/map/script1/png</em>. {: .solution} {:
.challenge}</p>
</blockquote>
</blockquote>
<blockquote>
<h2 id="esmvaltool-gallery">ESMValTool gallery</h2>
<p>ESMValTool makes it possible to produce a wide array of plots and
figures as seen in the <a href="https://docs.esmvaltool.org/en/latest/gallery.html" class="external-link">gallery</a>.
{: .callout}</p>
</blockquote>
</div>
<div class="section level3">
<h3 id="saving-the-output">Saving the output<a class="anchor" aria-label="anchor" href="#saving-the-output"></a>
</h3>
<p>In our example, the function <code>save_data</code> in line 56 is
used to save the Iris cube. The saved files can be found under the
<code>work</code> directory in a <code>.nc</code> format. There is also
the function <code>save_figure</code> in line 62 to save the plots under
the <code>plot</code> directory in a <code>.png</code> format (or
preferred format specified in your configuration settings). Again, you
may choose your own method of saving the output.</p>
</div>
<div class="section level3">
<h3 id="recording-the-provenance">Recording the provenance<a class="anchor" aria-label="anchor" href="#recording-the-provenance"></a>
</h3>
<p>When developing a diagnostic script, it is good practice to record
provenance. To do so, we use the function
<code>get_provenance_record</code> (line 100). Let us have a look at the
definition of this function in line 21 where we describe the diagnostic
data and plot. Using the dictionary <code>record</code>, it is possible
to add custom provenance to our diagnostics output. Provenance is stored
in the <em><a href="https://www.w3.org/TR/prov-xml/" class="external-link">W3C PROV
XML</a></em> format and also in an <em>SVG</em> file under the
<code>work</code> and <code>plot</code> directory. For more information,
see [recording provenance][provenance].</p>
</div>
</section><section><h2 class="section-heading" id="congratulations">Congratulations!<a class="anchor" aria-label="anchor" href="#congratulations"></a>
</h2>
<hr class="half-width">
<p>You now know the basic diagnostic script structure and some available
tools for putting together your own diagnostics. Have a look at existing
recipes and diagnostics in the repository for more examples of functions
you can use in your diagnostics! {% include links.md %}</p>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</section></section><section id="aio-09-cmorization"><p>Content from <a href="09-cmorization.html">CMORization: adding new datasets to ESMValTool</a></p>
<hr>
<p>Last updated on 2024-11-21 |

        <a href="https://github.com/ehogan/ESMValTool_Tutorial/edit/main/episodes/09-cmorization.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Estimated time: <i aria-hidden="true" data-feather="clock"></i> 60 minutes</p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<figure><img src="../fig/data_flow.png" alt="Data flow with ESMValTool" class="figure mx-auto d-block"><div class="figcaption">Data flow with ESMValTool</div>
</figure><section><h2 class="section-heading" id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<hr class="half-width">
<p>This episode deals with “CMORization”. ESMValTool is designed to work
with data that follow the CMOR standards. Unfortunately, not all
datasets follow these standards. In order to use such datasets in
ESMValTool we first need to reformat the data. This process is called
“CMORization”.</p>
<blockquote>
<h2 id="what-are-the-cmor-standards">What are the CMOR standards?</h2>
<p>The name “CMOR” originates from a tool: <a href="https://cmor.llnl.gov/" class="external-link">the Climate Model Output Rewriter</a>.
This tool is used to create “CF-Compliant netCDF files for use in the
CMIP projects”. So CMOR extends the <a href="https://cfconventions.org/" class="external-link">CF-standard</a> with additional
requirements for the Coupled Model Intercomparison Projects (see e.g. <a href="https://pcmdi.llnl.gov/CMIP6/Guide/modelers.html#5-model-output-requirements" class="external-link">here</a>).</p>
<p>Concretely, the CMOR standards dictate e.g. the variable names and
units, coordinate information, how the data should be structured (e.g. 1
variable per file), additional metadata requirements, and file naming
conventions a.k.a. the data reference syntax (<a href="https://docs.esmvaltool.org/projects/esmvalcore/en/latest/quickstart/find_data.html" class="external-link">DRS</a>).
All this information is stored in so-called CMOR tables. For example,
the CMOR tables for the CMIP6 project can be found <a href="https://github.com/PCMDI/cmip6-cmor-tables" class="external-link">here</a>. {:
.callout}</p>
</blockquote>
<p>ESMValTool offers two ways to CMORize data: 1. A reformatting script
can be used to create a CMOR-compliant copy. CMORizer scripts for
several popular datasets are included in ESMValTool, and ESMValTool also
provides a convenient way to execute them. 2. ESMValCore can execute
CMOR fixes ‘<a href="https://docs.esmvaltool.org/projects/esmvalcore/en/latest/develop/%20fixing_data.html#fixing-data" class="external-link">on
the fly</a>’. The advantage is that you don’t need to store an
additional, reformatted copy of the data. The disadvantage is that these
fixes should be implemented inside ESMValCore, which is beyond the scope
of this tutorial.</p>
<p>In this lesson, we will re-implement a CMORizer script for the
FLUXCOM dataset that contains observations of the Gross Primary
Production (GPP), a variable that is important for calculating
components of the global carbon cycle. See the next section on how to
obtain data.</p>
<p>As in the previous episode (<a href="%7B%7B%20page.root%20%7D%7D%7B%%20link%20_episodes/07-development-setup.md%20%%7D">Development
and Contribution episode</a>), we will be using the development
installation of ESMValTool.</p>
</section><section><h2 class="section-heading" id="obtaining-the-data">Obtaining the data<a class="anchor" aria-label="anchor" href="#obtaining-the-data"></a>
</h2>
<hr class="half-width">
<p>The data for this episode is available via the <a href="http://www.bgc-jena.mpg.de/geodb/BGI/Home" class="external-link">FluxCom Data
Portal</a>. First you’ll need to register. After registration, in the
dropdown boxes, select FLUXCOM as the data choice and click download.
Three files will be displayed. Click the download button on the “FLUXCOM
(RS+METEO) Global Land Carbon Fluxes using CRUNCEP climate data”. You’ll
receive an email with the FTP address to access the server. Connect to
the server, follow the path in your email, and look for the file
<code>raw/monthly/GPP.ANN.CRUNCEPv6.monthly.2000.nc</code>. Download
that file and save it in a folder called
<code>~/data/RAWOBS/Tier3/FLUXCOM</code>.</p>
<p>Note: you’ll need a user-friendly ftp client. On Linux,
<code>ncftp</code> works okay.</p>
<blockquote>
<h2 id="what-is-the-deal-with-those-tiers">What is the deal with those
“tiers”?</h2>
<p>Many datasets come with access restrictions. In this way the data
providers can keep track of how their data is used. In many cases
“restricted access” just means that one has to register with an email
address and accept the terms of use, which typically ask that you
acknowledge the data providers.</p>
<p>There are also datasets available that do not need a registration.
The “obs4MIPs” or “ana4MIPs” datasets, for example, are specifically
produced to facilitate comparisons with model simulations.</p>
<p>To reflect these different levels of access restriction, the
ESMValTool team has created a tier-system. The definition of the
different tiers are as follows:</p>
<ul>
<li>
<strong>Tier1</strong>: obs4MIPs and ana4MIPS datasets (can be used
directly with the ESMValTool)</li>
<li>
<strong>Tier2</strong>: other freely available datasets (most of
them will need some kind of cmorization)</li>
<li>
<strong>Tier3</strong>: datasets with access restrictions (most of
these datasets will also need some kind of cmorization)</li>
</ul>
<p>These access restrictions are also why the ESMValTool developers
cannot distribute copies or automate downloading of all observations and
reanalysis data used in the recipes. As a compromise, we provide the
CMORization scripts so that each user can CMORize their own copy of the
access restricted datasets if needed.</p>
<p>{: .callout}</p>
</blockquote>
</section><section><h2 class="section-heading" id="run-the-existing-cmorizer-script">Run the existing CMORizer script<a class="anchor" aria-label="anchor" href="#run-the-existing-cmorizer-script"></a>
</h2>
<hr class="half-width">
<p>Before we develop our own CMORizer script, let’s first see what
happens when we run the existing one. There is a specific command
available in the ESMValTool to run the CMORizer scripts:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="ex">esmvaltool</span> data format <span class="at">--config_file</span> <span class="op">&lt;</span>path to config-user.yml<span class="op">&gt;</span>  <span class="op">&lt;</span>dataset-name<span class="op">&gt;</span></span></code></pre>
</div>
<p>The <code>config-user.yml</code> is the file in which we define the
different data paths, see the episode on <a href="%7B%7B%20page.root%20%7D%7D%7B%%20link%20_episodes/03-configuration.md%20%%7D">Configuration</a>.
In the <code>rootpath</code> of your <code>config-user.yml</code>, make
sure to add the right directory for “RAWOBS” data in which you
downloaded the FLUXCOM dataset:</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">YAML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yaml" tabindex="0"><code class="sourceCode yaml"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="fu">rootpath</span><span class="kw">:</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="at">  </span><span class="fu">RAWOBS</span><span class="kw">:</span><span class="at"> ~/data/RAWOBS</span></span></code></pre>
</div>
<p>This enables ESMValTool to find the raw observational datasets stored
in the “RAWOBS” folder. The <code>dataset-name</code> needs to be
identical to the folder name that was created to store the raw
observation data files, i.e. <code>RAWOBS/TierX/dataset-name</code>. In
our case this would be “FLUXCOM”.</p>
<p>If everything is okay, the output should look something like
this:</p>
<pre><code>...
... Starting the CMORization Tool at time: 2022-07-26 14:02:16 UTC
... ----------------------------------------------------------------------
... input_dir  = /home/peter/data/RAWOBS
... output_dir = /home/peter/esmvaltool_output/data_formatting_20220726_140216
... ----------------------------------------------------------------------
... Running the CMORization scripts.
... Processing datasets ['FLUXCOM']
... Input data from: /home/peter/data/RAWOBS/Tier3/FLUXCOM
... Output will be written to: /home/peter/esmvaltool_output/
      data_formatting_20220726_140216/Tier3/FLUXCOM
... Reformat script: /home/peter/mambaforge/envs/esmvaltool/lib/python3.9/
      site-packages/esmvaltool/cmorizers/data/formatters/datasets/fluxcom
... CMORizing dataset FLUXCOM using Python script /home/peter/mambaforge/envs/
      esmvaltool/lib/python3.9/site-packages/esmvaltool/cmorizers/data/formatters/
      datasets/fluxcom.py
... Found input file '/home/peter/data/RAWOBS/Tier3/FLUXCOM/GPP.ANN.CRUNCEPv6.monthly.*.nc'
... CMORizing variable 'gpp'
... Lmon
... Var is gpp
... ... UserWarning: Ignoring netCDF variable 'GPP' invalid units 'gC m-2 day-1'

... Fixing time...
... Fixing latitude...
... Fixing longitude...
... Flipping dimensional coordinate latitude...
... Saving file
... Saving: /home/peter/esmvaltool_output/data_formatting_20220726_140216/Tier3/
      FLUXCOM/OBS_FLUXCOM_reanaly_ANN-v1_Lmon_gpp_200001-200012.nc
... Cube has lazy data [lazy is preferred]
... CMORization of dataset FLUXCOM finished!
... Formatting successful for dataset FLUXCOM</code></pre>
<p>{: .output}</p>
<p>So you can see that several fixes are applied, and the CMORized file
is written to the ESMValTool output directory, i.e.
<code>~/esmvaltool_output/data_formatting_YYYYMMDD_HHMMSS/TierX/dataset-name/filename.nc</code>
In order to use it, we’ll have to copy it from the output directory to a
folder called <code>~/data/OBS/Tier3/FLUXCOM</code> and make sure the
path to <code>OBS</code> is set correctly in our config-user file:</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">YAML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yaml" tabindex="0"><code class="sourceCode yaml"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="fu">rootpath</span><span class="kw">:</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a><span class="at">  </span><span class="fu">OBS</span><span class="kw">:</span><span class="at"> ~/data/OBS</span></span></code></pre>
</div>
<p>You can also see the path where ESMValTool stores the reformatting
script:
<code>~/ESMValTool/esmvaltool/data/formatters/datasets/fluxcom.py</code>.
You may have a look at this file if you want. The script also uses a
configuration file:
<code>~/ESMValTool/esmvaltool/cmorizers/data/cmor_config/FLUXCOM.yml</code>.</p>
</section><section><h2 class="section-heading" id="make-a-test-recipe">Make a test recipe<a class="anchor" aria-label="anchor" href="#make-a-test-recipe"></a>
</h2>
<hr class="half-width">
<p>To verify that the data is correctly CMORized, we will make a simple
test recipe. As illustrated in the figure at the top of this episode,
one of the steps that ESMValTool executes is a CMOR-check. If the data
is not correctly CMORized, ESMValTool will give a warning or error.</p>
<blockquote>
<h2 id="create-a-test-recipe">Create a test recipe</h2>
<p>Create a simple recipe called <a href="../files/recipe_check_fluxcom.yml">recipe_check_fluxcom.yml</a> that
loads the FLUXCOM data. It should include a datasets section with a
single entry for the “FLUXCOM” dataset with the correct dataset keys,
and a diagnostics section with two variables: gpp. We don’t need any
preprocessors or scripts (set <code>scripts: null</code>), but we have
to add a documentation section with a description, authors and
maintainer, otherwise the recipe will fail.</p>
<p>Use the following dataset keys:</p>
<ul>
<li>project: OBS</li>
<li>dataset: FLUXCOM</li>
<li>type: reanaly</li>
<li>version: ANN-v1</li>
<li>mip: Lmon</li>
<li>start_year: 2000</li>
<li>end_year: 2000</li>
<li>tier: 3</li>
</ul>
<p>Some of these dataset keys are further explained in the callout boxes
in this episode.</p>
<blockquote>
<h2 id="answer">Answer</h2>
<p>Here’s an example recipe</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">YAML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yaml" tabindex="0"><code class="sourceCode yaml"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="fu">documentation</span><span class="kw">:</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a><span class="at">  </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Test recipe for FLUXCOM data</span></span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a><span class="at">  </span><span class="fu">title</span><span class="kw">:</span><span class="at"> This is a test recipe for the FLUXCOM data.</span></span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a><span class="at">  </span><span class="fu">authors</span><span class="kw">:</span></span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> kalverla_peter</span></span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a><span class="at">  </span><span class="fu">maintainer</span><span class="kw">:</span></span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> kalverla_peter</span></span>
<span id="cb5-11"><a href="#cb5-11" tabindex="-1"></a></span>
<span id="cb5-12"><a href="#cb5-12" tabindex="-1"></a><span class="fu">datasets</span><span class="kw">:</span></span>
<span id="cb5-13"><a href="#cb5-13" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="kw">{</span><span class="fu">project</span><span class="kw">:</span><span class="at"> OBS</span><span class="kw">,</span><span class="at"> </span><span class="fu">dataset</span><span class="kw">:</span><span class="at"> FLUXCOM</span><span class="kw">,</span><span class="at"> </span><span class="fu">mip</span><span class="kw">:</span><span class="at"> Lmon</span><span class="kw">,</span><span class="at"> </span><span class="fu">tier</span><span class="kw">:</span><span class="at"> </span><span class="dv">3</span><span class="kw">,</span><span class="at"> </span><span class="fu">start_year</span><span class="kw">:</span><span class="at"> </span><span class="dv">2000</span><span class="kw">,</span><span class="at"> </span></span>
<span id="cb5-14"><a href="#cb5-14" tabindex="-1"></a><span class="at">     </span><span class="fu">end_year</span><span class="kw">:</span><span class="at"> </span><span class="dv">2000</span><span class="kw">,</span><span class="at"> </span><span class="fu">type</span><span class="kw">:</span><span class="at"> reanaly</span><span class="kw">,</span><span class="at"> </span><span class="fu">version</span><span class="kw">:</span><span class="at"> ANN-v1</span><span class="kw">}</span></span>
<span id="cb5-15"><a href="#cb5-15" tabindex="-1"></a></span>
<span id="cb5-16"><a href="#cb5-16" tabindex="-1"></a><span class="fu">diagnostics</span><span class="kw">:</span></span>
<span id="cb5-17"><a href="#cb5-17" tabindex="-1"></a><span class="at">  </span><span class="fu">check_fluxcom</span><span class="kw">:</span></span>
<span id="cb5-18"><a href="#cb5-18" tabindex="-1"></a><span class="at">    </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Check that ESMValTool can load the cmorized fluxnet data without errors.</span></span>
<span id="cb5-19"><a href="#cb5-19" tabindex="-1"></a><span class="at">    </span><span class="fu">variables</span><span class="kw">:</span></span>
<span id="cb5-20"><a href="#cb5-20" tabindex="-1"></a><span class="at">      </span><span class="fu">gpp</span><span class="kw">:</span></span>
<span id="cb5-21"><a href="#cb5-21" tabindex="-1"></a><span class="at">    </span><span class="fu">scripts</span><span class="kw">:</span><span class="at"> </span><span class="ch">null</span></span></code></pre>
</div>
<p>To learn more about writing a recipe, please refer to <a href="%7B%7B%20page.root%20%7D%7D%7B%%20link%20_episodes/06-preprocessor.md%20%%7D">Writing
your own recipe</a>.</p>
<p>{: .solution} {: .challenge}</p>
</blockquote>
</blockquote>
<p>Try to run the example recipe with</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="ex">esmvaltool</span> run recipe_check_fluxcom.yml <span class="at">--config_file</span> <span class="op">&lt;</span>path to config-user.yml<span class="op">&gt;</span> --log_level debug</span></code></pre>
</div>
<p>If everything is okay, the recipe should run without problems.</p>
</section><section><h2 class="section-heading" id="starting-from-scratch">Starting from scratch<a class="anchor" aria-label="anchor" href="#starting-from-scratch"></a>
</h2>
<hr class="half-width">
<p>Now that you’ve seen how to use an existing CMORizer script, let’s
think about adding a new one. We will remove the existing CMORizer
script, and re-implement it from scratch. This exercise allows us to
point out all the details of what’s going on. We’ll also remove the
CMORized data that we’ve just created, so our test recipe will not be
able to use it anymore.</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="fu">rm</span> ~/data/OBS/Tier3/FLUXCOM/OBS_FLUXCOM_reanaly_ANN-v1_Lmon_gpp_200001-200012.nc</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a><span class="fu">rm</span> ~/ESMValTool/esmvaltool/cmorizers/data/formatters/datasets/fluxcom.py</span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a><span class="fu">rm</span> ~/ESMValTool/esmvaltool/cmorizers/data/cmor_config/FLUXCOM.yml</span></code></pre>
</div>
<p>If you now run the test recipe again it should fail, and somewhere in
the output you should find something like:</p>
<pre><code>No input files found for ...
Looked for files matching: /home/peter/data/OBS/Tier3/
      FLUXCOM/OBS_FLUXCOM_reanaly_ANN-v1_Lmon_gpp[_.]*nc</code></pre>
<p>{: .error}</p>
<p>From this we can see that the first thing our CMORizer should do is
to rename the file so that it follows the CMOR filename conventions.</p>
</section><section><h2 class="section-heading" id="create-a-new-cmorizer-script-and-a-corresponding-config-file">Create a new CMORizer script and a corresponding config file<a class="anchor" aria-label="anchor" href="#create-a-new-cmorizer-script-and-a-corresponding-config-file"></a>
</h2>
<hr class="half-width">
<p>The first step now is to create a new file in the right folder that
will contain our new CMORizer instructions. Create a file called
<code>fluxcom.py</code></p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="fu">nano</span> ~/ESMValTool/esmvaltool/cmorizers/data/formatters/datasets/fluxcom.py</span></code></pre>
</div>
<p>and fill it with the following boilerplate code:</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="co">"""ESMValTool CMORizer for FLUXCOM GPP data.</span></span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a><span class="co">&lt;We will add some useful info here later&gt;</span></span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a><span class="im">import</span> logging</span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a><span class="im">from</span> esmvaltool.cmorizers.data <span class="im">import</span> utilities <span class="im">as</span> utils</span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a></span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a>logger <span class="op">=</span> logging.getLogger(<span class="va">__name__</span>)</span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a></span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a><span class="kw">def</span> cmorization(in_dir, out_dir, cfg, cfg_user, start_date, end_date):</span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a>    <span class="co">"""Cmorize the dataset."""</span></span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a></span>
<span id="cb10-13"><a href="#cb10-13" tabindex="-1"></a>    <span class="co"># This is where you'll add the cmorization code</span></span>
<span id="cb10-14"><a href="#cb10-14" tabindex="-1"></a>    <span class="co"># 1. find the input data</span></span>
<span id="cb10-15"><a href="#cb10-15" tabindex="-1"></a>    <span class="co"># 2. apply the necessary fixes</span></span>
<span id="cb10-16"><a href="#cb10-16" tabindex="-1"></a>    <span class="co"># 3. store the data with the correct filename</span></span></code></pre>
</div>
<p>Here, <code>in_dir</code> corresponds to the input directory of the
raw files, <code>out_dir</code> to the output directory of final
reformatted data set and <code>cfg</code> to a configuration dictionary
given by a configuration file that we will get to shortly. The last
three arguments will not be considered in this script but can be used in
other cases. <code>cfg_user</code> corresponds to the user configuration
file, <code>start_date</code> to the start of the period to format, and
<code>end_date</code> to the end of the period to format. When you type
the command <code>esmvaltool data format</code> in the terminal,
ESMValTool will call this function with the settings found in your
configuration files.</p>
<p>The ESMValTool CMORizer also needs a dataset configuration file.
Create a file called
<code>~/ESMValTool/esmvaltool/cmorizers/data/cmor_config/FLUXCOM.yml</code>
and fill it with the following boilerplate:</p>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">YAML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yaml" tabindex="0"><code class="sourceCode yaml"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="pp">---</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a><span class="co"># filename: ???</span></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a><span class="fu">attributes</span><span class="kw">:</span></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a><span class="at">  </span><span class="fu">project_id</span><span class="kw">:</span><span class="at"> OBS6</span></span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a><span class="co">#   dataset_id: ???</span></span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a><span class="co">#   version: ???</span></span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a><span class="co">#   tier: ???</span></span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a><span class="co">#   modeling_realm: ???</span></span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a><span class="co">#   source: ???</span></span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a><span class="co">#   reference: ???</span></span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a><span class="co">#   comment: ???</span></span>
<span id="cb11-13"><a href="#cb11-13" tabindex="-1"></a></span>
<span id="cb11-14"><a href="#cb11-14" tabindex="-1"></a><span class="co"># variables:</span></span>
<span id="cb11-15"><a href="#cb11-15" tabindex="-1"></a><span class="co">#   ???:</span></span>
<span id="cb11-16"><a href="#cb11-16" tabindex="-1"></a><span class="co">#     mip: ???</span></span></code></pre>
</div>
<p><strong>Note</strong>: the name of this file <em>must</em> be
identical to <code>dataset-name</code>.</p>
<p>As you can see, the configuration file contains information about the
original filename of the dataset, and some additional metadata that you
might recognize from the CMOR filename structure. It also contains a
list of variables that’s available for this dataset. We’ll add this
information step by step in the following sections.</p>
<blockquote>
<h2 id="rawobs-obs-obs6">RAWOBS, OBS, OBS6!?</h2>
<p>In the configuration above we’ve already filled in the
<code>project_id</code>. ESMValTool uses these project IDs to find the
data on your hard drive, and also to find more information about the
data. The <code>RAWOBS</code> and <code>OBS</code> projects refer to
<em>external</em> data before and after CMORization, respectively.
Historically, most external data were observations, hence the
naming.</p>
<p>In going from CMIP5 to CMIP6, the CMOR standards changed a bit. For
example, some variables were renamed, which posed a dilemma: should
CMORization reformat to the CMIP5 or CMIP6 definition? To solve this,
the <code>OBS6</code> project was created. So <code>OBS6</code> data
follow the CMIP6 standards, and that’s what we’ll use for the new
CMORizer.</p>
<p>{: .callout}</p>
</blockquote>
<p>You can try running the CMORizer at this point, and it should work
without errors. However, it doesn’t produce any output yet:</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="ex">esmvaltool</span> data format <span class="at">--config_file</span> <span class="op">&lt;</span>path to config-user.yml<span class="op">&gt;</span> FLUXCOM</span></code></pre>
</div>
<div class="section level3">
<h3 id="find-the-input-data">1. Find the input data<a class="anchor" aria-label="anchor" href="#find-the-input-data"></a>
</h3>
<p>First we’ll get the CMORizer script to locate our FLUXCOM data. We
can use the information from the <code>in_dir</code> and
<code>cfg</code> variables. Add the following snippet to your CMORizer
script:</p>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="co"># 1. find the input data</span></span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>logger.info(<span class="st">"in_dir: '</span><span class="sc">%s</span><span class="st">'"</span>, in_dir)</span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a>logger.info(<span class="st">"cfg: '</span><span class="sc">%s</span><span class="st">'"</span>, cfg)</span></code></pre>
</div>
<p>If you run the CMORizer again, it will print out the content of these
variables and the output should contain something like this:</p>
<pre><code>... in_dir: '/home/peter/data/RAWOBS/Tier3/FLUXCOM'
... cfg: '{'attributes': {'project_id': 'OBS6', 'comment': ''},
    'cmor_table': &lt;esmvalcore.cmor.table.CMIP6Info object at 0x7fbd0a0f6bf0&gt;}'</code></pre>
<p>{: .output}</p>
<blockquote>
<h2 id="load-the-data">Load the data</h2>
<p>Try to locate the input data inside the CMORizer script and load it
(we’ll use <code>iris</code> because ESMValTool includes helper
utilities for iris cubes). Confirm that you’ve loaded the data by
logging the correct path and (part of the) file content.</p>
<blockquote>
<h2 id="solution">Solution</h2>
<p>There are many ways to do it. In any case, you should have added the
original filename to the configuration file (and un-commented this
line): <code>filename: 'GPP.ANN.CRUNCEPv6.monthly.*.nc'</code>. Note the
<code>*</code>: this is a useful shorthand to find multiple files for
different years. In a similar way we can also look for multiple
variables, etc.</p>
<p>Here’s an example solution (inserted directly under the original
comment):</p>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="co"># 1. find the input data</span></span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a>filename_pattern <span class="op">=</span> cfg[<span class="st">'filename'</span>]</span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a>matches <span class="op">=</span> Path(in_dir).glob(filename_pattern)</span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a></span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a><span class="cf">for</span> match <span class="kw">in</span> matches:</span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a>    input_file <span class="op">=</span> <span class="bu">str</span>(match)</span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a>    logger.info(<span class="st">"found: </span><span class="sc">%s</span><span class="st">"</span>, input_file)</span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a>    cube <span class="op">=</span> iris.load_cube(input_file)</span>
<span id="cb15-9"><a href="#cb15-9" tabindex="-1"></a>    logger.info(<span class="st">"content: </span><span class="sc">%s</span><span class="st">"</span>, cube)</span></code></pre>
</div>
<p>To make this work we’ve added <code>import iris</code> and
<code>from pathlib import Path</code> at the top of the file. Note that
we’ve started a loop, since we may find multiple files if there’s more
than one year of data available.</p>
<p>{: .solution} {: .challenge}</p>
</blockquote>
</blockquote>
</div>
<div class="section level3">
<h3 id="save-the-data-with-the-correct-filename">2. Save the data with the correct filename<a class="anchor" aria-label="anchor" href="#save-the-data-with-the-correct-filename"></a>
</h3>
<p>Before we start adding fixes, we’ll first make sure that our CMORizer
can also write output files with the correct name. This will enable us
to use the test recipe for the CMOR compatibility check.</p>
<p>We can use the <code>save</code> function from the <code>utils</code>
that we imported at the top. The call signature looks like this:
<code>utils.save_variables(cube, var, outdir, attrs, **kwargs)</code>.</p>
<p>We already have the <code>cube</code> and the <code>outdir</code>.
The variable short name (<code>var</code>) and attributes
(<code>attrs</code>) are set through the configuration file. So we need
to find out what the correct short name and attributes are.</p>
<p>The standard attributes for CMIP variables are defined in the <a href="https://github.com/ESMValGroup/ESMValCore/tree/main/esmvalcore/cmor/tables/cmip6/Tables" class="external-link">CMIP
tables</a>. These tables are differentiated according to the “MIP” they
belong to. The tables are a copy of the <a href="https://github.com/PCMDI" class="external-link">PCMDI</a> guidelines.</p>
<blockquote>
<h2 id="find-the-variable-gpp-in-a-cmor-table">Find the variable “gpp”
in a CMOR table</h2>
<p>Check the available CMOR tables to find the variable “gpp” with the
following characteristics: - standard_name:
<code>gross_primary_productivity_of_biomass_expressed_as_carbon</code> -
frequency: <code>mon</code> - modeling_realm: <code>land</code></p>
<blockquote>
<h2 id="answers">Answers</h2>
<p>The variable “gpp” belongs to the land variables. The temporal
resolution that we are looking for is “monthly”. This information points
to the “Lmon” CMIP table. And indeed, the variable “gpp” can be found in
the file <a href="https://github.com/ESMValGroup/ESMValCore/blob/main/esmvalcore/%20cmor/tables/cmip6/Tables/CMIP6_Lmon.json" class="external-link">here</a>.</p>
<p>{: .solution} {: .challenge}</p>
</blockquote>
</blockquote>
<p>If the variable you are interested in is not available in the
standard CMOR tables, you could write a custom CMOR table entry for the
variable. This, however, is beyond the scope of this tutorial.</p>
<blockquote>
<h2 id="fill-the-configuration-file">Fill the configuration file</h2>
<p>Uncomment the following entries in your configuration file and fill
them with appropriate values:</p>
<ul>
<li>dataset_id</li>
<li>version</li>
<li>tier</li>
<li>modeling_realm</li>
<li>short_name (the ??? immediately under <code>variables</code>)</li>
<li>mip</li>
</ul>
<blockquote>
<h2 id="answers-1">Answers</h2>
<p>The configuration file now look something like this:</p>
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">YAML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yaml" tabindex="0"><code class="sourceCode yaml"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="pp">---</span></span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a><span class="fu">filename</span><span class="kw">:</span><span class="at"> </span><span class="st">'GPP.ANN.CRUNCEPv6.monthly.*.nc'</span></span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a><span class="fu">attributes</span><span class="kw">:</span></span>
<span id="cb16-5"><a href="#cb16-5" tabindex="-1"></a><span class="at">  </span><span class="fu">project_id</span><span class="kw">:</span><span class="at"> OBS6</span></span>
<span id="cb16-6"><a href="#cb16-6" tabindex="-1"></a><span class="at">  </span><span class="fu">dataset_id</span><span class="kw">:</span><span class="at"> FLUXCOM</span></span>
<span id="cb16-7"><a href="#cb16-7" tabindex="-1"></a><span class="at">  </span><span class="fu">version</span><span class="kw">:</span><span class="at"> </span><span class="st">'ANN-v1'</span></span>
<span id="cb16-8"><a href="#cb16-8" tabindex="-1"></a><span class="at">  </span><span class="fu">tier</span><span class="kw">:</span><span class="at"> </span><span class="dv">3</span></span>
<span id="cb16-9"><a href="#cb16-9" tabindex="-1"></a><span class="at">  </span><span class="fu">modeling_realm</span><span class="kw">:</span><span class="at"> reanaly</span></span>
<span id="cb16-10"><a href="#cb16-10" tabindex="-1"></a><span class="at">  </span><span class="fu">source</span><span class="kw">:</span><span class="at"> </span><span class="st">''</span></span>
<span id="cb16-11"><a href="#cb16-11" tabindex="-1"></a><span class="at">  </span><span class="fu">reference</span><span class="kw">:</span><span class="at"> </span><span class="st">''</span></span>
<span id="cb16-12"><a href="#cb16-12" tabindex="-1"></a><span class="at">  </span><span class="fu">comment</span><span class="kw">:</span><span class="at"> </span><span class="st">''</span></span>
<span id="cb16-13"><a href="#cb16-13" tabindex="-1"></a></span>
<span id="cb16-14"><a href="#cb16-14" tabindex="-1"></a><span class="fu">variables</span><span class="kw">:</span></span>
<span id="cb16-15"><a href="#cb16-15" tabindex="-1"></a><span class="at">  </span><span class="fu">gpp</span><span class="kw">:</span></span>
<span id="cb16-16"><a href="#cb16-16" tabindex="-1"></a><span class="at">    </span><span class="fu">mip</span><span class="kw">:</span><span class="at"> Lmon</span></span></code></pre>
</div>
<p>{: .solution} {: .challenge}</p>
</blockquote>
</blockquote>
<p>Now that we have set this information correctly in the config file,
we can call the save function. Add the following python code to your
CMORizer script:</p>
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="co"># 3. store the data with the correct filename</span></span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a>attributes <span class="op">=</span> cfg[<span class="st">'attributes'</span>]</span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a>variables <span class="op">=</span> cfg[<span class="st">'variables'</span>]</span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a><span class="cf">for</span> short_name, variable_info <span class="kw">in</span> variables.items():</span>
<span id="cb17-6"><a href="#cb17-6" tabindex="-1"></a>    all_attributes <span class="op">=</span> {<span class="op">**</span>attributes, <span class="op">**</span>variable_info}  <span class="co"># add the mip to the other attributes</span></span>
<span id="cb17-7"><a href="#cb17-7" tabindex="-1"></a>    utils.save_variable(cube<span class="op">=</span>cube, var<span class="op">=</span>short_name, outdir<span class="op">=</span>out_dir, attrs<span class="op">=</span>all_attributes)</span></code></pre>
</div>
<p>Since we only have one variable (gpp), the loop is not strictly
necessary. However, this makes it possible to add more variables later
on.</p>
<blockquote>
<h2 id="was-the-cmorization-successful-so-far">Was the CMORization
successful so far?</h2>
<p>If you run the CMORizer again, you should see that it creates an
output file named
<code>OBS6_FLUXCOM_reanaly_ANN-v1_Lmon_gpp_xxxx01-xxxx12.nc</code>
stored in your ESMValTool output directory
<code>~/esmvaltool_output/data_formatting_YYYYMMDD_HHMMSS/Tier3/FLUXCOM/</code>.
The “xxxx” and “yyyy” represent the start and end year of the data.</p>
<p>{: .callout}</p>
</blockquote>
<p>Great! So we have produced a NetCDF file with the CMORizer that
follows the naming convention for ESMValTool datasets. Let’s have a look
at the NetCDF file as it was written with the very basic CMORizer from
above.</p>
<div class="codewrapper sourceCode" id="cb18">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a><span class="ex">ncdump</span> <span class="at">-h</span> OBS6_FLUXCOM_reanaly_ANN-v1_Lmon_gpp_200001-200012.nc</span></code></pre>
</div>
<pre><code>netcdf OBS6_FLUXCOM_reanaly_ANN-v1_Lmon_gpp_200001-200012 {
dimensions:
        time = 12 ;
        lat = 360 ;
        lon = 720 ;
variables:
        float GPP(time, lat, lon) ;
                GPP:_FillValue = 1.e+20f ;
                GPP:long_name = "GPP" ;
        double time(time) ;
                time:axis = "T" ;
                time:units = "days since 1582-10-15 00:00:00" ;
                time:standard_name = "time" ;
                time:calendar = "gregorian" ;
        double lat(lat) ;
        double lon(lon) ;

// global attributes:
                :_NCProperties = "version=2,netcdf=4.7.4,hdf5=1.10.6" ;
                :created_by = "Fabian Gans [fgans@bgc-jena.mpg.de], Ulrich Weber
		  [uweber@bgc-jena.mpg.de]" ;
                :flux = "GPP" ;
                :forcing = "CRUNCEPv6" ;
                :institution = "MPI-BGC-BGI" ;
                :invalid_units = "gC m-2 day-1" ;
                :method = "Artificial Neural Networks" ;
                :provided_by = "Martin Jung [mjung@bgc-jena.mpg.de] on behalf of FLUXCOM team" ;
                :reference = "Jung et al. 2016, Nature; Tramontana et al. 2016, Biogeosciences" ;
                :temporal_resolution = "monthly" ;
                :title = "GPP based on FLUXCOM RS+METEO with CRUNCEPv6 climate " ;
                :version = "v1" ;
                :Conventions = "CF-1.7" ;
}</code></pre>
<p>{: .output}</p>
<p>The file contains a variable named “GPP” that contains three
dimensions: “time”, “lat”, “lon”. Notice the strange time units, and the
<code>invalid_units</code> in the global attributes section. Also it
seems that there is not information available about the lat and lon
coordinates. These are just some of the things we’ll address in the next
section.</p>
</div>
<div class="section level3">
<h3 id="implementing-additional-fixes">3. Implementing additional fixes<a class="anchor" aria-label="anchor" href="#implementing-additional-fixes"></a>
</h3>
<p>Copy the output of the CMORizer to your folder
<code>~/data/OBS6/Tier3/FLUXCOM/</code> and change the test recipe to
look for OBS6 data instead of OBS (note: we’re upgrading the CMORizer to
newer standards here!). Make sure the path to <code>OBS6</code> is set
correctly in our config-user file:</p>
<div class="codewrapper sourceCode" id="cb20">
<h3 class="code-label">YAML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yaml" tabindex="0"><code class="sourceCode yaml"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a><span class="fu">rootpath</span><span class="kw">:</span></span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a><span class="at">  </span><span class="fu">OBS6</span><span class="kw">:</span><span class="at"> ~/data/OBS6</span></span></code></pre>
</div>
<p>If we now run the test recipe on our newly ‘CMORized’ data,</p>
<div class="codewrapper sourceCode" id="cb21">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a><span class="ex">esmvaltool</span> run recipe_check_fluxcom.yml <span class="at">--config_file</span> <span class="op">&lt;</span>path to config-user.yml<span class="op">&gt;</span> --log_level debug</span></code></pre>
</div>
<p>it should be able to find the correct file, but it does not succeed
yet. The first thing that the ESMValTool CMOR checker brings up is:</p>
<pre><code>iris.exceptions.UnitConversionError: Cannot convert from unknown units. The
"units" attribute may be set directly.</code></pre>
<p>{: .error}</p>
<p>If you look closely at the error messages, you can see that this
error concerns the units of the coordinates. ESMValTool tries to fix
them automatically, but since no units are defined on the coordinates,
this fails.</p>
<p>The cmorizer utilities also include a function called
<code>fix_coords</code>, but before we can use it, we’ll also need to
make sure the coordinates have the correct standard name. Add the
following code to your cmorizer:</p>
<div class="codewrapper sourceCode" id="cb23">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a><span class="co"># 2. Apply the necessary fixes</span></span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a><span class="co"># 2a. Fix/add coordinate information and metadata</span></span>
<span id="cb23-3"><a href="#cb23-3" tabindex="-1"></a>cube.coord(<span class="st">'lat'</span>).standard_name <span class="op">=</span> <span class="st">'latitude'</span></span>
<span id="cb23-4"><a href="#cb23-4" tabindex="-1"></a>cube.coord(<span class="st">'lon'</span>).standard_name <span class="op">=</span> <span class="st">'longitude'</span></span>
<span id="cb23-5"><a href="#cb23-5" tabindex="-1"></a>utils.fix_coords(cube)</span></code></pre>
</div>
<p>With some additional refactoring, our cmorization function might then
look something like this:</p>
<div class="codewrapper sourceCode" id="cb24">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a><span class="kw">def</span> cmorization(in_dir, out_dir, cfg, cfg_user, start_date, end_date):</span>
<span id="cb24-2"><a href="#cb24-2" tabindex="-1"></a>    <span class="co">"""Cmorize the dataset."""</span></span>
<span id="cb24-3"><a href="#cb24-3" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" tabindex="-1"></a>    <span class="co"># Get general information from the config file</span></span>
<span id="cb24-5"><a href="#cb24-5" tabindex="-1"></a>    attributes <span class="op">=</span> cfg[<span class="st">'attributes'</span>]</span>
<span id="cb24-6"><a href="#cb24-6" tabindex="-1"></a>    variables <span class="op">=</span> cfg[<span class="st">'variables'</span>]</span>
<span id="cb24-7"><a href="#cb24-7" tabindex="-1"></a></span>
<span id="cb24-8"><a href="#cb24-8" tabindex="-1"></a>    <span class="cf">for</span> short_name, variable_info <span class="kw">in</span> variables.items():</span>
<span id="cb24-9"><a href="#cb24-9" tabindex="-1"></a>        logger.info(<span class="st">"CMORizing variable: </span><span class="sc">%s</span><span class="st">"</span>, short_name)</span>
<span id="cb24-10"><a href="#cb24-10" tabindex="-1"></a></span>
<span id="cb24-11"><a href="#cb24-11" tabindex="-1"></a>        <span class="co"># 1a. Find the input data (one file for each year)</span></span>
<span id="cb24-12"><a href="#cb24-12" tabindex="-1"></a>        filename_pattern <span class="op">=</span> cfg[<span class="st">'filename'</span>]</span>
<span id="cb24-13"><a href="#cb24-13" tabindex="-1"></a>        matches <span class="op">=</span> Path(in_dir).glob(filename_pattern)</span>
<span id="cb24-14"><a href="#cb24-14" tabindex="-1"></a></span>
<span id="cb24-15"><a href="#cb24-15" tabindex="-1"></a>        <span class="cf">for</span> match <span class="kw">in</span> matches:</span>
<span id="cb24-16"><a href="#cb24-16" tabindex="-1"></a>            <span class="co"># 1b. Load the input data</span></span>
<span id="cb24-17"><a href="#cb24-17" tabindex="-1"></a>            input_file <span class="op">=</span> <span class="bu">str</span>(match)</span>
<span id="cb24-18"><a href="#cb24-18" tabindex="-1"></a>            logger.info(<span class="st">"found: </span><span class="sc">%s</span><span class="st">"</span>, input_file)</span>
<span id="cb24-19"><a href="#cb24-19" tabindex="-1"></a>            cube <span class="op">=</span> iris.load_cube(input_file)</span>
<span id="cb24-20"><a href="#cb24-20" tabindex="-1"></a></span>
<span id="cb24-21"><a href="#cb24-21" tabindex="-1"></a>            <span class="co"># 2. Apply the necessary fixes</span></span>
<span id="cb24-22"><a href="#cb24-22" tabindex="-1"></a>            <span class="co"># 2a. Fix/add coordinate information and metadata</span></span>
<span id="cb24-23"><a href="#cb24-23" tabindex="-1"></a>            cube.coord(<span class="st">'lat'</span>).standard_name <span class="op">=</span> <span class="st">'latitude'</span></span>
<span id="cb24-24"><a href="#cb24-24" tabindex="-1"></a>            cube.coord(<span class="st">'lon'</span>).standard_name <span class="op">=</span> <span class="st">'longitude'</span></span>
<span id="cb24-25"><a href="#cb24-25" tabindex="-1"></a>            utils.fix_coords(cube)</span>
<span id="cb24-26"><a href="#cb24-26" tabindex="-1"></a></span>
<span id="cb24-27"><a href="#cb24-27" tabindex="-1"></a>            <span class="co"># 3. Save the CMORized data</span></span>
<span id="cb24-28"><a href="#cb24-28" tabindex="-1"></a>            all_attributes <span class="op">=</span> {<span class="op">**</span>attributes, <span class="op">**</span>variable_info}</span>
<span id="cb24-29"><a href="#cb24-29" tabindex="-1"></a>            utils.save_variable(cube<span class="op">=</span>cube, var<span class="op">=</span>short_name, outdir<span class="op">=</span>out_dir, attrs<span class="op">=</span>all_attributes)</span></code></pre>
</div>
<p>Run the CMORizer script once more. Have a look at the netCDF file,
and confirm that the coordinates now have much more metadata added to
them. Then, run the test recipe again with the latest CMORizer output.
The next error is:</p>
<pre><code>esmvalcore.cmor.check.CMORCheckError: There were errors in variable GPP:
Variable GPP units unknown can not be converted to kg m-2 s-1 in cube:</code></pre>
<p>{: .error}</p>
<p>Okay, so let’s fix the units of the “GPP” variable in the CMORizer.
Remember that you can find the correct units in the CMOR table. Add the
following three lines to our CMORizer:</p>
<div class="codewrapper sourceCode" id="cb26">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a><span class="co"># 2b. Fix gpp units</span></span>
<span id="cb26-2"><a href="#cb26-2" tabindex="-1"></a>logger.info(<span class="st">"Changing units for gpp from gc/m2/day to kg/m2/s"</span>)</span>
<span id="cb26-3"><a href="#cb26-3" tabindex="-1"></a>cube.data <span class="op">=</span> cube.core_data() <span class="op">/</span> (<span class="dv">1000</span> <span class="op">*</span> <span class="dv">86400</span>)</span>
<span id="cb26-4"><a href="#cb26-4" tabindex="-1"></a>cube.units <span class="op">=</span> <span class="st">'kg m-2 s-1'</span></span></code></pre>
</div>
<p>If everything is okay, the test recipe should now pass. We’re getting
there. Looking through the output though, there’s still a warning.</p>
<pre><code>WARNING There were warnings in variable GPP:
Standard name for GPP changed from None to gross_primary_productivity_of_biomass_expressed_as_carbon
Long name for GPP changed from GPP to Carbon Mass Flux out of Atmosphere Due to
      Gross Primary Production on Land [kgC m-2 s-1]</code></pre>
<p>{: .output}</p>
<p>ESMValTool is able to apply automatic fixes here, but if we are
running a CMORizer script anyway, we might as well fix it
immediately.</p>
<p>Add the following snippet:</p>
<div class="codewrapper sourceCode" id="cb28">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" tabindex="-1"></a><span class="co"># 2c. Fix metadata</span></span>
<span id="cb28-2"><a href="#cb28-2" tabindex="-1"></a>cmor_table <span class="op">=</span> cfg[<span class="st">'cmor_table'</span>]</span>
<span id="cb28-3"><a href="#cb28-3" tabindex="-1"></a>cmor_info <span class="op">=</span> cmor_table.get_variable(variable_info[<span class="st">'mip'</span>], short_name)</span>
<span id="cb28-4"><a href="#cb28-4" tabindex="-1"></a>utils.fix_var_metadata(cube, cmor_info)</span></code></pre>
</div>
<p>You can see that we’re using the CMOR table here. This was passed on
by ESMValTool as part of the <code>CFG</code> input variable. So here
we’re making sure that we’re updating the cubes metadata to conform to
the CMOR table.</p>
<p>Finally, the test recipe should run without errors or warnings.</p>
</div>
<div class="section level3">
<h3 id="finalizing-the-cmorizer">4. Finalizing the CMORizer<a class="anchor" aria-label="anchor" href="#finalizing-the-cmorizer"></a>
</h3>
<p>Once everything works as expected, there’s a couple of things that we
can still do.</p>
<ul>
<li>
<strong>Add download instructions</strong>. The header of the
CMORizer contains information about where to obtain the data, when it
was accessed the last time, which ESMValTool “tier” it is associated
with, and more detailed information about the necessary downloading and
processing steps.</li>
</ul>
<blockquote>
<h2 id="fill-out-the-header-for-the-fluxcom-dataset">Fill out the header
for the “FLUXCOM” dataset</h2>
<p>Fill out the header of the new CMORizer. The different parts that
need to be present in the header are the following:</p>
<ul>
<li>Caption: the first line of the docstring should summarize what the
script does.</li>
<li>Tier</li>
<li>Source</li>
<li>Last access</li>
<li>Download and processing instructions</li>
</ul>
<blockquote>
<h2 id="answers-2">Answers</h2>
<p>The header for the “FLUXCOM” dataset could look something like
this:</p>
<div class="codewrapper sourceCode" id="cb29">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" tabindex="-1"></a><span class="co">"""ESMValTool CMORizer for FLUXCOM GPP data.</span></span>
<span id="cb29-2"><a href="#cb29-2" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" tabindex="-1"></a><span class="co">Tier</span></span>
<span id="cb29-4"><a href="#cb29-4" tabindex="-1"></a><span class="co">    Tier 3: restricted dataset.</span></span>
<span id="cb29-5"><a href="#cb29-5" tabindex="-1"></a></span>
<span id="cb29-6"><a href="#cb29-6" tabindex="-1"></a><span class="co">Source</span></span>
<span id="cb29-7"><a href="#cb29-7" tabindex="-1"></a><span class="co">    http://www.bgc-jena.mpg.de/geodb/BGI/Home</span></span>
<span id="cb29-8"><a href="#cb29-8" tabindex="-1"></a></span>
<span id="cb29-9"><a href="#cb29-9" tabindex="-1"></a><span class="co">Last access</span></span>
<span id="cb29-10"><a href="#cb29-10" tabindex="-1"></a><span class="co">    20190727</span></span>
<span id="cb29-11"><a href="#cb29-11" tabindex="-1"></a></span>
<span id="cb29-12"><a href="#cb29-12" tabindex="-1"></a><span class="co">Download and processing instructions</span></span>
<span id="cb29-13"><a href="#cb29-13" tabindex="-1"></a><span class="co">    From the website, select FLUXCOM as the data choice and click download.</span></span>
<span id="cb29-14"><a href="#cb29-14" tabindex="-1"></a><span class="co">    Two files will be displayed. One for Land Carbon Fluxes and one for</span></span>
<span id="cb29-15"><a href="#cb29-15" tabindex="-1"></a><span class="co">    Land Energy fluxes. The Land Carbon Flux file (RS + METEO) using</span></span>
<span id="cb29-16"><a href="#cb29-16" tabindex="-1"></a><span class="co">    CRUNCEP data file has several data files for different variables.</span></span>
<span id="cb29-17"><a href="#cb29-17" tabindex="-1"></a><span class="co">    The data for GPP generated using the</span></span>
<span id="cb29-18"><a href="#cb29-18" tabindex="-1"></a><span class="co">    Artificial Neural Network Method will be in files with name:</span></span>
<span id="cb29-19"><a href="#cb29-19" tabindex="-1"></a><span class="co">    GPP.ANN.CRUNCEPv6.monthly.\*.nc</span></span>
<span id="cb29-20"><a href="#cb29-20" tabindex="-1"></a><span class="co">    A registration is required for downloading the data.</span></span>
<span id="cb29-21"><a href="#cb29-21" tabindex="-1"></a><span class="co">    Users in the UK with a CEDA-JASMIN account may request access to the jules</span></span>
<span id="cb29-22"><a href="#cb29-22" tabindex="-1"></a><span class="co">    workspace and access the data.</span></span>
<span id="cb29-23"><a href="#cb29-23" tabindex="-1"></a><span class="co">    Note : This data may require rechunking of the netcdf files.</span></span>
<span id="cb29-24"><a href="#cb29-24" tabindex="-1"></a><span class="co">    This constraint will not exist once iris is updated to</span></span>
<span id="cb29-25"><a href="#cb29-25" tabindex="-1"></a><span class="co">    version 2.3.0 Aug 2019</span></span>
<span id="cb29-26"><a href="#cb29-26" tabindex="-1"></a><span class="co">"""</span></span></code></pre>
</div>
<p>{: .solution} {: .challenge}</p>
</blockquote>
</blockquote>
<ul>
<li>
<strong>Fill the dataset information list</strong>. The file <a href="https://github.com/ESMValGroup/ESMValTool/blob/main/esmvaltool/%20cmorizers/data/datasets.yml" class="external-link">datasets.yml</a>
contains the ESMValTool “tier”, the data source, the last access time
and download instructions for all supported datasets in ESMValTool. You
can simply reuse the information written in the header of the
CMORizer.</li>
</ul>
<blockquote>
<h2 id="fill-out-the-fluxcom-entry-in-datasets.yml">Fill out the FLUXCOM
entry in <code>datasets.yml</code>
</h2>
<p>Fill out the FLUXCOM entry in <code>datasets.yml</code>. The
different parts that need to be present in the entry are the
following:</p>
<ul>
<li>Dataset-name</li>
<li>Tier</li>
<li>Source</li>
<li>Last access</li>
<li>Download and processing instructions</li>
</ul>
<blockquote>
<h2 id="answers-3">Answers</h2>
<p>The entry for the “FLUXCOM” dataset should look like:</p>
<div class="codewrapper sourceCode" id="cb30">
<h3 class="code-label">YAML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yaml" tabindex="0"><code class="sourceCode yaml"><span id="cb30-1"><a href="#cb30-1" tabindex="-1"></a><span class="fu">FLUXCOM</span><span class="kw">:</span></span>
<span id="cb30-2"><a href="#cb30-2" tabindex="-1"></a><span class="at">  </span><span class="fu">tier</span><span class="kw">:</span><span class="at"> </span><span class="dv">3</span></span>
<span id="cb30-3"><a href="#cb30-3" tabindex="-1"></a><span class="at">  </span><span class="fu">source</span><span class="kw">:</span><span class="at"> http://www.bgc-jena.mpg.de/geodb/BGI/Home</span></span>
<span id="cb30-4"><a href="#cb30-4" tabindex="-1"></a><span class="at">  </span><span class="fu">last_access</span><span class="kw">:</span><span class="at"> 2019-07-27</span></span>
<span id="cb30-5"><a href="#cb30-5" tabindex="-1"></a><span class="fu">  info</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb30-6"><a href="#cb30-6" tabindex="-1"></a>    From the website, select FLUXCOM as the data choice and click download.</span>
<span id="cb30-7"><a href="#cb30-7" tabindex="-1"></a>    Two files will be displayed. One for Land Carbon Fluxes and one for</span>
<span id="cb30-8"><a href="#cb30-8" tabindex="-1"></a>    Land Energy fluxes. The Land Carbon Flux file (RS + METEO) using</span>
<span id="cb30-9"><a href="#cb30-9" tabindex="-1"></a>    CRUNCEP data file has several data files for different variables.</span>
<span id="cb30-10"><a href="#cb30-10" tabindex="-1"></a>    The data for GPP generated using the</span>
<span id="cb30-11"><a href="#cb30-11" tabindex="-1"></a>    Artificial Neural Network Method will be in files with name:</span>
<span id="cb30-12"><a href="#cb30-12" tabindex="-1"></a>    GPP.ANN.CRUNCEPv6.monthly.*.nc</span>
<span id="cb30-13"><a href="#cb30-13" tabindex="-1"></a>    A registration is required for downloading the data.</span>
<span id="cb30-14"><a href="#cb30-14" tabindex="-1"></a>    Users in the UK with a CEDA-JASMIN account may request access to the jules</span>
<span id="cb30-15"><a href="#cb30-15" tabindex="-1"></a>    workspace and access the data.</span>
<span id="cb30-16"><a href="#cb30-16" tabindex="-1"></a>    Note : This data may require rechunking of the netcdf files.</span>
<span id="cb30-17"><a href="#cb30-17" tabindex="-1"></a>    This constraint will not exist once iris is updated to</span>
<span id="cb30-18"><a href="#cb30-18" tabindex="-1"></a>    version 2.3.0 Aug 2019</span></code></pre>
</div>
<p>{: .solution} {: .challenge}</p>
</blockquote>
</blockquote>
<p>Once the <code>datasets.yml</code> file is filled, you can check that
ESMValTool can display information about the added dataset with:</p>
<div class="codewrapper sourceCode" id="cb31">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb31-1"><a href="#cb31-1" tabindex="-1"></a><span class="ex">esmvaltool</span> data info FLUXCOM</span></code></pre>
</div>
<p>If everything is okay, the output should look something like
this:</p>
<pre><code> $ esmvaltool data info FLUXCOM
FLUXCOM

Tier: 3
Source: http://www.bgc-jena.mpg.de/geodb/BGI/Home
Automatic download: No

From the website, select FLUXCOM as the data choice and click download.
Two files will be displayed. One for Land Carbon Fluxes and one for
Land Energy fluxes. The Land Carbon Flux file (RS + METEO) using
CRUNCEP data file has several data files for different variables.
The data for GPP generated using the
Artificial Neural Network Method will be in files with name:
GPP.ANN.CRUNCEPv6.monthly.*.nc
A registration is required for downloading the data.
Users in the UK with a CEDA-JASMIN account may request access to the jules
workspace and access the data.
Note : This data may require rechunking of the netcdf files.
This constraint will not exist once iris is updated to
version 2.3.0 Aug 2019</code></pre>
<p>{: .output}</p>
<p>Note that <code>Automatic download: No</code> means that no automatic
downloading script is available in ESMValTool for this dataset. The
implementation of such a script is beyond the scope of this tutorial. To
find out which datasets come with an automatic download script, you can
run: <code>esmvaltool data list</code> to list all datasets supported in
ESMValTool. More information about the usage of automatic downloading
scripts can be found in the <a href="https://docs.esmvaltool.org/en/latest/develop/dataset.html#downloader-script-optional" class="external-link">User
Guide</a>.</p>
<ul>
<li>
<strong>Complete the metadata in the config file</strong>. We have
left a few fields empty in the configuration file, such as ‘source’. By
filling out these fields we can make sure the relevant metadata is
passed on as attributes in the CMORized data. To make this work, add the
following line to the CMORizer script:</li>
</ul>
<div class="codewrapper sourceCode" id="cb33">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" tabindex="-1"></a><span class="co"># 2d. Update the cubes metadata with all info from the config file</span></span>
<span id="cb33-2"><a href="#cb33-2" tabindex="-1"></a>utils.set_global_atts(cube, attributes)</span></code></pre>
</div>
<ul>
<li><p><strong>Add a reference</strong>. Make sure that there is a
reference file available for the dataset, see the instruction <a href="https://docs.esmvaltool.org/en%20/latest/community/diagnostic.html#adding-references" class="external-link">here</a>.</p></li>
<li><p><strong>Make a pull request</strong>. Since you have gone through
all the trouble to reformat the dataset so that the ESMValTool can work
with it, it would be great if you could provide the CMORizer, and
ultimately with that the dataset, to the rest of the community. For more
information, see the episode on <a href="%7B%7B%20page.root%20%7D%7D%7B%%20link%20_episodes/07-development-setup.md%20%%7D">Development
and contribution</a>.</p></li>
<li><p><strong>Add documentation</strong>. Make sure that you have added
the info of your dataset to the User Guide so that people know it is
available for the ESMValTool <a href="https://github.com/ESMValGroup/ESMValTool/blob/main/doc/sphinx/source/input.rst" class="external-link">Obtaining
input data</a>.</p></li>
</ul>
</div>
</section><section><h2 class="section-heading" id="some-final-comments">Some final comments<a class="anchor" aria-label="anchor" href="#some-final-comments"></a>
</h2>
<hr class="half-width">
<p>Congratulations! You have just added support for a new dataset to
ESMValTool! Adding a new CMORizer is definitely already an advanced task
when working with the ESMValTool. You need to have a basic understanding
of how the ESMValTool works and how it’s internal structure looks like.
In addition, you need to have a basic understanding of NetCDF files and
a programming language. In our example we used python for the CMORizing
script since we advocate for focusing the code development on only a few
different programming languages. This helps to maintain the code and to
ensure the compatibility of the code with possible fundamental changes
to the structure of the ESMValTool and ESMValCore.</p>
<p>More information about adding observations to the ESMValTool can be
found in the <a href="https://docs.esmvaltool.org/en/latest/input.html#observations" class="external-link">documentation</a>.</p>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</section></section><section id="aio-10-debugging"><p>Content from <a href="10-debugging.html">Debugging</a></p>
<hr>
<p>Last updated on 2024-11-21 |

        <a href="https://github.com/ehogan/ESMValTool_Tutorial/edit/main/episodes/10-debugging.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Estimated time: <i aria-hidden="true" data-feather="clock"></i> 45 minutes</p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<p>Every user encounters errors. Once you know why you get certain types
of errors, they become much easier to fix. The good news is that
ESMValTool creates a record of the output messages and stores them in
log files. They can be used for debugging or monitoring the process.
This lesson helps you understand the different types of errors and when
you are likely to encounter them.</p>
<section><h2 class="section-heading" id="log-files">Log files<a class="anchor" aria-label="anchor" href="#log-files"></a>
</h2>
<hr class="half-width">
<p>Each time we run ESMValTool, it will produce a new output directory.
This directory should contain the <code>run</code> folder that is
automatically generated by ESMValTool. To examine this, we run a
<code>recipe_python.yml</code> that can be found in lesson <a href="%7B%7B%20page.root%20%7D%7D%7B%%20link%20_episodes/04-recipe.md%20%%7D">Running
your first recipe</a>. Check lesson <a href="%7B%7B%20page.root%20%7D%7D%7B%%20link%20_episodes/03-configuration.md%20%%7D">Configuration</a>
on how to set paths.</p>
<p>In a new terminal, run the recipe:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a>  <span class="bu">cd</span> esmvaltool_tutorial</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a>  <span class="ex">esmvaltool</span> run examples/recipe_python.yml</span></code></pre>
</div>
<pre><code>esmvaltool: command not found</code></pre>
<p>{: .error}</p>
<p>ESMValTool encounters this error because the conda environment
<code>esmvaltool</code> has not been activated. To fix the error, before
running the recipe, activate the environment:</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="ex">conda</span> activate esmvaltool</span></code></pre>
</div>
<blockquote>
<h2 id="conda-environment">conda environment</h2>
<p>More information about the conda environment can be found at <a href="%7B%7B%20page.root%20%7D%7D%7B%%20link%20_episodes/02-installation.md%20%%7D">Installation</a>.
{: .callout}</p>
</blockquote>
<p>Let’s list the files in the <code>run</code> directory:</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>  <span class="fu">ls</span> esmvaltool_output/recipe_python_#_#/run</span></code></pre>
</div>
<pre><code>main_log_debug.txt  main_log.txt  map  recipe_python.yml  resource_usage.txt
timeseries</code></pre>
<p>{: .output}</p>
<p>In the <code>main_log_debug.txt</code> and <code>main_log.txt</code>,
ESMValTool writes the output messages, warnings and possible errors that
might happen during pre-processings. To inspect them, we can look inside
the files. For example:</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a>  <span class="fu">cat</span> esmvaltool_output/recipe_python_#_#/run/main_log.txt</span></code></pre>
</div>
<p>Now, let’s have a look inside the folder
<code>timeseries/script1</code>:</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>  <span class="fu">ls</span> esmvaltool_output/recipe_python_#_#/run/timeseries/script1/</span></code></pre>
</div>
<pre><code>diagnostic_provenance.yml log.txt  resource_usage.txt  settings.yml</code></pre>
<p>{: .output}</p>
<p>In the <code>log.txt</code>, ESMValTool writes the output messages,
warnings and possible errors that are related to the diagnostic
script.</p>
<p>If you encounter an error and don’t know what it means, it is
important to read the log information. Sometimes knowing where the error
occurred is enough to fix it, even if you don’t entirely understand the
message. However, note that you may not always be able to find the error
or fix it. In that case, ESMValTool community helps you figure out what
went wrong.</p>
<blockquote>
<h2 id="different-log-files">Different log files</h2>
<p>In the <code>run</code> directory, there are two log files
<code>main_log_debug.txt</code> and <code>main_log.txt</code>. What are
their differences?</p>
<blockquote>
<h2 id="solution">Solution</h2>
<p>The <code>main_log_debug.txt</code> contains the output messages from
the pre-processor whereas the <code>main_log.txt</code> shows general
errors and warnings that might happen in running the recipe and
diagnostics script. {: .solution} {: .challenge}</p>
</blockquote>
</blockquote>
<p>Let’s change some settings in the recipe to run a regional
pre-processor. We use a text editor called <code>nano</code> to open the
recipe file:</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>  <span class="fu">nano</span> recipe_python.yml</span></code></pre>
</div>
<blockquote>
<h2 id="text-editor-side-note">Text editor side note</h2>
<p>No matter what editor you use, you will need to know where it
searches for and saves files. If you start it from the shell, it will
(probably) use your current working directory as its default location.
We use <code>nano</code> in examples here because it is one of the least
complex text editors. Press <kbd>ctrl</kbd> + <kbd>O</kbd> to save the
file, and then <kbd>ctrl</kbd> + <kbd>X</kbd> to exit <code>nano</code>.
{: .callout}</p>
</blockquote>
<blockquote>
<h2 id="see-the-recipe_python.yml">See the recipe_python.yml</h2>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">YAML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yaml" tabindex="0"><code class="sourceCode yaml"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="co"># ESMValTool</span></span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a><span class="co"># recipe_python.yml</span></span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a><span class="pp">---</span></span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a><span class="co"># See https://docs.esmvaltool.org/en/latest/recipes/recipe_examples.html</span></span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a><span class="co"># for a description of this recipe.</span></span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a><span class="co"># See https://docs.esmvaltool.org/projects/esmvalcore/en/latest/recipe/overview.html</span></span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a><span class="co"># for a description of the recipe format.</span></span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a><span class="pp">---</span></span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a><span class="fu">documentation</span><span class="kw">:</span></span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a><span class="fu">  description</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a>    Example recipe that plots a map and timeseries of temperature.</span>
<span id="cb10-13"><a href="#cb10-13" tabindex="-1"></a></span>
<span id="cb10-14"><a href="#cb10-14" tabindex="-1"></a><span class="at">  </span><span class="fu">title</span><span class="kw">:</span><span class="at"> Recipe that runs an example diagnostic written in Python.</span></span>
<span id="cb10-15"><a href="#cb10-15" tabindex="-1"></a></span>
<span id="cb10-16"><a href="#cb10-16" tabindex="-1"></a><span class="at">  </span><span class="fu">authors</span><span class="kw">:</span></span>
<span id="cb10-17"><a href="#cb10-17" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> andela_bouwe</span></span>
<span id="cb10-18"><a href="#cb10-18" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> righi_mattia</span></span>
<span id="cb10-19"><a href="#cb10-19" tabindex="-1"></a></span>
<span id="cb10-20"><a href="#cb10-20" tabindex="-1"></a><span class="at">  </span><span class="fu">maintainer</span><span class="kw">:</span></span>
<span id="cb10-21"><a href="#cb10-21" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> schlund_manuel</span></span>
<span id="cb10-22"><a href="#cb10-22" tabindex="-1"></a></span>
<span id="cb10-23"><a href="#cb10-23" tabindex="-1"></a><span class="at">  </span><span class="fu">references</span><span class="kw">:</span></span>
<span id="cb10-24"><a href="#cb10-24" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> acknow_project</span></span>
<span id="cb10-25"><a href="#cb10-25" tabindex="-1"></a></span>
<span id="cb10-26"><a href="#cb10-26" tabindex="-1"></a><span class="at">  </span><span class="fu">projects</span><span class="kw">:</span></span>
<span id="cb10-27"><a href="#cb10-27" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> esmval</span></span>
<span id="cb10-28"><a href="#cb10-28" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> c3s-magic</span></span>
<span id="cb10-29"><a href="#cb10-29" tabindex="-1"></a></span>
<span id="cb10-30"><a href="#cb10-30" tabindex="-1"></a><span class="fu">datasets</span><span class="kw">:</span></span>
<span id="cb10-31"><a href="#cb10-31" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="kw">{</span><span class="fu">dataset</span><span class="kw">:</span><span class="at"> BCC-ESM1</span><span class="kw">,</span><span class="at"> </span><span class="fu">project</span><span class="kw">:</span><span class="at"> CMIP6</span><span class="kw">,</span><span class="at"> </span><span class="fu">exp</span><span class="kw">:</span><span class="at"> historical</span><span class="kw">,</span><span class="at"> </span><span class="fu">ensemble</span><span class="kw">:</span><span class="at"> r1i1p1f1</span><span class="kw">,</span><span class="at"> </span><span class="fu">grid</span><span class="kw">:</span><span class="at"> gn</span><span class="kw">}</span></span>
<span id="cb10-32"><a href="#cb10-32" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="kw">{</span><span class="fu">dataset</span><span class="kw">:</span><span class="at"> bcc-csm1-1</span><span class="kw">,</span><span class="at"> </span><span class="fu">version</span><span class="kw">:</span><span class="at"> v1</span><span class="kw">,</span><span class="at"> </span><span class="fu">project</span><span class="kw">:</span><span class="at"> CMIP5</span><span class="kw">,</span><span class="at"> </span><span class="fu">exp</span><span class="kw">:</span><span class="at"> historical</span><span class="kw">,</span><span class="at"> </span><span class="fu">ensemble</span><span class="kw">:</span><span class="at"> r1i1p1</span><span class="kw">}</span></span>
<span id="cb10-33"><a href="#cb10-33" tabindex="-1"></a></span>
<span id="cb10-34"><a href="#cb10-34" tabindex="-1"></a><span class="fu">preprocessors</span><span class="kw">:</span></span>
<span id="cb10-35"><a href="#cb10-35" tabindex="-1"></a><span class="co"># See https://docs.esmvaltool.org/projects/esmvalcore/en/latest/recipe/preprocessor.html</span></span>
<span id="cb10-36"><a href="#cb10-36" tabindex="-1"></a><span class="co"># for a description of the preprocessor functions.</span></span>
<span id="cb10-37"><a href="#cb10-37" tabindex="-1"></a></span>
<span id="cb10-38"><a href="#cb10-38" tabindex="-1"></a><span class="at">  </span><span class="fu">to_degrees_c</span><span class="kw">:</span></span>
<span id="cb10-39"><a href="#cb10-39" tabindex="-1"></a><span class="at">    </span><span class="fu">convert_units</span><span class="kw">:</span></span>
<span id="cb10-40"><a href="#cb10-40" tabindex="-1"></a><span class="at">      </span><span class="fu">units</span><span class="kw">:</span><span class="at"> degrees_C</span></span>
<span id="cb10-41"><a href="#cb10-41" tabindex="-1"></a></span>
<span id="cb10-42"><a href="#cb10-42" tabindex="-1"></a><span class="at">  </span><span class="fu">annual_mean_amsterdam</span><span class="kw">:</span></span>
<span id="cb10-43"><a href="#cb10-43" tabindex="-1"></a><span class="at">    </span><span class="fu">extract_location</span><span class="kw">:</span></span>
<span id="cb10-44"><a href="#cb10-44" tabindex="-1"></a><span class="at">      </span><span class="fu">location</span><span class="kw">:</span><span class="at"> Amsterdam</span></span>
<span id="cb10-45"><a href="#cb10-45" tabindex="-1"></a><span class="at">      </span><span class="fu">scheme</span><span class="kw">:</span><span class="at"> linear</span></span>
<span id="cb10-46"><a href="#cb10-46" tabindex="-1"></a><span class="at">    </span><span class="fu">annual_statistics</span><span class="kw">:</span></span>
<span id="cb10-47"><a href="#cb10-47" tabindex="-1"></a><span class="at">      </span><span class="fu">operator</span><span class="kw">:</span><span class="at"> mean</span></span>
<span id="cb10-48"><a href="#cb10-48" tabindex="-1"></a><span class="at">    </span><span class="fu">multi_model_statistics</span><span class="kw">:</span></span>
<span id="cb10-49"><a href="#cb10-49" tabindex="-1"></a><span class="at">      </span><span class="fu">statistics</span><span class="kw">:</span></span>
<span id="cb10-50"><a href="#cb10-50" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> mean</span></span>
<span id="cb10-51"><a href="#cb10-51" tabindex="-1"></a><span class="at">      </span><span class="fu">span</span><span class="kw">:</span><span class="at"> overlap</span></span>
<span id="cb10-52"><a href="#cb10-52" tabindex="-1"></a><span class="at">    </span><span class="fu">convert_units</span><span class="kw">:</span></span>
<span id="cb10-53"><a href="#cb10-53" tabindex="-1"></a><span class="at">      </span><span class="fu">units</span><span class="kw">:</span><span class="at"> degrees_C</span></span>
<span id="cb10-54"><a href="#cb10-54" tabindex="-1"></a></span>
<span id="cb10-55"><a href="#cb10-55" tabindex="-1"></a><span class="at">  </span><span class="fu">annual_mean_global</span><span class="kw">:</span></span>
<span id="cb10-56"><a href="#cb10-56" tabindex="-1"></a><span class="at">    </span><span class="fu">area_statistics</span><span class="kw">:</span></span>
<span id="cb10-57"><a href="#cb10-57" tabindex="-1"></a><span class="at">      </span><span class="fu">operator</span><span class="kw">:</span><span class="at"> mean</span></span>
<span id="cb10-58"><a href="#cb10-58" tabindex="-1"></a><span class="at">    </span><span class="fu">annual_statistics</span><span class="kw">:</span></span>
<span id="cb10-59"><a href="#cb10-59" tabindex="-1"></a><span class="at">      </span><span class="fu">operator</span><span class="kw">:</span><span class="at"> mean</span></span>
<span id="cb10-60"><a href="#cb10-60" tabindex="-1"></a><span class="at">    </span><span class="fu">convert_units</span><span class="kw">:</span></span>
<span id="cb10-61"><a href="#cb10-61" tabindex="-1"></a><span class="at">      </span><span class="fu">units</span><span class="kw">:</span><span class="at"> degrees_C</span></span>
<span id="cb10-62"><a href="#cb10-62" tabindex="-1"></a></span>
<span id="cb10-63"><a href="#cb10-63" tabindex="-1"></a><span class="fu">diagnostics</span><span class="kw">:</span></span>
<span id="cb10-64"><a href="#cb10-64" tabindex="-1"></a></span>
<span id="cb10-65"><a href="#cb10-65" tabindex="-1"></a><span class="at">  </span><span class="fu">map</span><span class="kw">:</span></span>
<span id="cb10-66"><a href="#cb10-66" tabindex="-1"></a><span class="at">    </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Global map of temperature in January 2000.</span></span>
<span id="cb10-67"><a href="#cb10-67" tabindex="-1"></a><span class="at">    </span><span class="fu">themes</span><span class="kw">:</span></span>
<span id="cb10-68"><a href="#cb10-68" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> phys</span></span>
<span id="cb10-69"><a href="#cb10-69" tabindex="-1"></a><span class="at">    </span><span class="fu">realms</span><span class="kw">:</span></span>
<span id="cb10-70"><a href="#cb10-70" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> atmos</span></span>
<span id="cb10-71"><a href="#cb10-71" tabindex="-1"></a><span class="at">    </span><span class="fu">variables</span><span class="kw">:</span></span>
<span id="cb10-72"><a href="#cb10-72" tabindex="-1"></a><span class="at">      </span><span class="fu">tas</span><span class="kw">:</span></span>
<span id="cb10-73"><a href="#cb10-73" tabindex="-1"></a><span class="at">        </span><span class="fu">mip</span><span class="kw">:</span><span class="at"> Amon</span></span>
<span id="cb10-74"><a href="#cb10-74" tabindex="-1"></a><span class="at">        </span><span class="fu">preprocessor</span><span class="kw">:</span><span class="at"> to_degrees_c</span></span>
<span id="cb10-75"><a href="#cb10-75" tabindex="-1"></a><span class="at">        </span><span class="fu">timerange</span><span class="kw">:</span><span class="at"> 2000/P1M</span></span>
<span id="cb10-76"><a href="#cb10-76" tabindex="-1"></a><span class="fu">        caption</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb10-77"><a href="#cb10-77" tabindex="-1"></a>          Global map of {long_name} in January 2000 according to {dataset}.</span>
<span id="cb10-78"><a href="#cb10-78" tabindex="-1"></a><span class="at">    </span><span class="fu">scripts</span><span class="kw">:</span></span>
<span id="cb10-79"><a href="#cb10-79" tabindex="-1"></a><span class="at">      </span><span class="fu">script1</span><span class="kw">:</span></span>
<span id="cb10-80"><a href="#cb10-80" tabindex="-1"></a><span class="at">        </span><span class="fu">script</span><span class="kw">:</span><span class="at"> examples/diagnostic.py</span></span>
<span id="cb10-81"><a href="#cb10-81" tabindex="-1"></a><span class="at">        </span><span class="fu">quickplot</span><span class="kw">:</span></span>
<span id="cb10-82"><a href="#cb10-82" tabindex="-1"></a><span class="at">          </span><span class="fu">plot_type</span><span class="kw">:</span><span class="at"> pcolormesh</span></span>
<span id="cb10-83"><a href="#cb10-83" tabindex="-1"></a><span class="at">          </span><span class="fu">cmap</span><span class="kw">:</span><span class="at"> Reds</span></span>
<span id="cb10-84"><a href="#cb10-84" tabindex="-1"></a></span>
<span id="cb10-85"><a href="#cb10-85" tabindex="-1"></a><span class="at">  </span><span class="fu">timeseries</span><span class="kw">:</span></span>
<span id="cb10-86"><a href="#cb10-86" tabindex="-1"></a><span class="at">    </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Annual mean temperature in Amsterdam and global mean since 1850.</span></span>
<span id="cb10-87"><a href="#cb10-87" tabindex="-1"></a><span class="at">    </span><span class="fu">themes</span><span class="kw">:</span></span>
<span id="cb10-88"><a href="#cb10-88" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> phys</span></span>
<span id="cb10-89"><a href="#cb10-89" tabindex="-1"></a><span class="at">    </span><span class="fu">realms</span><span class="kw">:</span></span>
<span id="cb10-90"><a href="#cb10-90" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> atmos</span></span>
<span id="cb10-91"><a href="#cb10-91" tabindex="-1"></a><span class="at">    </span><span class="fu">variables</span><span class="kw">:</span></span>
<span id="cb10-92"><a href="#cb10-92" tabindex="-1"></a><span class="at">      </span><span class="fu">tas_amsterdam</span><span class="kw">:</span></span>
<span id="cb10-93"><a href="#cb10-93" tabindex="-1"></a><span class="at">        </span><span class="fu">short_name</span><span class="kw">:</span><span class="at"> tas</span></span>
<span id="cb10-94"><a href="#cb10-94" tabindex="-1"></a><span class="at">        </span><span class="fu">mip</span><span class="kw">:</span><span class="at"> Amon</span></span>
<span id="cb10-95"><a href="#cb10-95" tabindex="-1"></a><span class="at">        </span><span class="fu">preprocessor</span><span class="kw">:</span><span class="at"> annual_mean_amsterdam</span></span>
<span id="cb10-96"><a href="#cb10-96" tabindex="-1"></a><span class="at">        </span><span class="fu">timerange</span><span class="kw">:</span><span class="at"> 1850/2000</span></span>
<span id="cb10-97"><a href="#cb10-97" tabindex="-1"></a><span class="at">        </span><span class="fu">caption</span><span class="kw">:</span><span class="at"> Annual mean {long_name} in Amsterdam according to {dataset}.</span></span>
<span id="cb10-98"><a href="#cb10-98" tabindex="-1"></a><span class="at">      </span><span class="fu">tas_global</span><span class="kw">:</span></span>
<span id="cb10-99"><a href="#cb10-99" tabindex="-1"></a><span class="at">        </span><span class="fu">short_name</span><span class="kw">:</span><span class="at"> tas</span></span>
<span id="cb10-100"><a href="#cb10-100" tabindex="-1"></a><span class="at">        </span><span class="fu">mip</span><span class="kw">:</span><span class="at"> Amon</span></span>
<span id="cb10-101"><a href="#cb10-101" tabindex="-1"></a><span class="at">        </span><span class="fu">preprocessor</span><span class="kw">:</span><span class="at"> annual_mean_global</span></span>
<span id="cb10-102"><a href="#cb10-102" tabindex="-1"></a><span class="at">        </span><span class="fu">timerange</span><span class="kw">:</span><span class="at"> 1850/2000</span></span>
<span id="cb10-103"><a href="#cb10-103" tabindex="-1"></a><span class="at">        </span><span class="fu">caption</span><span class="kw">:</span><span class="at"> Annual global mean {long_name} according to {dataset}.</span></span>
<span id="cb10-104"><a href="#cb10-104" tabindex="-1"></a><span class="at">    </span><span class="fu">scripts</span><span class="kw">:</span></span>
<span id="cb10-105"><a href="#cb10-105" tabindex="-1"></a><span class="at">      </span><span class="fu">script1</span><span class="kw">:</span></span>
<span id="cb10-106"><a href="#cb10-106" tabindex="-1"></a><span class="at">        </span><span class="fu">script</span><span class="kw">:</span><span class="at"> examples/diagnostic.py</span></span>
<span id="cb10-107"><a href="#cb10-107" tabindex="-1"></a><span class="at">        </span><span class="fu">quickplot</span><span class="kw">:</span></span>
<span id="cb10-108"><a href="#cb10-108" tabindex="-1"></a><span class="at">          </span><span class="fu">plot_type</span><span class="kw">:</span><span class="at"> plot</span></span></code></pre>
</div>
<p>{: .solution}</p>
</blockquote>
</section><section><h2 class="section-heading" id="keys-and-values-in-recipe-settings">Keys and values in recipe settings<a class="anchor" aria-label="anchor" href="#keys-and-values-in-recipe-settings"></a>
</h2>
<hr class="half-width">
<p>The <a href="https://docs.esmvaltool.org/projects/ESMValCore/en/latest/%20recipe/preprocessor.html?highlight=preprocessor" class="external-link">ESMValTool
pre-processors</a> cover a broad range of operations on the input data,
like time manipulation, area manipulation, land-sea masking, variable
derivation, etc. Let’s add the preprocessor <code>extract_region</code>
to a new section <code>annual_mean_regional</code>:</p>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">YAML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yaml" tabindex="0"><code class="sourceCode yaml"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="fu">preprocessors</span><span class="kw">:</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a><span class="at">  </span><span class="fu">annual_mean_regional</span><span class="kw">:</span></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a><span class="at">    </span><span class="fu">annual_statistics</span><span class="kw">:</span></span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a><span class="at">      </span><span class="fu">operator</span><span class="kw">:</span><span class="at"> mean</span></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a><span class="at">    </span><span class="fu">extract_region</span><span class="kw">:</span></span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a><span class="at">      </span><span class="fu">start_longitude</span><span class="kw">:</span><span class="at"> </span><span class="dv">-10</span></span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a><span class="at">      </span><span class="fu">end_longitude</span><span class="kw">:</span><span class="at"> </span><span class="dv">40</span></span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a><span class="at">      </span><span class="fu">start_latitude</span><span class="kw">:</span><span class="at"> </span><span class="dv">27</span></span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a><span class="at">      </span><span class="fu">end_latitude</span><span class="kw">:</span><span class="at"> </span><span class="dv">70</span></span></code></pre>
</div>
<p>Also, we change the <code>projects</code> value <code>esmval</code>
to <code>tutorial</code>:</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">YAML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yaml" tabindex="0"><code class="sourceCode yaml"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="fu">projects</span><span class="kw">:</span></span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> tutorial</span></span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> c3s-magic</span></span></code></pre>
</div>
<p>Then, we save the file and run the recipe: ~<del>bash esmvaltool run
recipe_python.yml</del>~</p>
<pre><code>ValueError: Tag 'tutorial' does not exist in section 'projects' of
esmvaltool/config-references.yml 2020-06-29 18:09:56,641 UTC [46055] INFO If you
have a question or need help, please start a new discussion on
https://github.com/ESMValGroup/ESMValTool/discussions If you suspect this is a
bug, please open an issue on https://github.com/ESMValGroup/ESMValTool/issues To
make it easier to find out what the problem is, please consider attaching the
files run/recipe_*.yml and run/main_log_debug.txt from the output directory.</code></pre>
<p>{: .error}</p>
<p>The values for the keys <code>author</code>, <code>maintainer</code>,
<code>projects</code> and <code>references</code> in the recipe should
be known by ESMValTool:</p>
<ul>
<li>A list of ESMValTool author, maintainer, and projects can be found
in the <a href="https://github.com/ESMValGroup/ESMValTool/blob/master/%20esmvaltool/config-references.yml" class="external-link">config-references.yml</a>.</li>
<li>ESMValTool references in <code>BibTeX</code> format can be found in
the <a href="https://github.com/ESMValGroup/ESMValTool/%20tree/master/esmvaltool/references" class="external-link">ESMValTool/esmvaltool/references</a>
directory.</li>
</ul>
<blockquote>
<h2 id="esmvaltool-cant-locate-the-data">ESMValTool can’t locate the
data</h2>
<p>You are assisting a colleague with ESMValTool. The colleague replaces
the <code>CanESM2</code> entry in
<code>dataset: CanESM2, project: CMIP5</code> to <code>ACCESS1-3</code>
and runs the recipe. However, ESMValTool encounters an error like:</p>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="ex">ERROR</span>   No input files found for variable {<span class="st">'short_name'</span>: <span class="st">'tas'</span>, <span class="st">'mip'</span>: <span class="st">'Amon'</span>,</span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a><span class="st">'preprocessor'</span><span class="ex">:</span> <span class="st">'annual_mean_amsterdam'</span>, <span class="st">'variable_group'</span>: <span class="st">'tas_amsterdam'</span>,</span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a><span class="st">'diagnostic'</span><span class="ex">:</span> <span class="st">'timeseries'</span>, <span class="st">'dataset'</span>: <span class="st">'ACCESS1-3'</span>, <span class="st">'project'</span>: <span class="st">'CMIP5'</span>, <span class="st">'exp'</span>:</span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a><span class="st">'historical'</span><span class="ex">,</span> <span class="st">'ensemble'</span>: <span class="st">'r1i1p1'</span>, <span class="st">'recipe_dataset_index'</span>: 1, <span class="st">'institute'</span>:</span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a><span class="ex">[</span><span class="st">'CSIRO-BOM'</span><span class="ex">],</span> <span class="st">'product'</span>: [<span class="st">'output1'</span>, <span class="st">'output2'</span>], <span class="st">'timerange'</span>: <span class="st">'1850/2000'</span>,</span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a><span class="st">'alias'</span><span class="ex">:</span> <span class="st">'CMIP5'</span>, <span class="st">'original_short_name'</span>: <span class="st">'tas'</span>, <span class="st">'standard_name'</span>:</span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a><span class="st">'air_temperature'</span><span class="ex">,</span> <span class="st">'long_name'</span>: <span class="st">'Near-Surface Air Temperature'</span>, <span class="st">'units'</span>: <span class="st">'K'</span>,</span>
<span id="cb14-8"><a href="#cb14-8" tabindex="-1"></a><span class="st">'modeling_realm'</span><span class="ex">:</span> <span class="pp">[</span><span class="st">'atmos'</span><span class="pp">]</span>, <span class="st">'frequency'</span>: <span class="st">'mon'</span>, <span class="st">'start_year'</span>: 1850,</span>
<span id="cb14-9"><a href="#cb14-9" tabindex="-1"></a><span class="st">'end_year'</span><span class="ex">:</span> 2000}</span>
<span id="cb14-10"><a href="#cb14-10" tabindex="-1"></a><span class="ex">ERROR</span>   Looked for files matching</span>
<span id="cb14-11"><a href="#cb14-11" tabindex="-1"></a><span class="ex">[</span><span class="st">'tas_Amon_ACCESS1-3_historical_r1i1p1*.nc'</span><span class="ex">],</span> but did not find any existing</span>
<span id="cb14-12"><a href="#cb14-12" tabindex="-1"></a><span class="ex">input</span> directory</span>
<span id="cb14-13"><a href="#cb14-13" tabindex="-1"></a><span class="ex">ERROR</span>   Set <span class="st">'log_level'</span> to <span class="st">'debug'</span> to get more information</span></code></pre>
</div>
<p>What suggestions would you give the researcher for fixing the
error?</p>
<blockquote>
<h2 id="solution-1">Solution</h2>
<ol style="list-style-type: decimal">
<li>Check <code>user-config.yml</code> to see if the correct directory
for input data is introduced</li>
<li>Check the available data, regarding exp, mip, ensemble, start_year,
and end_year</li>
<li>Check the variable names in the diagnostics section in the recipe {:
.solution} {: .challenge}</li>
</ol>
</blockquote>
</blockquote>
</section><section><h2 class="section-heading" id="check-pre-processed-data">Check pre-processed data<a class="anchor" aria-label="anchor" href="#check-pre-processed-data"></a>
</h2>
<hr class="half-width">
<p>The setting <code>save_intermediary_cubes</code> in the configuration
file can be used to save the pre-processed data. More information about
this setting can be found at <a href="%7B%7B%20page.root%20%7D%7D%7B%%20link%20_episodes/03-configuration.md%20%%7D">Configuration</a>.</p>
<blockquote>
<h2 id="save_intermediary_cubes">save_intermediary_cubes</h2>
<p>Note that this setting should only be used for debugging, as it
significantly slows down the recipe and increases disk usage because a
lot of output files need to be stored. {: .callout}</p>
</blockquote>
</section><section><h2 class="section-heading" id="check-diagnostic-script-path">Check diagnostic script path<a class="anchor" aria-label="anchor" href="#check-diagnostic-script-path"></a>
</h2>
<hr class="half-width">
<p>The result of the pre-processor is passed to the
<code>examples/diagnostic.py</code> script, that is introduced in the
recipe as:</p>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">YAML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yaml" tabindex="0"><code class="sourceCode yaml"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="fu">scripts</span><span class="kw">:</span></span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a><span class="at">  </span><span class="fu">script1</span><span class="kw">:</span></span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a><span class="at">    </span><span class="fu">script</span><span class="kw">:</span></span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a><span class="at">      </span><span class="fu">script</span><span class="kw">:</span><span class="at"> examples/diagnostic.py</span></span></code></pre>
</div>
<p>The diagnostic scripts are located in the folder
<code>diag_scripts</code> in the ESMValTool installation directory
<code>&lt;path_to_esmvaltool&gt;</code>. To find where ESMValTool is
located on your system, see <a href="%7B%7B%20page.root%20%7D%7D%7B%%20link%20_episodes/02-installation.md%20%%7D">Installation</a>.</p>
<p>Let’s see what happens if we can change the script path as:</p>
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">YAML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yaml" tabindex="0"><code class="sourceCode yaml"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="fu">scripts</span><span class="kw">:</span></span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a><span class="at">  </span><span class="fu">script1</span><span class="kw">:</span></span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a><span class="at">    </span><span class="fu">script</span><span class="kw">:</span></span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a><span class="at">      </span><span class="fu">script</span><span class="kw">:</span><span class="at"> diag_scripts/ocean/diagnostic_timeseries.py</span></span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a>  <span class="ex">esmvaltool</span> run examples/recipe_python.yml</span></code></pre>
</div>
<pre><code>esmvalcore._task.DiagnosticError: Cannot execute script
'diag_scripts/ocean/diagnostic_timeseries.py'
(~/mambaforge/envs/esmvaltool2.6/lib/python3.10/site-packages/esmvaltool/
diag_scripts/diag_scripts/ocean/diagnostic_timeseries.py):
file does not exist. 2022-10-18 11:42:34,136 UTC [39323] INFO If you have a
question or need help, please start a new discussion on
https://github.com/ESMValGroup/ESMValTool/discussions If you suspect this is a
bug, please open an issue on https://github.com/ESMValGroup/ESMValTool/issues To
make it easier to find out what the problem is, please consider attaching the
files run/recipe_*.yml and run/main_log_debug.txt from the output directory.</code></pre>
<p>{: .error}</p>
<p>The script path should be relative to <code>diag_scripts</code>
directory. It means that the script
<code>diagnostic_timeseries.py</code> is located in
<code>&lt;path_to_esmvaltool&gt;/diag_scripts/ocean/</code>.
Alternatively, the script path can be an absolute path. To examine this,
we can download the script from the <code>ESMValTool</code>
repository:</p>
<div class="codewrapper sourceCode" id="cb19">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a><span class="fu">wget</span> https://raw.githubusercontent.com/ESMValGroup/ESMValTool/main/esmvaltool/<span class="dt">\</span></span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a>diag_scripts/ocean/diagnostic_timeseries.py</span></code></pre>
</div>
<p>One way to get the absolute path is to run:</p>
<div class="codewrapper sourceCode" id="cb20">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a><span class="fu">readlink</span> <span class="at">-f</span> diagnostic_timeseries.py</span></code></pre>
</div>
<p>Then we can update the script path :</p>
<div class="codewrapper sourceCode" id="cb21">
<h3 class="code-label">YAML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yaml" tabindex="0"><code class="sourceCode yaml"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a><span class="fu">scripts</span><span class="kw">:</span></span>
<span id="cb21-2"><a href="#cb21-2" tabindex="-1"></a><span class="at">  </span><span class="fu">script1</span><span class="kw">:</span></span>
<span id="cb21-3"><a href="#cb21-3" tabindex="-1"></a><span class="at">    </span><span class="fu">script</span><span class="kw">:</span></span>
<span id="cb21-4"><a href="#cb21-4" tabindex="-1"></a><span class="at">      </span><span class="fu">script</span><span class="kw">:</span><span class="at"> &lt;path_to_script&gt;/diagnostic_timeseries.py</span></span></code></pre>
</div>
<p>Then, run the recipe again and examine the output to see
<code>Run was successful</code>!</p>
<blockquote>
<h2 id="available-recipe-and-diagnostic-scripts">Available recipe and
diagnostic scripts</h2>
<p>ESMValTool provides a broad suite of <a href="https://docs.esmvaltool.org/en/latest/recipes/index.html" class="external-link">recipes
and diagnostic</a> scripts for different disciplines like atmosphere,
climate metrics, future projections, IPCC, land, ocean, …. {:
.callout}</p>
</blockquote>
<blockquote>
<h2 id="re-running-a-diagnostic">Re-running a diagnostic</h2>
<p>Look at the <code>main_log.txt</code> file and answer the following
question: How to re-run the diagnostic script?</p>
<blockquote>
<h2 id="solution-2">Solution</h2>
<p>The <code>main_log.txt</code> file contains information on how to
re-run the diagnostic script without re-running the pre-processors:</p>
<div class="codewrapper sourceCode" id="cb22">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a><span class="ex">2020-06-29</span> 20:36:32,844 UTC <span class="pp">[</span><span class="ss">52810</span><span class="pp">]</span> INFO    To re-run this diagnostic script, run:</span></code></pre>
</div>
<p>If you run the command in a terminal, you will be able to re-run the
diagnostic. {: .solution} {: .challenge}</p>
</blockquote>
</blockquote>
<blockquote>
<h2 id="memory-issues">Memory issues</h2>
<p>If you run out of memory, try setting <code>max_parallel_tasks</code>
to 1 in the configuration file. Then, check the amount of memory you
need for that by inspecting the file <code>run/resource_usage.txt</code>
in the output directory. Using the number, there you can increase the
number of parallel tasks again to a reasonable number for the amount of
memory available in your system. {: .callout}</p>
</blockquote>
<p>{% include links.md %}</p>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</section></section>
</div>
    </main>
</div>
<!-- END  : inst/pkgdown/templates/content-extra.html -->

      </div>
<!--/div.row-->
      		<footer class="row footer mx-md-3"><hr>
<div class="col-md-6">
        <p>This lesson is subject to the <a href="CODE_OF_CONDUCT.html">Code of Conduct</a></p>
        <p>

        <a href="https://github.com/ehogan/ESMValTool_Tutorial/edit/main/README.md" class="external-link">Edit on GitHub</a>

	
        | <a href="https://github.com/ehogan/ESMValTool_Tutorial/blob/main/CONTRIBUTING.md" class="external-link">Contributing</a>
        | <a href="https://github.com/ehogan/ESMValTool_Tutorial/" class="external-link">Source</a></p>
				<p><a href="https://github.com/ehogan/ESMValTool_Tutorial/blob/main/CITATION.cff" class="external-link">Cite</a> | <a href="mailto:team@carpentries.org">Contact</a> | <a href="https://carpentries.org/about/" class="external-link">About</a></p>
			</div>
			<div class="col-md-6">

        <p>Materials licensed under <a href="LICENSE.html">CC-BY 4.0</a> by the authors</p>

        <p>Template licensed under <a href="https://creativecommons.org/licenses/by-sa/4.0/" class="external-link">CC-BY 4.0</a> by <a href="https://carpentries.org/" class="external-link">The Carpentries</a></p>
        <p>Built with <a href="https://github.com/carpentries/sandpaper/tree/0.16.10" class="external-link">sandpaper (0.16.10)</a>, <a href="https://github.com/carpentries/pegboard/tree/0.7.7" class="external-link">pegboard (0.7.7)</a>, and <a href="https://github.com/carpentries/varnish/tree/1.0.5" class="external-link">varnish (1.0.5)</a></p>
			</div>
		</footer>
</div> <!-- / div.container -->
	<div id="to-top">
		<a href="#top">
      <i class="search-icon" data-feather="arrow-up" role="img" aria-label="Back To Top"></i><br><!-- <span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top --><span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top
		</a>
	</div>
  <script type="application/ld+json">
    {
  "@context": "https://schema.org",
  "@type": "TrainingMaterial",
  "@id": "https://ehogan.github.io/ESMValTool_Tutorial/instructor/aio.html",
  "inLanguage": "en",
  "dct:conformsTo": "https://bioschemas.org/profiles/TrainingMaterial/1.0-RELEASE",
  "description": "A Carpentries Lesson teaching foundational data and coding skills to researchers worldwide",
  "keywords": "software, data, lesson, The Carpentries",
  "name": "All in One View",
  "creativeWorkStatus": "active",
  "url": "https://ehogan.github.io/ESMValTool_Tutorial/instructor/aio.html",
  "identifier": "https://ehogan.github.io/ESMValTool_Tutorial/instructor/aio.html",
  "dateCreated": "2024-11-21",
  "dateModified": "2024-11-26",
  "datePublished": "2024-11-26"
}

  </script><script>
		feather.replace();
	</script>
</body>
</html><!-- END:   inst/pkgdown/templates/layout.html-->

